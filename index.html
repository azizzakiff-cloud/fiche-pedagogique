<!DOCTYPE html>
<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    GÃ‰NÃ‰RATEUR DE FICHES PÃ‰DAGOGIQUES                          â•‘
â•‘                                                                               â•‘
â•‘  Â© 2025 EZ-ZAKY AZIZ â€” Tous droits rÃ©servÃ©s                                  â•‘
â•‘  Licence : Creative Commons BY-NC-SA 4.0                                      â•‘
â•‘                                                                               â•‘
â•‘  Cette application est protÃ©gÃ©e par le droit d'auteur.                       â•‘
â•‘  Vous pouvez l'utiliser, la modifier et la partager UNIQUEMENT si vous :     â•‘
â•‘  âœ“ CrÃ©ditez l'auteur original (EZ-ZAKY AZIZ)                                â•‘
â•‘  âœ“ N'en faites pas un usage commercial                                       â•‘
â•‘  âœ“ Partagez vos modifications sous la mÃªme licence                           â•‘
â•‘                                                                               â•‘
â•‘  Application crÃ©Ã©e avec â¤ï¸ pour les enseignants                              â•‘
â•‘  Version 3.0 â€” FÃ©vrier 2026                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fiche PÃ©dagogique</title>
<meta name="description" content="GÃ©nÃ©rateur de fiches pÃ©dagogiques PDF">
<meta name="author" content="EZ-ZAKY AZIZ">
<meta name="copyright" content="Â© 2025 EZ-ZAKY AZIZ. Tous droits rÃ©servÃ©s.">
<meta name="license" content="CC BY-NC-SA 4.0">
<!-- Forcer le mode plein Ã©cran (cacher la barre d'adresse) -->
<meta name="theme-color" content="#1565C0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fiche PÃ©da">
<meta name="msapplication-TileColor" content="#1565C0">
<meta name="msapplication-navbutton-color" content="#1565C0">
<meta name="application-name" content="Fiche PÃ©dagogique">
<meta name="format-detection" content="telephone=no">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231565C0'/%3E%3Crect x='28' y='36' width='136' height='10' rx='5' fill='%23C9A84C'/%3E%3Crect x='28' y='56' width='136' height='8' rx='4' fill='white' opacity='.9'/%3E%3Crect x='28' y='74' width='136' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='92' width='90' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='112' width='136' height='60' rx='6' fill='white' opacity='.15'/%3E%3Ctext x='96' y='152' font-family='serif' font-size='28' font-weight='bold' fill='%23C9A84C' text-anchor='middle'%3EPDF%3C/text%3E%3C/svg%3E">
<link rel="manifest" id="pwa-manifest">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&family=Georgia:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,400;0,700;1,400&family=Open+Sans:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<!-- Quill.js pour l'Ã©dition de texte riche -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<!-- JSZip pour crÃ©er des fichiers DOCX valides -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// â”€â”€ PWA : Manifest inline â”€â”€
(function() {
  const manifest = {
    name: "Fiche PÃ©dagogique â€” EZ-ZAKY AZIZ",
    short_name: "Fiche PÃ©da",
    description: "GÃ©nÃ©rateur de fiches pÃ©dagogiques PDF",
    start_url: "./",
    scope: "/",
    display: "standalone",
    display_override: ["standalone", "fullscreen"],
    background_color: "#F7F5F0",
    theme_color: "#1565C0",
    orientation: "portrait",
    prefer_related_applications: false,
    icons: [
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231565C0'/%3E%3Crect x='28' y='36' width='136' height='10' rx='5' fill='%23C9A84C'/%3E%3Crect x='28' y='56' width='136' height='8' rx='4' fill='white' opacity='.9'/%3E%3Crect x='28' y='74' width='136' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='92' width='90' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='112' width='136' height='60' rx='6' fill='white' opacity='.15'/%3E%3Ctext x='96' y='152' font-family='serif' font-size='28' font-weight='bold' fill='%23C9A84C' text-anchor='middle'%3EPDF%3C/text%3E%3C/svg%3E",
        sizes: "192x192",
        type: "image/svg+xml",
        purpose: "any maskable"
      },
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%231565C0'/%3E%3Crect x='72' y='96' width='368' height='28' rx='14' fill='%23C9A84C'/%3E%3Crect x='72' y='144' width='368' height='22' rx='11' fill='white' opacity='.9'/%3E%3Crect x='72' y='178' width='368' height='22' rx='11' fill='white' opacity='.7'/%3E%3Crect x='72' y='212' width='240' height='22' rx='11' fill='white' opacity='.7'/%3E%3Crect x='72' y='256' width='368' height='160' rx='16' fill='white' opacity='.15'/%3E%3Ctext x='256' y='356' font-family='serif' font-size='72' font-weight='bold' fill='%23C9A84C' text-anchor='middle'%3EPDF%3C/text%3E%3C/svg%3E",
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "any maskable"
      }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  document.getElementById('pwa-manifest').setAttribute('href', url);
})();

// â”€â”€ PWA : Service Worker inline (offline-first) â”€â”€
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'fiche-peda-v4';
    const EXTERNAL = [
      'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
      'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&display=swap',
      'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css',
      'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js'
    ];

    // PrÃ©-cache au premier chargement (page + ressources externes)
    self.addEventListener('install', e => {
      self.skipWaiting();
      e.waitUntil(
        caches.open(CACHE).then(cache => {
          cache.add(self.location.href).catch(() => {});
          return Promise.allSettled(
            EXTERNAL.map(url =>
              fetch(url, { mode: 'cors' })
                .then(r => r.ok ? cache.put(url, r) : null)
                .catch(() => null)
            )
          );
        })
      );
    });

    // Nettoyage des anciens caches
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(keys =>
          Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        ).then(() => self.clients.claim())
      );
    });

    // StratÃ©gie : Cache-first pour ressources externes, Network-first pour la page
    self.addEventListener('fetch', e => {
      const url = e.request.url;
      const isExternal = EXTERNAL.some(ext => url.startsWith(ext.split('?')[0]));
      const isFont = url.includes('fonts.googleapis.com') || url.includes('fonts.gstatic.com');

      if (isExternal || isFont) {
        // Cache-first : si en cache â†’ sert depuis cache, sinon rÃ©seau puis mise en cache
        e.respondWith(
          caches.open(CACHE).then(cache =>
            cache.match(e.request).then(cached => {
              if (cached) return cached;
              return fetch(e.request).then(response => {
                if (response && response.ok) {
                  cache.put(e.request, response.clone());
                }
                return response;
              }).catch(() => cached || new Response('', { status: 503 }));
            })
          )
        );
      } else {
        // Network-first pour la page principale : rÃ©seau d'abord, cache en fallback
        e.respondWith(
          fetch(e.request)
            .then(response => {
              if (response && response.ok) {
                const clone = response.clone();
                caches.open(CACHE).then(cache => cache.put(e.request, clone));
              }
              return response;
            })
            .catch(() => caches.match(e.request).then(r => r || new Response('Hors ligne', { status: 503 })))
        );
      }
    });
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl)
    .then(reg => {
      // VÃ©rifie pÃ©riodiquement si une mise Ã  jour est disponible
      setInterval(() => reg.update(), 60 * 60 * 1000);
    })
    .catch(() => {});
}
</script>
<style>
  :root {
    --blue: #1565C0;
    --blue-light: #1976D2;
    --blue-dark: #0D47A1;
    --blue-pale: #E3F2FD;
    --gold: #C9A84C;
    --white: #FFFFFF;
    --off-white: #F7F5F0;
    --ink: #1A1A2E;
    --muted: #6B7280;
    --border: #DDD8CE;
    --success: #2E7D32;
    --shadow: 0 4px 24px rgba(21,101,192,0.12);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORCER LE MODE PLEIN Ã‰CRAN - CACHER LA BARRE D'ADRESSE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @media all and (display-mode: fullscreen) {
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
  }
  
  @media all and (display-mode: standalone) {
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Source Serif 4', Georgia, serif;
    background: var(--off-white);
    color: var(--ink);
    min-height: 100vh;
    padding-bottom: 32px; /* Espace pour le footer fixe */
    /* EmpÃªcher le zoom qui fait apparaÃ®tre la barre d'adresse */
    touch-action: pan-x pan-y;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .app-header {
    background: var(--blue);
    padding: 18px 24px 14px;
    display: flex;
    align-items: center;
    gap: 14px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }
  .app-header .logo {
    width: 38px; height: 38px;
    background: var(--gold);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .app-header h1 {
    font-family: 'Playfair Display', serif;
    color: white;
    font-size: 17px;
    font-weight: 700;
    line-height: 1.2;
    flex: 1;
  }
  .app-header h1 span {
    display: block;
    font-size: 11px;
    font-weight: 400;
    color: rgba(255,255,255,0.65);
    font-family: 'Source Serif 4', serif;
    letter-spacing: 0.04em;
    margin-top: 2px;
  }

  /* â”€â”€â”€ TABS â”€â”€â”€ */
  .tabs {
    display: flex;
    background: white;
    border-bottom: 2px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab-btn {
    flex: 1;
    min-width: 90px;
    padding: 12px 8px;
    background: none;
    border: none;
    font-family: 'Source Serif 4', serif;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; gap: 4px;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--blue);
    border-bottom-color: var(--blue);
  }
  .tab-btn .tab-icon { font-size: 18px; }

  /* â”€â”€â”€ CONTENT PANELS â”€â”€â”€ */
  .panel { display: none; padding: 16px; }
  .panel.active { display: block; }

  /* â”€â”€â”€ SECTION CARD â”€â”€â”€ */
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
    overflow: hidden;
  }
  .card-header {
    background: var(--blue);
    padding: 10px 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .card-header h2 {
    font-family: 'Playfair Display', serif;
    color: white;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .card-header .badge {
    background: var(--gold);
    color: white;
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 20px;
    font-family: 'Source Serif 4', serif;
  }
  .card-body { padding: 14px; }

  /* â”€â”€â”€ FORM FIELDS â”€â”€â”€ */
  .field { margin-bottom: 14px; }
  .field:last-child { margin-bottom: 0; }
  .field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .field label .required { color: #E53935; margin-left: 2px; }
  .field input, .field textarea, .field select {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    color: var(--ink);
    background: var(--off-white);
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }
  .field input:focus, .field textarea:focus, .field select:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.1);
    background: white;
  }
  .field textarea {
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }
  .field textarea.tall { min-height: 120px; }
  .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .field-hint {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
    font-style: italic;
  }

  /* â”€â”€â”€ Ã‰TAPES â”€â”€â”€ */
  .etape-card {
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .etape-header {
    background: var(--blue-pale);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }
  .etape-header h3 {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    color: var(--blue-dark);
  }
  .etape-num {
    background: var(--blue);
    color: white;
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .etape-body { padding: 12px; }
  .btn-remove-etape {
    background: none;
    border: 1px solid #FFCDD2;
    color: #C62828;
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    font-family: 'Source Serif 4', serif;
  }
  .btn-move-etape {
    background: none;
    border: 1px solid #BBDEFB;
    color: #1565C0;
    border-radius: 6px;
    padding: 3px 7px;
    font-size: 11px;
    cursor: pointer;
    line-height: 1;
  }
  .btn-move-etape:active { background: #E3F2FD; }
  /* Badge durÃ©e totale */
  #duree-totale-badge {
    display:inline-flex;align-items:center;gap:6px;
    background:linear-gradient(90deg,#1565C0,#1976D2);
    color:#fff;border-radius:20px;padding:5px 14px;
    font-size:13px;font-weight:700;margin-bottom:12px;
    box-shadow:0 2px 8px rgba(21,101,192,0.25);
  }
  .btn-add-etape {
    width: 100%;
    padding: 12px;
    background: white;
    border: 2px dashed var(--blue-light);
    color: var(--blue);
    border-radius: 10px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 16px;
  }
  .btn-add-etape:hover { background: var(--blue-pale); }

  /* â”€â”€â”€ PARAMÃˆTRES â”€â”€â”€ */
  .param-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .param-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .param-item label {
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .param-item input[type="number"],
  .param-item input[type="color"],
  .param-item select {
    padding: 8px 10px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    background: var(--off-white);
  }
  .param-item input[type="color"] {
    height: 40px;
    padding: 4px;
    cursor: pointer;
  }
  .param-section-title {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    color: var(--blue-dark);
    padding: 8px 0 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
    margin-top: 6px;
  }

  /* â”€â”€â”€ BOUTON GÃ‰NÃ‰RER â”€â”€â”€ */
  .btn-generate {
    width: 100%;
    padding: 16px;
    background: var(--blue);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 16px rgba(21,101,192,0.35);
    transition: all 0.2s;
    margin-bottom: 20px;
  }
  .btn-generate:active { transform: scale(0.98); }
  .btn-generate:disabled { opacity: 0.6; cursor: not-allowed; }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 20px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 13px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
    z-index: 999;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€â”€ PREVIEW PANEL â”€â”€â”€ */
  .preview-info {
    background: var(--blue-pale);
    border: 1px solid #BBDEFB;
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 16px;
    font-size: 13px;
    color: var(--blue-dark);
    line-height: 1.6;
  }
  .preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    border: 1.5px solid var(--blue);
  }
  .preview-table th {
    background: var(--blue);
    color: white;
    padding: 6px 4px;
    text-align: center;
    font-family: 'Source Serif 4', serif;
    font-weight: 600;
    border: 1px solid rgba(255,255,255,0.3);
  }
  .preview-table td {
    border: 1px solid var(--border);
    padding: 5px 4px;
    vertical-align: top;
    line-height: 1.4;
  }
  .preview-table tr.etape-sep td {
    border-top: 2px solid var(--blue);
  }
  .etape-label {
    font-weight: 700;
    color: var(--blue-dark);
    font-size: 10px;
  }

  /* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* â”€â”€â”€ EN-TÃŠTE FLEXIBLE â”€â”€â”€ */
  .editable-field-wrap { position: relative; }
  .editable-label {
    display: flex; align-items: center; gap: 5px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    background: transparent;
    border: 1px dashed transparent;
  }
  .editable-label:hover {
    background: #f0f7ff;
    border-color: #1565C0;
  }
  .editable-label .label-edit-hint {
    font-size: 12px; 
    opacity: 0.4; 
    transition: all 0.2s;
    cursor: pointer;
  }
  .editable-field-wrap:hover .label-edit-hint { 
    opacity: 1; 
    color: #1565C0;
    transform: scale(1.1);
  }
  .editable-label.editing-mode .label-edit-hint { display: none; }
  .editable-label::after {
    content: '(double-clic)';
    font-size: 10px;
    color: #1565C0;
    opacity: 0;
    margin-left: 4px;
    font-weight: 400;
    font-style: italic;
    transition: opacity 0.2s ease;
  }
  .editable-label:hover::after {
    opacity: 1;
  }
  .label-edit-input {
    border: 1.5px solid var(--gold);
    border-radius: 5px;
    padding: 2px 7px;
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-family: 'Source Serif 4', serif;
    background: white;
    outline: none;
    min-width: 80px;
    box-shadow: 0 0 0 2px rgba(201,168,76,0.2);
  }
  .fgrp-title {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px dashed var(--border);
  }
  .fixed-row-group { margin-bottom: 18px; }
  .fixed-row-group:last-child { margin-bottom: 0; }

  /* Lignes libres */
  .ligne-libre-card {
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
    background: white;
  }
  .ligne-libre-header {
    background: var(--blue-pale);
    padding: 7px 12px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }
  .ligne-libre-header .ll-title {
    font-size: 12px; font-weight: 600; color: var(--blue-dark);
    font-family: 'Playfair Display', serif;
  }
  .ll-actions { display: flex; gap: 6px; align-items: center; }
  .btn-ll-move {
    background: none; border: 1px solid var(--border); color: var(--muted);
    border-radius: 5px; padding: 2px 7px; font-size: 12px; cursor: pointer;
    line-height: 1;
  }
  .btn-ll-move:hover { background: var(--blue-pale); color: var(--blue); }
  .btn-ll-del {
    background: none; border: 1px solid #FFCDD2; color: #C62828;
    border-radius: 5px; padding: 2px 8px; font-size: 11px; cursor: pointer;
  }
  .ligne-libre-body { padding: 12px; }
  .ll-double { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* Live preview de l'en-tÃªte */
  .live-preview-table {
    width: 100%; border-collapse: collapse;
    font-size: 11px; border: 2px solid var(--blue);
    border-radius: 4px; overflow: hidden;
  }
  .live-preview-row { display: flex; }
  .lp-cell-label {
    background: var(--blue); color: white;
    padding: 5px 8px;
    font-weight: 700; font-size: 10px;
    white-space: nowrap; min-width: 70px;
    display: flex; align-items: center;
  }
  .lp-cell-value {
    background: white; color: var(--ink);
    padding: 5px 8px; flex: 1;
    font-size: 10px; border-bottom: 1px solid var(--border);
    border-left: 1.5px solid var(--blue);
    min-height: 24px; word-break: break-word;
  }
  .lp-cell-value.empty { color: var(--muted); font-style: italic; }
  .lp-row-outer { border-bottom: 1px solid var(--blue); display: flex; }
  .lp-row-outer:last-child { border-bottom: none; }
  .lp-half { flex: 1; display: flex; }
  .lp-half + .lp-half { border-left: 1.5px solid var(--blue); }
  .lp-title-row {
    background: var(--blue); color: white;
    padding: 6px 10px; font-weight: 700; font-size: 11px;
    display: flex; justify-content: space-between;
    border-bottom: 2px solid var(--gold);
  }
  .lp-objectif-label {
    background: var(--blue); color: white;
    padding: 6px 8px; font-weight: 700; font-size: 10px;
    min-width: 70px; display: flex; align-items: flex-start;
  }
  .lp-objectif-value {
    background: white; padding: 6px 8px; flex: 1;
    font-size: 10px; min-height: 36px; word-break: break-word;
    border-left: 1.5px solid var(--blue); color: var(--ink);
  }
  .lp-objectif-value.empty { color: var(--muted); font-style: italic; }

  /* â”€â”€â”€ BANNIÃˆRE HORS LIGNE â”€â”€â”€ */
  #offline-banner {
    display: none;
    background: #E65100;
    color: white;
    text-align: center;
    padding: 7px 16px;
    font-size: 12px;
    font-family: 'Source Serif 4', serif;
    letter-spacing: 0.03em;
    position: sticky;
    top: 72px;
    z-index: 99;
  }
  #offline-banner.show { display: block; }
  #offline-banner.online-restored { background: #2E7D32; }

  /* â”€â”€â”€ THÃˆMES â”€â”€â”€ */
  .theme-swatch {
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2.5px solid transparent;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .theme-swatch:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.18); }
  .theme-swatch.active { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.3); }
  .theme-swatch-bar { height: 22px; display:flex; align-items:center; padding: 0 7px; gap:5px; }
  .theme-swatch-dot { width:7px; height:7px; border-radius:50%; background:rgba(255,255,255,0.6); flex-shrink:0; }
  .theme-swatch-body { background:white; padding:5px 7px; display:flex; flex-direction:column; gap:3px; }
  .theme-swatch-line { height:5px; border-radius:2px; }
  .theme-swatch-row { display:flex; gap:4px; }
  .theme-swatch-name { font-size:10px; font-weight:700; color:var(--ink); text-align:center; padding:4px 2px 2px; background:white; }

  /* â”€â”€â”€ BOUTONS DE FORMATAGE (B et I) â”€â”€â”€ */
  .format-btn {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    min-width: 32px;
    height: 28px;
    transition: all 0.2s;
  }
  .format-btn:hover {
    background: var(--blue-pale);
    border-color: var(--blue);
  }
  .format-btn:active {
    background: var(--blue);
    color: white;
  }
  
  /* â”€â”€â”€ SÃ‰LECTEURS DE COULEUR COMPACTS - STYLE UNIFORME â”€â”€â”€ */
  .color-picker-btn {
    width: 32px !important;
    height: 28px !important;
    border: 1.5px solid var(--border) !important;
    border-radius: 5px !important;
    cursor: pointer !important;
    padding: 0 !important;
    background: white !important;
    vertical-align: middle !important;
    display: inline-block !important;
  }
  .color-picker-btn:hover {
    border-color: var(--blue) !important;
    box-shadow: 0 0 0 2px var(--blue-pale) !important;
  }
  /* Masquer le wrapper interne pour un affichage compact */
  .color-picker-btn::-webkit-color-swatch-wrapper {
    padding: 2px !important;
  }
  .color-picker-btn::-webkit-color-swatch {
    border: none !important;
    border-radius: 3px !important;
  }
  .color-picker-btn::-moz-color-swatch {
    border: none !important;
    border-radius: 3px !important;
  }


  /* â”€â”€â”€ CHAMPS Ã‰DITABLES (contenteditable) â”€â”€â”€ */
  .editable-input {
    background: white;
    border: 1.5px dashed var(--border);
    border-radius: 8px;
    padding: 10px 40px 10px 12px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    line-height: 1.6;
    min-height: 42px;
    outline: none;
    transition: all 0.2s ease;
    cursor: text;
    position: relative;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px 16px;
  }
  .editable-input:hover {
    border-color: var(--blue);
    background-color: #f8fbff;
    border-style: solid;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%231565C0" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>');
  }
  .editable-input:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
    border-style: solid;
    background-image: none;
    padding-right: 12px;
  }
  .editable-input:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
  }
  
  /* Indicateur "Cliquez pour Ã©diter" au hover */
  .editable-input::after {
    content: 'âœï¸ Cliquez pour Ã©diter';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    color: #1565C0;
    background: white;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #1565C0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    white-space: nowrap;
    font-weight: 600;
  }
  .editable-input:hover::after {
    opacity: 1;
  }
  .editable-input:focus::after {
    display: none;
  }

  /* â”€â”€â”€ STYLES QUILL.JS POUR TEXTE RICHE â”€â”€â”€ */

  /* Polices dans l'Ã©diteur Quill */
  .ql-font-times      { font-family: 'Times New Roman', Times, serif; }
  .ql-font-georgia    { font-family: Georgia, 'Times New Roman', serif; }
  .ql-font-merriweather { font-family: 'Merriweather', Georgia, serif; }
  .ql-font-roboto     { font-family: 'Roboto', Arial, sans-serif; }
  .ql-font-lato       { font-family: 'Lato', Arial, sans-serif; }
  .ql-font-opensans   { font-family: 'Open Sans', Arial, sans-serif; }
  .ql-font-courier    { font-family: 'Courier New', Courier, monospace; }
  /* Affichage des options dans le select */
  .ql-picker.ql-font .ql-picker-label::before,
  .ql-picker.ql-font .ql-picker-item::before { content: 'Sans-sÃ©rif'; }
  .ql-picker.ql-font .ql-picker-label[data-value=times]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=times]::before { content: 'Times Roman'; font-family:'Times New Roman',serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=georgia]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=georgia]::before { content: 'Georgia'; font-family:Georgia,serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=merriweather]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=merriweather]::before { content: 'Merriweather'; font-family:'Merriweather',serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=roboto]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=roboto]::before { content: 'Roboto'; font-family:'Roboto',sans-serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=lato]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=lato]::before { content: 'Lato'; font-family:'Lato',sans-serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=opensans]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=opensans]::before { content: 'Open Sans'; font-family:'Open Sans',sans-serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=courier]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=courier]::before { content: 'Courier'; font-family:'Courier New',monospace; }
  .quill-wrapper {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--off-white);
    overflow: hidden;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .quill-wrapper:focus-within {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.1);
    background: white;
  }
  /* Toolbar custom (pre-rendue) */
  .quill-wrapper .ql-custom-toolbar-wrap {
    background: #f8f9fa;
    border-bottom: 1px solid var(--border);
    padding: 4px 6px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 2px;
  }
  /* Quill injecte .ql-toolbar sur notre div toolbar, conserver le style */
  .quill-wrapper .ql-toolbar {
    background: #f8f9fa;
    border: none;
    border-bottom: 1px solid var(--border);
    padding: 4px 6px;
  }
  .quill-wrapper .ql-container {
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    border: none;
  }
  .quill-wrapper .ql-editor {
    min-height: 80px;
    padding: 10px 12px;
    line-height: 1.6;
  }
  .quill-wrapper .ql-editor.ql-blank::before {
    color: #999;
    font-style: italic;
  }
  /* Ajustement pour les textarea larges avec Quill */
  .quill-wrapper.tall .ql-editor {
    min-height: 120px;
  }

  /* â”€â”€â”€ TABLEAU DANS L'Ã‰DITEUR QUILL â”€â”€â”€ */
  .ql-editor table {
    border-collapse: collapse;
    width: 100%;
    margin: 8px 0;
    font-size: 13px;
  }
  .ql-editor table td, .ql-editor table th {
    border: 1.5px solid #1565C0;
    padding: 5px 8px;
    min-width: 40px;
    min-height: 22px;
    vertical-align: top;
    word-break: break-word;
  }
  .ql-editor table th {
    background: #E3F2FD;
    font-weight: 700;
    text-align: center;
  }
  .ql-editor img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    border: 1.5px solid var(--border);
    margin: 4px 0;
    display: block;
  }

  /* â”€â”€â”€ BOUTONS PERSONNALISÃ‰S DANS LA TOOLBAR QUILL â”€â”€â”€ */
  .ql-toolbar .ql-custom-table,
  .ql-toolbar .ql-custom-image,
  .ql-toolbar .ql-custom-symbol,
  .ql-toolbar .ql-custom-size {
    background: none;
    border: 1px solid var(--border) !important;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 5px;
    font-size: 16px;
    line-height: 1;
    color: #444;
    transition: background 0.15s, border-color 0.15s;
    min-width: 32px;
    min-height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 2px;
    vertical-align: middle;
  }
  .ql-toolbar .ql-custom-table:hover,
  .ql-toolbar .ql-custom-image:hover,
  .ql-toolbar .ql-custom-symbol:hover,
  .ql-toolbar .ql-custom-size:hover,
  .ql-toolbar .ql-custom-table:active,
  .ql-toolbar .ql-custom-image:active,
  .ql-toolbar .ql-custom-symbol:active,
  .ql-toolbar .ql-custom-size:active {
    background: #e8f0fe !important;
    border-color: var(--blue) !important;
    color: var(--blue);
  }
  .ql-toolbar .ql-custom-symbol.active {
    background: var(--blue-pale) !important;
    border-color: var(--blue) !important;
    color: var(--blue);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NOUVEAUX STYLES : SÃ©lecteurs de couleur amÃ©liorÃ©s pour Quill
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  
  /* Masquer les anciens sÃ©lecteurs Quill (on utilise input color maintenant) */
  .ql-toolbar .ql-color,
  .ql-toolbar .ql-background {
    display: none !important;
  }

  /* Style pour les nouveaux sÃ©lecteurs de couleur type="color" */
  .ql-toolbar .color-picker-btn,
  .ql-custom-toolbar-wrap .color-picker-btn {
    width: 32px !important;
    height: 28px !important;
    border: 1.5px solid #ddd !important;
    border-radius: 5px !important;
    cursor: pointer !important;
    padding: 0 !important;
    margin: 0 2px !important;
    transition: all 0.15s ease !important;
    vertical-align: middle !important;
    background: white !important;
  }

  .ql-toolbar .color-picker-btn:hover,
  .ql-custom-toolbar-wrap .color-picker-btn:hover {
    border-color: var(--blue) !important;
    box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.1) !important;
  }

  /* Masquer le wrapper et le swatch par dÃ©faut pour un rendu plus propre */
  .ql-toolbar .color-picker-btn::-webkit-color-swatch-wrapper,
  .ql-custom-toolbar-wrap .color-picker-btn::-webkit-color-swatch-wrapper {
    padding: 2px !important;
  }

  .ql-toolbar .color-picker-btn::-webkit-color-swatch,
  .ql-custom-toolbar-wrap .color-picker-btn::-webkit-color-swatch {
    border: none !important;
    border-radius: 3px !important;
  }

  .ql-toolbar .color-picker-btn::-moz-color-swatch,
  .ql-custom-toolbar-wrap .color-picker-btn::-moz-color-swatch {
    border: none !important;
    border-radius: 3px !important;
  }

  /* AmÃ©lioration globale de la toolbar Quill */
  .quill-wrapper .ql-toolbar,
  .quill-wrapper .ql-custom-toolbar-wrap {
    background: #f8f9fa;
    border: none;
    border-bottom: 1.5px solid var(--border);
    padding: 6px 8px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 2px;
  }

  /* Espacement cohÃ©rent entre les groupes de formats */
  .ql-toolbar .ql-formats {
    margin-right: 8px !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 2px !important;
  }

  /* AmÃ©liorer tous les boutons standards de Quill */
  .ql-toolbar button {
    background: white !important;
    border: 1.5px solid #ddd !important;
    border-radius: 5px !important;
    padding: 4px 8px !important;
    transition: all 0.15s ease !important;
    min-width: 32px !important;
    min-height: 28px !important;
  }

  .ql-toolbar button:hover {
    background: #e8f0fe !important;
    border-color: var(--blue) !important;
  }

  .ql-toolbar button.ql-active {
    background: var(--blue-pale) !important;
    border-color: var(--blue) !important;
  }

  .ql-toolbar button svg .ql-stroke {
    stroke: #444 !important;
  }

  .ql-toolbar button:hover svg .ql-stroke,
  .ql-toolbar button.ql-active svg .ql-stroke {
    stroke: var(--blue) !important;
  }

  .ql-toolbar button svg .ql-fill {
    fill: #444 !important;
  }

  .ql-toolbar button:hover svg .ql-fill,
  .ql-toolbar button.ql-active svg .ql-fill {
    fill: var(--blue) !important;
  }

  /* AmÃ©liorer les select de Quill */
  .ql-toolbar select {
    background: white !important;
    border: 1.5px solid #ddd !important;
    border-radius: 5px !important;
    padding: 4px 24px 4px 8px !important;
    font-size: 12px !important;
    height: 28px !important;
    color: #444 !important;
    transition: all 0.15s ease !important;
  }

  .ql-toolbar select:hover {
    border-color: var(--blue) !important;
    background: #f8f9fa !important;
  }

  .ql-toolbar select:focus {
    outline: none !important;
    border-color: var(--blue) !important;
    box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.1) !important;
  }

  /* Responsive: ajustement pour mobile */
  @media (max-width: 600px) {
    .ql-toolbar .ql-formats {
      margin-right: 4px !important;
    }
    
    .ql-toolbar .color-picker-btn,
    .ql-custom-toolbar-wrap .color-picker-btn {
      width: 28px !important;
      height: 26px !important;
    }
  }


  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOUTON FLOTTANT D'APERÃ‡U (remplace le panneau de symboles)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .floating-preview-btn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    z-index: 9000;
    background: linear-gradient(135deg, #1565C0, #1976D2);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 700;
    font-family: 'Source Serif 4', serif;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(21, 101, 192, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .floating-preview-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 28px rgba(21, 101, 192, 0.5);
    background: linear-gradient(135deg, #1976D2, #2196F3);
  }
  .floating-preview-btn:active {
    transform: translateY(-1px);
    box-shadow: 0 3px 15px rgba(21, 101, 192, 0.4);
  }
  
  /* Animation d'entrÃ©e */
  @keyframes slideInRight {
    from {
      transform: translateX(100px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  .floating-preview-btn {
    animation: slideInRight 0.5s ease-out;
  }
  
  /* Responsive */
  @media (max-width: 600px) {
    .floating-preview-btn {
      bottom: 70px;
      right: 15px;
      padding: 12px 20px;
      font-size: 14px;
    }
  }

  /* â”€â”€â”€ MODAL INSERTION TABLEAU â”€â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 9000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal-box {
    background: white;
    border-radius: 14px;
    box-shadow: 0 8px 40px rgba(21,101,192,0.22);
    padding: 24px 22px 18px;
    width: 300px;
    max-width: 95vw;
    font-family: 'Source Serif 4', serif;
  }
  .modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--blue-dark);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .modal-field {
    margin-bottom: 12px;
  }
  .modal-field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 5px;
  }
  .modal-field input[type="number"] {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    background: var(--off-white);
  }
  .modal-field input[type="number"]:focus {
    outline: none;
    border-color: var(--blue);
    background: white;
  }
  .modal-check {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--ink);
    margin-bottom: 14px;
    cursor: pointer;
  }
  .modal-check input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--blue); }
  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }
  .btn-modal-ok {
    flex: 1;
    padding: 10px;
    background: var(--blue);
    color: white;
    border: none;
    border-radius: 8px;
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-modal-ok:hover { background: var(--blue-dark); }
  .btn-modal-cancel {
    flex: 1;
    padding: 10px;
    background: var(--off-white);
    color: var(--muted);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    cursor: pointer;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AMÃ‰LIORATIONS VISUELLES - CODES COULEURS THÃ‰MATIQUES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  
  /* Couleurs pour sections PDF */
  :root {
    --color-mise-situation: #E8F5E9;  /* Vert clair */
    --color-identification: #E3F2FD;  /* Bleu clair */
    --color-axes: #FFF3E0;            /* Orange clair */
    --color-synthese: #F3E5F5;        /* Violet clair */
  }

  /* IcÃ´nes pÃ©dagogiques */
  .icone-lecture::before { content: 'ğŸ“– '; }
  .icone-reflexion::before { content: 'ğŸ’­ '; }
  .icone-ecriture::before { content: 'âœï¸ '; }
  .icone-groupe::before { content: 'ğŸ‘¥ '; }
  .icone-duree::before { content: 'â±ï¸ '; }

  /* Alternance de couleurs pour lignes de tableau */
  .tableau-alterne tr:nth-child(even) {
    background-color: rgba(21, 101, 192, 0.03);
  }
  .tableau-alterne tr:nth-child(odd) {
    background-color: white;
  }

  /* Bordures arrondies et ombres */
  .carte-section {
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 16px;
    overflow: hidden;
  }

  /* Typographie amÃ©liorÃ©e */
  .titre-section-principal {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--blue);
  }
  .titre-section-secondaire {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--ink);
  }
  .mot-cle {
    font-weight: 700;
    color: var(--blue);
  }

  /* En-tÃªte visuel personnalisable */
  .entete-personnalise {
    background: linear-gradient(135deg, var(--blue) 0%, var(--blue-dark) 100%);
    padding: 20px;
    border-radius: 12px 12px 0 0;
    color: white;
    text-align: center;
    margin-bottom: 20px;
  }
  .logo-etablissement {
    max-width: 80px;
    max-height: 80px;
    margin-bottom: 10px;
    border-radius: 8px;
  }

  /* Boutons export multiples */
  .btn-export-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  .btn-export {
    flex: 1;
    min-width: 150px;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-export-pdf {
    background: #D32F2F;
    color: white;
    box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
  }
  .btn-export-pdf:hover {
    background: #B71C1C;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
  }
  .btn-export-docx {
    background: #1976D2;
    color: white;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
  }
  .btn-export-docx:hover {
    background: #1565C0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
  }
  .btn-export-save {
    background: #2E7D32;
    color: white;
    box-shadow: 0 2px 8px rgba(46,125,50,0.3);
  }
  .btn-export-save:hover {
    background: #1B5E20;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(46,125,50,0.4);
  }
  /* RÃ©pertoire des fiches */
  .repertoire-card {
    background: #fff;
    border: 1.5px solid #E3EAF6;
    border-radius: 12px;
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .repertoire-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: #F5F8FF;
    border-bottom: 1px solid #E3EAF6;
  }
  .repertoire-card-title {
    font-weight: 700;
    color: #1565C0;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 55%;
  }
  .repertoire-card-date {
    font-size: 11px;
    color: #999;
  }
  .repertoire-card-body {
    padding: 8px 14px 10px;
    font-size: 12px;
    color: #555;
    line-height: 1.5;
  }
  .repertoire-card-actions {
    display: flex;
    gap: 6px;
    padding: 0 14px 10px;
    flex-wrap: wrap;
  }
  .btn-rep {
    border: none;
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-rep-ouvrir  { background: #1565C0; color: #fff; }
  .btn-rep-suppr   { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
  .repertoire-empty {
    text-align: center;
    padding: 40px 20px;
    color: #aaa;
    font-size: 14px;
  }


  /* PrÃ©visualisation temps rÃ©el */
  .preview-live {
    background: white;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }
  .preview-live-header {
    background: linear-gradient(135deg, var(--blue) 0%, var(--blue-dark) 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
  }
  .preview-section {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--blue);
  }
  .preview-section.mise-situation {
    background: var(--color-mise-situation);
    border-left-color: #4CAF50;
  }
  .preview-section.identification {
    background: var(--color-identification);
    border-left-color: #2196F3;
  }
  .preview-section.axes {
    background: var(--color-axes);
    border-left-color: #FF9800;
  }
  .preview-section.synthese {
    background: var(--color-synthese);
    border-left-color: #9C27B0;
  }


  /* â”€â”€â”€ MODÃˆLES DE FICHES â”€â”€â”€ */
  .modele-tag {
    display: inline-block; font-size: 10px; font-weight: 600;
    padding: 2px 8px; border-radius: 10px; margin-right: 4px; margin-bottom: 3px;
  }
  .modele-tag-matiere { background: #E3F2FD; color: #1565C0; }
  .modele-tag-niveau  { background: #E8F5E9; color: #2E7D32; }
  .modele-tag-duree   { background: #FFF3E0; color: #E65100; }
  .modele-card {
    background: white; border: 1.5px solid #E3EAF6; border-radius: 14px;
    margin-bottom: 14px; overflow: hidden;
    box-shadow: 0 2px 10px rgba(21,101,192,0.08);
    transition: box-shadow 0.2s, transform 0.2s;
  }
  .modele-card:hover { box-shadow: 0 6px 22px rgba(21,101,192,0.18); transform: translateY(-2px); }
  .modele-card-header {
    background: linear-gradient(90deg, #1565C0, #1976D2);
    padding: 12px 16px; display: flex; align-items: center; gap: 10px;
  }
  .modele-card-icon {
    font-size: 24px; width: 44px; height: 44px;
    background: rgba(255,255,255,0.15); border-radius: 10px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .modele-card-title { font-family: 'Playfair Display',serif; color: white; font-size: 14px; font-weight: 700; line-height: 1.3; flex: 1; }
  .modele-card-subtitle { color: rgba(255,255,255,0.8); font-size: 11px; margin-top: 2px; }
  .modele-card-body { padding: 12px 14px 8px; }
  .modele-desc { font-size: 12px; color: #555; line-height: 1.55; margin-bottom: 10px; }
  .modele-etapes-preview { background: #F5F8FF; border-radius: 8px; padding: 8px 10px; margin-bottom: 10px; border: 1px solid #E3EAF6; }
  .modele-etape-row { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 11px; color: #444; border-bottom: 1px dashed #E3EAF6; }
  .modele-etape-row:last-child { border-bottom: none; }
  .modele-etape-num { background: #1565C0; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; }
  .modele-etape-name { font-weight: 600; color: #1565C0; min-width: 80px; flex-shrink: 0; }
  .modele-etape-desc { flex: 1; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .modele-etape-duree { color: #E65100; font-weight: 600; flex-shrink: 0; }
  .modele-card-actions { display: flex; gap: 8px; padding: 0 14px 12px; }
  .btn-modele-charger {
    flex: 1; background: #1565C0; color: white; border: none; border-radius: 8px;
    padding: 9px 16px; font-family: 'Source Serif 4',serif; font-size: 12px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s;
  }
  .btn-modele-charger:hover { background: #0D47A1; }
  .btn-modele-sauver {
    background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9;
    border-radius: 8px; padding: 9px 14px; font-family: 'Source Serif 4',serif;
    font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: background 0.2s;
  }
  .btn-modele-sauver:hover { background: #C8E6C9; }
  .modeles-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
  .modele-filter-btn {
    padding: 5px 14px; border-radius: 20px; border: 1.5px solid var(--border);
    background: white; font-size: 12px; font-family: 'Source Serif 4',serif;
    cursor: pointer; transition: all 0.18s; color: var(--muted);
  }
  .modele-filter-btn.active, .modele-filter-btn:hover { background: #1565C0; color: white; border-color: #1565C0; }

  /* Ajustement marges */
  .marge-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }
  .marge-control {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .marge-control label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
  }
  .marge-control input {
    padding: 8px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-size: 13px;
  }

  /* â”€â”€ Footer permanent avec version â”€â”€ */
  .app-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    border-top: 1px solid rgba(21, 101, 192, 0.15);
    padding: 4px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 10px;
    color: #888;
    z-index: 999;
    backdrop-filter: blur(10px);
  }
  .app-footer a {
    color: #1565C0;
    text-decoration: none;
    font-weight: 600;
  }
  .app-footer a:hover {
    text-decoration: underline;
  }
  .version-badge {
    background: rgba(21, 101, 192, 0.1);
    color: #1565C0;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.03em;
  }



  /* â”€â”€â”€ REDIMENSIONNEMENT D'IMAGE â”€â”€â”€ */
  .ql-editor img { cursor: pointer; transition: outline 0.15s; }
  .ql-editor img.img-selected { outline: 2px solid var(--blue); outline-offset: 2px; }
  #img-resize-panel {
    display: none; position: fixed; z-index: 9999;
    background: white; border: 1.5px solid var(--blue);
    border-radius: 10px; box-shadow: 0 6px 24px rgba(21,101,192,0.20);
    padding: 12px 16px; min-width: 250px;
    font-family: 'Source Serif 4', serif; font-size: 12px;
  }
  #img-resize-panel.show { display: block; }
  #img-resize-panel .rp-head {
    font-weight: 700; color: var(--blue-dark); font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.05em;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
  }
  #img-resize-panel .rp-dims { font-weight: 400; color: var(--muted); font-size: 10px; }
  #img-resize-panel .rp-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  #img-resize-panel .rp-lbl { color: var(--muted); font-size: 11px; min-width: 56px; }
  #img-resize-panel input[type="range"] { flex: 1; accent-color: var(--blue); height: 4px; }
  #img-resize-panel input[type="number"] {
    width: 60px; padding: 3px 6px; border: 1.5px solid var(--border);
    border-radius: 5px; font-size: 12px; font-family: inherit; text-align: center;
    color: var(--ink);
  }
  #img-resize-panel .rp-unit { font-size: 10px; color: var(--muted); }
  #img-resize-panel .rp-presets { display: flex; gap: 5px; margin: 4px 0 10px; }
  #img-resize-panel .rp-pre {
    flex: 1; padding: 4px 0; background: var(--blue-pale); border: 1px solid var(--border);
    border-radius: 5px; font-size: 11px; cursor: pointer; text-align: center;
    color: var(--blue-dark); transition: all 0.15s; font-family: inherit;
  }
  #img-resize-panel .rp-pre:hover, #img-resize-panel .rp-pre.active {
    background: var(--blue); color: white; border-color: var(--blue);
  }
  #img-resize-panel .rp-info { font-size: 10px; color: var(--muted); margin-bottom: 10px; }
  #img-resize-panel .rp-btns { display: flex; gap: 8px; }
  #img-resize-panel .rp-btn {
    flex: 1; padding: 6px 0; border: none; border-radius: 6px;
    font-size: 12px; cursor: pointer; font-family: inherit; font-weight: 600;
    transition: opacity 0.15s;
  }
  #img-resize-panel .rp-ok { background: var(--blue); color: white; }
  #img-resize-panel .rp-cancel { background: var(--off-white); color: var(--muted); border: 1px solid var(--border); font-weight: 400; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NOUVELLES FONCTIONNALITÃ‰S v3.0
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* â”€â”€â”€ LAYOUT TABLETTE (â‰¥768px) â”€â”€â”€ */
  @media (min-width: 768px) {
    body { display: flex; flex-direction: column; }
    
    .app-header h1 { font-size: 20px; }
    .app-header h1 span { font-size: 13px; }
    
    /* Navigation latÃ©rale au lieu des onglets horizontaux */
    .tabs {
      position: fixed;
      left: 0; top: 72px; bottom: 28px;
      width: 130px;
      flex-direction: column;
      border-right: 2px solid var(--border);
      border-bottom: none;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 50;
      box-shadow: 2px 0 12px rgba(0,0,0,0.08);
    }
    .tab-btn {
      min-width: unset;
      width: 100%;
      padding: 14px 8px;
      border-bottom: none;
      border-right: 3px solid transparent;
      border-left: none;
      margin-bottom: 0;
      margin-right: -2px;
      flex-direction: column;
      font-size: 11px;
      border-top: 1px solid var(--border);
    }
    .tab-btn.active {
      border-right-color: var(--blue);
      border-bottom: none;
      background: var(--blue-pale);
    }
    .tab-btn .tab-icon { font-size: 22px; }
    
    /* Contenu principal dÃ©calÃ© Ã  droite de la nav */
    .panel {
      margin-left: 130px;
      padding: 20px 24px;
    }
    #offline-banner {
      margin-left: 130px;
      top: 72px;
    }
    #save-bar { margin-left: 130px; }
    
    /* Layout 2 colonnes pour En-tÃªte + AperÃ§u live cÃ´te Ã  cÃ´te */
    #panel-entete.active {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      align-items: start;
    }
    #card-entete-preview {
      position: sticky;
      top: 90px;
      grid-row: 1 / 20;
      grid-column: 2;
    }
    
    /* AperÃ§u PDF en 2 colonnes */
    #panel-apercu.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: start;
    }
    
    .app-footer { padding-left: 142px; }
    
    /* Boutons plus grands sur tablette */
    .btn-generate { font-size: 16px; padding: 14px; }
  }

  @media (min-width: 1024px) {
    .tabs { width: 160px; }
    .panel { margin-left: 160px; padding: 24px 32px; }
    #offline-banner, #save-bar { margin-left: 160px; }
    #card-entete-preview { position: sticky; top: 90px; }
    .app-footer { padding-left: 172px; }
    #panel-apercu.active { grid-template-columns: 1fr 1fr; }
  }

  /* â”€â”€â”€ MODAL GÃ‰NÃ‰RIQUE v3 â”€â”€â”€ */
  .modal-v3-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    padding: 16px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-v3-overlay.show { opacity: 1; pointer-events: all; }
  .modal-v3-box {
    background: white;
    border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    padding: 24px;
    max-width: 520px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    transform: translateY(20px);
    transition: transform 0.25s;
  }
  .modal-v3-overlay.show .modal-v3-box { transform: translateY(0); }
  .modal-v3-title {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--blue-dark);
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 10px;
  }
  .modal-v3-actions {
    display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;
  }
  .btn-v3 {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn-v3-primary { background: var(--blue); color: white; }
  .btn-v3-primary:hover { background: var(--blue-dark); }
  .btn-v3-success { background: #2E7D32; color: white; }
  .btn-v3-success:hover { background: #1B5E20; }
  .btn-v3-warn { background: #E65100; color: white; }
  .btn-v3-warn:hover { background: #BF360C; }
  .btn-v3-ghost { background: var(--off-white); color: var(--muted); border: 1px solid var(--border); }
  .btn-v3-ghost:hover { background: var(--border); }

  /* â”€â”€â”€ EXPORT/IMPORT SECTION â”€â”€â”€ */
  .export-section {
    background: white;
    border-radius: 14px;
    border: 1.5px solid #E3EAF6;
    margin-bottom: 16px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(21,101,192,0.08);
  }
  .export-section-header {
    background: linear-gradient(90deg, #1565C0, #1976D2);
    padding: 12px 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .export-section-header span { color: white; font-weight: 700; font-size: 14px; }
  .export-section-body { padding: 16px; }
  .export-btn-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 12px;
  }
  @media (max-width: 400px) { .export-btn-grid { grid-template-columns: 1fr; } }

  /* â”€â”€â”€ QR CODE â”€â”€â”€ */
  .qr-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #F5F8FF;
    border-radius: 12px;
    border: 1px solid #E3EAF6;
  }
  #qr-canvas {
    border: 4px solid white;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  }
  .qr-info {
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    line-height: 1.5;
  }
  .qr-url-box {
    width: 100%;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 11px;
    color: var(--muted);
    word-break: break-all;
    max-height: 80px;
    overflow-y: auto;
    font-family: monospace;
  }

  /* â”€â”€â”€ APERÃ‡U PDF SIMULÃ‰ â”€â”€â”€ */
  .pdf-preview-container {
    background: #888;
    border-radius: 12px;
    padding: 16px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  .pdf-page-sim {
    background: white;
    width: 100%;
    max-width: 595px;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    padding: 28px 24px;
    font-family: 'Times New Roman', Times, serif;
    font-size: 11px;
    line-height: 1.4;
    min-height: 300px;
  }
  .pdf-sim-header {
    border: 2px solid var(--sim-color, #1565C0);
    margin-bottom: 8px;
    border-radius: 2px;
  }
  .pdf-sim-header-row {
    display: flex;
    border-bottom: 1px solid var(--sim-color, #1565C0);
  }
  .pdf-sim-header-row:last-child { border-bottom: none; }
  .pdf-sim-label {
    background: var(--sim-color, #1565C0);
    color: white;
    padding: 4px 8px;
    font-size: 9px;
    font-weight: 700;
    min-width: 80px;
    display: flex;
    align-items: center;
    white-space: nowrap;
  }
  .pdf-sim-value {
    padding: 4px 8px;
    font-size: 9px;
    flex: 1;
    border-left: 1px solid var(--sim-color, #1565C0);
    word-break: break-word;
  }
  .pdf-sim-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--sim-color, #1565C0);
    font-size: 9px;
    margin-top: 8px;
  }
  .pdf-sim-table th {
    background: var(--sim-color, #1565C0);
    color: white;
    padding: 5px 4px;
    text-align: center;
    font-size: 8px;
    border: 1px solid rgba(255,255,255,0.3);
  }
  .pdf-sim-table td {
    border: 1px solid #ddd;
    padding: 4px 5px;
    vertical-align: top;
    font-size: 8px;
    line-height: 1.3;
  }
  .pdf-sim-etape {
    font-weight: 700;
    color: var(--sim-color, #1565C0);
    text-align: center;
  }
  .pdf-sim-toolbar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 8px;
  }
  .pdf-sim-info {
    font-size: 11px;
    color: #ddd;
    text-align: center;
    margin-top: 4px;
  }
  .pdf-preview-update-btn {
    background: var(--blue);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 12px;
    font-family: 'Source Serif 4', serif;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
  }
  .pdf-preview-update-btn:hover { background: var(--blue-dark); }

  /* â”€â”€â”€ BARRE D'OUTILS TABLETTE â”€â”€â”€ */
  .tablet-toolbar {
    display: none;
  }
  @media (min-width: 768px) {
    .tablet-toolbar {
      display: flex;
      gap: 8px;
      padding: 8px 16px 8px 146px;
      background: white;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      align-items: center;
      position: sticky;
      top: 72px;
      z-index: 49;
    }
    .tablet-toolbar-label {
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .offline-banner-tablet { top: 108px !important; }
    #offline-banner { top: 108px; }
    #save-bar { top: 108px; position: sticky; z-index: 48; }
    .panel { padding-top: 16px; }
  }

  /* â”€â”€â”€ BACKUP WARNING CARD â”€â”€â”€ */
  .backup-warn {
    background: #FFF3E0;
    border: 1px solid #FFB74D;
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 12px;
    color: #E65100;
    line-height: 1.6;
    margin-bottom: 12px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  .backup-warn-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }

  /* â”€â”€â”€ PARTAGE â”€â”€â”€ */
  .share-method-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
  }
  .share-method-tab {
    flex: 1;
    padding: 8px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--off-white);
    font-family: 'Source Serif 4', serif;
    font-size: 12px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    color: var(--muted);
  }
  .share-method-tab.active {
    background: var(--blue);
    color: white;
    border-color: var(--blue);
  }
  .share-panel { display: none; }
  .share-panel.active { display: block; }

</style>
</head>
<body>

<div class="app-header">
  <div class="logo">ğŸ“‹</div>
  <h1>Fiche PÃ©dagogique
    <span>EZ-ZAKY AZIZ â€” v3.0 Â· PDF Â· Tablette Â· Partage</span>
  </h1>
  <button onclick="nouvelleFiche()" title="Effacer et recommencer une nouvelle fiche" style="background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.5);color:#fff;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap;">
    ğŸ”„ Nouvelle fiche
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TABS DE NAVIGATION                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" onclick="showTab('entete')" id="tab-entete">
    <span class="tab-icon">ğŸ“</span>En-tÃªte
  </button>
  <button class="tab-btn" onclick="showTab('etapes')" id="tab-etapes">
    <span class="tab-icon">ğŸ“š</span>Ã‰tapes
  </button>
  <button class="tab-btn" onclick="showTab('params')" id="tab-params">
    <span class="tab-icon">âš™ï¸</span>ParamÃ¨tres
  </button>
  <button class="tab-btn" onclick="showTab('apercu')" id="tab-apercu">
    <span class="tab-icon">ğŸ‘ï¸</span>AperÃ§u
  </button>
  <button class="tab-btn" onclick="showTab('repertoire')" id="tab-repertoire">
    <span class="tab-icon">ğŸ“</span>RÃ©pertoire
  </button>
  <button class="tab-btn" onclick="showTab('modeles')" id="tab-modeles">
    <span class="tab-icon">ğŸ—‚ï¸</span>ModÃ¨les
  </button>
  <button class="tab-btn" onclick="showTab('guide')" id="tab-guide">
    <span class="tab-icon">ğŸ“–</span>Guide
  </button>
  <button class="tab-btn" onclick="showTab('apropos')" id="tab-apropos">
    <span class="tab-icon">â„¹ï¸</span>Ã€ propos
  </button>
  <button class="tab-btn" onclick="showTab('partage')" id="tab-partage">
    <span class="tab-icon">ğŸ”—</span>Partage
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- BARRE D'OUTILS RAPIDE (tablette uniquement)        -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tablet-toolbar" id="tablet-toolbar">
  <span class="tablet-toolbar-label">Actions rapides :</span>
  <button class="btn-v3 btn-v3-primary" onclick="genererPDF()" style="padding:7px 14px;font-size:12px;">
    ğŸ“„ GÃ©nÃ©rer PDF
  </button>
  <button class="btn-v3 btn-v3-success" onclick="enregistrerDansRepertoire()" style="padding:7px 14px;font-size:12px;">
    ğŸ’¾ Sauvegarder
  </button>
  <button class="btn-v3" onclick="showTab('apercu');genererPreviewSimulee();" style="padding:7px 14px;font-size:12px;background:#E8F5E9;color:#2E7D32;border:1px solid #C8E6C9;">
    ğŸ‘ï¸ AperÃ§u PDF
  </button>
  <button class="btn-v3 btn-v3-ghost" onclick="exporterToutesLesFinches()" style="padding:7px 14px;font-size:12px;">
    ğŸ“¦ Exporter backup
  </button>
  <button class="btn-v3 btn-v3-ghost" onclick="showTab('partage');switchShareMethod('code',document.querySelector('.share-method-tab:nth-child(2)'));" style="padding:7px 14px;font-size:12px;">
    ğŸ”‘ Partager (code)
  </button>
</div>

<div id="offline-banner">ğŸ“µ Mode hors ligne â€” La gÃ©nÃ©ration PDF reste disponible</div>
<div id="save-bar" style="display:none;background:#E8F5E9;border-bottom:1px solid #A5D6A7;padding:5px 14px;font-size:11px;color:#2E7D32;text-align:center;">
  <span id="save-status">âœ… Fiche sauvegardÃ©e automatiquement</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL 1 : EN-TÃŠTE FLEXIBLE -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel active" id="panel-entete">

  <!-- AperÃ§u live de l'en-tÃªte -->
  <div class="card" id="card-entete-preview">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>APERÃ‡U DE L'EN-TÃŠTE</h2>
        <span class="badge">Live</span>
      </div>
      <span style="font-size:11px;color:rgba(255,255,255,0.95);font-style:italic;background:rgba(255,255,255,0.15);padding:4px 8px;border-radius:4px;">âœï¸ cliquez pour Ã©diter les champs</span>
    </div>
    <div class="card-body" style="padding:10px;">
      <div id="entete-live-preview"></div>
    </div>
  </div>

  <!-- Champs fixes (labels editables) -->
  <div class="card">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>CHAMPS FIXES</h2>
        <span class="badge">Labels modifiables</span>
      </div>
      <span style="font-size:11px;color:rgba(255,255,255,0.95);font-style:italic;background:rgba(255,255,255,0.15);padding:4px 8px;border-radius:4px;">âœï¸ double-clic sur les labels pour les modifier</span>
    </div>
    <div class="card-body" id="fixed-fields-container">

      <!-- Ligne 1 : Prof + Niveau (cÃ´te Ã  cÃ´te) -->
      <div class="fixed-row-group" id="fgrp-ligne1">
        <div class="fgrp-title">Ligne 1 â€” Identification</div>
        <div class="field-row">
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Professeur</span>
              <span class="label-edit-hint">âœï¸</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('prof', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('prof', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('prof', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('prof', this.value)" title="Couleur de surlignage" value="#FFFFFF">
              <button type="button" class="format-btn" onclick="removeColorFromContentEditable('prof')" title="Supprimer les couleurs" style="font-size:11px;">ğŸš«</button>
            </div>
            <div id="prof" contenteditable="true" class="editable-input" oninput="updateLivePreview()">EZ-ZAKY AZIZ</div>
          </div>
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Niveau</span>
              <span class="label-edit-hint">âœï¸</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('niveau', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('niveau', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('niveau', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('niveau', this.value)" title="Couleur de surlignage" value="#FFFFFF">
            </div><div id="niveau" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Ex : 1BAC, 2BAC, TCâ€¦"></div>
          </div>
        </div>
      </div>

      <!-- Ligne 2 : Module -->
      <div class="fixed-row-group" id="fgrp-module">
        <div class="fgrp-title">Ligne 2</div>
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
            <span class="label-text">Module</span>
            <span class="label-edit-hint">âœï¸</span>
          </label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
            <button type="button" class="format-btn" onclick="toggleFormat('module', 'bold')" title="Gras"><b>B</b></button>
            <button type="button" class="format-btn" onclick="toggleFormat('module', 'italic')" title="Italique"><i>I</i></button>
            <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('module', this.value)" title="Couleur du texte" value="#000000">
            <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('module', this.value)" title="Couleur de surlignage" value="#FFFFFF">
          </div><div id="module" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="IntitulÃ© exact du module"></div>
        </div>
      </div>

      <!-- Ligne 3 : SÃ©quence -->
      <div class="fixed-row-group" id="fgrp-sequence">
        <div class="fgrp-title">Ligne 3</div>
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
            <span class="label-text">SÃ©quence</span>
            <span class="label-edit-hint">âœï¸</span>
          </label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
            <button type="button" class="format-btn" onclick="toggleFormat('sequence', 'bold')" title="Gras"><b>B</b></button>
            <button type="button" class="format-btn" onclick="toggleFormat('sequence', 'italic')" title="Italique"><i>I</i></button>
            <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('sequence', this.value)" title="Couleur du texte" value="#000000">
            <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('sequence', this.value)" title="Couleur de surlignage" value="#FFFFFF">
          </div><div id="sequence" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="IntitulÃ© exact de la sÃ©quence"></div>
        </div>
      </div>

      <!-- Ligne 4 : ActivitÃ© + Support -->
      <div class="fixed-row-group" id="fgrp-ligne4">
        <div class="fgrp-title">Ligne 4</div>
        <div class="field-row">
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">ActivitÃ©</span>
              <span class="label-edit-hint">âœï¸</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('activite', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('activite', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('activite', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('activite', this.value)" title="Couleur de surlignage" value="#FFFFFF">
            </div><div id="activite" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="IntitulÃ© de l'activitÃ©"></div>
          </div>
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Support</span>
              <span class="label-edit-hint">âœï¸</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('support', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('support', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('support', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('support', this.value)" title="Couleur de surlignage" value="#FFFFFF">
            </div><div id="support" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Titre / rÃ©fÃ©rence support"></div>
          </div>
        </div>
      </div>

      <!-- Ligne 5 : Objectif -->
      <div class="fixed-row-group" id="fgrp-objectif">
        <div class="fgrp-title">Ligne 5 â€” Objectif</div>
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
            <span class="label-text">Objectif(s)</span>
            <span class="label-edit-hint">âœï¸</span>
          </label>
          <div id="objectif-wrapper" class="quill-wrapper tall"></div>
          <div class="field-hint">Zone Ã©tendue dans le PDF. Utilisez la barre d'outils pour mettre en forme.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Lignes supplÃ©mentaires libres -->
  <div class="card">
    <div class="card-header" style="justify-content:space-between; flex-wrap:wrap; gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>LIGNES SUPPLÃ‰MENTAIRES</h2>
        <span class="badge">Optionnel</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="ajouterLigneLibre('simple')" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">+ Champ simple</button>
        <button onclick="ajouterLigneLibre('double')" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">+ 2 champs cÃ´te Ã  cÃ´te</button>
      </div>
    </div>
    <div class="card-body" id="lignes-libres-container">
      <p id="no-lignes-libres-msg" style="color:var(--muted);font-size:12px;text-align:center;padding:12px 0;">
        Aucune ligne supplÃ©mentaire. Utilisez les boutons ci-dessus pour en ajouter.
      </p>
    </div>
  </div>

  <button class="btn-generate" onclick="showTab('etapes')">
    Suivant : Saisir les Ã©tapes â†’
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL 2 : Ã‰TAPES -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-etapes">

  <div class="card" style="margin-bottom:16px;">
    <div class="card-header"><h2>TABLEAU PÃ‰DAGOGIQUE â€” Ã‰TAPES DE LA SÃ‰ANCE</h2></div>
    <div class="card-body" style="padding:10px 14px; font-size:12px; color:var(--muted); line-height:1.6;">
      Chaque Ã©tape correspond Ã  un bloc de lignes dans le tableau PDF.<br>
      Collez votre contenu tel quel dans chaque champ.
    </div>
  </div>

  <div id="etapes-container"></div>

  <!-- Badge durÃ©e totale -->
  <div style="text-align:center;margin:10px 0 4px;">
    <span id="duree-totale-badge">â±ï¸ DurÃ©e totale : <span id="duree-totale-val">â€”</span></span>
  </div>

  <button class="btn-add-etape" onclick="ajouterEtape()">
    + Ajouter une Ã©tape
  </button>

  <!-- Boutons export multiples -->
  <div class="btn-export-group">
    <button class="btn-export btn-export-save" onclick="enregistrerDansRepertoire()">
      ğŸ’¾ Enregistrer la fiche
    </button>
    <button class="btn-export btn-export-pdf" onclick="genererPDF()">
      ğŸ“„ Exporter en PDF
    </button>
    <button class="btn-export btn-export-docx" onclick="genererDOCX()">
      ğŸ“˜ Exporter en Word (.docx)
    </button>
  </div>
</div>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-params">

  <!-- Bouton rÃ©initialisation -->
  <div style="text-align:right;margin-bottom:10px;">
    <button onclick="reinitialiserParams()" style="background:#fff;border:1.5px solid #1565C0;color:#1565C0;border-radius:8px;padding:7px 16px;font-size:12px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:6px;">
      ğŸ”„ ParamÃ¨tres par dÃ©faut
    </button>
  </div>

  <div class="card">
    <div class="card-header"><h2>MISE EN PAGE â€” MARGES</h2></div>
    <div class="card-body">
      <div class="param-grid">
        <div class="param-item">
          <label>Marge (pts)</label>
          <input type="number" id="p-marge" value="8.5" min="0" max="50" step="0.5">
        </div>
        <div class="param-item">
          <label>Esp. en-tÃªte/tableau (pts)</label>
          <input type="number" id="p-gap" value="5" min="0" max="30" step="1">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>TYPOGRAPHIE</h2></div>
    <div class="card-body">
      <div class="param-section-title">En-tÃªte de la fiche</div>
      <div class="param-grid">
        <div class="param-item">
          <label>Taille Ã©tiquettes (pt)</label>
          <input type="number" id="p-font-entete-label" value="11" min="6" max="18" step="0.5">
        </div>
        <div class="param-item">
          <label>Taille contenu (pt)</label>
          <input type="number" id="p-font-entete-content" value="10" min="6" max="16" step="0.5">
        </div>
      </div>
      <div class="param-section-title">Tableau pÃ©dagogique</div>
      <div class="param-grid">
        <div class="param-item">
          <label>En-tÃªtes colonnes (pt)</label>
          <input type="number" id="p-font-table-header" value="10" min="6" max="16" step="0.5">
        </div>
        <div class="param-item">
          <label>Contenu cellules (pt)</label>
          <input type="number" id="p-font-table-content" value="9" min="6" max="14" step="0.5">
        </div>
        <div class="param-item">
          <label>Hauteur ligne donnÃ©es (pt)</label>
          <input type="number" id="p-row-height" value="8" min="6" max="20" step="0.5">
        </div>
        <div class="param-item">
          <label>Hauteur en-tÃªte tableau (pt)</label>
          <input type="number" id="p-table-header-h" value="18" min="12" max="30" step="1">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>EN-TÃŠTE â€” DIMENSIONS</h2></div>
    <div class="card-body">
      <div class="param-grid">
        <div class="param-item">
          <label>Hauteur totale en-tÃªte (pt)</label>
          <input type="number" id="p-header-h" value="100" min="60" max="160" step="2">
        </div>
        <div class="param-item">
          <label>Hauteur ligne 1 (pt)</label>
          <input type="number" id="p-l1h" value="22" min="14" max="40" step="1">
        </div>
        <div class="param-item">
          <label>Hauteur lignes 2/3/4 (pt)</label>
          <input type="number" id="p-l234h" value="18" min="12" max="30" step="1">
        </div>
        <div class="param-item">
          <label>Hauteur ligne 5 / Objectif (pt)</label>
          <input type="number" id="p-l5h" value="40" min="24" max="80" step="2">
        </div>
        <div class="param-item">
          <label>SÃ©parateur 1 (% largeur)</label>
          <input type="number" id="p-sep1" value="32" min="10" max="60" step="1">
        </div>
        <div class="param-item">
          <label>SÃ©parateur 2 (% largeur)</label>
          <input type="number" id="p-sep2" value="60" min="30" max="80" step="1">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>PROPORTIONS DES COLONNES DU TABLEAU</h2></div>
    <div class="card-body">
      <div class="param-grid">
        <div class="param-item">
          <label>Ã‰tapes (%)</label>
          <input type="number" id="p-col1" value="20" min="10" max="30" step="1">
        </div>
        <div class="param-item">
          <label>DÃ©roulement (%)</label>
          <input type="number" id="p-col2" value="65" min="50" max="75" step="1">
        </div>
      </div>
      <div class="field-hint" style="margin-top:8px;">La colonne Â« DurÃ©e Â» prend le reste (100 % âˆ’ somme des autres).</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>ğŸ“ LABELS DES COLONNES D'Ã‰TAPES</h2></div>
    <div class="card-body">
      <p style="margin-bottom: 12px; color: var(--muted); font-size: 13px;">
        Personnalisez les noms des colonnes dans le tableau des Ã©tapes (PDF et Word).
      </p>
      <div class="field">
        <label>Nom de la colonne 1 (Ã‰tapes)</label>
        <input type="text" id="label-col-etapes" value="Ã‰tapes" placeholder="Ex: Phases, Moments, Parties...">
      </div>
      <div class="field">
        <label>Nom de la colonne 2 (DÃ©roulement)</label>
        <input type="text" id="label-col-deroulement" value="DÃ©roulement de la sÃ©ance" placeholder="Ex: ActivitÃ©s, Description, Contenu...">
      </div>
      <div class="field">
        <label>Nom de la colonne 3 (DurÃ©e)</label>
        <input type="text" id="label-col-duree" value="DurÃ©e" placeholder="Ex: Temps, Timing...">
      </div>
      
      <!-- â”€â”€ COLONNES SUPPLÃ‰MENTAIRES â”€â”€ -->
      <div style="margin-top:18px; border-top:1px dashed var(--border); padding-top:14px;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap; gap:8px;">
          <p style="font-size:12px; color:var(--blue-dark); font-weight:600; margin:0;">
            â• Colonnes supplÃ©mentaires
          </p>
          <button onclick="ajouterColonneSup()" style="background:var(--blue);color:white;border:none;border-radius:6px;padding:5px 12px;font-size:11px;cursor:pointer;font-family:'Source Serif 4',serif;">
            + Ajouter une colonne
          </button>
        </div>
        <p style="font-size:11px; color:var(--muted); margin-bottom:10px;">
          Les colonnes supplÃ©mentaires s'ajoutent aprÃ¨s Â« DÃ©roulement Â» et avant Â« DurÃ©e Â» dans le tableau PDF et Word. Max 3 colonnes ajoutÃ©es.
        </p>
        <div id="colonnes-sup-container"></div>
        <p id="no-col-sup-msg" style="font-size:11px; color:var(--muted); text-align:center; padding:8px 0; font-style:italic;">
          Aucune colonne supplÃ©mentaire. Cliquez sur Â« + Ajouter une colonne Â» pour en crÃ©er.
        </p>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>ğŸ¨ THÃˆME DE MISE EN PAGE</h2></div>
    <div class="card-body">

      <!-- ThÃ¨mes prÃ©dÃ©finis -->
      <div class="param-section-title">ThÃ¨mes prÃ©dÃ©finis</div>
      <div id="theme-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px;"></div>

      <!-- Couleurs personnalisÃ©es -->
      <div class="param-section-title">Personnaliser</div>
      <div class="param-grid" style="margin-top:8px;">
        <div class="param-item">
          <label>Couleur principale</label>
          <input type="color" id="p-color-main" value="#1565C0" oninput="applyThemePreview()">
        </div>
        <div class="param-item">
          <label>Couleur accent (or)</label>
          <input type="color" id="p-color-accent" value="#C9A84C" oninput="applyThemePreview()">
        </div>
        <div class="param-item">
          <label>Couleur bordures</label>
          <input type="color" id="p-color-grid" value="#AAAAAA" oninput="applyThemePreview()">
        </div>
        <div class="param-item">
          <label>Texte Ã©tapes (tableau)</label>
          <input type="color" id="p-color-etape-text" value="#1565C0" oninput="applyThemePreview()">
        </div>
      </div>

      <!-- AperÃ§u mini -->
      <div style="margin-top:14px;">
        <div class="param-section-title">AperÃ§u du thÃ¨me</div>
        <div id="theme-preview" style="margin-top:8px; border-radius:8px; overflow:hidden; border:1.5px solid var(--border);">
          <div id="tp-header" style="padding:7px 10px; display:flex; gap:8px; align-items:center;">
            <div id="tp-badge" style="width:12px;height:12px;border-radius:3px;flex-shrink:0;"></div>
            <span id="tp-title" style="color:white;font-size:11px;font-weight:700;">FICHE PÃ‰DAGOGIQUE</span>
            <span id="tp-sub" style="color:rgba(255,255,255,0.7);font-size:10px;margin-left:auto;">EZ-ZAKY AZIZ</span>
          </div>
          <div style="background:white;padding:6px 10px;display:flex;flex-direction:column;gap:4px;">
            <div style="display:flex;gap:6px;align-items:center;">
              <span id="tp-label1" style="font-size:9px;font-weight:700;">MODULE :</span>
              <div style="flex:1;height:10px;background:#f0f0f0;border-radius:2px;border:0.5px solid #ddd;"></div>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              <span id="tp-label2" style="font-size:9px;font-weight:700;">OBJECTIF :</span>
              <div style="flex:1;height:10px;background:#f0f0f0;border-radius:2px;border:0.5px solid #ddd;"></div>
            </div>
          </div>
          <div id="tp-table-header" style="padding:5px 10px;display:flex;gap:0;">
            <span style="color:white;font-size:9px;font-weight:700;flex:2;text-align:center;">Ã‰tapes</span>
            <span style="color:white;font-size:9px;font-weight:700;flex:5;text-align:center;">DÃ©roulement</span>
            <span style="color:white;font-size:9px;font-weight:700;flex:1;text-align:center;">DurÃ©e</span>
          </div>
          <div style="background:white;display:flex;padding:5px 10px;gap:0;align-items:center;">
            <span id="tp-etape" style="flex:2;font-size:9px;font-weight:700;text-align:center;">I. Intro</span>
            <span style="flex:5;font-size:9px;color:#333;padding-left:4px;">ActivitÃ© d'amorce...</span>
            <span style="flex:1;font-size:9px;color:#666;text-align:center;">5 min</span>
          </div>
        </div>
      </div>

    </div>
  </div>



  <button class="btn-generate" onclick="genererPDF()">
    ğŸ“„ GÃ©nÃ©rer la Fiche PDF
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL 4 : APERÃ‡U -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-apercu">

  <div class="preview-info" id="preview-summary">
    Remplissez l'en-tÃªte et les Ã©tapes, puis revenez ici pour voir un aperÃ§u avant gÃ©nÃ©ration.
  </div>

  <!-- â”€â”€ NOUVELLE : AperÃ§u PDF simulÃ© en temps rÃ©el â”€â”€ -->
  <div class="card" id="card-pdf-sim">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>APERÃ‡U PDF SIMULÃ‰</h2>
        <span class="badge">Temps rÃ©el</span>
      </div>
      <button onclick="genererPreviewSimulee()" class="pdf-preview-update-btn" style="font-size:11px;padding:5px 10px;">
        ğŸ”„ Actualiser
      </button>
    </div>
    <div style="padding:12px;">
      <div class="pdf-preview-container" id="pdf-preview-container">
        <div class="pdf-sim-info">Cliquez sur "Actualiser" pour gÃ©nÃ©rer l'aperÃ§u</div>
      </div>
    </div>
  </div>

  <!-- AperÃ§u avec codes couleurs thÃ©matiques -->
  <div id="preview-live-container" class="preview-live">
    <div class="preview-live-header">
      <h2 style="margin: 0;">ğŸ“‹ APERÃ‡U DE LA FICHE</h2>
      <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">
        PrÃ©visualisation avec codes couleurs par section
      </p>
    </div>
    <div id="preview-live-content">
      <!-- Le contenu sera gÃ©nÃ©rÃ© dynamiquement -->
    </div>
  </div>

  <div id="preview-table-container"></div>

  <!-- Boutons export multiples (mis Ã  jour) -->
  <div class="btn-export-group">
    <button class="btn-export btn-export-save" onclick="enregistrerDansRepertoire()">
      ğŸ’¾ Enregistrer la fiche
    </button>
    <button class="btn-export btn-export-pdf" onclick="genererPDF()">
      ğŸ“„ Exporter en PDF
    </button>
    <button class="btn-export btn-export-docx" onclick="genererDOCX()">
      ğŸ“˜ Exporter en Word (.docx)
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL 6 : RÃ‰PERTOIRE DES FICHES                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-repertoire">
  <div style="background:linear-gradient(90deg,#1565C0,#1976D2);border-radius:12px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div style="color:#fff;font-weight:700;font-size:15px;">ğŸ“ RÃ©pertoire des fiches</div>
      <div style="color:rgba(255,255,255,0.8);font-size:11px;margin-top:2px;">Fiches enregistrÃ©es manuellement sur cet appareil</div>
    </div>
    <span id="rep-compteur" style="background:rgba(255,255,255,0.2);color:#fff;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700;">0 fiche</span>
  </div>
  <div id="repertoire-liste">
    <div class="repertoire-empty">
      <div style="font-size:40px;margin-bottom:8px;">ğŸ“‚</div>
      <div>Aucune fiche enregistrÃ©e.</div>
      <div style="font-size:12px;margin-top:6px;color:#bbb;">Utilisez le bouton <strong>ğŸ’¾ Enregistrer la fiche</strong><br>depuis l'onglet Ã‰tapes ou AperÃ§u.</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL MODÃˆLES : FICHES PRÃŠTES Ã€ L'EMPLOI          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-modeles">
  <div style="background:linear-gradient(135deg,#1565C0 0%,#0D47A1 100%);border-radius:14px;padding:18px 16px 14px;margin-bottom:16px;box-shadow:0 4px 18px rgba(21,101,192,0.3);">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <div style="font-size:32px;">ğŸ—‚ï¸</div>
      <div>
        <div style="color:#fff;font-weight:800;font-size:16px;font-family:'Playfair Display',serif;">ModÃ¨les de Fiches PÃ©dagogiques</div>
        <div style="color:rgba(255,255,255,0.8);font-size:11px;margin-top:2px;">Fiches prÃªtes Ã  l'emploi Â· Chargez, personnalisez, exportez</div>
      </div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:600;">ğŸ“– FranÃ§ais</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:600;">ğŸ“ Maths</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:600;">ğŸ”¬ SVT Â· ğŸ›ï¸ Histoire Â· âš—ï¸ Physique Â· ğŸ‡¬ğŸ‡§ Anglais</span>
      <span style="background:rgba(201,168,76,0.85);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:700;">7 modÃ¨les</span>
    </div>
  </div>
  <div class="modeles-filter-bar">
    <button class="modele-filter-btn active" onclick="filtrerModeles('all',this)">ğŸ“‹ Tous</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('francais',this)">ğŸ“– FranÃ§ais</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('maths',this)">ğŸ“ Maths</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('svt',this)">ğŸ”¬ SVT</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('histoire',this)">ğŸ›ï¸ Histoire</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('anglais',this)">ğŸ‡¬ğŸ‡§ Anglais</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('physique',this)">âš—ï¸ Physique</button>
  </div>
  <div id="modeles-liste"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL 5 : GUIDE D'UTILISATION                      -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-guide">
<div id="guide-content">

  <!-- â”€â”€ HERO â”€â”€ -->
  <div style="background:linear-gradient(135deg,#1565C0 0%,#0D47A1 60%,#1565C0 100%);border-radius:16px;padding:28px 20px 22px;margin-bottom:18px;text-align:center;box-shadow:0 6px 24px rgba(21,101,192,0.35);">
    <div style="font-size:52px;margin-bottom:8px;">ğŸ“‹</div>
    <h1 style="color:#fff;font-size:20px;font-weight:800;margin:0 0 6px;letter-spacing:0.02em;">GÃ©nÃ©rateur de Fiches PÃ©dagogiques</h1>
    <p style="color:rgba(255,255,255,0.85);font-size:13px;margin:0 0 14px;">par <strong>EZ-ZAKY AZIZ</strong></p>
    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">ğŸ“„ Export PDF</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">ğŸ“˜ Export Word</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">âœ’ï¸ Texte riche</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">ğŸ–¼ï¸ Images</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">ğŸ¨ 9 ThÃ¨mes</span>
      <span style="background:rgba(201,168,76,0.85);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:700;">ğŸ†• v3.0 : Tablette Â· Partage Â· Backup</span>
    </div>
  </div>

  <!-- â”€â”€ CARACTÃ‰RISTIQUES â”€â”€ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#1565C0,#1976D2);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">â­</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">CARACTÃ‰RISTIQUES</span>
    </div>
    <div style="padding:14px 16px;display:grid;gap:10px;">

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E3F2FD;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ“</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">En-tÃªte entiÃ¨rement personnalisable</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Labels modifiables par double-clic (Professeur, Niveau, Module, SÃ©quence, ActivitÃ©, Support, Objectif). PossibilitÃ© d'ajouter des lignes libres simples ou doubles.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E8F5E9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ“š</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Tableau d'Ã©tapes dynamique</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Ajoutez, supprimez et rÃ©ordonnez vos Ã©tapes. Chaque Ã©tape dispose d'un Ã©diteur de texte riche (gras, italique, soulignÃ©, listes, tableaux, images, symboles).</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#FFF3E0;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">â•</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Colonnes supplÃ©mentaires (jusqu'Ã  3)</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Ajoutez des colonnes personnalisÃ©es dans le tableau des Ã©tapes : MatÃ©riel, Supports, Outils pÃ©dagogiques, etc. Largeur rÃ©glable de 5 Ã  25 %.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#F3E5F5;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ¨</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">9 thÃ¨mes de couleurs professionnels</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Bleu classique, Marine & or, Vert acadÃ©mique, Bordeaux, Violet royal, Ardoise, Noir & or, Turquoise, Rouge vif. Couleurs personnalisables manuellement.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E8F5E9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ“</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Mise en page paramÃ©trable</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Orientation (portrait/paysage), taille de police, largeurs des colonnes, marges, numÃ©rotation des pages. Format A4 standard.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E3F2FD;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ’¾</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Export double format</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">GÃ©nÃ©ration PDF fidÃ¨le en un clic pour impression et partage. Export Word (.docx) Ã©ditable avec images intÃ©grÃ©es, compatible Microsoft Word et LibreOffice.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#FFF8E1;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ“µ</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Mode hors ligne</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">La gÃ©nÃ©ration PDF fonctionne mÃªme sans connexion internet. L'export Word nÃ©cessite le chargement initial des bibliothÃ¨ques.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- â”€â”€ GUIDE Ã‰TAPE PAR Ã‰TAPE â”€â”€ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#1565C0,#1976D2);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">ğŸ—ºï¸</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">GUIDE D'UTILISATION â€” Ã‰TAPE PAR Ã‰TAPE</span>
    </div>
    <div style="padding:14px 16px;display:grid;gap:0;">

      <!-- Ã‰tape 1 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">1</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">ğŸ“ Remplir l'en-tÃªte (onglet En-tÃªte)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Saisissez les informations de la fiche : Professeur, Niveau, Module, SÃ©quence, ActivitÃ©, Support et Objectif(s).<br>
            <strong>ğŸ’¡ Astuce :</strong> double-cliquez sur un label (ex : Â« Professeur Â») pour le renommer selon votre Ã©tablissement.<br>
            <strong>â•</strong> Utilisez Â« Ajouter une ligne Â» pour des champs supplÃ©mentaires (Ã‰tablissement, Date, Groupeâ€¦).
          </div>
        </div>
      </div>

      <!-- Ã‰tape 2 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">2</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">ğŸ“š CrÃ©er les Ã©tapes (onglet Ã‰tapes)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Cliquez sur <strong>Â« + Ajouter une Ã©tape Â»</strong> pour crÃ©er chaque Ã©tape du dÃ©roulement.<br>
            Pour chaque Ã©tape, renseignez :<br>
            &nbsp;&nbsp;â€¢ <strong>Nom</strong> de l'Ã©tape (Mise en route, PrÃ©sentation, Productionâ€¦)<br>
            &nbsp;&nbsp;â€¢ <strong>DÃ©roulement</strong> : dÃ©crivez l'activitÃ© avec l'Ã©diteur riche<br>
            &nbsp;&nbsp;â€¢ <strong>DurÃ©e</strong> : temps allouÃ© (ex : 15 min)<br>
            <strong>ğŸ–¼ï¸</strong> InsÃ©rez des images dans le dÃ©roulement via le bouton image de la barre d'outils.<br>
            <strong>Î©</strong> Utilisez le sÃ©lecteur de symboles pour enrichir le texte.
          </div>
        </div>
      </div>

      <!-- Ã‰tape 3 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">3</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">âš™ï¸ Configurer les paramÃ¨tres (onglet ParamÃ¨tres)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            <strong>ThÃ¨me :</strong> choisissez parmi les 9 thÃ¨mes ou personnalisez les couleurs manuellement.<br>
            <strong>Mise en page :</strong> orientation, taille de police, largeurs des colonnes, marges.<br>
            <strong>Labels du tableau :</strong> renommez les en-tÃªtes des colonnes (Ã‰tapes, DÃ©roulement, DurÃ©e).<br>
            <strong>Colonnes sup. :</strong> ajoutez jusqu'Ã  3 colonnes personnalisÃ©es avec leur nom et leur largeur.
          </div>
        </div>
      </div>

      <!-- Ã‰tape 4 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">4</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">ğŸ‘ï¸ VÃ©rifier l'aperÃ§u (onglet AperÃ§u)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Consultez le rendu complet de votre fiche avant export : en-tÃªte et tableau des Ã©tapes avec les couleurs du thÃ¨me choisi.<br>
            L'aperÃ§u se met Ã  jour automatiquement Ã  chaque modification.
          </div>
        </div>
      </div>

      <!-- Ã‰tape 5 -->
      <div style="display:flex;gap:12px;padding:12px 0;">
        <div style="min-width:34px;height:34px;background:#C9A84C;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">5</div>
        <div>
          <div style="font-weight:700;color:#C9A84C;font-size:13px;margin-bottom:4px;">ğŸ’¾ Exporter la fiche</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Depuis l'onglet <strong>AperÃ§u</strong>, cliquez sur :<br>
            &nbsp;&nbsp;â€¢ <strong>ğŸ“„ Exporter en PDF</strong> â€” pour impression ou partage immÃ©diat<br>
            &nbsp;&nbsp;â€¢ <strong>ğŸ“˜ Exporter en Word (.docx)</strong> â€” pour modifier et rÃ©utiliser la fiche<br>
            Le fichier se tÃ©lÃ©charge directement en un seul clic.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- â”€â”€ CONSEILS PRO â”€â”€ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#C9A84C,#E6B84C);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">ğŸ†</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">CONSEILS D'UTILISATION PROFESSIONNELLE</span>
    </div>
    <div style="padding:14px 16px;display:grid;gap:10px;">

      <div style="background:#FFFDE7;border-left:4px solid #C9A84C;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#795548;font-size:12px;margin-bottom:3px;">ğŸ“Œ Standardisation institutionnelle</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Renommez tous les labels une fois pour toutes selon les normes de votre Ã©tablissement. Ainsi chaque fiche produite sera conforme au mÃªme standard.</div>
      </div>

      <div style="background:#E8F5E9;border-left:4px solid #2E7D32;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#2E7D32;font-size:12px;margin-bottom:3px;">ğŸ”„ RÃ©utilisation des fiches</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Exportez en Word (.docx) pour archiver vos fiches et les modifier facilement d'une sÃ©quence Ã  l'autre sans repartir de zÃ©ro.</div>
      </div>

      <div style="background:#E3F2FD;border-left:4px solid #1565C0;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#1565C0;font-size:12px;margin-bottom:3px;">ğŸ¨ CohÃ©rence visuelle</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Utilisez le mÃªme thÃ¨me de couleurs pour toutes vos fiches afin de crÃ©er une identitÃ© visuelle professionnelle et reconnaissable.</div>
      </div>

      <div style="background:#F3E5F5;border-left:4px solid #7B1FA2;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#7B1FA2;font-size:12px;margin-bottom:3px;">ğŸ“¸ Images dans le dÃ©roulement</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">IntÃ©grez des captures d'Ã©crans, schÃ©mas ou illustrations directement dans le dÃ©roulement de la sÃ©ance. Elles apparaissent dans le PDF et le Word.</div>
      </div>

      <div style="background:#FFF3E0;border-left:4px solid #E65100;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#E65100;font-size:12px;margin-bottom:3px;">â• Colonnes personnalisÃ©es</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Ajoutez une colonne Â« MatÃ©riel Â» ou Â« CompÃ©tences Â» dans l'onglet ParamÃ¨tres â†’ Colonnes supplÃ©mentaires pour enrichir le tableau sans surcharger la mise en page.</div>
      </div>

      <div style="background:#E8F5E9;border-left:4px solid #1B5E20;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#1B5E20;font-size:12px;margin-bottom:3px;">ğŸ–¨ï¸ Impression optimale</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Utilisez l'orientation <strong>Paysage</strong> si votre tableau comporte beaucoup de colonnes. Le format PDF A4 est prÃªt Ã  imprimer directement.</div>
      </div>

    </div>
  </div>

  <!-- â”€â”€ RACCOURCIS Ã‰DITEUR â”€â”€ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#37474F,#546E7A);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">âŒ¨ï¸</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">RACCOURCIS DE L'Ã‰DITEUR DE TEXTE</span>
    </div>
    <div style="padding:14px 16px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <kbd style="background:#1565C0;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">G</kbd>
          <span style="font-size:12px;color:#444;">Gras</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <kbd style="background:#1565C0;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;font-style:italic;">I</kbd>
          <span style="font-size:12px;color:#444;">Italique</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <kbd style="background:#1565C0;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;text-decoration:underline;">S</kbd>
          <span style="font-size:12px;color:#444;">SoulignÃ©</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">â‰¡</span>
          <span style="font-size:12px;color:#444;">Liste Ã  puces</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">âŠ</span>
          <span style="font-size:12px;color:#444;">Tableau</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">ğŸ–¼</span>
          <span style="font-size:12px;color:#444;">Image</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">Î©</span>
          <span style="font-size:12px;color:#444;">Symboles</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">AÂ²</span>
          <span style="font-size:12px;color:#444;">Exposant</span>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PIED â”€â”€ -->
  <div style="text-align:center;padding:16px 12px 24px;color:#999;font-size:11px;">
    <div style="font-size:28px;margin-bottom:6px;">ğŸ“‹</div>
    <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">GÃ©nÃ©rateur de Fiches PÃ©dagogiques</div>
    <div>DÃ©veloppÃ© par <strong style="color:#1565C0;">EZ-ZAKY AZIZ</strong></div>
    <div style="margin-top:4px;">Application 100 % locale â€” vos donnÃ©es restent sur votre appareil</div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL : Ã€ PROPOS (COPYRIGHT & LICENCE)             -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-apropos">
  <div id="apropos-content">

    <!-- â”€â”€ HERO Ã€ PROPOS â”€â”€ -->
    <div style="background:linear-gradient(135deg,#1565C0 0%,#0D47A1 60%,#1565C0 100%);border-radius:16px;padding:32px 20px;margin-bottom:18px;text-align:center;box-shadow:0 8px 28px rgba(21,101,192,0.4);">
      <div style="font-size:64px;margin-bottom:12px;">ğŸ“‹</div>
      <h1 style="color:#fff;font-size:22px;font-weight:800;margin:0 0 8px;letter-spacing:0.02em;">GÃ©nÃ©rateur de Fiches PÃ©dagogiques</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:14px;margin:0 0 6px;font-weight:600;">Version 2.11 â€” FÃ©vrier 2025</p>
      <p style="color:rgba(255,255,255,0.85);font-size:13px;margin:0;">ConÃ§u et dÃ©veloppÃ© par <strong>EZ-ZAKY AZIZ</strong></p>
    </div>

    <!-- â”€â”€ COPYRIGHT â”€â”€ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#1565C0,#1976D2);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">Â©</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">COPYRIGHT & PROPRIÃ‰TÃ‰ INTELLECTUELLE</span>
      </div>
      <div style="padding:18px 16px;">
        <div style="background:#E3F2FD;border-left:4px solid #1565C0;border-radius:0 8px 8px 0;padding:14px 16px;margin-bottom:14px;">
          <div style="font-size:13px;color:#1565C0;font-weight:700;margin-bottom:8px;">Â© 2025 EZ-ZAKY AZIZ â€” Tous droits rÃ©servÃ©s</div>
          <div style="font-size:12px;color:#444;line-height:1.7;">
            Cette application et tous ses composants (code source, design, documentation, modÃ¨les) sont la propriÃ©tÃ© intellectuelle de <strong>EZ-ZAKY AZIZ</strong>.<br><br>
            <strong>CrÃ©ateur :</strong> EZ-ZAKY AZIZ<br>
            <strong>Date de crÃ©ation :</strong> 2024-2025<br>
            <strong>Contact :</strong> Pour toute question ou demande de collaboration, veuillez me contacter directement.
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ LICENCE D'UTILISATION â”€â”€ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#2E7D32,#388E3C);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">ğŸ“œ</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">LICENCE D'UTILISATION</span>
      </div>
      <div style="padding:18px 16px;">
        <div style="font-size:13px;font-weight:700;color:#2E7D32;margin-bottom:10px;">Creative Commons BY-NC-SA 4.0</div>
        <div style="font-size:12px;color:#444;line-height:1.7;margin-bottom:14px;">
          Cette application est distribuÃ©e sous licence <strong>Creative Commons Attribution - Pas d'Utilisation Commerciale - Partage dans les MÃªmes Conditions 4.0 International (CC BY-NC-SA 4.0)</strong>.
        </div>

        <div style="display:grid;gap:10px;">
          <!-- AutorisÃ© -->
          <div style="background:#E8F5E9;border-left:4px solid #2E7D32;border-radius:0 8px 8px 0;padding:12px 14px;">
            <div style="font-weight:700;color:#2E7D32;font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;">âœ…</span> VOUS POUVEZ (Usage autorisÃ©)
            </div>
            <div style="font-size:12px;color:#555;line-height:1.6;">
              â€¢ <strong>Utiliser</strong> l'application pour crÃ©er vos fiches pÃ©dagogiques<br>
              â€¢ <strong>Partager</strong> l'application avec vos collÃ¨gues enseignants<br>
              â€¢ <strong>Modifier</strong> et adapter l'application Ã  vos besoins personnels<br>
              â€¢ <strong>Distribuer</strong> vos versions modifiÃ©es sous la mÃªme licence
            </div>
          </div>

          <!-- Obligations -->
          <div style="background:#FFF3E0;border-left:4px solid #F57C00;border-radius:0 8px 8px 0;padding:12px 14px;">
            <div style="font-weight:700;color:#E65100;font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;">âš ï¸</span> VOUS DEVEZ (Obligations)
            </div>
            <div style="font-size:12px;color:#555;line-height:1.6;">
              â€¢ <strong>CrÃ©diter</strong> l'auteur original : "Application crÃ©Ã©e par EZ-ZAKY AZIZ"<br>
              â€¢ <strong>Indiquer</strong> si des modifications ont Ã©tÃ© apportÃ©es<br>
              â€¢ <strong>Fournir</strong> un lien vers la licence CC BY-NC-SA 4.0<br>
              â€¢ <strong>Distribuer vos modifications</strong> sous la mÃªme licence
            </div>
          </div>

          <!-- Interdit -->
          <div style="background:#FFEBEE;border-left:4px solid #C62828;border-radius:0 8px 8px 0;padding:12px 14px;">
            <div style="font-weight:700;color:#C62828;font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;">âŒ</span> VOUS NE POUVEZ PAS (Interdit)
            </div>
            <div style="font-size:12px;color:#555;line-height:1.6;">
              â€¢ <strong>Utilisation commerciale</strong> : vendre l'application ou l'utiliser dans un cadre commercial<br>
              â€¢ <strong>Supprimer les crÃ©dits</strong> : retirer le nom de l'auteur original<br>
              â€¢ <strong>PrÃ©tendre Ãªtre l'auteur</strong> : vous ne pouvez pas vous prÃ©senter comme le crÃ©ateur original<br>
              â€¢ <strong>Appliquer des restrictions supplÃ©mentaires</strong> : vous ne pouvez pas restreindre davantage les droits
            </div>
          </div>
        </div>

        <div style="margin-top:14px;padding:12px;background:#F5F7FA;border-radius:8px;font-size:11px;color:#666;line-height:1.6;">
          <strong>Note :</strong> Cette licence s'applique au code source et Ã  l'application elle-mÃªme. Les fiches pÃ©dagogiques que vous crÃ©ez avec cette application vous appartiennent entiÃ¨rement et ne sont pas soumises Ã  cette licence.
        </div>
      </div>
    </div>

    <!-- â”€â”€ INFORMATIONS TECHNIQUES â”€â”€ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#7B1FA2,#9C27B0);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">ğŸ’»</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">INFORMATIONS TECHNIQUES</span>
      </div>
      <div style="padding:14px 16px;">
        <div style="display:grid;gap:8px;font-size:12px;color:#444;">
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Version</span>
            <span>Version 3.0 â€” FÃ©vrier 2026 (amÃ©liorÃ© par IA)</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Type d'application</span>
            <span>PWA (Progressive Web App)</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Technologies utilisÃ©es</span>
            <span>HTML5, CSS3, JavaScript, jsPDF, Quill.js</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">CompatibilitÃ©</span>
            <span>Tous navigateurs modernes, Android, iOS</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Mode hors ligne</span>
            <span>âœ… Disponible</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">DonnÃ©es</span>
            <span>100% locales (navigateur)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ REMERCIEMENTS â”€â”€ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#C9A84C,#E6B84C);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">ğŸ™</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">REMERCIEMENTS</span>
      </div>
      <div style="padding:14px 16px;font-size:12px;color:#444;line-height:1.7;">
        Cette application a Ã©tÃ© dÃ©veloppÃ©e avec passion pour faciliter le travail des enseignants.<br><br>
        Un grand merci Ã  tous les collÃ¨gues enseignants qui ont testÃ© l'application et fourni leurs prÃ©cieux retours pour l'amÃ©liorer.<br><br>
        <strong>BibliothÃ¨ques open source utilisÃ©es :</strong><br>
        â€¢ jsPDF â€” GÃ©nÃ©ration de fichiers PDF<br>
        â€¢ Quill.js â€” Ã‰diteur de texte riche<br>
        â€¢ JSZip â€” CrÃ©ation de fichiers DOCX
      </div>
    </div>

    <!-- â”€â”€ PIED Ã€ PROPOS â”€â”€ -->
    <div style="text-align:center;padding:20px 12px 24px;">
      <div style="font-size:32px;margin-bottom:10px;">ğŸ“‹</div>
      <div style="font-weight:700;color:#1565C0;font-size:14px;margin-bottom:6px;">GÃ©nÃ©rateur de Fiches PÃ©dagogiques</div>
      <div style="color:#666;font-size:12px;margin-bottom:4px;">Â© 2025-2026 <strong style="color:#1565C0;">EZ-ZAKY AZIZ</strong></div>
      <div style="color:#999;font-size:11px;">Tous droits rÃ©servÃ©s â€” Licence CC BY-NC-SA 4.0 â€” v3.0</div>
      <div style="margin-top:12px;padding:10px;background:#F5F7FA;border-radius:8px;display:inline-block;">
        <div style="font-size:11px;color:#666;line-height:1.6;">
          Application 100% locale â€” Vos donnÃ©es restent sur votre appareil<br>
          Aucune connexion serveur â€” Respect total de votre vie privÃ©e
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANEL : PARTAGE & SAUVEGARDE AVANCÃ‰E (v3.0)       -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-partage">

  <!-- Avertissement backup -->
  <div class="backup-warn">
    <span class="backup-warn-icon">âš ï¸</span>
    <div>
      <strong>Rappel important :</strong> Vos fiches sont stockÃ©es dans votre navigateur (localStorage). 
      Si vous videz les donnÃ©es du navigateur ou changez d'appareil, vos fiches seront perdues. 
      <strong>Exportez rÃ©guliÃ¨rement un backup JSON</strong> pour les conserver en sÃ©curitÃ©.
    </div>
  </div>

  <!-- Section Export/Import -->
  <div class="export-section">
    <div class="export-section-header">
      <span style="font-size:18px;">ğŸ’¾</span>
      <span>SAUVEGARDE & RESTAURATION</span>
    </div>
    <div class="export-section-body">
      <p style="font-size:12px;color:#555;margin-bottom:14px;line-height:1.6;">
        Exportez toutes vos fiches dans un fichier <strong>.json</strong> que vous pouvez stocker 
        sur votre tÃ©lÃ©phone, Google Drive, ou envoyer par email. Pour restaurer, importez ce fichier.
      </p>
      <div class="export-btn-grid">
        <button class="btn-v3 btn-v3-primary" onclick="exporterToutesLesFinches()" style="width:100%;justify-content:center;">
          ğŸ“¦ Exporter toutes les fiches (.json)
        </button>
        <button class="btn-v3 btn-v3-success" onclick="importerFichesJSON()" style="width:100%;justify-content:center;">
          ğŸ“¥ Importer un backup (.json)
        </button>
      </div>
      <div class="export-btn-grid">
        <button class="btn-v3 btn-v3-ghost" onclick="exporterFicheActuelle()" style="width:100%;justify-content:center;">
          ğŸ“„ Exporter la fiche actuelle
        </button>
        <button class="btn-v3 btn-v3-warn" onclick="confirmerEffacerTout()" style="width:100%;justify-content:center;">
          ğŸ—‘ï¸ Effacer toutes les fiches
        </button>
      </div>
      <div id="export-status" style="display:none;margin-top:10px;padding:10px;border-radius:8px;font-size:12px;text-align:center;"></div>
      
      <!-- Stats du rÃ©pertoire -->
      <div style="margin-top:14px;background:#F5F8FF;border-radius:8px;padding:12px;display:flex;gap:16px;flex-wrap:wrap;">
        <div style="text-align:center;flex:1;">
          <div id="stat-fiches" style="font-size:24px;font-weight:700;color:var(--blue);">0</div>
          <div style="font-size:11px;color:var(--muted);">Fiches sauvegardÃ©es</div>
        </div>
        <div style="text-align:center;flex:1;">
          <div id="stat-taille" style="font-size:24px;font-weight:700;color:var(--gold);">0 Ko</div>
          <div style="font-size:11px;color:var(--muted);">Espace utilisÃ©</div>
        </div>
        <div style="text-align:center;flex:1;">
          <div id="stat-backup" style="font-size:24px;font-weight:700;color:#2E7D32;">â€”</div>
          <div style="font-size:11px;color:var(--muted);">Dernier backup</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Partage par lien / QR Code -->
  <div class="export-section">
    <div class="export-section-header">
      <span style="font-size:18px;">ğŸ”—</span>
      <span>PARTAGER CETTE FICHE</span>
    </div>
    <div class="export-section-body">
      <p style="font-size:12px;color:#555;margin-bottom:14px;line-height:1.6;">
        Choisissez votre mÃ©thode de partage selon votre situation.
      </p>
      
      <div class="share-method-tabs">
        <button class="share-method-tab active" onclick="switchShareMethod('qr', this)">ğŸ·ï¸ QR RÃ©sumÃ©</button>
        <button class="share-method-tab" onclick="switchShareMethod('code', this)">ğŸ”‘ Code court</button>
        <button class="share-method-tab" onclick="switchShareMethod('email', this)">ğŸ“§ Email</button>
      </div>
      
      <!-- QR RÃ©sumÃ© (NOUVEAU - toujours fonctionne car encode seulement les infos essentielles) -->
      <div class="share-panel active" id="share-panel-qr">
        <div style="background:#E8F5E9;border-radius:8px;padding:10px 12px;font-size:11px;color:#2E7D32;margin-bottom:12px;line-height:1.5;">
          âœ… <strong>Ce QR Code fonctionne toujours</strong> car il encode uniquement le <strong>rÃ©sumÃ© de la fiche</strong> 
          (Professeur, Niveau, Module, Objectif) â€” pas le contenu complet. 
          Utile pour <strong>afficher en classe</strong>, coller sur un cahier, ou partager rapidement les infos.
        </div>
        <button class="btn-v3 btn-v3-primary" onclick="genererQRResume()" style="width:100%;justify-content:center;margin-bottom:14px;">
          ğŸ·ï¸ GÃ©nÃ©rer le QR RÃ©sumÃ©
        </button>
        <div class="qr-container" id="qr-container" style="display:none;">
          <canvas id="qr-canvas" width="220" height="220"></canvas>
          <div class="qr-info" id="qr-info-text">Le QR Code contient le rÃ©sumÃ© de la fiche.</div>
          <div id="qr-content-preview" style="width:100%;background:#F5F8FF;border-radius:8px;border:1px solid #E3EAF6;padding:10px;font-size:10px;color:#444;line-height:1.7;font-family:monospace;max-height:100px;overflow-y:auto;"></div>
          <button class="btn-v3 btn-v3-ghost" onclick="telechargerQR()" style="width:100%;justify-content:center;">â¬‡ï¸ TÃ©lÃ©charger QR (PNG)</button>
        </div>
        <div style="margin-top:14px;background:#FFF3E0;border:1px solid #FFB74D;border-radius:8px;padding:10px;font-size:11px;color:#E65100;line-height:1.5;">
          ğŸ’¡ <strong>Pour partager la fiche complÃ¨te</strong> (avec tout le contenu) : utilisez <strong>"ğŸ”‘ Code court"</strong> 
          (mÃªme appareil) ou <strong>"ğŸ“§ Email"</strong> avec export JSON (entre appareils).
        </div>
      </div>
      
      <!-- Code court (fonctionne sur Android WebView / APK) -->
      <div class="share-panel" id="share-panel-code">
        <div style="background:#E8F5E9;border-radius:8px;padding:10px 12px;font-size:11px;color:#2E7D32;margin-bottom:12px;line-height:1.5;">
          âœ… <strong>MÃ©thode recommandÃ©e sur Android/APK.</strong> GÃ©nÃ©rez un code court, envoyez-le par SMS ou WhatsApp. Votre collÃ¨gue l'entre dans son application.
        </div>
        <button class="btn-v3 btn-v3-primary" onclick="genererCodeCourt()" style="width:100%;justify-content:center;margin-bottom:14px;">
          ğŸ”‘ GÃ©nÃ©rer un code de partage
        </button>
        <div id="code-court-container" style="display:none;">
          <div style="text-align:center;margin-bottom:14px;">
            <div style="font-size:38px;font-weight:900;letter-spacing:6px;color:var(--blue);font-family:monospace;background:#E3F2FD;border-radius:12px;padding:16px;border:2px dashed var(--blue);" id="code-court-display">â€”â€”</div>
            <div style="font-size:11px;color:var(--muted);margin-top:6px;" id="code-court-expiry"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-v3 btn-v3-primary" onclick="copierCode()" style="flex:1;justify-content:center;">ğŸ“‹ Copier le code</button>
            <button class="btn-v3 btn-v3-ghost" onclick="partagerCodeWhatsApp()" style="flex:1;justify-content:center;">ğŸ’¬ WhatsApp</button>
          </div>
        </div>
        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px;">
          <div style="font-size:12px;font-weight:600;color:var(--blue-dark);margin-bottom:8px;">ğŸ“¥ Charger une fiche par code</div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="code-import-input" placeholder="Code (ex: A3F7X2K9)" maxlength="12"
              style="flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:monospace;font-size:18px;font-weight:700;text-transform:uppercase;letter-spacing:4px;text-align:center;"
              oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
            <button class="btn-v3 btn-v3-success" onclick="chargerParCode()">âœ… Charger</button>
          </div>
          <div id="code-import-status" style="font-size:11px;color:var(--muted);margin-top:6px;text-align:center;min-height:16px;"></div>
        </div>
      </div>
      
      <!-- Email -->
      <div class="share-panel" id="share-panel-email">
        <p style="font-size:12px;color:#555;margin-bottom:12px;line-height:1.6;">
          MÃ©thode la plus fiable : exportez le fichier JSON et envoyez-le par email. Votre collÃ¨gue l'importe dans son application.
        </p>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <button class="btn-v3 btn-v3-primary" onclick="partagerEmail('json')" style="justify-content:center;">
            ğŸ“§ PrÃ©parer email (fichier JSON)
          </button>
          <button class="btn-v3 btn-v3-ghost" onclick="partagerEmailCode()" style="justify-content:center;">
            ğŸ“§ Envoyer le code par email
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section AperÃ§u amÃ©liorÃ© -->
  <div class="export-section">
    <div class="export-section-header">
      <span style="font-size:18px;">ğŸ–¨ï¸</span>
      <span>GÃ‰NÃ‰RATION RAPIDE</span>
    </div>
    <div class="export-section-body">
      <div class="export-btn-grid">
        <button class="btn-v3 btn-v3-primary" onclick="genererPDF()" style="width:100%;justify-content:center;">
          ğŸ“„ GÃ©nÃ©rer PDF
        </button>
        <button class="btn-v3" onclick="genererDOCX()" style="width:100%;justify-content:center;background:#1B5E20;color:white;">
          ğŸ“ GÃ©nÃ©rer DOCX
        </button>
      </div>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- BOUTON FLOTTANT : APERÃ‡U RAPIDE                     -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<button class="floating-preview-btn" onclick="showTab('apercu')" title="AperÃ§u rapide de la fiche">
  ğŸ‘ï¸ AperÃ§u
</button>

<!-- INPUT FILE cachÃ© pour l'import JSON -->
<input type="file" id="import-json-input" accept=".json" style="display:none" onchange="lireJSONImporte(event)">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL : INSERTION DE TABLEAU                       -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-tableau">
  <div class="modal-box">
    <div class="modal-title">âŠ InsÃ©rer un tableau</div>
    <div class="modal-field">
      <label>Nombre de colonnes</label>
      <input type="number" id="tbl-cols" value="3" min="1" max="10">
    </div>
    <div class="modal-field">
      <label>Nombre de lignes</label>
      <input type="number" id="tbl-rows" value="3" min="1" max="20">
    </div>
    <label class="modal-check">
      <input type="checkbox" id="tbl-header" checked>
      PremiÃ¨re ligne en en-tÃªte
    </label>
    <div class="modal-actions">
      <button class="btn-modal-cancel" onclick="fermerModalTableau()">Annuler</button>
      <button class="btn-modal-ok" onclick="insererTableauQuill()">âŠ InsÃ©rer</button>
    </div>
  </div>
</div>


<!-- PANNEAU REDIMENSIONNEMENT IMAGE -->
<div id="img-resize-panel">
  <div class="rp-head">
    <span>ğŸ–¼ Taille de l'image</span>
    <span class="rp-dims" id="rp-dims-orig"></span>
  </div>
  <div class="rp-row">
    <span class="rp-lbl">Largeur</span>
    <input type="range" id="rp-range" min="5" max="100" value="100" step="1"
           oninput="rpUpdateFromRange(this.value)">
  </div>
  <div class="rp-row">
    <span class="rp-lbl">En pixels</span>
    <input type="number" id="rp-px" min="10" max="3000" step="1"
           oninput="rpUpdateFromPx(this.value)">
    <span class="rp-unit">px</span>
    <span style="color:var(--muted);font-size:10px;">Ã—</span>
    <input type="number" id="rp-py" min="10" max="3000" step="1" style="width:60px"
           oninput="rpUpdateFromPy(this.value)">
    <span class="rp-unit">px</span>
  </div>
  <div class="rp-presets">
    <button class="rp-pre" onclick="rpSetPct(25)">25%</button>
    <button class="rp-pre" onclick="rpSetPct(50)">50%</button>
    <button class="rp-pre" onclick="rpSetPct(75)">75%</button>
    <button class="rp-pre" onclick="rpSetPct(100)">100%</button>
  </div>
  <div class="rp-info" id="rp-preview-size"></div>
  <div class="rp-btns">
    <button class="rp-btn rp-cancel" onclick="rpFermer(false)">Annuler</button>
    <button class="rp-btn rp-ok" onclick="rpAppliquer()">âœ” Appliquer</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">âœ… PDF gÃ©nÃ©rÃ© et tÃ©lÃ©chargÃ© !</div>

<!-- BibliothÃ¨ques externes â€” chargÃ©es depuis le cache du Service Worker si hors ligne -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
  onerror="document.getElementById('libs-warn').style.display='block'"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
  onerror="document.getElementById('libs-warn').style.display='block'"></script>

<div id="libs-warn" style="display:none; background:#FFF3E0; border-left:4px solid #E65100; padding:12px 16px; margin:12px 16px; border-radius:8px; font-size:13px; color:#BF360C; font-family:'Source Serif 4',serif;">
  âš ï¸ <strong>BibliothÃ¨ques non chargÃ©es (PDF & Word).</strong><br>
  â€¢ Si vous Ãªtes <strong>hors ligne</strong> : Ces bibliothÃ¨ques seront disponibles aprÃ¨s une premiÃ¨re visite en ligne.<br>
  â€¢ Si vous Ãªtes <strong>en ligne</strong> : Rechargez la page et attendez quelques secondes.
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  var panel = document.getElementById('panel-' + name);
  var tab   = document.getElementById('tab-'   + name);
  if (panel) panel.classList.add('active');
  if (tab)   tab.classList.add('active');
  if (name === 'apercu')    { rafraichirApercu(); genererPreviewLive(); }
  if (name === 'repertoire') afficherRepertoire();
  if (name === 'modeles')    rendreTousLesModeles();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION DES Ã‰TAPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let etapeCount = 0;

function ajouterEtape(data) {
  etapeCount++;
  const n = etapeCount;
  const d = data || {};
  const container = document.getElementById('etapes-container');

  const div = document.createElement('div');
  div.className = 'etape-card';
  div.id = 'etape-' + n;
  div.innerHTML = `
    <div class="etape-header">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="etape-num etape-num-${n}">${n}</div>
        <h3 class="etape-titre-${n}">Ã‰tape ${n}</h3>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <button class="btn-move-etape" onclick="monterEtape('etape-${n}')" title="Monter">â–²</button>
        <button class="btn-move-etape" onclick="descendreEtape('etape-${n}')" title="Descendre">â–¼</button>
        <button class="btn-remove-etape" onclick="supprimerEtape(${n})">âœ• Supprimer</button>
      </div>
    </div>
    <div class="etape-body">
      <div class="field">
        <label>Nom de l'Ã©tape <span class="required">*</span></label>
        <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
          <button type="button" class="format-btn" onclick="toggleFormat('e${n}-nom', 'bold')" title="Gras"><b>B</b></button>
          <button type="button" class="format-btn" onclick="toggleFormat('e${n}-nom', 'italic')" title="Italique"><i>I</i></button>
          <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('e${n}-nom', this.value)" title="Couleur du texte" value="#000000">
          <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('e${n}-nom', this.value)" title="Couleur de surlignage" value="#FFFFFF">
        </div>
        <div id="e${n}-nom" contenteditable="true" class="editable-input" data-placeholder="Ex : Mise en route, PrÃ©sentationâ€¦">${d.nom||''}</div>
      </div>
      <div class="field">
        <label>DÃ©roulement de la sÃ©ance <span class="required">*</span></label>
        <div id="e${n}-enseignant-wrapper" class="quill-wrapper tall"></div>
      </div>
      <div class="field field-duree">
        <label>DurÃ©e</label>
        <input type="text" id="e${n}-duree" placeholder="Ex : 10 min" value="${d.duree||''}">
      </div>
    </div>
  `;
  container.appendChild(div);
  
  // Initialiser l'Ã©diteur Quill pour cette Ã©tape
  setTimeout(() => {
    initQuillEditor(`e${n}-enseignant-wrapper`, 'Coller ici le dÃ©roulement complet de la sÃ©ance : actions de l\'enseignant, tÃ¢ches des apprenants, consignes, questions, exercicesâ€¦');
    // Si on restaure des donnÃ©es, les injecter
    if (d.enseignant) {
      setQuillHTML(`e${n}-enseignant-wrapper`, d.enseignant);
    }
    // Ajouter les champs colonnes supplÃ©mentaires si existantes
    rafraichirChampsEtapes();
    // Restaurer les valeurs des colonnes supplÃ©mentaires si prÃ©sentes
    if (d.supVals) {
      Object.keys(d.supVals).forEach(colN => {
        const el = document.getElementById('e'+n+'-colsup-'+colN);
        if (el && d.supVals[colN]) {
          if (el.contentEditable === 'true') {
            el.innerHTML = d.supVals[colN];
          } else {
            el.value = d.supVals[colN];
          }
        }
      });
    }
  }, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUILL.JS â€” INITIALISATION DES Ã‰DITEURS RICHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let quillInstances = {};

// â”€â”€ Enregistrer les polices personnalisÃ©es dans Quill â”€â”€
const QuillFont = Quill.import('formats/font');
QuillFont.whitelist = ['times','georgia','merriweather','roboto','lato','opensans','courier'];
Quill.register(QuillFont, true);

let activeQuillWrapper = null;
let toolbarCount = 0;

function initQuillEditor(wrapperId, placeholder = '') {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return null;

  // â”€â”€ CrÃ©er la toolbar HTML AVANT Quill, dans le wrapper parent â”€â”€
  // On insÃ¨re un div toolbar au-dessus du wrapper, puis on crÃ©e un div Ã©diteur dedans.
  toolbarCount++;
  const tbId = 'ql-tb-' + toolbarCount;
  const edId = 'ql-ed-' + toolbarCount;
  const colorPickerId = 'color-picker-' + toolbarCount;
  const bgPickerId = 'bg-picker-' + toolbarCount;

  // Vider le wrapper et y injecter toolbar + zone Ã©diteur
  wrapper.innerHTML = `
    <div id="${tbId}" class="ql-custom-toolbar-wrap">
      <span class="ql-formats">
        <select class="ql-font" title="Police">
          <option selected value="">Sans-sÃ©rif</option>
          <option value="times">Times Roman</option>
          <option value="georgia">Georgia</option>
          <option value="merriweather">Merriweather</option>
          <option value="roboto">Roboto</option>
          <option value="lato">Lato</option>
          <option value="opensans">Open Sans</option>
          <option value="courier">Courier</option>
        </select>
      </span>
      <span class="ql-formats">
        <select class="ql-header" title="Style d'Ã©criture">
          <option value="1">Titre 1</option>
          <option value="2">Titre 2</option>
          <option value="3">Titre 3</option>
          <option selected value="">Normal</option>
        </select>
      </span>
      <span class="ql-formats">
        <button class="ql-custom-size" data-size="small"  title="Petit"     type="button" onclick="appliquerTaille('${wrapperId}','small');  return false;"><span style="font-size:9px;font-weight:700;">A</span></button>
        <button class="ql-custom-size" data-size=""        title="Normal"    type="button" onclick="appliquerTaille('${wrapperId}','');       return false;"><span style="font-size:12px;font-weight:700;">A</span></button>
        <button class="ql-custom-size" data-size="large"  title="Grand"     type="button" onclick="appliquerTaille('${wrapperId}','large');  return false;"><span style="font-size:15px;font-weight:700;">A</span></button>
        <button class="ql-custom-size" data-size="huge"   title="TrÃ¨s grand" type="button" onclick="appliquerTaille('${wrapperId}','huge');   return false;"><span style="font-size:18px;font-weight:700;">A</span></button>
      </span>
      <span class="ql-formats">
        <button class="ql-bold"      title="Gras"></button>
        <button class="ql-italic"    title="Italique"></button>
        <button class="ql-underline" title="SoulignÃ©"></button>
      </span>
      <span class="ql-formats">
        <input type="color" id="${colorPickerId}" class="color-picker-btn" title="Couleur du texte" value="#000000">
        <input type="color" id="${bgPickerId}" class="color-picker-btn" title="Couleur de surlignage" value="#FFFF00">
      </span>
      <span class="ql-formats">
        <button class="ql-list" value="ordered" title="Liste numÃ©rotÃ©e"></button>
        <button class="ql-list" value="bullet"  title="Liste Ã  puces"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-custom-image"  title="InsÃ©rer une image"   type="button" onclick="(function(){ activeQuillWrapper='${wrapperId}'; ouvrirSelecteurImage('${wrapperId}'); })(); return false;">ğŸ–¼</button>
        <button class="ql-custom-table"  title="InsÃ©rer un tableau"  type="button" onclick="(function(){ activeQuillWrapper='${wrapperId}'; ouvrirModalTableau(); })(); return false;">âŠ</button>
      </span>
      <span class="ql-formats">
        <button class="ql-clean" title="Effacer le formatage"></button>
      </span>
    </div>
    <div id="${edId}"></div>
  `;

  // Initialiser Quill sur le div Ã©diteur, en pointant vers la toolbar custom
  const quill = new Quill('#' + edId, {
    theme: 'snow',
    modules: {
      toolbar: '#' + tbId
    },
    placeholder: placeholder
  });

  // â”€â”€ Connecter les sÃ©lecteurs de couleur personnalisÃ©s â”€â”€
  const colorPicker = document.getElementById(colorPickerId);
  const bgPicker = document.getElementById(bgPickerId);
  
  if (colorPicker) {
    colorPicker.addEventListener('change', function() {
      const range = quill.getSelection();
      if (range) {
        if (range.length === 0) {
          // Pas de sÃ©lection : appliquer au prochain caractÃ¨re
          quill.format('color', this.value);
        } else {
          // Il y a une sÃ©lection : appliquer Ã  la sÃ©lection
          quill.formatText(range.index, range.length, 'color', this.value);
        }
      }
    });
  }
  
  if (bgPicker) {
    bgPicker.addEventListener('change', function() {
      const range = quill.getSelection();
      if (range) {
        if (range.length === 0) {
          // Pas de sÃ©lection : appliquer au prochain caractÃ¨re
          quill.format('background', this.value);
        } else {
          // Il y a une sÃ©lection : appliquer Ã  la sÃ©lection
          quill.formatText(range.index, range.length, 'background', this.value);
        }
      }
    });
  }

  // DÃ©clencher updateLivePreview quand le contenu change
  quill.on('text-change', function() {
    if (wrapperId === 'objectif-wrapper') {
      updateLivePreview();
    }
  });

  quillInstances[wrapperId] = quill;
  return quill;

}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE â€” SÃ‰LECTION ET INSERTION DANS QUILL

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE â€” SÃ‰LECTION ET INSERTION DANS QUILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ouvrirSelecteurImage(wrapperId) {
  // CrÃ©er un input file temporaire
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/png,image/jpeg,image/gif,image/webp';
  input.style.display = 'none';
  document.body.appendChild(input);
  input.addEventListener('change', function() {
    const file = input.files[0];
    if (!file) { document.body.removeChild(input); return; }
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      insererImageQuill(wrapperId, dataUrl);
      document.body.removeChild(input);
    };
    reader.readAsDataURL(file);
  });
  input.click();
}

function insererImageQuill(wrapperId, dataUrl) {
  const quill = quillInstances[wrapperId];
  if (!quill) return;
  const range = quill.getSelection(true);
  const index = range ? range.index : quill.getLength();
  quill.insertEmbed(index, 'image', dataUrl, Quill.sources.USER);
  quill.setSelection(index + 1, Quill.sources.SILENT);
  // Ouvrir automatiquement le panneau de redimensionnement aprÃ¨s insertion
  setTimeout(() => {
    const imgs = quill.root.querySelectorAll('img');
    const img = imgs[imgs.length - 1];
    if (img) rpOuvrir(img, wrapperId);
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REDIMENSIONNEMENT D'IMAGE â€” PANNEAU FLOTTANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _rpImg   = null;   // <img> en cours
let _rpWId   = null;   // wrapperId Quill
let _rpNatW  = 1;      // largeur naturelle originale
let _rpNatH  = 1;      // hauteur naturelle originale
let _rpSavedW = null;  // taille avant ouverture (pour annuler)
let _rpSavedH = null;

function rpOuvrir(imgEl, wrapperId) {
  _rpImg  = imgEl;
  _rpWId  = wrapperId;

  // Charger les dimensions naturelles (stockÃ©es en data ou lues)
  const tmp = new Image();
  tmp.src = imgEl.src;
  _rpNatW = parseInt(imgEl.getAttribute('data-nat-w')) || tmp.naturalWidth  || imgEl.naturalWidth  || 400;
  _rpNatH = parseInt(imgEl.getAttribute('data-nat-h')) || tmp.naturalHeight || imgEl.naturalHeight || 300;
  // Stocker les dims naturelles sur l'Ã©lÃ©ment pour usage futur
  if (!imgEl.getAttribute('data-nat-w')) imgEl.setAttribute('data-nat-w', _rpNatW);
  if (!imgEl.getAttribute('data-nat-h')) imgEl.setAttribute('data-nat-h', _rpNatH);

  // Taille actuelle
  const curW = parseInt(imgEl.getAttribute('data-w') || imgEl.style.width) || _rpNatW;
  const curH = parseInt(imgEl.getAttribute('data-h') || imgEl.style.height) || _rpNatH;
  _rpSavedW = curW; _rpSavedH = curH;

  // Mettre en Ã©vidence l'image
  document.querySelectorAll('.ql-editor img').forEach(i => i.classList.remove('img-selected'));
  imgEl.classList.add('img-selected');

  // Remplir le panneau
  document.getElementById('rp-dims-orig').textContent = _rpNatW + ' Ã— ' + _rpNatH + ' px (original)';
  document.getElementById('rp-px').value = curW;
  document.getElementById('rp-py').value = curH;
  const pct = Math.round((curW / _rpNatW) * 100);
  document.getElementById('rp-range').value = Math.min(pct, 100);
  rpUpdateInfo(curW, curH);
  rpHighlightPreset(pct);

  // Positionner le panneau (fixed, prÃ¨s de l'image)
  const panel = document.getElementById('img-resize-panel');
  const rect  = imgEl.getBoundingClientRect();
  let top  = rect.bottom + 8;
  let left = rect.left;
  // Garder dans la fenÃªtre
  const pw = 270;
  if (left + pw > window.innerWidth - 12) left = window.innerWidth - pw - 12;
  if (left < 8) left = 8;
  if (top + 280 > window.innerHeight) top = Math.max(8, rect.top - 290);
  panel.style.top  = top  + 'px';
  panel.style.left = left + 'px';
  panel.classList.add('show');
}

function rpFermer(apply) {
  if (!apply && _rpImg && _rpSavedW) {
    // Restaurer la taille d'avant
    _rpImg.style.width  = _rpSavedW + 'px';
    _rpImg.style.height = _rpSavedH + 'px';
  }
  document.querySelectorAll('.ql-editor img').forEach(i => i.classList.remove('img-selected'));
  document.getElementById('img-resize-panel').classList.remove('show');
  _rpImg = null; _rpWId = null;
}

function rpAppliquer() {
  if (!_rpImg) { rpFermer(true); return; }
  const w = parseInt(document.getElementById('rp-px').value) || _rpNatW;
  const h = parseInt(document.getElementById('rp-py').value) || _rpNatH;
  _rpImg.style.width  = w + 'px';
  _rpImg.style.height = h + 'px';
  _rpImg.setAttribute('data-w', w);
  _rpImg.setAttribute('data-h', h);
  // Forcer la mise Ã  jour Quill
  const quill = _rpWId ? quillInstances[_rpWId] : null;
  if (quill) quill.update();
  rpFermer(true);
}

function rpUpdateFromRange(pct) {
  const w = Math.max(10, Math.round((parseInt(pct) / 100) * _rpNatW));
  const h = Math.round(w * (_rpNatH / (_rpNatW || 1)));
  document.getElementById('rp-px').value = w;
  document.getElementById('rp-py').value = h;
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(parseInt(pct));
}

function rpUpdateFromPx(val) {
  const w = Math.max(10, parseInt(val) || 10);
  const h = Math.round(w * (_rpNatH / (_rpNatW || 1)));
  document.getElementById('rp-py').value = h;
  const pct = Math.round((w / _rpNatW) * 100);
  document.getElementById('rp-range').value = Math.min(pct, 100);
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(pct);
}

function rpUpdateFromPy(val) {
  const h = Math.max(10, parseInt(val) || 10);
  const w = Math.round(h * (_rpNatW / (_rpNatH || 1)));
  document.getElementById('rp-px').value = w;
  const pct = Math.round((w / _rpNatW) * 100);
  document.getElementById('rp-range').value = Math.min(pct, 100);
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(pct);
}

function rpSetPct(pct) {
  const w = Math.round((pct / 100) * _rpNatW);
  const h = Math.round(w * (_rpNatH / (_rpNatW || 1)));
  document.getElementById('rp-px').value    = w;
  document.getElementById('rp-py').value    = h;
  document.getElementById('rp-range').value = pct;
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(pct);
}

function rpPreviewLive(w, h) {
  if (!_rpImg) return;
  _rpImg.style.width  = w + 'px';
  _rpImg.style.height = h + 'px';
}

function rpUpdateInfo(w, h) {
  document.getElementById('rp-preview-size').textContent =
    'AperÃ§u : ' + w + ' Ã— ' + h + ' px';
}

function rpHighlightPreset(pct) {
  document.querySelectorAll('#img-resize-panel .rp-pre').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.textContent) === pct);
  });
}

// Ã‰coute globale : clic sur image Quill â†’ ouvrir panneau
document.addEventListener('click', function(e) {
  const target = e.target;
  const panel  = document.getElementById('img-resize-panel');
  if (target.tagName === 'IMG' && target.closest('.ql-editor')) {
    e.preventDefault(); e.stopPropagation();
    const wrapper = target.closest('.quill-wrapper');
    rpOuvrir(target, wrapper ? wrapper.id : null);
    return;
  }
  // Fermer si clic hors panneau et hors image
  if (panel && panel.classList.contains('show') && !panel.contains(target) && target.tagName !== 'IMG') {
    rpFermer(false);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLEAU â€” MODAL ET INSERTION DANS QUILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ouvrirModalTableau() {
  document.getElementById('modal-tableau').classList.add('show');
}

function fermerModalTableau() {
  document.getElementById('modal-tableau').classList.remove('show');
}

// Fermer le modal en cliquant l'overlay
document.getElementById('modal-tableau').addEventListener('click', function(e) {
  if (e.target === this) fermerModalTableau();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SÃ‰LECTEUR DE SYMBOLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYMBOLES = {
  fleches: {
    label: 'FlÃ¨ches',
    groupes: [
      { titre: 'Directions simples', syms: ['â†’','â†','â†‘','â†“','â†”','â†•','â†—','â†˜','â†™','â†–'] },
      { titre: 'Doubles', syms: ['â‡’','â‡','â‡‘','â‡“','â‡”','â‡•','â‡—','â‡˜'] },
      { titre: 'Longues', syms: ['âŸ¶','âŸµ','âŸ·','âŸ¹','âŸ¸','âŸº'] },
      { titre: 'StylisÃ©es', syms: ['âœ','â¡','â¢','â¤','â¥','â¦','â§','â¨','â©','âª','â«','â¬','â­','â®','â¯','â±'] },
      { titre: 'Triangles / Pointeurs', syms: ['â–¶','â—€','â–²','â–¼','â–º','â—„','â–¸','â—‚','â–´','â–¾','âŠ³','âŠ²'] },
      { titre: 'CourbÃ©es / SpÃ©ciales', syms: ['â†©','â†ª','â†«','â†¬','â†­','â†°','â†±','â†²','â†³','â†´','â†µ','â†·','â†¶','âŸ³','âŸ²','â†º','â†»'] },
    ]
  },
  puces: {
    label: 'Puces & Listes',
    groupes: [
      { titre: 'Puces classiques', syms: ['â€¢','â—¦','â–ª','â–«','â–¸','â–¹','â€£','âƒ','â¦¾','â¦¿'] },
      { titre: 'CarrÃ©s & Rectangles', syms: ['â– ','â–¡','â–ª','â–«','â–¬','â–­','â–®','â–¯','â—¼','â—»','â—¾','â—½'] },
      { titre: 'Cercles & Ovales', syms: ['â—','â—‹','â—‰','â—','â—Œ','â—','â—”','â—•','â¬¤','â­•'] },
      { titre: 'Losanges & Ã‰toiles', syms: ['â—†','â—‡','â—ˆ','â¬¥','â¬¦','â–','âœ¦','âœ§','âœ¶','âœ·'] },
      { titre: 'Coches & Croix', syms: ['âœ“','âœ”','âœ—','âœ˜','â˜‘','â˜’','âœ…','âŒ','â','â˜'] },
    ]
  },
  maths: {
    label: 'MathÃ©matiques',
    groupes: [
      { titre: 'OpÃ©rateurs', syms: ['Â±','Ã—','Ã·','Â·','âˆ™','âˆš','âˆ›','âˆœ','âˆ','%','â€°','â€±'] },
      { titre: 'Relations', syms: ['=','â‰ ','â‰¡','â‰¢','â‰ˆ','â‰‰','â‰¤','â‰¥','â‰ª','â‰«','â‰º','â‰»','âŠ‚','âŠƒ','âŠ„','âŠ…','âŠ†','âŠ‡'] },
      { titre: 'Logique & Ensembles', syms: ['âˆ§','âˆ¨','Â¬','âˆ€','âˆƒ','âˆ„','âˆ…','âˆ©','âˆª','âˆˆ','âˆ‰','âˆ‹','âˆŒ'] },
      { titre: 'Lettres grecques', syms: ['Î±','Î²','Î³','Î´','Îµ','Î¶','Î·','Î¸','Î¹','Îº','Î»','Î¼','Î½','Î¾','Ï€','Ï','Ïƒ','Ï„','Ï…','Ï†','Ï‡','Ïˆ','Ï‰','Î”','Î£','Î ','Î©'] },
      { titre: 'Calcul', syms: ['âˆ‚','âˆ‡','âˆ«','âˆ¬','âˆ­','âˆ®','âˆ‘','âˆ','âˆ','âŒ€','âŒ'] },
      { titre: 'Fractions', syms: ['Â½','â…“','â…”','Â¼','Â¾','â…•','â…–','â…—','â…˜','â…™','â…š','â…›','â…œ','â…','â…'] },
    ]
  },
  etoiles: {
    label: 'Ã‰toiles & Formes',
    groupes: [
      { titre: 'Ã‰toiles', syms: ['â˜…','â˜†','âœ©','âœª','âœ«','âœ¬','âœ­','âœ®','âœ¯','âœ°','â­','ğŸŒŸ'] },
      { titre: 'CÅ“urs', syms: ['â™¥','â™¡','â¤','â¥','â£','â¦','â§','ğŸ’™','ğŸ’š','ğŸ’›','ğŸ’œ','ğŸ–¤'] },
      { titre: 'Fleurs & Nature', syms: ['âœ¿','â€','â','â‚','âƒ','âœ¾','âš˜','â˜˜','ğŸŒ¿','ğŸ€'] },
      { titre: 'Symboles divers', syms: ['â˜€','â˜','â˜‚','â˜ƒ','â˜„','âš¡','âš¡','â˜','âœ‰','âœ‚','âœ','âœ’','ğŸ”‘','ğŸ”’','ğŸ”“'] },
      { titre: 'MÃ©dailles & TrophÃ©es', syms: ['ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ–','ğŸ…','ğŸ—','ğŸ¯','ğŸª','ğŸ¨'] },
    ]
  },
  ponctuation: {
    label: 'Ponctuation',
    groupes: [
      { titre: 'Guillemets', syms: ['Â«','Â»','â€¹','â€º','"','"','â€','â€Ÿ','â€š','\'','\u2018','\u2019'] },
      { titre: 'Tirets & Traits', syms: ['â€“','â€”','â€•','â€’','â€‘','â€','-','_','~','â‰ˆ','â‰¡'] },
      { titre: 'Points & Ellipses', syms: ['â€¦','Â·','â€¢','â€¥','â€','â','â“'] },
      { titre: 'Symboles spÃ©ciaux', syms: ['Â©','Â®','â„¢','â„ƒ','â„‰','Â°','â„–','â„—','â„ ','â„¡'] },
      { titre: 'Monnaies', syms: ['â‚¬','Â£','Â¥','Â¢','â‚¹','â‚½','â‚¿','â‚º','â‚©','â‚ª'] },
    ]
  },
  exposants: {
    label: 'Exp. & Indices',
    groupes: [
      { titre: 'Exposants chiffres', syms: ['â°','Â¹','Â²','Â³','â´','âµ','â¶','â·','â¸','â¹'] },
      { titre: 'Exposants lettres', syms: ['áµƒ','áµ‡','á¶œ','áµˆ','áµ‰','á¶ ','áµ','Ê°','â±','Ê²','áµ','Ë¡','áµ','â¿','áµ’','áµ–','Ê³','Ë¢','áµ—','áµ˜','áµ›','Ê·','Ë£','Ê¸','á¶»'] },
      { titre: 'Indices chiffres', syms: ['â‚€','â‚','â‚‚','â‚ƒ','â‚„','â‚…','â‚†','â‚‡','â‚ˆ','â‚‰'] },
      { titre: 'Indices lettres', syms: ['â‚','â‚‘','â‚’','â‚“','â‚™','â‚˜','â‚–','â‚œ','â‚›','áµ¢','áµ¤','áµ¥'] },
    ]
  }
};

let activeSymTab = 'fleches';
let symPickerBtnEl = null;

function showSymTab(tabId, btnEl) {
  activeSymTab = tabId;
  // Mettre Ã  jour les onglets actifs
  document.querySelectorAll('.sym-tab').forEach(b => b.classList.remove('active'));
  btnEl.classList.add('active');
  renderSymTab(tabId);
}

function renderSymTab(tabId) {
  const body = document.getElementById('sym-body');
  const data = SYMBOLES[tabId];
  if (!data) return;
  let html = '';
  data.groupes.forEach(grp => {
    html += `<div class="sym-label">${grp.titre}</div>`;
    html += `<div class="sym-grid">`;
    grp.syms.forEach(sym => {
      // Encoder le symbole pour l'attribut data
      html += `<button class="sym-btn" title="${sym}" type="button" onclick="insererSymbole(this.dataset.sym)" data-sym="${encodeURIComponent(sym)}">${sym}</button>`;
    });
    html += `</div>`;
  });
  body.innerHTML = html;
}

// â”€â”€ TAILLE DE POLICE VIA BOUTONS A â”€â”€
function appliquerTaille(wrapperId, size) {
  const quill = quillInstances[wrapperId];
  if (!quill) return;
  const selection = quill.getSelection(true);
  if (selection && selection.length > 0) {
    quill.format('size', size || false);
  } else {
    quill.format('size', size || false);
  }
  // Feedback visuel : marquer le bouton actif
  const wrapper = document.getElementById(wrapperId);
  if (wrapper) {
    wrapper.querySelectorAll('.ql-custom-size').forEach(btn => {
      btn.style.background = btn.dataset.size === size ? '#E3F2FD' : '';
      btn.style.borderColor = btn.dataset.size === size ? '#1565C0' : '';
    });
  }
}

function ouvrirSymbolPicker(btnEl) {
  const picker = document.getElementById('symbol-picker');
  const isOpen = picker.classList.contains('show');

  // Retirer la classe active de tous les anciens boutons Î©
  document.querySelectorAll('.ql-custom-symbol').forEach(b => b.classList.remove('active'));

  if (isOpen && symPickerBtnEl === btnEl) {
    // DÃ©jÃ  ouvert sur ce bouton â†’ fermer
    fermerSymbolPicker();
    return;
  }

  symPickerBtnEl = btnEl;
  btnEl.classList.add('active');

  // Rendre le contenu de l'onglet actif
  renderSymTab(activeSymTab);

  // Positionner le panneau sous le bouton
  const rect = btnEl.getBoundingClientRect();
  const pickerW = 300;
  const pickerH = 380;
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  let left = rect.left;
  let top = rect.bottom + 4;

  // Ajustement horizontal si dÃ©bordement
  if (left + pickerW > vw - 8) left = vw - pickerW - 8;
  if (left < 8) left = 8;

  // Ajustement vertical : si pas assez de place en bas, afficher au-dessus
  if (top + pickerH > vh - 8) top = rect.top - pickerH - 4;
  if (top < 8) top = 8;

  picker.style.left = left + 'px';
  picker.style.top = top + 'px';
  picker.classList.add('show');

  // Fermer si clic en dehors (avec un lÃ©ger dÃ©lai pour Ã©viter l'auto-fermeture)
  setTimeout(() => {
    document.addEventListener('mousedown', fermerSymPickerSiExterieur);
    document.addEventListener('touchstart', fermerSymPickerSiExterieur, { passive: true });
  }, 100);
}

function fermerSymPickerSiExterieur(e) {
  const picker = document.getElementById('symbol-picker');
  if (!picker.contains(e.target) && e.target !== symPickerBtnEl) {
    fermerSymbolPicker();
  }
}

function fermerSymbolPicker() {
  const picker = document.getElementById('symbol-picker');
  picker.classList.remove('show');
  if (symPickerBtnEl) symPickerBtnEl.classList.remove('active');
  symPickerBtnEl = null;
  document.removeEventListener('mousedown', fermerSymPickerSiExterieur);
  document.removeEventListener('touchstart', fermerSymPickerSiExterieur);
}

function insererSymbole(encodedSym) {
  const sym = decodeURIComponent(encodedSym);
  const quill = quillInstances[activeQuillWrapper];
  if (!quill) return;
  const range = quill.getSelection(true);
  const index = range ? range.index : quill.getLength();
  quill.insertText(index, sym, Quill.sources.USER);
  quill.setSelection(index + sym.length, Quill.sources.SILENT);
  // Ne pas fermer â†’ permet d'insÃ©rer plusieurs symboles Ã  la suite
}

function insererTableauQuill() {
  const cols   = Math.max(1, Math.min(10, parseInt(document.getElementById('tbl-cols').value)  || 3));
  const rows   = Math.max(1, Math.min(20, parseInt(document.getElementById('tbl-rows').value)  || 3));
  const header = document.getElementById('tbl-header').checked;

  const quill = quillInstances[activeQuillWrapper];
  if (!quill) { fermerModalTableau(); return; }

  // Construire le HTML du tableau
  let html = '<table><tbody>';
  for (let r = 0; r < rows; r++) {
    html += '<tr>';
    for (let c = 0; c < cols; c++) {
      if (r === 0 && header) {
        html += '<th style="border:1.5px solid #1565C0;padding:5px 8px;background:#E3F2FD;font-weight:700;text-align:center;">En-tÃªte ' + (c+1) + '</th>';
      } else {
        html += '<td style="border:1.5px solid #1565C0;padding:5px 8px;min-width:50px;">&nbsp;</td>';
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table><p><br></p>';

  // InsÃ©rer Ã  la position courante
  const range = quill.getSelection(true);
  const index = range ? range.index : quill.getLength();
  quill.clipboard.dangerouslyPasteHTML(index, html, Quill.sources.USER);
  quill.setSelection(index + 1, Quill.sources.SILENT);

  fermerModalTableau();
}

// Fonction pour obtenir le HTML d'un Ã©diteur Quill
function getQuillHTML(wrapperId) {
  const quill = quillInstances[wrapperId];
  if (!quill) return '';
  return quill.root.innerHTML;
}

// Fonction pour obtenir le texte brut d'un Ã©diteur Quill
function getQuillText(wrapperId) {
  const quill = quillInstances[wrapperId];
  if (!quill) return '';
  return quill.getText().trim();
}

// Fonction pour dÃ©finir le contenu HTML d'un Ã©diteur Quill
function setQuillHTML(wrapperId, html) {
  const quill = quillInstances[wrapperId];
  if (!quill) return;
  if (html) {
    quill.root.innerHTML = html;
  }
}

// Initialiser l'Ã©diteur Quill pour l'objectif au chargement
document.addEventListener('DOMContentLoaded', function() {
  initQuillEditor('objectif-wrapper', 'Objectif de la sÃ©anceâ€¦');
});


function supprimerEtape(n) {
  const el = document.getElementById('etape-' + n);
  if (el) el.remove();
  mettreAJourNumeros();
  calculerDureeTotale();
  sauvegarderAutomatique();
}

// â”€â”€ MONTER / DESCENDRE UNE Ã‰TAPE â”€â”€
function monterEtape(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const prev = el.previousElementSibling;
  if (prev && prev.classList.contains('etape-card')) {
    el.parentNode.insertBefore(el, prev);
    mettreAJourNumeros();
    sauvegarderAutomatique();
  }
}
function descendreEtape(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const next = el.nextElementSibling;
  if (next && next.classList.contains('etape-card')) {
    el.parentNode.insertBefore(next, el);
    mettreAJourNumeros();
    sauvegarderAutomatique();
  }
}
// Recalculer les numÃ©ros affichÃ©s aprÃ¨s dÃ©placement
function mettreAJourNumeros() {
  document.querySelectorAll('.etape-card').forEach((card, i) => {
    const num = card.querySelector('.etape-num');
    if (num) num.textContent = i + 1;
  });
}

// â”€â”€ CALCUL DURÃ‰E TOTALE â”€â”€
function calculerDureeTotale() {
  let totalMin = 0;
  let hasVal = false;
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    const dureeStr = (document.getElementById('e' + id + '-duree')?.value || '').trim();
    if (!dureeStr) return;
    const match = dureeStr.match(/(\d+[\.,]?\d*)/);
    if (match) {
      totalMin += parseFloat(match[1].replace(',', '.'));
      hasVal = true;
    }
  });
  const el = document.getElementById('duree-totale-val');
  if (!el) return;
  if (!hasVal) { el.textContent = 'â€”'; return; }
  if (totalMin >= 60) {
    const h = Math.floor(totalMin / 60);
    const m = Math.round(totalMin % 60);
    el.textContent = m > 0 ? `${h}h${String(m).padStart(2,'0')} (${Math.round(totalMin)} min)` : `${h}h00 (${Math.round(totalMin)} min)`;
  } else {
    el.textContent = `${Math.round(totalMin)} min`;
  }
}

// â”€â”€ SAUVEGARDE AUTOMATIQUE (localStorage) â”€â”€
const SAVE_KEY = 'fiche_ped_autosave';

function sauvegarderAutomatique() {
  try {
    const data = collecterTout();
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    afficherStatutSauvegarde('âœ… SauvegardÃ© automatiquement', '#2E7D32');
  } catch(e) { /* silencieux */ }
}

function afficherStatutSauvegarde(msg, color) {
  const bar = document.getElementById('save-bar');
  const st  = document.getElementById('save-status');
  if (!bar || !st) return;
  bar.style.display = 'flex';
  st.textContent = msg;
  st.style.color = color;
}

function collecterTout() {
  const etapes = [];
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    etapes.push({
      nom:       document.getElementById('e' + id + '-nom')?.value || '',
      enseignant: getQuillHTML('e' + id + '-enseignant-wrapper') || '',
      duree:     document.getElementById('e' + id + '-duree')?.value || ''
    });
  });
  return {
    v: 2,
    entete: {
      prof:     document.getElementById('prof')?.value || '',
      niveau:   document.getElementById('niveau')?.value || '',
      module:   document.getElementById('module')?.value || '',
      sequence: document.getElementById('sequence')?.value || '',
      activite: document.getElementById('activite')?.value || '',
      support:  document.getElementById('support')?.value || '',
      objectif: getQuillHTML('objectif-wrapper') || ''
    },
    etapes,
    params: {
      marge:           document.getElementById('p-marge')?.value || '8.5',
      gap:             document.getElementById('p-gap')?.value || '5',
      fontEnteteLabel: document.getElementById('p-font-entete-label')?.value || '11',
      fontEnteteContent:document.getElementById('p-font-entete-content')?.value || '10',
      fontTableHeader: document.getElementById('p-font-table-header')?.value || '10',
      fontTableContent:document.getElementById('p-font-table-content')?.value || '9',
      rowHeight:       document.getElementById('p-row-height')?.value || '8',
      tableHeaderH:    document.getElementById('p-table-header-h')?.value || '18',
      headerH:         document.getElementById('p-header-h')?.value || '100',
      l1h:             document.getElementById('p-l1h')?.value || '22',
      l234h:           document.getElementById('p-l234h')?.value || '18',
      l5h:             document.getElementById('p-l5h')?.value || '40',
      sep1:            document.getElementById('p-sep1')?.value || '32',
      sep2:            document.getElementById('p-sep2')?.value || '60',
      col1:            document.getElementById('p-col1')?.value || '20',
      col2:            document.getElementById('p-col2')?.value || '65',
      colorMain:       document.getElementById('p-color-main')?.value || '#1565C0',
      colorAccent:     document.getElementById('p-color-accent')?.value || '#C9A84C',
      colorGrid:       document.getElementById('p-color-grid')?.value || '#AAAAAA',
      colorEtapeText:  document.getElementById('p-color-etape-text')?.value || '#1565C0',
      labelColEtapes:  document.getElementById('label-col-etapes')?.value || 'Ã‰tapes',
      labelColDerou:   document.getElementById('label-col-deroulement')?.value || 'DÃ©roulement de la sÃ©ance',
      labelColDuree:   document.getElementById('label-col-duree')?.value || 'DurÃ©e'
    },
    savedAt: new Date().toLocaleString('fr-FR')
  };
}

function restaurerFiche(data) {
  if (!data) return;
  // En-tÃªte â€” champs contenteditable
  const e = data.entete || {};
  const setContent = (id, val) => {
    var el = document.getElementById(id);
    if (!el || val === undefined) return;
    if (el.contentEditable === 'true') el.innerHTML = val;
    else el.value = val;
  };
  setContent('prof',     e.prof);
  setContent('niveau',   e.niveau);
  setContent('module',   e.module);
  setContent('sequence', e.sequence);
  setContent('activite', e.activite);
  setContent('support',  e.support);
  if (e.objectif) setTimeout(() => setQuillHTML('objectif-wrapper', e.objectif), 200);
  // Ã‰tapes
  if (data.etapes && data.etapes.length > 0) {
    document.getElementById('etapes-container').innerHTML = '';
    etapeCount = 0;
    data.etapes.forEach(et => ajouterEtape(et));
  }
  // ParamÃ¨tres
  const p = data.params || {};
  const setVal = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined) el.value = val; };
  setVal('p-marge', p.marge); setVal('p-gap', p.gap);
  setVal('p-font-entete-label', p.fontEnteteLabel); setVal('p-font-entete-content', p.fontEnteteContent);
  setVal('p-font-table-header', p.fontTableHeader); setVal('p-font-table-content', p.fontTableContent);
  setVal('p-row-height', p.rowHeight); setVal('p-table-header-h', p.tableHeaderH);
  setVal('p-header-h', p.headerH); setVal('p-l1h', p.l1h); setVal('p-l234h', p.l234h); setVal('p-l5h', p.l5h);
  setVal('p-sep1', p.sep1); setVal('p-sep2', p.sep2);
  setVal('p-col1', p.col1); setVal('p-col2', p.col2);
  setVal('p-color-main', p.colorMain); setVal('p-color-accent', p.colorAccent);
  setVal('p-color-grid', p.colorGrid); setVal('p-color-etape-text', p.colorEtapeText);
  setVal('label-col-etapes', p.labelColEtapes); setVal('label-col-deroulement', p.labelColDerou);
  setVal('label-col-duree', p.labelColDuree);
  if (p.colorMain) applyThemePreview();
  updateLivePreview();
  calculerDureeTotale();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RÃ‰PERTOIRE DES FICHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REP_KEY = 'fiche_ped_repertoire';

function lireRepertoire() {
  try {
    return JSON.parse(localStorage.getItem(REP_KEY) || '[]');
  } catch(e) { return []; }
}

function ecrireRepertoire(fiches) {
  localStorage.setItem(REP_KEY, JSON.stringify(fiches));
}

function enregistrerDansRepertoire() {
  const entete   = collecterEntete();
  const etapes   = collecterEtapes();
  const activite = entete.activite || entete.module || 'Sans titre';
  const niveau   = entete.niveau   || '';

  // Demander un nom pour la fiche
  const nomSuggere = [activite, niveau].filter(Boolean).join(' â€” ');
  const nom = prompt('ğŸ’¾ Nom de la fiche Ã  enregistrer :', nomSuggere);
  if (nom === null) return; // annulÃ©
  const nomFinal = nom.trim() || nomSuggere || 'Fiche sans titre';

  const fiches = lireRepertoire();

  // VÃ©rifier si une fiche avec ce nom existe dÃ©jÃ 
  const existant = fiches.findIndex(f => f.nom === nomFinal);
  if (existant !== -1) {
    if (!confirm(`âš ï¸ Une fiche nommÃ©e "${nomFinal}" existe dÃ©jÃ .\nVoulez-vous la remplacer ?`)) return;
    fiches.splice(existant, 1);
  }

  const data = collecterTout();
  data.nom     = nomFinal;
  data.savedAt = new Date().toLocaleString('fr-FR');

  // RÃ©sumÃ© lisible
  const totalMin = etapes.reduce((s, e) => {
    const m = (e.duree || '').match(/(\d+[\.,]?\d*)/);
    return s + (m ? parseFloat(m[1].replace(',','.')) : 0);
  }, 0);
  data.resume = `${etapes.length} Ã©tape${etapes.length>1?'s':''} Â· ${totalMin>0?totalMin+' min':'durÃ©e non dÃ©finie'}`;
  data.niveau  = niveau;
  data.module  = entete.module || '';

  fiches.unshift(data); // plus rÃ©cent en premier
  ecrireRepertoire(fiches);

  // Feedback
  afficherStatutSauvegarde(`âœ… Fiche "${nomFinal}" enregistrÃ©e dans le rÃ©pertoire !`, '#2E7D32');
  // Badge onglet
  mettreAJourBadgeRepertoire();
}

function afficherRepertoire() {
  const fiches  = lireRepertoire();
  const liste   = document.getElementById('repertoire-liste');
  const compteur = document.getElementById('rep-compteur');
  if (!liste) return;

  if (compteur) compteur.textContent = fiches.length + ' fiche' + (fiches.length > 1 ? 's' : '');

  if (fiches.length === 0) {
    liste.innerHTML = `<div class="repertoire-empty">
      <div style="font-size:40px;margin-bottom:8px;">ğŸ“‚</div>
      <div>Aucune fiche enregistrÃ©e.</div>
      <div style="font-size:12px;margin-top:6px;color:#bbb;">Utilisez le bouton <strong>ğŸ’¾ Enregistrer la fiche</strong><br>depuis l'onglet Ã‰tapes ou AperÃ§u.</div>
    </div>`;
    return;
  }

  liste.innerHTML = fiches.map((f, i) => `
    <div class="repertoire-card">
      <div class="repertoire-card-header">
        <div class="repertoire-card-title">ğŸ“‹ ${f.nom || 'Fiche ' + (i+1)}</div>
        <div class="repertoire-card-date">ğŸ• ${f.savedAt || 'â€”'}</div>
      </div>
      <div class="repertoire-card-body">
        ${f.niveau ? `<span style="background:#E3F2FD;color:#1565C0;border-radius:4px;padding:1px 7px;font-size:11px;font-weight:600;margin-right:6px;">${f.niveau}</span>` : ''}
        ${f.module ? `<span style="color:#555;">${f.module}</span>` : ''}
        <br><span style="color:#888;font-size:11px;">${f.resume || ''}</span>
      </div>
      <div class="repertoire-card-actions">
        <button class="btn-rep btn-rep-ouvrir" onclick="ouvrirFicheRepertoire(${i})">ğŸ“‚ Ouvrir</button>
        <button class="btn-rep" onclick="dupliquerFicheRepertoire(${i})" style="background:#E8F5E9;color:#2E7D32;border:1px solid #C8E6C9;">ğŸ“‹ Dupliquer</button>
        <button class="btn-rep btn-rep-suppr" onclick="supprimerFicheRepertoire(${i})">ğŸ—‘ï¸ Supprimer</button>
      </div>
    </div>
  `).join('');
}

function ouvrirFicheRepertoire(index) {
  const fiches = lireRepertoire();
  const f = fiches[index];
  if (!f) return;
  if (!confirm(`ğŸ“‚ Ouvrir la fiche "${f.nom}" ?\nLe contenu actuel sera remplacÃ©.`)) return;
  restaurerFiche(f);
  showTab('etapes');
  afficherStatutSauvegarde(`ğŸ“‚ Fiche "${f.nom}" ouverte`, '#1565C0');
}

function dupliquerFicheRepertoire(index) {
  const fiches = lireRepertoire();
  const f = JSON.parse(JSON.stringify(fiches[index])); // copie profonde
  f.nom     = f.nom + ' (copie)';
  f.savedAt = new Date().toLocaleString('fr-FR');
  fiches.splice(index + 1, 0, f);
  ecrireRepertoire(fiches);
  afficherRepertoire();
  mettreAJourBadgeRepertoire();
}

function supprimerFicheRepertoire(index) {
  const fiches = lireRepertoire();
  const f = fiches[index];
  if (!confirm(`ğŸ—‘ï¸ Supprimer la fiche "${f.nom}" ?\nCette action est irrÃ©versible.`)) return;
  fiches.splice(index, 1);
  ecrireRepertoire(fiches);
  afficherRepertoire();
  mettreAJourBadgeRepertoire();
}

function mettreAJourBadgeRepertoire() {
  const n = lireRepertoire().length;
  const btn = document.getElementById('tab-repertoire');
  if (!btn) return;
  // Afficher un badge numÃ©rique sur l'onglet si des fiches existent
  const existing = btn.querySelector('.rep-badge');
  if (existing) existing.remove();
  if (n > 0) {
    const badge = document.createElement('span');
    badge.className = 'rep-badge';
    badge.style.cssText = 'background:#C9A84C;color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700;margin-left:4px;';
    badge.textContent = n;
    btn.appendChild(badge);
  }
}

// â”€â”€ NOUVELLE FICHE (remise Ã  zÃ©ro complÃ¨te) â”€â”€
function nouvelleFiche() {
  if (!confirm('ğŸ”„ Commencer une nouvelle fiche ?\n\nLe contenu actuel sera effacÃ©.\nâš ï¸ Pensez Ã  l\'enregistrer dans le rÃ©pertoire si vous voulez le conserver.')) return;

  // RÃ©initialiser les champs de l'en-tÃªte (sauf le prof)
  ['niveau','module','sequence','activite','support'].forEach(id => {
    var el = document.getElementById(id);
    if (!el) return;
    if (el.contentEditable === 'true') el.innerHTML = '';
    else el.value = '';
  });
  // Vider l'objectif
  setQuillHTML('objectif-wrapper', '');

  // Supprimer toutes les Ã©tapes et repartir sur les Ã©tapes par dÃ©faut
  document.getElementById('etapes-container').innerHTML = '';
  etapeCount = 0;
  ajouterEtape({ nom:'Mise en route', enseignant:'', duree:'5 min' });
  ajouterEtape({ nom:'PrÃ©sentation',  enseignant:'', duree:'15 min' });
  ajouterEtape({ nom:'EntraÃ®nement',  enseignant:'', duree:'20 min' });
  ajouterEtape({ nom:'Production',    enseignant:'', duree:'10 min' });
  ajouterEtape({ nom:'ClÃ´ture',       enseignant:'', duree:'5 min' });
  setTimeout(calculerDureeTotale, 300);

  // Effacer la sauvegarde automatique
  try { localStorage.removeItem(SAVE_KEY); } catch(e) {}

  // Mettre Ã  jour l'aperÃ§u live de l'en-tÃªte
  updateLivePreview();

  // Retourner sur l'onglet En-tÃªte
  showTab('entete');

  afficherStatutSauvegarde('ğŸ”„ Nouvelle fiche â€” contenu rÃ©initialisÃ©', '#1565C0');
}

// â”€â”€ PARAMÃˆTRES PAR DÃ‰FAUT â”€â”€
function reinitialiserParams() {
  if (!confirm('ğŸ”„ Remettre tous les paramÃ¨tres Ã  leurs valeurs par dÃ©faut ?\nLes couleurs et les labels seront aussi rÃ©initialisÃ©s.')) return;
  const defs = {
    'p-marge':'8.5','p-gap':'5',
    'p-font-entete-label':'11','p-font-entete-content':'10',
    'p-font-table-header':'10','p-font-table-content':'9',
    'p-row-height':'8','p-table-header-h':'18',
    'p-header-h':'100','p-l1h':'22','p-l234h':'18','p-l5h':'40',
    'p-sep1':'32','p-sep2':'60',
    'p-col1':'20','p-col2':'65',
    'p-color-main':'#1565C0','p-color-accent':'#C9A84C',
    'p-color-grid':'#AAAAAA','p-color-etape-text':'#1565C0',
    'label-col-etapes':'Ã‰tapes',
    'label-col-deroulement':'DÃ©roulement de la sÃ©ance',
    'label-col-duree':'DurÃ©e'
  };
  Object.entries(defs).forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) el.value = val;
  });
  applyThemePreview();
  // Feedback visuel
  const btn = event?.target?.closest('button');
  if (btn) { btn.textContent = 'âœ… RÃ©initialisÃ© !'; setTimeout(() => { btn.innerHTML = 'ğŸ”„ ParamÃ¨tres par dÃ©faut'; }, 1500); }
}

// â”€â”€ RESTAURATION AU DÃ‰MARRAGE â”€â”€
(function chargerSauvegardeAuDemarrage() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data || !data.v) return;
    setTimeout(() => {
      restaurerFiche(data);
      afficherStatutSauvegarde(`âœ… Fiche restaurÃ©e (sauvegardÃ©e le ${data.savedAt || '?'})`, '#2E7D32');
      mettreAJourBadgeRepertoire();
    }, 400);
  } catch(e) { /* silencieux */ }
})();

function collecterEtapes() {
  const colsSup = collecterColonnesSup();
  const etapes = [];
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    const nom = (document.getElementById('e'+id+'-nom')?.innerHTML || '').trim();
    const enseignantHTML = getQuillHTML('e'+id+'-enseignant-wrapper');
    const enseignant = getQuillText('e'+id+'-enseignant-wrapper');
    const duree = (document.getElementById('e'+id+'-duree')?.value || '').trim();
    // Collecter les valeurs des colonnes supplÃ©mentaires (maintenant contenteditable)
    const supVals = {};
    colsSup.forEach(col => {
      const el = document.getElementById('e'+id+'-colsup-'+col.n);
      // Lire innerHTML si c'est un contenteditable, sinon value pour rÃ©trocompatibilitÃ©
      if (el) {
        supVals[col.n] = (el.contentEditable === 'true' ? el.innerHTML : el.value || '').trim();
      } else {
        supVals[col.n] = '';
      }
    });
    if (nom || enseignant) {
      etapes.push({ nom, enseignant: enseignantHTML || enseignant, duree, supVals });
    }
  });
  return etapes;
}

// Ã‰tapes exemples par dÃ©faut
ajouterEtape({ nom:'Mise en route', enseignant:'', duree:'5 min' });
ajouterEtape({ nom:'PrÃ©sentation', enseignant:'', duree:'15 min' });
ajouterEtape({ nom:'EntraÃ®nement', enseignant:'', duree:'20 min' });
ajouterEtape({ nom:'Production', enseignant:'', duree:'10 min' });
ajouterEtape({ nom:'ClÃ´ture', enseignant:'', duree:'5 min' });
setTimeout(calculerDureeTotale, 300);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APERÃ‡U
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rafraichirApercu() {
  const entete = collecterEntete();
  const etapes = collecterEtapes();
  const P = collecterParams();

  // RÃ©sumÃ© avec labels personnalisÃ©s
  let summary = `<strong>ğŸ“‹ ${entete[entete.labelNiveau ? 'niveau' : 'niveau'] || 'â€”'}</strong> | ${entete.module || 'â€”'}<br>
    ${entete.labelSequence||'SÃ©quence'} : ${entete.sequence || 'â€”'}<br>
    ${entete.labelActivite||'ActivitÃ©'} : ${entete.activite || 'â€”'} | ${entete.labelSupport||'Support'} : ${entete.support || 'â€”'}<br>`;
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        summary += `${ll.label} : ${ll.val1 || 'â€”'}<br>`;
      } else {
        summary += `${ll.label1} : ${ll.val1 || 'â€”'} | ${ll.label2} : ${ll.val2 || 'â€”'}<br>`;
      }
    });
  }
  summary += `${entete.labelObjectif||'Objectif'} : <em>${(getQuillText('objectif-wrapper')||'â€”').substring(0,120)}${getQuillText('objectif-wrapper') && getQuillText('objectif-wrapper').length>120?'â€¦':''}</em>`;
  document.getElementById('preview-summary').innerHTML = summary;

  if (!etapes.length) {
    document.getElementById('preview-table-container').innerHTML = '<p style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">Aucune Ã©tape saisie.</p>';
    return;
  }

  let html = `<div style="overflow-x:auto;">
    <table class="preview-table">
      <thead>
        <tr>
          <th style="width:20%">${P.labelColEtapes || 'Ã‰tapes'}</th>
          <th style="width:${Math.max(20, 65 - (P.colsSup||[]).reduce((s,c)=>s+c.width,0))}%">${P.labelColDeroulement || 'DÃ©roulement de la sÃ©ance'}</th>
          ${(P.colsSup||[]).map(col => `<th style="width:${col.width}%">${col.label}</th>`).join('')}
          <th style="width:15%">${P.labelColDuree || 'DurÃ©e'}</th>
        </tr>
      </thead>
      <tbody>`;
  etapes.forEach((e, i) => {
    html += `<tr class="${i>0?'etape-sep':''}">
      <td class="etape-label">${e.nom}</td>
      <td>${e.enseignant.replace(/\n/g,'<br>')}</td>
      ${(P.colsSup||[]).map(col => `<td>${(e.supVals && e.supVals[col.n]) ? e.supVals[col.n] : ''}</td>`).join('')}
      <td>${e.duree}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  document.getElementById('preview-table-container').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EN-TÃŠTE FLEXIBLE â€” GESTION DES LABELS Ã‰DITABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function editLabel(labelEl) {
  const span = labelEl.querySelector('.label-text');
  if (!span) return;
  const currentText = span.textContent.trim();
  // CrÃ©er un input en ligne
  const inp = document.createElement('input');
  inp.type = 'text';
  inp.className = 'label-edit-input';
  inp.value = currentText;
  labelEl.classList.add('editing-mode');
  span.replaceWith(inp);
  inp.focus(); inp.select();

  function finishEdit() {
    const newText = inp.value.trim() || currentText;
    const newSpan = document.createElement('span');
    newSpan.className = 'label-text';
    newSpan.textContent = newText;
    inp.replaceWith(newSpan);
    labelEl.classList.remove('editing-mode');
    updateLivePreview();
  }
  inp.addEventListener('blur', finishEdit);
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); finishEdit(); }
    if (e.key === 'Escape') { inp.value = currentText; finishEdit(); }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGNES LIBRES SUPPLÃ‰MENTAIRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ligneLibreCount = 0;

function ajouterLigneLibre(type) {
  ligneLibreCount++;
  const n = ligneLibreCount;
  const container = document.getElementById('lignes-libres-container');
  const msg = document.getElementById('no-lignes-libres-msg');
  if (msg) msg.style.display = 'none';

  const div = document.createElement('div');
  div.className = 'ligne-libre-card';
  div.id = 'll-card-' + n;
  div.dataset.type = type;

  // Toolbar de formatage rÃ©utilisable pour un champ contenteditable
  const llToolbar = (fieldId) => `
    <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
      <button type="button" class="format-btn" onclick="toggleFormat('${fieldId}','bold')" title="Gras"><b>B</b></button>
      <button type="button" class="format-btn" onclick="toggleFormat('${fieldId}','italic')" title="Italique"><i>I</i></button>
      <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('${fieldId}',this.value)" title="Couleur du texte" value="#000000">
      <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('${fieldId}',this.value)" title="Couleur de surlignage" value="#FFFFFF">
      <button type="button" class="format-btn" onclick="removeColorFromContentEditable('${fieldId}')" title="Supprimer les couleurs" style="font-size:11px;">ğŸš«</button>
    </div>`;

  if (type === 'simple') {
    div.innerHTML = `
      <div class="ligne-libre-header">
        <span class="ll-title">Ligne libre #${n} â€” Champ simple</span>
        <div class="ll-actions">
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},-1)" title="Monter">â†‘</button>
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},1)" title="Descendre">â†“</button>
          <button class="btn-ll-del" onclick="supprimerLigneLibre(${n})">âœ• Suppr.</button>
        </div>
      </div>
      <div class="ligne-libre-body">
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier le label">
            <span class="label-text">Champ ${n}</span>
            <span class="label-edit-hint">âœï¸</span>
          </label>
          ${llToolbar('ll'+n+'-val1')}
          <div id="ll${n}-val1" contenteditable="true" class="editable-input" data-placeholder="Contenu du champâ€¦" oninput="updateLivePreview()"></div>
        </div>
      </div>`;
  } else {
    div.innerHTML = `
      <div class="ligne-libre-header">
        <span class="ll-title">Ligne libre #${n} â€” 2 champs cÃ´te Ã  cÃ´te</span>
        <div class="ll-actions">
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},-1)" title="Monter">â†‘</button>
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},1)" title="Descendre">â†“</button>
          <button class="btn-ll-del" onclick="supprimerLigneLibre(${n})">âœ• Suppr.</button>
        </div>
      </div>
      <div class="ligne-libre-body">
        <div class="ll-double">
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier le label">
              <span class="label-text">Champ ${n}a</span>
              <span class="label-edit-hint">âœï¸</span>
            </label>
            ${llToolbar('ll'+n+'-val1')}
            <div id="ll${n}-val1" contenteditable="true" class="editable-input" data-placeholder="Contenu gaucheâ€¦" oninput="updateLivePreview()"></div>
          </div>
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier le label">
              <span class="label-text">Champ ${n}b</span>
              <span class="label-edit-hint">âœï¸</span>
            </label>
            ${llToolbar('ll'+n+'-val2')}
            <div id="ll${n}-val2" contenteditable="true" class="editable-input" data-placeholder="Contenu droitâ€¦" oninput="updateLivePreview()"></div>
          </div>
        </div>
      </div>`;
  }
  container.appendChild(div);
  updateLivePreview();
}

function supprimerLigneLibre(n) {
  const el = document.getElementById('ll-card-' + n);
  if (el) el.remove();
  const container = document.getElementById('lignes-libres-container');
  if (!container.querySelector('.ligne-libre-card')) {
    const msg = document.getElementById('no-lignes-libres-msg');
    if (msg) msg.style.display = '';
  }
  updateLivePreview();
}

function moveLigneLibre(n, dir) {
  const card = document.getElementById('ll-card-' + n);
  if (!card) return;
  const container = document.getElementById('lignes-libres-container');
  const cards = [...container.querySelectorAll('.ligne-libre-card')];
  const idx = cards.indexOf(card);
  if (dir === -1 && idx > 0) {
    container.insertBefore(card, cards[idx - 1]);
  } else if (dir === 1 && idx < cards.length - 1) {
    container.insertBefore(cards[idx + 1], card);
  }
  updateLivePreview();
}

function getLabelText(labelEl) {
  const span = labelEl ? labelEl.querySelector('.label-text') : null;
  return span ? span.textContent.trim() : '';
}

function collecterLignesLibres() {
  const lines = [];
  document.querySelectorAll('#lignes-libres-container .ligne-libre-card').forEach(card => {
    const n = card.id.replace('ll-card-', '');
    const type = card.dataset.type;
    const labels = card.querySelectorAll('.editable-label');
    const val1El = document.getElementById('ll'+n+'-val1');
    const val2El = document.getElementById('ll'+n+'-val2');
    // Lire innerHTML si contenteditable, sinon value (rÃ©trocompatibilitÃ©)
    const readVal = (el) => {
      if (!el) return '';
      if (el.contentEditable === 'true') return el.innerHTML.trim();
      return el.value ? el.value.trim() : '';
    };
    if (type === 'simple') {
      lines.push({
        type: 'simple',
        label: getLabelText(labels[0]),
        val1: readVal(val1El)
      });
    } else {
      lines.push({
        type: 'double',
        label1: getLabelText(labels[0]),
        val1: readVal(val1El),
        label2: getLabelText(labels[1]),
        val2: readVal(val2El)
      });
    }
  });
  return lines;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APERÃ‡U LIVE DE L'EN-TÃŠTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLivePreview() {
  const entete = collecterEntete();
  const lignesLibres = collecterLignesLibres();
  const container = document.getElementById('entete-live-preview');
  if (!container) return;

  const blue = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#1565C0';
  const gold = getComputedStyle(document.documentElement).getPropertyValue('--gold').trim() || '#C9A84C';

  function lpCell(label, value, flex1, flex2) {
    const val = value || '';
    return `<div class="lp-half" style="flex:${flex1||1}">
      <div class="lp-cell-label" style="background:${blue};">${label}</div>
      <div class="lp-cell-value${!val?' empty':''}">${val || 'â€”'}</div>
    </div>`;
  }

  let html = `<div style="border:2px solid ${blue};border-radius:5px;overflow:hidden;">`;
  // Ligne titre
  html += `<div class="lp-title-row" style="background:${blue};border-bottom:2px solid ${gold};">
    <span>ğŸ“‹ FICHE PÃ‰DAGOGIQUE</span>
    <span style="font-size:10px;opacity:0.8;">${entete.prof||'â€”'}</span>
  </div>`;

  // Ligne 1 : Prof + Niveau
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    ${lpCell(entete.labelProf||'PROF', entete.prof, 1.4)}
    <div class="lp-half" style="flex:1; border-left:1.5px solid ${blue};">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelNiveau||'NIVEAU'}</div>
      <div class="lp-cell-value${!entete.niveau?' empty':''}">${entete.niveau||'â€”'}</div>
    </div>
  </div>`;

  // Ligne 2 : Module
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    <div class="lp-half" style="flex:1;">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelModule||'MODULE'}</div>
      <div class="lp-cell-value${!entete.module?' empty':''}">${entete.module||'â€”'}</div>
    </div>
  </div>`;

  // Ligne 3 : SÃ©quence
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    <div class="lp-half" style="flex:1;">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelSequence||'SÃ‰QUENCE'}</div>
      <div class="lp-cell-value${!entete.sequence?' empty':''}">${entete.sequence||'â€”'}</div>
    </div>
  </div>`;

  // Ligne 4 : ActivitÃ© + Support
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    ${lpCell(entete.labelActivite||'ACTIVITÃ‰', entete.activite, 1.2)}
    <div class="lp-half" style="flex:1; border-left:1.5px solid ${blue};">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelSupport||'SUPPORT'}</div>
      <div class="lp-cell-value${!entete.support?' empty':''}">${entete.support||'â€”'}</div>
    </div>
  </div>`;

  // Lignes libres supplÃ©mentaires
  lignesLibres.forEach(ll => {
    if (ll.type === 'simple') {
      html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
        <div class="lp-half" style="flex:1;">
          <div class="lp-cell-label" style="background:${blue};">${ll.label||'CHAMP'}</div>
          <div class="lp-cell-value${!ll.val1?' empty':''}">${ll.val1||'â€”'}</div>
        </div>
      </div>`;
    } else {
      html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
        ${lpCell(ll.label1||'CHAMP A', ll.val1, 1)}
        <div class="lp-half" style="flex:1; border-left:1.5px solid ${blue};">
          <div class="lp-cell-label" style="background:${blue};">${ll.label2||'CHAMP B'}</div>
          <div class="lp-cell-value${!ll.val2?' empty':''}">${ll.val2||'â€”'}</div>
        </div>
      </div>`;
    }
  });

  // Ligne Objectif
  const obj = getQuillText('objectif-wrapper') || '';
  html += `<div style="display:flex; border-top:1px solid ${blue};">
    <div class="lp-objectif-label" style="background:${blue};">${entete.labelObjectif||'OBJECTIF'}</div>
    <div class="lp-objectif-value${!obj?' empty':''}">${obj.replace(/\n/g,'<br>')||'â€”'}</div>
  </div>`;

  html += `</div>`;
  container.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLECTE DES DONNÃ‰ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFixedLabel(groupId, index) {
  const grp = document.getElementById(groupId);
  if (!grp) return '';
  const labels = grp.querySelectorAll('.editable-label .label-text');
  return labels[index] ? labels[index].textContent.trim() : '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATAGE GRAS ET ITALIQUE POUR LES CHAMPS CONTENTEDITABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFormat(fieldId, format) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  if (format === 'bold') {
    document.execCommand('bold', false, null);
  } else if (format === 'italic') {
    document.execCommand('italic', false, null);
  }
  
  // DÃ©clencher la mise Ã  jour de l'aperÃ§u
  updateLivePreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COULEURS POUR LES CHAMPS CONTENTEDITABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyColorToContentEditable(fieldId, color) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  // Utiliser execCommand pour appliquer la couleur
  document.execCommand('foreColor', false, color);
  
  updateLivePreview();
}

function applyBackgroundToContentEditable(fieldId, color) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  // Utiliser execCommand pour appliquer le surlignage
  document.execCommand('backColor', false, color);
  
  updateLivePreview();
}

function removeColorFromContentEditable(fieldId) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  // Supprimer les couleurs
  document.execCommand('foreColor', false, '#000000');
  document.execCommand('backColor', false, '#ffffff');
  document.execCommand('removeFormat', false, null);
  
  updateLivePreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLECTE DES DONNÃ‰ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function collecterEntete() {
  const objectifHTML = getQuillHTML('objectif-wrapper');
  const objectifText = getQuillText('objectif-wrapper');
  
  return {
    // Valeurs rÃ©cupÃ©rÃ©es depuis les champs contenteditable (avec HTML pour le formatage)
    prof:       document.getElementById('prof')?.innerHTML.trim() || 'EZ-ZAKY AZIZ',
    niveau:     document.getElementById('niveau')?.innerHTML.trim() || '',
    module:     document.getElementById('module')?.innerHTML.trim() || '',
    sequence:   document.getElementById('sequence')?.innerHTML.trim() || '',
    activite:   document.getElementById('activite')?.innerHTML.trim() || '',
    support:    document.getElementById('support')?.innerHTML.trim() || '',
    objectif:   objectifHTML || objectifText || '',
    // Labels personnalisÃ©s
    labelProf:      getFixedLabel('fgrp-ligne1', 0)     || 'PROF',
    labelNiveau:    getFixedLabel('fgrp-ligne1', 1)     || 'NIVEAU',
    labelModule:    getFixedLabel('fgrp-module', 0)     || 'MODULE',
    labelSequence:  getFixedLabel('fgrp-sequence', 0)   || 'SÃ‰QUENCE',
    labelActivite:  getFixedLabel('fgrp-ligne4', 0)     || 'ACTIVITÃ‰',
    labelSupport:   getFixedLabel('fgrp-ligne4', 1)     || 'SUPPORT',
    labelObjectif:  getFixedLabel('fgrp-objectif', 0)   || 'OBJECTIF(S)',
    // Lignes libres
    lignesLibres: collecterLignesLibres(),
  };
}

// Initialiser l'aperÃ§u live
setTimeout(updateLivePreview, 100);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLONNES SUPPLÃ‰MENTAIRES DU TABLEAU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let colSupCount = 0;
const MAX_COL_SUP = 3;

function ajouterColonneSup() {
  const container = document.getElementById('colonnes-sup-container');
  const current = container ? container.querySelectorAll('.col-sup-card').length : 0;
  if (current >= MAX_COL_SUP) {
    alert('Maximum ' + MAX_COL_SUP + ' colonnes supplÃ©mentaires autorisÃ©es.');
    return;
  }
  colSupCount++;
  const n = colSupCount;
  const msg = document.getElementById('no-col-sup-msg');
  if (msg) msg.style.display = 'none';

  const div = document.createElement('div');
  div.className = 'col-sup-card';
  div.id = 'col-sup-' + n;
  div.style.cssText = 'border:1.5px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;';
  div.innerHTML = `
    <div style="background:var(--blue-pale);padding:7px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
      <span style="font-size:12px;font-weight:600;color:var(--blue-dark);">Colonne sup. #${n}</span>
      <button onclick="supprimerColonneSup(${n})" style="background:none;border:1px solid #FFCDD2;color:#C62828;border-radius:5px;padding:2px 8px;font-size:11px;cursor:pointer;">âœ• Suppr.</button>
    </div>
    <div style="padding:10px;">
      <div class="field" style="margin-bottom:8px;">
        <label style="font-size:11px;font-weight:600;color:var(--blue-dark);letter-spacing:0.04em;text-transform:uppercase;display:block;margin-bottom:4px;">Nom de la colonne</label>
        <input type="text" id="col-sup-${n}-label" value="Colonne ${n}" placeholder="Ex : Supports, Outils, MatÃ©riel...">
      </div>
      <div class="field" style="margin-bottom:0;">
        <label style="font-size:11px;font-weight:600;color:var(--blue-dark);letter-spacing:0.04em;text-transform:uppercase;display:block;margin-bottom:4px;">Largeur (%)</label>
        <input type="number" id="col-sup-${n}-width" value="10" min="5" max="25" step="1">
        <p class="field-hint">La largeur sera dÃ©duite de la colonne Â« DÃ©roulement Â».</p>
      </div>
    </div>
  `;
  container.appendChild(div);
  rafraichirChampsEtapes();
}

function supprimerColonneSup(n) {
  const el = document.getElementById('col-sup-' + n);
  if (el) el.remove();
  const container = document.getElementById('colonnes-sup-container');
  if (container && !container.querySelector('.col-sup-card')) {
    const msg = document.getElementById('no-col-sup-msg');
    if (msg) msg.style.display = '';
  }
  rafraichirChampsEtapes();
}

function collecterColonnesSup() {
  const cols = [];
  const container = document.getElementById('colonnes-sup-container');
  if (!container) return cols;
  container.querySelectorAll('.col-sup-card').forEach(card => {
    const n = card.id.replace('col-sup-', '');
    const label = document.getElementById('col-sup-' + n + '-label')?.value.trim() || ('Colonne ' + n);
    const width = parseFloat(document.getElementById('col-sup-' + n + '-width')?.value) || 10;
    cols.push({ n, label, width });
  });
  return cols;
}

function rafraichirChampsEtapes() {
  const colsSup = collecterColonnesSup();
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    card.querySelectorAll('.col-sup-field').forEach(f => f.remove());
    const body = card.querySelector('.etape-body');
    if (!body) return;
    const dureeField = body.querySelector('.field-duree');
    colsSup.forEach(col => {
      const div = document.createElement('div');
      div.className = 'field col-sup-field';
      const fieldId = `e${id}-colsup-${col.n}`;
      div.innerHTML = `
        <label>${col.label}</label>
        <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
          <button type="button" class="format-btn" onclick="toggleFormat('${fieldId}', 'bold')" title="Gras"><b>B</b></button>
          <button type="button" class="format-btn" onclick="toggleFormat('${fieldId}', 'italic')" title="Italique"><i>I</i></button>
          <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('${fieldId}', this.value)" title="Couleur du texte" value="#000000">
          <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('${fieldId}', this.value)" title="Couleur de surlignage" value="#FFFFFF">
        </div>
        <div id="${fieldId}" contenteditable="true" class="editable-input" data-placeholder="Contenu pour Â« ${col.label} Â»â€¦"></div>
      `;
      if (dureeField) {
        body.insertBefore(div, dureeField);
      } else {
        body.appendChild(div);
      }
    });
  });
}

function collecterParams() {
  const colsSup = collecterColonnesSup();
  const totalSupPct = colsSup.reduce((s, c) => s + c.width, 0);
  const col1 = parseInt(document.getElementById('p-col1').value) || 20;
  const col2Raw = parseInt(document.getElementById('p-col2').value) || 65;
  const col2 = Math.max(10, col2Raw - totalSupPct);
  const col3 = 100 - col1 - col2Raw; // DurÃ©e (reste)
  return {
    marge: parseFloat(document.getElementById('p-marge').value) || 8.5,
    gap: parseFloat(document.getElementById('p-gap').value) || 5,
    fontEnteteLabel: parseFloat(document.getElementById('p-font-entete-label').value) || 11,
    fontEnteteContent: parseFloat(document.getElementById('p-font-entete-content').value) || 10,
    fontTableHeader: parseFloat(document.getElementById('p-font-table-header').value) || 10,
    fontTableContent: parseFloat(document.getElementById('p-font-table-content').value) || 9,
    rowHeight: parseFloat(document.getElementById('p-row-height').value) || 8,
    tableHeaderH: parseFloat(document.getElementById('p-table-header-h').value) || 18,
    headerH: parseFloat(document.getElementById('p-header-h').value) || 100,
    l1h: parseFloat(document.getElementById('p-l1h').value) || 22,
    l234h: parseFloat(document.getElementById('p-l234h').value) || 18,
    l5h: parseFloat(document.getElementById('p-l5h').value) || 40,
    sep1Pct: parseFloat(document.getElementById('p-sep1').value) / 100 || 0.32,
    sep2Pct: parseFloat(document.getElementById('p-sep2').value) / 100 || 0.60,
    cols: [col1/100, col2/100, col3/100],
    colorMain: document.getElementById('p-color-main').value || '#1565C0',
    colorGrid: document.getElementById('p-color-grid').value || '#AAAAAA',
    colorAccent: document.getElementById('p-color-accent').value || '#C9A84C',
    colorEtapeText: document.getElementById('p-color-etape-text').value || '#1565C0',
    // Labels personnalisÃ©s des colonnes d'Ã©tapes
    labelColEtapes: document.getElementById('label-col-etapes')?.value || 'Ã‰tapes',
    labelColDeroulement: document.getElementById('label-col-deroulement')?.value || 'DÃ©roulement de la sÃ©ance',
    labelColDuree: document.getElementById('label-col-duree')?.value || 'DurÃ©e',
    // Colonnes supplÃ©mentaires
    colsSup: colsSup,
    colsSupPct: colsSup.map(c => c.width / 100),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITAIRES COULEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hexToRgb(color) {
  if (!color) return [0, 0, 0]; // Retourner noir par dÃ©faut
  
  // Convertir rgb(r,g,b) ou rgba(r,g,b,a)
  if (color.startsWith('rgb')) {
    const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
      return [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
    }
  }
  
  // Convertir #RRGGBB ou #RGB
  if (color.startsWith('#')) {
    let hex = color.substring(1);
    // Convertir #RGB en #RRGGBB
    if (hex.length === 3) {
      hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
    }
    if (hex.length === 6) {
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      return [r, g, b];
    }
  }
  
  // Fallback
  return [0, 0, 0];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NORMALISATION DES SYMBOLES UNICODE POUR PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Convertit les symboles Unicode en alternatives compatibles PDF
function normaliserTexte(text) {
  if (!text) return text;
  return text
    // â”€â”€ FLÃˆCHES SIMPLES â”€â”€
    .replace(/â†’/g, '->').replace(/â†/g, '<-').replace(/â†‘/g, '^').replace(/â†“/g, 'v')
    .replace(/â†”/g, '<->').replace(/â†•/g, '^v').replace(/â†—/g, '/^').replace(/â†˜/g, '\\v')
    .replace(/â†™/g, '/v').replace(/â†–/g, '\\^').replace(/â†©/g, '<-,').replace(/â†ª/g, ',->') 
    .replace(/â†«/g, '<~').replace(/â†¬/g, '~>').replace(/â†­/g, '<~>').replace(/â†°/g, 'L^')
    .replace(/â†±/g, 'R^').replace(/â†²/g, 'Lv').replace(/â†³/g, 'Rv').replace(/â†´/g, 'v|')
    .replace(/â†µ/g, '<-|').replace(/â†·/g, '~>').replace(/â†¶/g, '<~')
    .replace(/â†º/g, 'o<').replace(/â†»/g, 'o>').replace(/âŸ³/g, 'o>').replace(/âŸ²/g, 'o<')
    // â”€â”€ FLÃˆCHES DOUBLES â”€â”€
    .replace(/â‡’/g, '=>').replace(/â‡/g, '<=').replace(/â‡‘/g, '^=').replace(/â‡“/g, 'v=')
    .replace(/â‡”/g, '<=>').replace(/â‡•/g, '^v=').replace(/â‡—/g, '/^=').replace(/â‡˜/g, '\\v=')
    // â”€â”€ FLÃˆCHES LONGUES â”€â”€
    .replace(/âŸ¶/g, '-->').replace(/âŸµ/g, '<--').replace(/âŸ·/g, '<-->') 
    .replace(/âŸ¹/g, '=>>').replace(/âŸ¸/g, '<<=' ).replace(/âŸº/g, '<<=>>')
    // â”€â”€ FLÃˆCHES STYLISÃ‰ES â”€â”€
    .replace(/âœ/g, '->').replace(/â¡/g, '->').replace(/â¢/g, '->').replace(/â¤/g, '->')
    .replace(/â¥/g, '->').replace(/â¦/g, '<-').replace(/â§/g, '->').replace(/â¨/g, '=>')
    .replace(/â©/g, '->').replace(/âª/g, '->').replace(/â«/g, '->').replace(/â¬/g, '->')
    .replace(/â­/g, '<-').replace(/â®/g, '->').replace(/â¯/g, '->').replace(/â±/g, '->')
    // â”€â”€ TRIANGLES / POINTEURS â”€â”€
    .replace(/â–¶/g, '>').replace(/â—€/g, '<').replace(/â–²/g, '^').replace(/â–¼/g, 'v')
    .replace(/â–º/g, '>').replace(/â—„/g, '<').replace(/â–¸/g, '>').replace(/â—‚/g, '<')
    .replace(/â–´/g, '^').replace(/â–¾/g, 'v').replace(/âŠ³/g, '>').replace(/âŠ²/g, '<')
    // â”€â”€ PUCES / LISTES â”€â”€
    .replace(/â€¢/g, '*').replace(/â—¦/g, 'o').replace(/â–ª/g, '-').replace(/â–«/g, '-')
    .replace(/â€£/g, '>').replace(/âƒ/g, '-').replace(/â¦¾/g, 'O').replace(/â¦¿/g, '@')
    // â”€â”€ CARRÃ‰S â”€â”€
    .replace(/â– /g, '[*]').replace(/â–¡/g, '[ ]').replace(/â–¬/g, '[-]').replace(/â–­/g, '[-]')
    .replace(/â–®/g, '[|]').replace(/â–¯/g, '[ ]').replace(/â—¼/g, '[*]').replace(/â—»/g, '[ ]')
    .replace(/â—¾/g, '[*]').replace(/â—½/g, '[ ]')
    // â”€â”€ CERCLES â”€â”€
    .replace(/â—/g, '(*)').replace(/â—‹/g, '( )').replace(/â—‰/g, '(.)').replace(/â—/g, '(o)')
    .replace(/â—Œ/g, '(-)').replace(/â—/g, '(+)').replace(/â—”/g, '(1/4)').replace(/â—•/g, '(3/4)')
    .replace(/â¬¤/g, '(*)').replace(/â­•/g, '(O)')
    // â”€â”€ LOSANGES â”€â”€
    .replace(/â—†/g, '<>').replace(/â—‡/g, '<>').replace(/â—ˆ/g, '<.>').replace(/â¬¥/g, '<>')
    .replace(/â¬¦/g, '<>').replace(/â–/g, '<+>')
    // â”€â”€ COCHES / CROIX â”€â”€
    .replace(/âœ“/g, 'v').replace(/âœ”/g, 'V').replace(/âœ—/g, 'x').replace(/âœ˜/g, 'X')
    .replace(/â˜‘/g, '[v]').replace(/â˜’/g, '[x]').replace(/âœ…/g, '[V]').replace(/âŒ/g, '[X]')
    .replace(/â/g, '[X]').replace(/â˜/g, '[ ]')
    // â”€â”€ Ã‰TOILES â”€â”€
    .replace(/â˜…/g, '*').replace(/â˜†/g, '*').replace(/âœ©/g, '*').replace(/âœª/g, '(*)') 
    .replace(/âœ«/g, '*').replace(/âœ¬/g, '*').replace(/âœ­/g, '*').replace(/âœ®/g, '*')
    .replace(/âœ¯/g, '*').replace(/âœ°/g, '*').replace(/â­/g, '*').replace(/ğŸŒŸ/g, '*')
    .replace(/âœ¦/g, '*').replace(/âœ§/g, '*').replace(/âœ¶/g, '*').replace(/âœ·/g, '*')
    // â”€â”€ COEURS â”€â”€
    .replace(/â™¥/g, '<3').replace(/â™¡/g, '<3').replace(/â¤/g, '<3').replace(/â¥/g, '<3')
    .replace(/â£/g, '<!').replace(/â¦/g, '<3').replace(/â§/g, '<3')
    .replace(/ğŸ’™/g, '<3').replace(/ğŸ’š/g, '<3').replace(/ğŸ’›/g, '<3')
    .replace(/ğŸ’œ/g, '<3').replace(/ğŸ–¤/g, '<3')
    // â”€â”€ FLEURS / NATURE â”€â”€
    .replace(/âœ¿/g, '*').replace(/â€/g, '*').replace(/â/g, '*').replace(/â‚/g, '(*)') 
    .replace(/âƒ/g, '*').replace(/âœ¾/g, '*').replace(/âš˜/g, '*').replace(/â˜˜/g, '*')
    .replace(/ğŸŒ¿/g, '*').replace(/ğŸ€/g, '*')
    // â”€â”€ SYMBOLES MÃ‰TÃ‰O / DIVERS â”€â”€
    .replace(/â˜€/g, 'O)').replace(/â˜/g, '(~)').replace(/â˜‚/g, '(u)').replace(/â˜ƒ/g, '(8)')
    .replace(/â˜„/g, '(*)').replace(/âš¡/g, '/\\')
    .replace(/â˜/g, 'TEL').replace(/âœ‰/g, '@').replace(/âœ‚/g, '>|<')
    .replace(/âœ/g, '/').replace(/âœ’/g, '/')
    // â”€â”€ MATHÃ‰MATIQUES â”€â”€
    .replace(/Â±/g, '+/-').replace(/Ã—/g, 'x').replace(/Ã·/g, '/').replace(/Â·/g, '.')
    .replace(/âˆ™/g, '.').replace(/âˆš/g, 'sqrt').replace(/âˆ›/g, 'cbrt').replace(/âˆœ/g, '4rt')
    .replace(/âˆ/g, 'inf').replace(/â€°/g, '0/00').replace(/â€±/g, '0/000')
    // â”€â”€ RELATIONS MATHÃ‰MATIQUES â”€â”€
    .replace(/â‰ /g, '!=').replace(/â‰¡/g, '===').replace(/â‰¢/g, '!==').replace(/â‰ˆ/g, '~=')
    .replace(/â‰‰/g, '!~=').replace(/â‰¤/g, '<=').replace(/â‰¥/g, '>=').replace(/â‰ª/g, '<<')
    .replace(/â‰«/g, '>>').replace(/â‰º/g, '<').replace(/â‰»/g, '>') 
    .replace(/âŠ‚/g, 'C').replace(/âŠƒ/g, ')').replace(/âŠ„/g, '!C').replace(/âŠ…/g, '!)')
    .replace(/âŠ†/g, 'C=').replace(/âŠ‡/g, ')=')
    // â”€â”€ LOGIQUE / ENSEMBLES â”€â”€
    .replace(/âˆ§/g, '/\\').replace(/âˆ¨/g, '\\/').replace(/Â¬/g, '!').replace(/âˆ€/g, 'V')
    .replace(/âˆƒ/g, 'E').replace(/âˆ„/g, '!E').replace(/âˆ…/g, '{}').replace(/âˆ©/g, 'n')
    .replace(/âˆª/g, 'U').replace(/âˆˆ/g, 'e').replace(/âˆ‰/g, '!e').replace(/âˆ‹/g, 'ni')
    .replace(/âˆŒ/g, '!ni')
    // â”€â”€ LETTRES GRECQUES â”€â”€
    .replace(/Î±/g, 'alpha').replace(/Î²/g, 'beta').replace(/Î³/g, 'gamma')
    .replace(/Î´/g, 'delta').replace(/Îµ/g, 'epsilon').replace(/Î¶/g, 'zeta')
    .replace(/Î·/g, 'eta').replace(/Î¸/g, 'theta').replace(/Î¹/g, 'iota')
    .replace(/Îº/g, 'kappa').replace(/Î»/g, 'lambda').replace(/Î¼/g, 'mu')
    .replace(/Î½/g, 'nu').replace(/Î¾/g, 'xi').replace(/Ï€/g, 'pi')
    .replace(/Ï/g, 'rho').replace(/Ïƒ/g, 'sigma').replace(/Ï„/g, 'tau')
    .replace(/Ï…/g, 'upsilon').replace(/Ï†/g, 'phi').replace(/Ï‡/g, 'chi')
    .replace(/Ïˆ/g, 'psi').replace(/Ï‰/g, 'omega')
    .replace(/Î”/g, 'Delta').replace(/âˆ†/g, 'Delta').replace(/Î£/g, 'Sigma')
    .replace(/Î /g, 'Pi').replace(/Î©/g, 'Omega')
    // â”€â”€ CALCUL â”€â”€
    .replace(/âˆ‚/g, 'd').replace(/âˆ‡/g, 'V').replace(/âˆ«/g, 'int')
    .replace(/âˆ¬/g, 'iint').replace(/âˆ­/g, 'iiint').replace(/âˆ®/g, 'oint')
    .replace(/âˆ‘/g, 'sum').replace(/âˆ/g, 'prod').replace(/âˆ/g, 'coprod')
    // â”€â”€ EXPOSANTS (chiffres) â”€â”€
    .replace(/â°/g, '^0').replace(/Â¹/g, '^1').replace(/Â²/g, '^2').replace(/Â³/g, '^3')
    .replace(/â´/g, '^4').replace(/âµ/g, '^5').replace(/â¶/g, '^6').replace(/â·/g, '^7')
    .replace(/â¸/g, '^8').replace(/â¹/g, '^9')
    // â”€â”€ EXPOSANTS (lettres) â”€â”€
    .replace(/áµƒ/g, '^a').replace(/áµ‡/g, '^b').replace(/á¶œ/g, '^c').replace(/áµˆ/g, '^d')
    .replace(/áµ‰/g, '^e').replace(/á¶ /g, '^f').replace(/áµ/g, '^g').replace(/Ê°/g, '^h')
    .replace(/â±/g, '^i').replace(/Ê²/g, '^j').replace(/áµ/g, '^k').replace(/Ë¡/g, '^l')
    .replace(/áµ/g, '^m').replace(/â¿/g, '^n').replace(/áµ’/g, '^o').replace(/áµ–/g, '^p')
    .replace(/Ê³/g, '^r').replace(/Ë¢/g, '^s').replace(/áµ—/g, '^t').replace(/áµ˜/g, '^u')
    .replace(/áµ›/g, '^v').replace(/Ê·/g, '^w').replace(/Ë£/g, '^x').replace(/Ê¸/g, '^y')
    .replace(/á¶»/g, '^z')
    // â”€â”€ INDICES (chiffres) â”€â”€
    .replace(/â‚€/g, '_0').replace(/â‚/g, '_1').replace(/â‚‚/g, '_2').replace(/â‚ƒ/g, '_3')
    .replace(/â‚„/g, '_4').replace(/â‚…/g, '_5').replace(/â‚†/g, '_6').replace(/â‚‡/g, '_7')
    .replace(/â‚ˆ/g, '_8').replace(/â‚‰/g, '_9')
    // â”€â”€ INDICES (lettres) â”€â”€
    .replace(/â‚/g, '_a').replace(/â‚‘/g, '_e').replace(/â‚’/g, '_o').replace(/â‚“/g, '_x')
    .replace(/â‚™/g, '_n').replace(/â‚˜/g, '_m').replace(/â‚–/g, '_k').replace(/â‚œ/g, '_t')
    .replace(/â‚›/g, '_s').replace(/áµ¢/g, '_i').replace(/áµ¤/g, '_u').replace(/áµ¥/g, '_v')
    // â”€â”€ FRACTIONS â”€â”€
    .replace(/Â½/g, '1/2').replace(/â…“/g, '1/3').replace(/â…”/g, '2/3')
    .replace(/Â¼/g, '1/4').replace(/Â¾/g, '3/4').replace(/â…•/g, '1/5')
    .replace(/â…–/g, '2/5').replace(/â…—/g, '3/5').replace(/â…˜/g, '4/5')
    .replace(/â…™/g, '1/6').replace(/â…š/g, '5/6').replace(/â…›/g, '1/8')
    .replace(/â…œ/g, '3/8').replace(/â…/g, '5/8').replace(/â…/g, '7/8')
    // â”€â”€ GUILLEMETS â”€â”€
    .replace(/Â«/g, '<<').replace(/Â»/g, '>>').replace(/â€¹/g, '<').replace(/â€º/g, '>')
    .replace(/\u201C/g, '"').replace(/\u201D/g, '"').replace(/\u201E/g, '"').replace(/\u201F/g, '"')
    .replace(/\u2018/g, "'").replace(/\u2019/g, "'").replace(/\u201A/g, "'").replace(/\u201B/g, "'")
    .replace(/\u2032/g, "'").replace(/\u2035/g, "'")
    // â”€â”€ TIRETS â”€â”€
    .replace(/[â€“â€”â€•â€’â€‘â€]/g, '-')
    // â”€â”€ ELLIPSES / POINTS â”€â”€
    .replace(/â€¦/g, '...').replace(/â€¥/g, '..').replace(/â€/g, '_').replace(/â“/g, '~')
    // â”€â”€ SYMBOLES LÃ‰GAUX / COMMERCE â”€â”€
    .replace(/Â©/g, '(c)').replace(/Â®/g, '(R)').replace(/â„¢/g, '(TM)')
    .replace(/â„ƒ/g, 'degC').replace(/â„‰/g, 'degF').replace(/Â°/g, 'deg')
    .replace(/â„–/g, 'No.').replace(/â„—/g, '(P)').replace(/â„ /g, 'SM').replace(/â„¡/g, 'TEL')
    // â”€â”€ MONNAIES â”€â”€
    .replace(/â‚¬/g, 'EUR').replace(/Â£/g, 'GBP').replace(/Â¥/g, 'JPY').replace(/Â¢/g, 'c')
    .replace(/â‚¹/g, 'INR').replace(/â‚½/g, 'RUB').replace(/â‚¿/g, 'BTC').replace(/â‚º/g, 'TRY')
    .replace(/â‚©/g, 'KRW').replace(/â‚ª/g, 'ILS')
    // â”€â”€ DIVERS RESTANTS â”€â”€
    .replace(/âŒ€/g, 'diam').replace(/â/g, '.').replace(/â‘/g, '**')
    // â”€â”€ NETTOYAGE FINAL : tout ce qui reste hors Latin-1 â†’ underscore lisible â”€â”€
    .replace(/[^\x00-\xFF]/g, '_');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONVERSION HTML (QUILL) VERS TEXTE FORMATÃ‰ POUR PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Retourne une liste de segments formatÃ©s :
// { text, bold, italic, underline, fontSize (pt), prefix }
// UtilisÃ© pour le rendu riche dans le PDF.
function htmlToFormattedText(html) {
  if (!html || html.trim() === '') return '';
  const temp = document.createElement('div');
  temp.innerHTML = html;
  let result = '';
  function processNode(node, indent) {
    if (node.nodeType === Node.TEXT_NODE) {
      const t = node.textContent;
      if (t) result += t;
    } else if (node.nodeType === Node.ELEMENT_NODE) {
      const tag = node.tagName.toLowerCase();
      if (tag === 'ol') {
        let idx = 1;
        Array.from(node.children).forEach(li => {
          result += indent + idx + '. ' + li.textContent.trim() + '\n';
          idx++;
        });
      } else if (tag === 'ul') {
        Array.from(node.children).forEach(li => {
          result += indent + '- ' + li.textContent.trim() + '\n';
        });
      } else if (tag === 'br') {
        result += '\n';
      } else if (tag === 'p') {
        Array.from(node.childNodes).forEach(c => processNode(c, indent));
        result += '\n';
      } else {
        Array.from(node.childNodes).forEach(c => processNode(c, indent));
      }
    }
  }
  Array.from(temp.childNodes).forEach(c => processNode(c, ''));
  return result.trim();
}

// Extrait des segments { text, bold, italic, underline, fontSize, prefix }
// depuis le HTML Quill pour un rendu PDF fidÃ¨le au formatage.
function htmlToRichSegments(html) {
  if (!html || html.trim() === '') return [];
  const temp = document.createElement('div');
  temp.innerHTML = html;

  const segments = [];

  // Tailles Quill â†’ points PDF (base 9 pt)
  const quillSizeMap = { 'small': 7.5, 'large': 12, 'huge': 15 };
  // Headers â†’ taille et gras
  const headerSizeMap = { '1': 16, '2': 13, '3': 11 };

  function walk(node, ctx) {
    if (node.nodeType === Node.TEXT_NODE) {
      const text = node.textContent;
      if (text) {
        segments.push({
          text: text,
          bold: ctx.bold,
          italic: ctx.italic,
          underline: ctx.underline,
          fontSize: ctx.fontSize,
          font: ctx.font || null,
          color: ctx.color || null,
          background: ctx.background || null,
          prefix: ctx.prefix || ''
        });
      }
      return;
    }
    if (node.nodeType !== Node.ELEMENT_NODE) return;
    const tag = node.tagName.toLowerCase();

    let c = Object.assign({}, ctx);
    c.prefix = '';

    if (tag === 'strong' || tag === 'b') c.bold = true;
    if (tag === 'em' || tag === 'i') c.italic = true;
    if (tag === 'u') c.underline = true;
    
    // Balise <font> avec attributs color et/ou bgcolor (gÃ©nÃ©rÃ© par execCommand)
    if (tag === 'font') {
      if (node.getAttribute('color')) {
        c.color = node.getAttribute('color');
      }
      if (node.getAttribute('bgcolor')) {
        c.background = node.getAttribute('bgcolor');
      }
    }
    
    // Balise <span> avec attributs style (gÃ©nÃ©rÃ© par execCommand moderne)
    if (tag === 'span') {
      if (node.style.color) {
        c.color = node.style.color;
      }
      if (node.style.backgroundColor) {
        c.background = node.style.backgroundColor;
      }
    }

    // Headers h1/h2/h3
    if (tag === 'h1') { c.bold = true; c.fontSize = headerSizeMap['1']; }
    if (tag === 'h2') { c.bold = true; c.fontSize = headerSizeMap['2']; }
    if (tag === 'h3') { c.bold = true; c.fontSize = headerSizeMap['3']; }

    // Taille via classe ql-size
    if (node.classList) {
      if (node.classList.contains('ql-size-small'))  c.fontSize = quillSizeMap['small'];
      if (node.classList.contains('ql-size-large'))  c.fontSize = quillSizeMap['large'];
      if (node.classList.contains('ql-size-huge'))   c.fontSize = quillSizeMap['huge'];
      // Police
      if (node.classList.contains('ql-font-times'))        c.font = 'times';
      if (node.classList.contains('ql-font-georgia'))      c.font = 'times'; // approx serif
      if (node.classList.contains('ql-font-merriweather')) c.font = 'times';
      if (node.classList.contains('ql-font-roboto'))       c.font = 'helvetica';
      if (node.classList.contains('ql-font-lato'))         c.font = 'helvetica';
      if (node.classList.contains('ql-font-opensans'))     c.font = 'helvetica';
      if (node.classList.contains('ql-font-courier'))      c.font = 'courier';
    }
    // Taille via attribut data-size (Quill v2)
    if (node.dataset && node.dataset.size) {
      c.fontSize = quillSizeMap[node.dataset.size] || c.fontSize;
    }
    // Taille via style inline
    if (node.style && node.style.fontSize) {
      const fs = parseFloat(node.style.fontSize);
      if (!isNaN(fs)) c.fontSize = fs * 0.75;
    }

    // â”€â”€ COULEURS Quill â”€â”€
    // Couleur du texte via classe .ql-color-xxx ou style.color
    if (node.classList) {
      // Quill gÃ©nÃ¨re des classes comme ql-color-#e60000
      const colorClass = Array.from(node.classList).find(cls => cls.startsWith('ql-color-'));
      if (colorClass) {
        const colorValue = colorClass.replace('ql-color-', '').replace(/_/g, '');
        c.color = '#' + colorValue;
      }
      // Fond (surlignage) via classe .ql-bg-xxx
      const bgClass = Array.from(node.classList).find(cls => cls.startsWith('ql-bg-'));
      if (bgClass) {
        const bgValue = bgClass.replace('ql-bg-', '').replace(/_/g, '');
        c.background = '#' + bgValue;
      }
    }
    // Couleur via style inline
    if (node.style) {
      if (node.style.color) {
        c.color = node.style.color;
      }
      if (node.style.backgroundColor) {
        c.background = node.style.backgroundColor;
      }
    }

    // â”€â”€ LISTES Quill v2 : <ol> contient des <li data-list="bullet|ordered"> â”€â”€
    if (tag === 'ol' || tag === 'ul') {
      let orderedIdx = 1;
      Array.from(node.children).forEach(li => {
        const dataList = li.getAttribute('data-list') || (tag === 'ol' ? 'ordered' : 'bullet');
        const isOrdered = dataList === 'ordered';
        const prefix = isOrdered ? (orderedIdx++) + '. ' : 'â€¢ ';
        let liCtx = Object.assign({}, c, { prefix: '' });
        segments.push({ text: prefix, bold: liCtx.bold, italic: liCtx.italic, underline: liCtx.underline, fontSize: liCtx.fontSize, prefix: '', listStart: true });
        Array.from(li.childNodes).forEach(ch => walk(ch, liCtx));
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: liCtx.fontSize, prefix: '' });
      });
      return;
    }
    // Li isolÃ© (hors ol/ul)
    if (tag === 'li') {
      const dataList = node.getAttribute('data-list') || 'bullet';
      const prefix = dataList === 'ordered' ? '1. ' : 'â€¢ ';
      segments.push({ text: prefix, bold: c.bold, italic: c.italic, underline: c.underline, fontSize: c.fontSize, prefix: '', listStart: true });
      Array.from(node.childNodes).forEach(ch => walk(ch, c));
      segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      return;
    }

    if (tag === 'br') {
      segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      return;
    }
    if (tag === 'p' || tag === 'h1' || tag === 'h2' || tag === 'h3') {
      Array.from(node.childNodes).forEach(ch => walk(ch, c));
      segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      return;
    }
    // Image base64
    if (tag === 'img') {
      const src = node.getAttribute('src') || '';
      if (src.startsWith('data:image')) {
        // Taille dÃ©finie par l'utilisateur (data-w/data-h ou style.width), sinon naturelle
        const userW = parseInt(node.getAttribute('data-w'))  || parseInt(node.style.width)  || node.naturalWidth  || 0;
        const userH = parseInt(node.getAttribute('data-h'))  || parseInt(node.style.height) || node.naturalHeight || 0;
        segments.push({ type: 'image', src: src, w: userW, h: userH });
      }
      return;
    }
    // Tableau HTML â€” chaque cellule produit des segments riches (couleurs, gras, etc.)
    if (tag === 'table') {
      const tableData = [];
      node.querySelectorAll('tr').forEach(tr => {
        const rowData = [];
        tr.querySelectorAll('td, th').forEach(cell => {
          const isHeader = cell.tagName.toLowerCase() === 'th';
          // Couleur de fond de la cellule elle-mÃªme
          let cellBg = null;
          if (cell.style && cell.style.backgroundColor) cellBg = cell.style.backgroundColor;
          // Contexte de base pour le contenu de la cellule
          const cellCtx = Object.assign({}, c, {
            bold:       isHeader || c.bold,
            color:      (cell.style && cell.style.color) ? cell.style.color : c.color,
            background: null,
            prefix:     ''
          });
          // Extraire les segments riches du contenu de la cellule
          const before = segments.length;
          Array.from(cell.childNodes).forEach(ch => walk(ch, cellCtx));
          const richContent = segments.splice(before);
          // Nettoyer les \n terminaux
          while (richContent.length && richContent[richContent.length-1].text === '\n') richContent.pop();
          rowData.push({
            text:        cell.textContent.trim(),
            isHeader:    isHeader,
            bgColor:     cellBg,
            richContent: richContent
          });
        });
        if (rowData.length > 0) tableData.push(rowData);
      });
      if (tableData.length > 0) {
        segments.push({ type: 'table', tableData: tableData, prefix: '' });
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      }
      return;
    }
    Array.from(node.childNodes).forEach(ch => walk(ch, c));
  }

  const baseCtx = { bold: false, italic: false, underline: false, fontSize: null, color: null, background: null, prefix: '' };
  Array.from(temp.childNodes).forEach(n => walk(n, baseCtx));

  // Nettoyer les \n finaux
  while (segments.length && segments[segments.length-1].text === '\n') segments.pop();

  return segments;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰NÃ‰RATION PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genererPDF() {
  // VÃ©rifier que jsPDF est chargÃ©
  if (typeof window.jspdf === 'undefined') {
    alert('âš ï¸ La bibliothÃ¨que PDF n\'est pas chargÃ©e.\n\nPour utiliser cette fonctionnalitÃ© :\n1. Assurez-vous d\'avoir une connexion internet\n2. Rechargez la page\n3. Attendez quelques secondes que les bibliothÃ¨ques se chargent\n\nVous pouvez aussi utiliser l\'export Word (.docx) qui fonctionne avec les mÃªmes bibliothÃ¨ques.');
    return;
  }

  const entete = collecterEntete();
  const etapes = collecterEtapes();
  const P = collecterParams();

  if (!entete.niveau || !entete.module || !entete.sequence || !entete.activite || !entete.objectif) {
    alert('Veuillez remplir au minimum : ' + (entete.labelNiveau||'Niveau') + ', ' + (entete.labelModule||'Module') + ', ' + (entete.labelSequence||'SÃ©quence') + ', ' + (entete.labelActivite||'ActivitÃ©') + ' et ' + (entete.labelObjectif||'Objectif') + '.');
    showTab('entete'); return;
  }
  if (!etapes.length) {
    alert('Veuillez ajouter au moins une Ã©tape.');
    showTab('etapes'); return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4', putOnlyUsedFonts: true });

    const PW = doc.internal.pageSize.width;   // 595.28
    const PH = doc.internal.pageSize.height;  // 841.89
  const M = P.marge;
  const UW = PW - 2 * M; // largeur utile

  const [mr, mg, mb] = hexToRgb(P.colorMain);
  const [gr, gg, gb] = hexToRgb(P.colorGrid);
  const [er, eg, eb] = hexToRgb(P.colorEtapeText);

  function setBlue() { doc.setFillColor(mr, mg, mb); doc.setDrawColor(mr, mg, mb); }
  function setWhite() { doc.setFillColor(255,255,255); doc.setDrawColor(255,255,255); }
  function setGray() { doc.setDrawColor(gr, gg, gb); }
  function setBlueStroke(w) {
    doc.setDrawColor(mr, mg, mb);
    doc.setLineWidth(w);
  }

  function drawTextWhite(text, x, y, size, bold) {
    doc.setTextColor(255,255,255);
    doc.setFontSize(size);
    doc.setFont('times', bold ? 'bold' : 'normal');
    doc.text(normaliserTexte(text), x, y);
  }
  function drawTextBlack(text, x, y, size, bold) {
    doc.setTextColor(0,0,0);
    doc.setFontSize(size);
    doc.setFont('times', bold ? 'bold' : 'normal');
    doc.text(normaliserTexte(text), x, y);
  }
  function drawTextBlue(text, x, y, size, bold) {
    doc.setTextColor(mr, mg, mb);
    doc.setFontSize(size);
    doc.setFont('times', bold ? 'bold' : 'normal');
    doc.text(normaliserTexte(text), x, y);
  }

  // Dessine un rect blanc avec bordure bleue (zone de saisie remplie ou vide)
  // Fonction pour dessiner du texte avec formatage HTML (gras, italique, COULEURS)
  function drawFormattedText(htmlText, x, y, maxWidth, fontSize) {
    if (!htmlText) return;
    
    // Utiliser htmlToRichSegments pour dÃ©tecter tous les formats y compris les couleurs
    const segments = htmlToRichSegments(htmlText);
    if (segments.length === 0) return;
    
    let currentX = x;
    const currentY = y;
    
    segments.forEach(seg => {
      if (seg.text && seg.text !== '\n') {
        const fs = seg.fontSize || fontSize;
        const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
        
        doc.setFontSize(fs);
        doc.setFont('times', fontStyle);
        
        // Appliquer la couleur du texte si prÃ©sente
        if (seg.color) {
          const [r, g, b] = hexToRgb(seg.color);
          doc.setTextColor(r, g, b);
        } else {
          doc.setTextColor(0, 0, 0);
        }
        
        const safeText = normaliserTexte(seg.text);
        const textWidth = doc.getTextWidth(safeText);
        
        // Appliquer le surlignage si prÃ©sent
        if (seg.background) {
          const [br, bg, bb] = hexToRgb(seg.background);
          doc.setFillColor(br, bg, bb);
          doc.rect(currentX, currentY - fs * 0.85, textWidth, fs * 1.1, 'F');
        }
        
        doc.text(safeText, currentX, currentY);
        currentX += textWidth;
      }
    });
    
    doc.setFont('times', 'normal');
    doc.setTextColor(0, 0, 0);
  }

  // Fonction pour dessiner du texte centrÃ© avec formatage HTML
  function drawFormattedTextCentered(htmlText, centerX, y, maxWidth, fontSize, defaultColor) {
    if (!htmlText) return;
    
    // Utiliser htmlToRichSegments pour dÃ©tecter tous les formats y compris les couleurs
    const segments = htmlToRichSegments(htmlText);
    if (segments.length === 0) return;
    
    // Filtrer les segments de texte (pas les \n)
    const textSegments = segments.filter(seg => seg.text && seg.text !== '\n');
    
    // Calculer la largeur totale pour centrer
    let totalWidth = 0;
    textSegments.forEach(seg => {
      const fs = seg.fontSize || fontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      doc.setFont('times', fontStyle);
      doc.setFontSize(fs);
      totalWidth += doc.getTextWidth(normaliserTexte(seg.text));
    });
    
    // Dessiner en centrant
    let currentX = centerX - totalWidth / 2;
    
    textSegments.forEach(seg => {
      const fs = seg.fontSize || fontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      
      doc.setFont('times', fontStyle);
      doc.setFontSize(fs);
      
      // Appliquer la couleur du segment si prÃ©sente, sinon la couleur par dÃ©faut
      if (seg.color) {
        const [r, g, b] = hexToRgb(seg.color);
        doc.setTextColor(r, g, b);
      } else if (defaultColor) {
        doc.setTextColor(defaultColor[0], defaultColor[1], defaultColor[2]);
      } else {
        doc.setTextColor(0, 0, 0);
      }
      
      const safeText = normaliserTexte(seg.text);
      const textWidth = doc.getTextWidth(safeText);
      
      // Appliquer le surlignage si prÃ©sent
      if (seg.background) {
        const [br, bg, bb] = hexToRgb(seg.background);
        doc.setFillColor(br, bg, bb);
        doc.rect(currentX, y - fs * 0.85, textWidth, fs * 1.1, 'F');
      }
      
      doc.text(safeText, currentX, y);
      currentX += textWidth;
    });
    
    doc.setFont('times', 'normal');
    doc.setTextColor(0, 0, 0);
  }

  // Fonction pour dessiner du texte blanc avec formatage HTML et limite de largeur
  function drawFormattedTextWhite(htmlText, x, y, maxWidth, fontSize) {
    if (!htmlText) return;
    
    // Utiliser htmlToRichSegments pour dÃ©tecter tous les formats y compris les couleurs
    const segments = htmlToRichSegments(htmlText);
    if (segments.length === 0) return;
    
    let currentX = x;
    const currentY = y;
    
    segments.forEach(seg => {
      if (seg.text && seg.text !== '\n') {
        const fs = seg.fontSize || fontSize;
        const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
        
        doc.setFontSize(fs);
        doc.setFont('times', fontStyle);
        
        // Appliquer la couleur du texte si prÃ©sente, sinon BLANC par dÃ©faut
        if (seg.color) {
          const [r, g, b] = hexToRgb(seg.color);
          doc.setTextColor(r, g, b);
        } else {
          doc.setTextColor(255, 255, 255); // BLANC par dÃ©faut pour fond bleu
        }
        
        const safeText = normaliserTexte(seg.text);
        const textWidth = doc.getTextWidth(safeText);
        
        // VÃ©rifier si on dÃ©passe la largeur max
        const remainingWidth = maxWidth - (currentX - x);
        if (textWidth > remainingWidth && remainingWidth > 0) {
          let truncated = safeText;
          while (doc.getTextWidth(truncated + '...') > remainingWidth && truncated.length > 0) {
            truncated = truncated.slice(0, -1);
          }
          
          // Appliquer surlignage si prÃ©sent
          if (seg.background) {
            const [br, bg, bb] = hexToRgb(seg.background);
            doc.setFillColor(br, bg, bb);
            doc.rect(currentX, currentY - fs * 0.85, doc.getTextWidth(truncated + '...'), fs * 1.1, 'F');
          }
          
          doc.text(truncated + '...', currentX, currentY);
          return;
        }
        
        // Appliquer le surlignage si prÃ©sent
        if (seg.background) {
          const [br, bg, bb] = hexToRgb(seg.background);
          doc.setFillColor(br, bg, bb);
          doc.rect(currentX, currentY - fs * 0.85, textWidth, fs * 1.1, 'F');
        }
        
        doc.text(safeText, currentX, currentY);
        currentX += textWidth;
      }
    });
    
    doc.setFont('times', 'normal');
    doc.setTextColor(0, 0, 0);
  }

  function drawInputBox(x, y, w, h, text, fontSize) {
    doc.setFillColor(255,255,255);
    setBlueStroke(0.5);
    doc.rect(x, y, w, h, 'FD');
    if (text) {
      // Parser le HTML pour extraire le formatage
      drawFormattedText(text, x + 2, y + (fontSize || P.fontEnteteContent) * 0.85 + 1, w - 4, fontSize || P.fontEnteteContent);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RENDU TEXTE RICHE DEPUIS SEGMENTS QUILL
  // Dessine des segments formatÃ©s (gras/italique/soulignÃ©/taille)
  // dans une zone de largeur maxW depuis (x, startY).
  // Retourne la hauteur totale utilisÃ©e.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function drawRichTextSegments(segments, x, startY, maxW, baseFontSize, defaultColor) {
    if (!segments || segments.length === 0) return 0;
    const lineH = baseFontSize * 1.35;
    let curX = x;
    let curY = startY;

    // DÃ©couper les segments texte en lignes en respectant maxW
    const lines = [];
    let curLine = [];
    let curLineW = 0;

    // Accumulateur mixte : { type:'text-line', items } | { type:'image', src } | { type:'table', tableData }
    const blocks = [];
    let pendingLine = [];
    let pendingLineW = 0;

    function flushPendingLine() {
      if (pendingLine.length > 0) {
        blocks.push({ type: 'text-line', items: pendingLine });
        pendingLine = [];
        pendingLineW = 0;
      }
    }

    segments.forEach(seg => {
      // Segments spÃ©ciaux (image, table)
      if (seg.type === 'image') {
        flushPendingLine();
        blocks.push({ type: 'image', src: seg.src });
        return;
      }
      if (seg.type === 'table') {
        flushPendingLine();
        blocks.push({ type: 'table', tableData: seg.tableData });
        return;
      }
      if (seg.text === '\n') {
        flushPendingLine();
        return;
      }
      const fs = seg.fontSize || baseFontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      const fontFace = seg.font || 'times';
      doc.setFontSize(fs);
      doc.setFont(fontFace, fontStyle);

      const words = seg.text.split(/(\s+)/);
      words.forEach(word => {
        if (word === '') return;
        const wW = doc.getTextWidth(normaliserTexte(word));
        if (pendingLineW + wW > maxW && pendingLine.length > 0 && word.trim() !== '') {
          flushPendingLine();
        }
        pendingLine.push({ 
          word, 
          bold: seg.bold, 
          italic: seg.italic, 
          underline: seg.underline, 
          fontSize: fs, 
          font: seg.font || 'times',
          color: seg.color || null,
          background: seg.background || null
        });
        pendingLineW += wW;
      });
    });
    flushPendingLine();

    // Dessiner les blocs
    blocks.forEach(block => {
      if (block.type === 'text-line') {
        let lx = x;
        block.items.forEach(item => {
          const fs = item.fontSize || baseFontSize;
          const fontStyle = item.bold && item.italic ? 'bolditalic' : item.bold ? 'bold' : item.italic ? 'italic' : 'normal';
          const fontFace = item.font || 'times';
          doc.setFontSize(fs);
          doc.setFont(fontFace, fontStyle);
          
          // Appliquer la couleur du texte
          if (item.color) {
            const [r, g, b] = hexToRgb(item.color);
            doc.setTextColor(r, g, b);
          } else if (defaultColor) {
            doc.setTextColor(...defaultColor);
          } else {
            doc.setTextColor(0, 0, 0);
          }
          
          const safeWord = normaliserTexte(item.word);
          const w = doc.getTextWidth(safeWord);
          
          // Appliquer le surlignage (background)
          if (item.background) {
            const [br, bg, bb] = hexToRgb(item.background);
            doc.setFillColor(br, bg, bb);
            doc.rect(lx, curY - fs * 0.85, w, fs * 1.1, 'F');
          }
          
          // Dessiner le texte
          doc.text(safeWord, lx, curY);
          
          // Soulignement
          if (item.underline) {
            const [ur, ug, ub] = item.color ? hexToRgb(item.color) : [0, 0, 0];
            doc.setDrawColor(ur, ug, ub);
            doc.setLineWidth(0.3);
            doc.line(lx, curY + 0.8, lx + w, curY + 0.8);
          }
          lx += w;
        });
        curY += lineH;

      } else if (block.type === 'image') {
        // Dimensions : taille user en px â†’ converti en pt (1px â‰ˆ 0.75pt), bornÃ© Ã  maxW
        try {
          const imgEl = new Image();
          imgEl.src = block.src;
          const natW = imgEl.naturalWidth  || 200;
          const natH = imgEl.naturalHeight || 150;
          const ratio = natH / (natW || 1);
          let imgW, imgH;
          if (block.w && block.w > 0) {
            // Taille dÃ©finie par l'utilisateur : 1px CSS = 0.75pt PDF
            imgW = Math.min(maxW, block.w * 0.75);
            imgH = block.h ? block.h * 0.75 : imgW * ratio;
          } else {
            // Pas de taille dÃ©finie : limiter Ã  160pt de large
            imgW = Math.min(maxW, 160);
            imgH = imgW * ratio;
          }
          let fmt = 'JPEG';
          if (block.src.includes('image/png'))  fmt = 'PNG';
          else if (block.src.includes('image/gif'))  fmt = 'GIF';
          else if (block.src.includes('image/webp')) fmt = 'WEBP';
          doc.addImage(block.src, fmt, x, curY, imgW, imgH);
          doc.setDrawColor(180,180,180); doc.setLineWidth(0.4);
          doc.rect(x, curY, imgW, imgH, 'S');
          curY += imgH + 3;
        } catch(e) {
          curY += lineH;
        }

      } else if (block.type === 'table') {
        // Dessiner le tableau : rÃ©partir Ã©quitablement les colonnes
        const tdata = block.tableData;
        if (!tdata || tdata.length === 0) return;
        const nCols = Math.max(...tdata.map(r => r.length));
        const colW = maxW / nCols;
        const cellPadTop = 2;
        const cellPadLeft = 3;
        const cellFontSize = baseFontSize * 0.88;

        tdata.forEach(row => {
          // Calculer la hauteur de la ligne (multi-wrap) en se basant sur le texte brut
          let maxLinesInRow = 1;
          row.forEach(cell => {
            doc.setFontSize(cellFontSize);
            doc.setFont('times', cell.isHeader ? 'bold' : 'normal');
            const wrapped = doc.splitTextToSize(normaliserTexte(cell.text || ''), colW - cellPadLeft*2);
            maxLinesInRow = Math.max(maxLinesInRow, wrapped.length);
          });
          const rowH = maxLinesInRow * cellFontSize * 1.3 + cellPadTop * 2;

          // Dessiner les cellules
          let cx = x;
          row.forEach((cell, ci) => {
            const cw = colW;
            // Fond de la cellule : couleur personnalisÃ©e > header bleu pÃ¢le > blanc
            if (cell.bgColor) {
              const [br2, bg2, bb2] = hexToRgb(cell.bgColor);
              doc.setFillColor(br2, bg2, bb2);
            } else if (cell.isHeader) {
              doc.setFillColor(227, 242, 253);
            } else {
              doc.setFillColor(255, 255, 255);
            }
            doc.rect(cx, curY, cw, rowH, 'F');
            // Bordure cellule
            doc.setDrawColor(mr, mg, mb); doc.setLineWidth(0.5);
            doc.rect(cx, curY, cw, rowH, 'S');

            // Texte riche : parcourir les segments de la cellule
            const segs = (cell.richContent && cell.richContent.length > 0)
              ? cell.richContent
              : [{ text: cell.text || '', bold: cell.isHeader, italic: false, color: null }];

            let ty = curY + cellPadTop + cellFontSize * 0.85;
            let lineX = cx + cellPadLeft;
            let lineW = 0;

            segs.forEach(seg => {
              if (!seg.text || seg.text === '\n') {
                if (seg.text === '\n') { ty += cellFontSize * 1.3; lineX = cx + cellPadLeft; lineW = 0; }
                return;
              }
              const fontStyle = (seg.bold && seg.italic) ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
              doc.setFontSize(cellFontSize);
              doc.setFont('times', fontStyle);
              // Couleur du texte
              if (seg.color) {
                const [tr2, tg2, tb2] = hexToRgb(seg.color);
                doc.setTextColor(tr2, tg2, tb2);
              } else {
                doc.setTextColor(0, 0, 0);
              }
              // Fond du run (surlignage dans la cellule)
              if (seg.background) {
                const [hr2, hg2, hb2] = hexToRgb(seg.background);
                const runW = doc.getTextWidth(normaliserTexte(seg.text));
                doc.setFillColor(hr2, hg2, hb2);
                doc.rect(lineX + lineW, ty - cellFontSize * 0.8, runW, cellFontSize * 1.1, 'F');
                // RÃ©tablir la couleur du texte aprÃ¨s avoir dessinÃ© le fond
                if (seg.color) {
                  const [tr2, tg2, tb2] = hexToRgb(seg.color);
                  doc.setTextColor(tr2, tg2, tb2);
                } else {
                  doc.setTextColor(0, 0, 0);
                }
              }
              // Wrap simple dans la largeur de la cellule
              const words = doc.splitTextToSize(normaliserTexte(seg.text), cw - cellPadLeft * 2);
              words.forEach((line, li) => {
                if (li > 0) { ty += cellFontSize * 1.3; lineX = cx + cellPadLeft; lineW = 0; }
                doc.text(line, lineX + lineW, ty);
                lineW += doc.getTextWidth(line);
              });
            });
            cx += cw;
          });
          curY += rowH;
        });
        curY += 3; // espace aprÃ¨s tableau
      }
    });

    return curY - startY;
  }

  // Calcule la hauteur qu'occuperait drawRichTextSegments sans dessiner
  function measureRichTextSegments(segments, maxW, baseFontSize) {
    if (!segments || segments.length === 0) return baseFontSize * 1.35;
    const lineH = baseFontSize * 1.35;
    let totalH = 0;
    let curLineW = 0;
    let lineCount = 0;

    function flushLines() {
      if (lineCount > 0 || curLineW > 0) {
        totalH += (lineCount + (curLineW > 0 ? 1 : 0)) * lineH;
        lineCount = 0;
        curLineW = 0;
      }
    }

    segments.forEach(seg => {
      if (seg.type === 'image') {
        flushLines();
        // Estimation hauteur image : taille user en pt ou 120pt par dÃ©faut
        if (seg.w && seg.h && seg.w > 0) {
          const maxW2 = maxW || 160;
          const imgW2 = Math.min(maxW2, seg.w * 0.75);
          const imgH2 = seg.h * 0.75 * (imgW2 / (seg.w * 0.75));
          totalH += imgH2 + 3;
        } else {
          totalH += 123;
        }
        return;
      }
      if (seg.type === 'table') {
        flushLines();
        // Estimer la hauteur du tableau
        const tdata = seg.tableData || [];
        const nCols = Math.max(1, ...tdata.map(r => r.length));
        const colW = maxW / nCols;
        const cellFontSize = baseFontSize * 0.88;
        tdata.forEach(row => {
          let maxLines = 1;
          row.forEach(cell => {
            doc.setFontSize(cellFontSize);
            doc.setFont('times', cell.isHeader ? 'bold' : 'normal');
            const wrapped = doc.splitTextToSize(normaliserTexte(cell.text || ''), colW - 6);
            maxLines = Math.max(maxLines, wrapped.length);
          });
          totalH += maxLines * cellFontSize * 1.3 + 4;
        });
        totalH += 3;
        return;
      }
      if (seg.text === '\n') {
        lineCount++;
        curLineW = 0;
        return;
      }
      const fs = seg.fontSize || baseFontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      doc.setFontSize(fs);
      doc.setFont('times', fontStyle);
      const words = seg.text.split(/(\s+)/);
      words.forEach(word => {
        if (word === '') return;
        const wW = doc.getTextWidth(normaliserTexte(word));
        if (curLineW + wW > maxW && curLineW > 0 && word.trim() !== '') {
          lineCount++;
          curLineW = 0;
        }
        curLineW += wW;
      });
    });
    flushLines();

    return Math.max(totalH, lineH);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MÃ‰TADONNÃ‰ES & WATERMARK INVISIBLE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const timestamp = new Date().toISOString();
  const uniqueId = 'FP-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9);
  
  // MÃ©tadonnÃ©es du PDF (traÃ§abilitÃ© invisible)
  doc.setProperties({
    title: `Fiche PÃ©dagogique - ${entete.activite || 'Sans titre'}`,
    subject: `${entete.module || ''} - ${entete.sequence || ''}`,
    author: 'EZ-ZAKY AZIZ',
    keywords: `fiche pÃ©dagogique, ${entete.niveau || ''}, Ã©ducation`,
    creator: 'GÃ©nÃ©rateur de Fiches PÃ©dagogiques v2.11 Â© EZ-ZAKY AZIZ',
    producer: `App ID: ${uniqueId} | Generated: ${timestamp}`
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PAGE 1 : EN-TÃŠTE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sep1 = M + UW * P.sep1Pct;
  const sep2 = M + UW * P.sep2Pct;
  const endX = M + UW;

  let hy = M;

  // â”€â”€ Ligne 1 (h = l1h) â€” Prof + Niveau avec labels personnalisÃ©s
  const L1H = P.l1h;
  setBlue();
  doc.rect(M, hy, UW, L1H, 'F');
  doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
  doc.line(sep1, hy, sep1, hy+L1H);
  doc.line(sep2, hy, sep2, hy+L1H);
  // Titre centrÃ© Ã  gauche
  drawTextWhite('FICHE PEDAGOGIQUE', M+5, hy + L1H*0.65, P.fontEnteteLabel, true);
  // Prof label + valeur avec formatage HTML
  const profLabel = normaliserTexte(entete.labelProf || 'PROF');
  drawTextWhite(profLabel + ' : ', sep1+5, hy + L1H*0.65, P.fontEnteteLabel, true);
  const profLabelW = doc.getTextWidth(profLabel + ' : ');
  // Dessiner la valeur du prof avec formatage HTML (limitÃ© en largeur)
  const profValueMaxW = sep2 - (sep1 + 5 + profLabelW + 5);
  drawFormattedTextWhite(entete.prof, sep1 + 5 + profLabelW, hy + L1H*0.65, profValueMaxW, P.fontEnteteLabel);
  // Niveau label
  const niveauLabel = normaliserTexte(entete.labelNiveau || 'NIVEAU');
  drawTextWhite(niveauLabel + ' :', sep2+5, hy + L1H*0.65, P.fontEnteteLabel, true);
  const niveauLabelW = doc.getTextWidth(niveauLabel + ' :') + 4;
  const niveauX = sep2 + niveauLabelW + 6;
  drawInputBox(niveauX, hy+4, endX-niveauX-2, L1H-8, entete.niveau, P.fontEnteteContent);
  hy += L1H;

  // â”€â”€ Ligne 2 (module)
  const L234H = P.l234h;
  const moduleLabel = normaliserTexte(entete.labelModule || 'Module');
  setBlue();
  doc.rect(M, hy, UW, L234H, 'F');
  drawTextWhite(moduleLabel + ' :', M+5, hy + L234H*0.65, P.fontEnteteLabel, true);
  const moduleLabelW = doc.getTextWidth(moduleLabel + ' :') + 4;
  drawInputBox(M+moduleLabelW+8, hy+3, endX-(M+moduleLabelW+8)-4, L234H-6, entete.module, P.fontEnteteContent);
  hy += L234H;

  // â”€â”€ Ligne 3 (sÃ©quence)
  const sequenceLabel = normaliserTexte(entete.labelSequence || 'Sequence');
  setBlue();
  doc.rect(M, hy, UW, L234H, 'F');
  drawTextWhite(sequenceLabel + ' :', M+5, hy + L234H*0.65, P.fontEnteteLabel, true);
  const seqLabelW = doc.getTextWidth(sequenceLabel + ' :') + 4;
  drawInputBox(M+seqLabelW+8, hy+3, endX-(M+seqLabelW+8)-4, L234H-6, entete.sequence, P.fontEnteteContent);
  hy += L234H;

  // â”€â”€ Ligne 4 (activitÃ© + support) â€” hauteur flexible INDÃ‰PENDANTE pour chaque case
  doc.setFontSize(P.fontEnteteContent);
  doc.setFont('times','normal');

  const activiteLabel = normaliserTexte(entete.labelActivite || 'Activite');
  const actLabelW = doc.getTextWidth(activiteLabel + ' :') + 4;
  // Largeur rÃ©elle de la zone de valeur ActivitÃ©
  const actBoxW = sep2 - (M + actLabelW + 8) - 4;
  // Largeur rÃ©elle de la zone de valeur Support
  const supportLabel = normaliserTexte(entete.labelSupport || 'Support');
  doc.setFontSize(P.fontEnteteLabel); doc.setFont('times','bold');
  const supLabelW = doc.getTextWidth(supportLabel + ' :') + 4;
  doc.setFontSize(P.fontEnteteContent); doc.setFont('times','normal');
  const supportBoxX = sep2 + supLabelW + 8;
  const supportBoxW = endX - supportBoxX - 4;

  // â€” Mesurer hauteur nÃ©cessaire pour ActivitÃ©
  const activiteSegments = htmlToRichSegments(entete.activite || '');
  const actNeededH = Math.max(L234H, measureRichTextSegments(activiteSegments, actBoxW - 4, P.fontEnteteContent) + 8);

  // â€” Mesurer hauteur nÃ©cessaire pour Support
  const supportSegments = htmlToRichSegments(entete.support || '');
  const supportNeededH = Math.max(L234H, measureRichTextSegments(supportSegments, supportBoxW - 4, P.fontEnteteContent) + 8);

  // â€” Hauteur de la ligne 4 = max des deux pour le fond bleu
  const rowL4H = Math.max(actNeededH, supportNeededH);
  const hyL4 = hy;

  // Fond bleu toute la ligne
  setBlue();
  doc.rect(M, hyL4, UW, rowL4H, 'F');

  // â€” Zone ActivitÃ© (gauche de sep2) avec SA propre hauteur
  drawTextWhite(activiteLabel + ' :', M+5, hyL4 + P.fontEnteteLabel * 1.1 + 3, P.fontEnteteLabel, true);
  doc.setFillColor(255,255,255);
  setBlueStroke(0.5);
  // La case ActivitÃ© utilise uniquement sa hauteur nÃ©cessaire
  doc.rect(M + actLabelW + 8, hyL4 + 3, actBoxW, actNeededH - 6, 'FD');
  if (activiteSegments && activiteSegments.length > 0) {
    drawRichTextSegments(activiteSegments, M + actLabelW + 10, hyL4 + P.fontEnteteContent * 0.85 + 4, actBoxW - 4, P.fontEnteteContent, [0,0,0]);
  }

  // â€” Zone Support (droite de sep2) avec SA propre hauteur
  setBlue();
  drawTextWhite(supportLabel + ' :', sep2 + 5, hyL4 + P.fontEnteteLabel * 1.1 + 3, P.fontEnteteLabel, true);
  doc.setFillColor(255,255,255);
  setBlueStroke(0.5);
  // La case Support utilise uniquement sa hauteur nÃ©cessaire
  doc.rect(supportBoxX, hyL4 + 3, supportBoxW, supportNeededH - 6, 'FD');
  if (supportSegments && supportSegments.length > 0) {
    drawRichTextSegments(supportSegments, supportBoxX + 2, hyL4 + P.fontEnteteContent * 0.85 + 4, supportBoxW - 4, P.fontEnteteContent, [0,0,0]);
  }
  hy += rowL4H;

  // â”€â”€ LIGNES LIBRES SUPPLÃ‰MENTAIRES (entre ligne 4 et objectif)
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        const llLabel = normaliserTexte(ll.label || 'Champ');
        const llVal = ll.val1 || '';
        setBlue();
        doc.rect(M, hy, UW, L234H, 'F');
        drawTextWhite(llLabel + ' :', M+5, hy + L234H*0.65, P.fontEnteteLabel, true);
        const llLabelW = doc.getTextWidth(llLabel + ' :') + 4;
        drawInputBox(M+llLabelW+8, hy+3, endX-(M+llLabelW+8)-4, L234H-6, llVal, P.fontEnteteContent);
        hy += L234H;
      } else {
        // Double
        const ll1 = normaliserTexte(ll.label1 || 'Champ A');
        const ll2 = normaliserTexte(ll.label2 || 'Champ B');
        setBlue();
        doc.rect(M, hy, UW, L234H, 'F');
        // SÃ©parateur au milieu
        const midX = M + UW/2;
        doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
        doc.line(midX, hy, midX, hy+L234H);
        // Gauche
        const ll1Y = hy + L234H * 0.65;
        drawTextWhite(ll1 + ' :', M+5, ll1Y, P.fontEnteteLabel, true);
        const ll1W = doc.getTextWidth(ll1 + ' :') + 4;
        drawInputBox(M+ll1W+8, hy+3, midX-(M+ll1W+8)-2, L234H-6, ll.val1||'', P.fontEnteteContent);
        // Droite
        drawTextWhite(ll2 + ' :', midX+5, ll1Y, P.fontEnteteLabel, true);
        const ll2W = doc.getTextWidth(ll2 + ' :') + 4;
        drawInputBox(midX+ll2W+8, hy+3, endX-(midX+ll2W+8)-4, L234H-6, ll.val2||'', P.fontEnteteContent);
        hy += L234H;
      }
    });
  }

  // â”€â”€ Ligne Objectif â€” hauteur 100 % flexible selon contenu rÃ©el
  const L5H = P.l5h;
  const objectifLabel = normaliserTexte(entete.labelObjectif || 'Objectif');
  const objectifSegments = htmlToRichSegments(entete.objectif);
  const objectifBoxW = endX - (M + 60) - 2;

  // Mesurer la hauteur rÃ©elle nÃ©cessaire pour le contenu de l'objectif
  let objectifMeasuredH = 0;
  if (objectifSegments.length > 0) {
    // Compter lignes : chaque newline et chaque wrapping de texte
    const lineHObj = P.fontEnteteContent * 1.45;
    let curLineW = 0;
    let lineCount = 1; // au moins 1 ligne
    objectifSegments.forEach(seg => {
      if (seg.type === 'image') { lineCount += Math.ceil(120 / lineHObj) + 1; curLineW = 0; return; }
      if (seg.type === 'table') {
        const tdata = seg.tableData || [];
        tdata.forEach(row => { lineCount += 2; });
        curLineW = 0; return;
      }
      if (seg.text === '\n') { lineCount++; curLineW = 0; return; }
      const fs = seg.fontSize || P.fontEnteteContent;
      const style = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      doc.setFontSize(fs); doc.setFont('times', style);
      const words = seg.text.split(/\s+/);
      words.forEach(w => {
        if (!w) return;
        const wW = doc.getTextWidth(normaliserTexte(w));
        if (curLineW + wW > objectifBoxW - 8 && curLineW > 0 && w.trim()) { lineCount++; curLineW = 0; }
        curLineW += wW;
      });
    });
    objectifMeasuredH = lineCount * lineHObj + 10; // +10 padding vertical (rÃ©duit de 12 Ã  10)
  } else {
    // Si vide, utiliser une hauteur minimale rÃ©duite
    objectifMeasuredH = L5H * 0.5; // Hauteur minimale rÃ©duite quand vide
  }
  // Prendre le minimum entre L5H et la hauteur mesurÃ©e + padding
  const objectifNeededH = Math.max(L5H * 0.6, objectifMeasuredH); // Hauteur minimum rÃ©duite Ã  60% de L5H

  setBlue();
  doc.rect(M, hy, 60, objectifNeededH, 'F');
  drawTextWhite(objectifLabel + ' :', M+3, hy + Math.min(20, objectifNeededH * 0.4), P.fontEnteteLabel, true);
  doc.setFillColor(255,255,255);
  setBlueStroke(0.5);
  doc.rect(M+60, hy+2, objectifBoxW, objectifNeededH-4, 'FD');
  if (objectifSegments.length > 0) {
    drawRichTextSegments(objectifSegments, M+62, hy + P.fontEnteteContent * 0.85 + 3, objectifBoxW - 6, P.fontEnteteContent, [0,0,0]);
  }
  const dynamicHeaderH = (hy - M) + objectifNeededH;
  hy += objectifNeededH;

  setBlueStroke(1.5);
  doc.setFillColor(0,0,0);
  doc.rect(M, M, UW, dynamicHeaderH, 'S');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PAGE 1 : TABLEAU â€” EN-TÃŠTE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ty = M + dynamicHeaderH + P.gap; // top du tableau

  const colsSup = P.colsSup || [];
  // Construire les en-tÃªtes et largeurs : [Ã‰tapes, DÃ©roulement, ...SupCols, DurÃ©e]
  const colHeaders = [P.labelColEtapes, P.labelColDeroulement, ...colsSup.map(c => c.label), P.labelColDuree];
  const colWidths  = [P.cols[0] * UW, P.cols[1] * UW, ...colsSup.map(c => (c.width/100) * UW), P.cols[2] * UW];

  const TH = P.tableHeaderH;
  setBlue();
  doc.rect(M, ty, UW, TH, 'F');
  // sÃ©parateurs et textes en-tÃªte colonnes
  let cx = M;
  colHeaders.forEach((hdr, i) => {
    // sÃ©parateur vertical (sauf premier)
    if (i > 0) {
      doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
      doc.line(cx, ty, cx, ty+TH);
    }
    const lines = hdr.split('\n');
    doc.setTextColor(255,255,255);
    doc.setFontSize(P.fontTableHeader);
    doc.setFont('times','bold');
    if (lines.length === 1) {
      doc.text(lines[0], cx + colWidths[i]/2, ty + TH/2 + P.fontTableHeader*0.35, {align:'center'});
    } else {
      doc.text(lines[0], cx + colWidths[i]/2, ty + TH*0.38, {align:'center'});
      doc.text(lines[1], cx + colWidths[i]/2, ty + TH*0.72, {align:'center'});
    }
    cx += colWidths[i];
  });
  // bordure tableau
  setBlueStroke(0.8);
  doc.rect(M, ty, UW, TH, 'S');
  ty += TH;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // LIGNES DE DONNÃ‰ES (multipages)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const RH = P.rowHeight;
  const bottomLimit = PH - M;
  let currentPage = 1;

  function newPage() {
    // Remplir la page courante jusqu'en bas avant de tourner la page
    while (ty + RH <= bottomLimit) {
      doc.setFillColor(255,255,255);
      doc.rect(M, ty, UW, RH, 'F');
      doc.setLineWidth(0.8);
      setBlueStroke(0.8);
      doc.rect(M, ty, UW, RH, 'S');
      ty += RH;
    }
    doc.addPage();
    currentPage++;
    ty = M;
    // En-tÃªte du tableau sur la nouvelle page (identique Ã  la premiÃ¨re)
    setBlue();
    doc.rect(M, ty, UW, TH, 'F');
    let cx2 = M;
    colHeaders.forEach((hdr, i) => {
      if (i > 0) {
        doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
        doc.line(cx2, ty, cx2, ty+TH);
      }
      const lines = hdr.split('\n');
      doc.setTextColor(255,255,255);
      doc.setFontSize(P.fontTableHeader);
      doc.setFont('times','bold');
      if (lines.length === 1) {
        doc.text(lines[0], cx2 + colWidths[i]/2, ty + TH/2 + P.fontTableHeader*0.35, {align:'center'});
      } else {
        doc.text(lines[0], cx2 + colWidths[i]/2, ty + TH*0.38, {align:'center'});
        doc.text(lines[1], cx2 + colWidths[i]/2, ty + TH*0.72, {align:'center'});
      }
      cx2 += colWidths[i];
    });
    setBlueStroke(0.8);
    doc.rect(M, ty, UW, TH, 'S');
    ty += TH;
  }

  // PrÃ©parer les lignes de donnÃ©es
  // Chaque Ã©tape = bloc de lignes
  // Calculer nb de lignes nÃ©cessaires par Ã©tape (wrap)
  function wrapText(text, width, fontSize) {
    if (!text) return [''];
    doc.setFontSize(fontSize);
    doc.setFont('times','normal');
    return doc.splitTextToSize(normaliserTexte(text), width - 4);
  }

  etapes.forEach((etape, etapeIdx) => {
    const w0 = colWidths[0];  // Ã‰tapes
    const w1 = colWidths[1];  // DÃ©roulement
    const wLast = colWidths[colWidths.length - 1]; // DurÃ©e

    // Convertir le HTML Quill en segments riches
    const enseignantSegments = htmlToRichSegments(etape.enseignant);
    const ensTextW = w1 - 6;
    const blockHeight = Math.max(
      measureRichTextSegments(enseignantSegments, ensTextW, P.fontTableContent) + 6,
      P.fontTableContent * 1.35 + 6
    );

    // Separator bleu avant chaque Ã©tape (sauf la premiÃ¨re)
    if (etapeIdx > 0) {
      if (ty + 2 > bottomLimit) newPage();
      setBlueStroke(1.0);
      doc.line(M, ty, M + UW, ty);
    }

    // Si bloc ne rentre pas, nouvelle page
    if (ty + blockHeight > bottomLimit) newPage();

    const blockStart = ty;

    // Fond blanc
    doc.setFillColor(255,255,255);
    doc.rect(M, ty, UW, blockHeight, 'F');

    // Texte col 0 : Ã©tape (centrÃ© verticalement, avec formatage HTML)
    doc.setFontSize(P.fontTableContent);
    doc.setTextColor(er, eg, eb);
    const etapeY = blockStart + blockHeight/2 + P.fontTableContent*0.35;
    
    // Parser le HTML du nom de l'Ã©tape pour extraire texte simple (pour le wrapping)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = etape.nom || '';
    const plainText = tempDiv.textContent || tempDiv.innerText || '';
    const etapeNomLines = wrapText(plainText, w0, P.fontTableContent);
    
    const lineHeight = P.fontTableContent * 1.3;
    if (etapeNomLines.length === 1) {
      // Une seule ligne - dessiner avec formatage HTML centrÃ©
      drawFormattedTextCentered(etape.nom, M + w0/2, etapeY, w0, P.fontTableContent, [er, eg, eb]);
    } else {
      // Multi-lignes - dessiner chaque ligne (sans HTML pour simplifier)
      const startY = blockStart + blockHeight/2 - (etapeNomLines.length * lineHeight)/2 + P.fontTableContent*0.85;
      doc.setFont('times','bold');
      etapeNomLines.forEach((l, li) => {
        doc.text(l, M + w0/2, startY + li*lineHeight, {align:'center'});
      });
    }

    // Texte dÃ©roulement (col 1)
    const ens_x = M + w0 + 3;
    drawRichTextSegments(enseignantSegments, ens_x, blockStart + P.fontTableContent * 0.85 + 3, ensTextW, P.fontTableContent, [0,0,0]);

    // Colonnes supplÃ©mentaires
    let supX = M + w0 + w1;
    colsSup.forEach((col, ci) => {
      const wSup = colWidths[2 + ci];
      const supVal = (etape.supVals && etape.supVals[col.n]) ? normaliserTexte(etape.supVals[col.n]) : '';
      doc.setFont('times','normal');
      doc.setTextColor(0,0,0);
      doc.setFontSize(P.fontTableContent);
      const supLines = wrapText(supVal, wSup, P.fontTableContent);
      supLines.forEach((line, li) => {
        doc.text(line, supX + 2, blockStart + P.fontTableContent * (0.85 + li * 1.3) + 3);
      });
      supX += wSup;
    });

    // DurÃ©e (derniÃ¨re colonne)
    doc.setFont('times','normal');
    doc.setTextColor(0,0,0);
    doc.setFontSize(P.fontTableContent);
    const dur_x = M + UW - wLast + 2;
    doc.text(normaliserTexte(etape.duree || ''), dur_x, blockStart + blockHeight/2 + P.fontTableContent*0.35);

    // Bordure extÃ©rieure du bloc (bleu)
    doc.setLineWidth(0.8);
    setBlueStroke(0.8);
    doc.rect(M, blockStart, UW, blockHeight, 'S');

    // SÃ©parateurs verticaux entre colonnes
    doc.setDrawColor(gr, gg, gb); doc.setLineWidth(0.4);
    let sepX = M + w0;
    for (let i = 1; i < colWidths.length - 1; i++) {
      doc.line(sepX, blockStart, sepX, blockStart + blockHeight);
      sepX += colWidths[i];
    }
    doc.line(sepX, blockStart, sepX, blockStart + blockHeight); // avant DurÃ©e

    ty += blockHeight;
  });

  // Remplissage lignes vides jusqu'en bas (page courante)
  while (ty + RH <= bottomLimit) {
    doc.setFillColor(255,255,255);
    doc.rect(M, ty, UW, RH, 'F');
    // Bordure extÃ©rieure seulement (pas de quadrillage interne)
    doc.setLineWidth(0.8);
    setBlueStroke(0.8);
    doc.rect(M, ty, UW, RH, 'S');
    ty += RH;
  }

  // NumÃ©ros de page et copyright
  const totalPages = doc.internal.getNumberOfPages();
  for (let p = 1; p <= totalPages; p++) {
    doc.setPage(p);
    doc.setFontSize(8);
    doc.setTextColor(150,150,150);
    doc.setFont('times','normal');
    // NumÃ©ro de page centrÃ©
    doc.text(`Page ${p} / ${totalPages}`, PW/2, PH-4, {align:'center'});
    // Date Ã  gauche
    doc.text(`${new Date().toLocaleDateString('fr-FR')}`, M, PH-4);
    // Professeur Ã  droite
    doc.text(normaliserTexte(entete.prof || ''), endX, PH-4, {align:'right'});
    // Copyright discret en bas (trÃ¨s petit) avec ID unique invisible
    doc.setFontSize(6);
    doc.setTextColor(180,180,180);
    doc.text(`\u00A9 EZ-ZAKY AZIZ | App v3.0 | ${uniqueId}`, M, PH-1);
  }

  // Sauvegarde â€” mÃ©thode spÃ©ciale AppsGeyser WebView
  const safeName = (entete.activite || 'fiche').replace(/[^a-zA-Z0-9\u00C0-\u024F]/gi,'_').slice(0,40);
  const pdfFileName = `FichePedagogique_${safeName}_${entete.niveau || 'N'}.pdf`;
  
  // TÃ©lÃ©chargement direct en un clic
  doc.save(pdfFileName);

  showToast();
  
  } catch (error) {
    console.error('Erreur PDF:', error);
    alert('âŒ Erreur lors de la gÃ©nÃ©ration du PDF.\n\nDÃ©tails: ' + error.message + '\n\nAssurez-vous que :\n1. Vous avez une connexion internet\n2. La bibliothÃ¨que jsPDF est chargÃ©e\n3. Tous les champs sont correctement remplis');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THÃˆMES DE MISE EN PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = [
  { id:'bleu',      name:'Bleu classique', main:'#1565C0', accent:'#C9A84C', grid:'#AAAAAA', etape:'#1565C0' },
  { id:'marine',    name:'Marine & or',    main:'#0D2B55', accent:'#D4AF37', grid:'#8899AA', etape:'#0D2B55' },
  { id:'vert',      name:'Vert acadÃ©mique',main:'#1B5E20', accent:'#F9A825', grid:'#A5C8A0', etape:'#1B5E20' },
  { id:'bordeaux',  name:'Bordeaux',       main:'#6D0C22', accent:'#C49A3C', grid:'#B07070', etape:'#6D0C22' },
  { id:'violet',    name:'Violet royal',   main:'#4A148C', accent:'#FFB300', grid:'#9E7CC0', etape:'#4A148C' },
  { id:'ardoise',   name:'Ardoise gris',   main:'#37474F', accent:'#78909C', grid:'#90A4AE', etape:'#37474F' },
  { id:'noir',      name:'Noir & or',      main:'#1A1A1A', accent:'#C9A84C', grid:'#555555', etape:'#C9A84C' },
  { id:'turquoise', name:'Turquoise',      main:'#00695C', accent:'#E65100', grid:'#80CBC4', etape:'#00695C' },
  { id:'rouge',     name:'Rouge vif',      main:'#B71C1C', accent:'#FFD600', grid:'#EF9A9A', etape:'#B71C1C' },
];

let activeThemeId = 'bleu';

function buildThemeGrid() {
  const grid = document.getElementById('theme-grid');
  grid.innerHTML = '';
  THEMES.forEach(t => {
    const div = document.createElement('div');
    div.className = 'theme-swatch' + (t.id === activeThemeId ? ' active' : '');
    div.id = 'swatch-' + t.id;
    div.onclick = () => applyTheme(t.id);
    div.innerHTML = `
      <div class="theme-swatch-bar" style="background:${t.main};">
        <div class="theme-swatch-dot" style="background:${t.accent};"></div>
        <div class="theme-swatch-dot"></div>
        <div class="theme-swatch-dot"></div>
      </div>
      <div class="theme-swatch-body">
        <div class="theme-swatch-line" style="background:${t.main};opacity:0.15;width:100%;"></div>
        <div class="theme-swatch-row">
          <div class="theme-swatch-line" style="background:${t.etape};width:35%;"></div>
          <div class="theme-swatch-line" style="background:#e0e0e0;flex:1;"></div>
        </div>
        <div class="theme-swatch-line" style="background:#e0e0e0;width:80%;"></div>
      </div>
      <div class="theme-swatch-name">${t.name}</div>
    `;
    grid.appendChild(div);
  });
}

function applyTheme(id) {
  const t = THEMES.find(x => x.id === id);
  if (!t) return;
  activeThemeId = id;
  document.getElementById('p-color-main').value = t.main;
  document.getElementById('p-color-accent').value = t.accent;
  document.getElementById('p-color-grid').value = t.grid;
  document.getElementById('p-color-etape-text').value = t.etape;
  // Mettre Ã  jour les swatches actifs
  document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
  const sw = document.getElementById('swatch-' + id);
  if (sw) sw.classList.add('active');
  applyThemePreview();
  // Appliquer aussi Ã  l'interface de l'app
  applyThemeToApp(t.main, t.accent);
}

function applyThemePreview() {
  const main = document.getElementById('p-color-main').value;
  const accent = document.getElementById('p-color-accent').value;
  const etape = document.getElementById('p-color-etape-text').value;
  // AperÃ§u mini
  document.getElementById('tp-header').style.background = main;
  document.getElementById('tp-badge').style.background = accent;
  document.getElementById('tp-table-header').style.background = main;
  document.getElementById('tp-label1').style.color = main;
  document.getElementById('tp-label2').style.color = main;
  document.getElementById('tp-etape').style.color = etape;
}

function applyThemeToApp(main, accent) {
  // Mettre Ã  jour les variables CSS de l'interface
  const r = document.documentElement.style;
  r.setProperty('--blue', main);
  r.setProperty('--blue-light', main);
  r.setProperty('--blue-dark', main);
  r.setProperty('--blue-pale', main + '18');
  r.setProperty('--gold', accent);
}

// Initialisation
buildThemeGrid();
applyThemePreview();


function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOUVELLES FONCTIONNALITÃ‰S
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



// â”€â”€â”€â”€â”€â”€ COLLECTER DONNÃ‰ES â”€â”€â”€â”€â”€â”€
function collecterDonnees() {
  const entete = collecterEntete();
  const etapes = collecterEtapes();
  
  return {
    entete: entete,
    etapes: etapes,
    objectifs: [entete.objectif], // L'objectif est dans l'en-tÃªte
    timestamp: Date.now()
  };
}

function genererPreviewLive() {
  const entete  = collecterEntete();
  const etapes  = collecterEtapes();
  const P       = collecterParams();
  const content = document.getElementById('preview-live-content');
  if (!content) return;

  const couleur = (document.getElementById('p-color-main')?.value) || '#1565C0';
  const accent  = (document.getElementById('p-color-accent')?.value) || '#C9A84C';

  // â”€â”€ EN-TÃŠTE â”€â”€
  let html = `<div style="margin:0 0 14px;padding:12px 14px;border:2px solid ${couleur};border-radius:10px;background:#fff;font-size:13px;line-height:1.7;">`;

  // Ligne prof / niveau
  html += `<div style="display:flex;gap:6px;margin-bottom:4px;">
    <div style="flex:1;padding:5px 8px;background:${couleur}15;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelProf||'Prof'} :</span>
      <span style="color:#222;"> ${entete.prof||'â€”'}</span>
    </div>
    <div style="min-width:90px;padding:5px 8px;background:${couleur}15;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelNiveau||'Niveau'} :</span>
      <span style="color:#222;"> ${entete.niveau||'â€”'}</span>
    </div>
  </div>`;

  // Module
  if (entete.module || entete.labelModule) {
    html += `<div style="padding:4px 8px;margin-bottom:3px;"><span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelModule||'Module'} :</span> <span style="color:#222;">${entete.module||'â€”'}</span></div>`;
  }

  // SÃ©quence
  if (entete.sequence || entete.labelSequence) {
    html += `<div style="padding:4px 8px;margin-bottom:3px;"><span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelSequence||'SÃ©quence'} :</span> <span style="color:#222;">${entete.sequence||'â€”'}</span></div>`;
  }

  // ActivitÃ© / Support
  html += `<div style="display:flex;gap:6px;margin-bottom:4px;">
    <div style="flex:1;padding:4px 8px;background:${accent}22;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelActivite||'ActivitÃ©'} :</span>
      <span style="color:#222;"> ${entete.activite||'â€”'}</span>
    </div>
    <div style="min-width:90px;padding:4px 8px;background:${accent}22;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelSupport||'Support'} :</span>
      <span style="color:#222;"> ${entete.support||'â€”'}</span>
    </div>
  </div>`;

  // Lignes libres
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        html += `<div style="padding:4px 8px;margin-bottom:3px;"><span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${ll.label||'Champ'} :</span> <span style="color:#222;">${ll.val1||'â€”'}</span></div>`;
      } else {
        html += `<div style="display:flex;gap:6px;margin-bottom:3px;">
          <div style="flex:1;padding:4px 8px;background:${couleur}0d;border-radius:5px;">
            <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${ll.label1||'A'} :</span>
            <span style="color:#222;"> ${ll.val1||'â€”'}</span>
          </div>
          <div style="flex:1;padding:4px 8px;background:${couleur}0d;border-radius:5px;">
            <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${ll.label2||'B'} :</span>
            <span style="color:#222;"> ${ll.val2||'â€”'}</span>
          </div>
        </div>`;
      }
    });
  }

  // Objectif
  const objTxt = getQuillText('objectif-wrapper') || 'â€”';
  html += `<div style="padding:5px 8px;margin-top:2px;border-top:1px solid ${couleur}33;">
    <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelObjectif||'Objectif(s)'} :</span>
    <span style="color:#444;font-style:italic;"> ${objTxt.substring(0,200)}${objTxt.length>200?'â€¦':''}</span>
  </div>`;

  html += `</div>`;

  // â”€â”€ TABLEAU DES Ã‰TAPES â”€â”€
  if (etapes.length === 0) {
    html += `<p style="color:#999;font-size:13px;text-align:center;padding:20px;">Aucune Ã©tape saisie.</p>`;
  } else {
    const colsSup = P.colsSup || [];
    html += `<div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="background:${couleur};color:white;">
          <th style="padding:7px 8px;border:1px solid ${couleur};text-align:left;font-weight:700;">${P.labelColEtapes||'Ã‰tapes'}</th>
          <th style="padding:7px 8px;border:1px solid ${couleur};text-align:left;font-weight:700;">${P.labelColDeroulement||'DÃ©roulement de la sÃ©ance'}</th>
          ${colsSup.map(c => `<th style="padding:7px 8px;border:1px solid ${couleur};text-align:left;font-weight:700;">${c.label}</th>`).join('')}
          <th style="padding:7px 8px;border:1px solid ${couleur};text-align:center;font-weight:700;">${P.labelColDuree||'DurÃ©e'}</th>
        </tr>
      </thead>
      <tbody>`;

    etapes.forEach((e, i) => {
      const bg = i % 2 === 0 ? '#fff' : `${couleur}08`;
      // Extraire le texte brut du HTML enseignant
      const div = document.createElement('div');
      div.innerHTML = e.enseignant || '';
      const enseignantTxt = div.textContent || '';
      html += `<tr style="background:${bg};">
          <td style="padding:6px 8px;border:1px solid ${couleur}44;font-weight:600;color:${couleur};">${e.nom||'â€”'}</td>
          <td style="padding:6px 8px;border:1px solid ${couleur}44;color:#333;">${enseignantTxt||'â€”'}</td>
          ${colsSup.map(c => `<td style="padding:6px 8px;border:1px solid ${couleur}44;color:#555;">${e.supVals?.[c.n]||'â€”'}</td>`).join('')}
          <td style="padding:6px 8px;border:1px solid ${couleur}44;text-align:center;color:#555;">${e.duree||'â€”'}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
  }

  content.innerHTML = html;
}

// Mettre Ã  jour la prÃ©visualisation quand les donnÃ©es changent
document.addEventListener('input', function(e) {
  clearTimeout(window.previewTimeout);
  window.previewTimeout = setTimeout(genererPreviewLive, 500);
  // Recalculer durÃ©e si champ durÃ©e modifiÃ©
  if (e.target && e.target.id && e.target.id.includes('-duree')) {
    calculerDureeTotale();
  }
  // Sauvegarde auto avec debounce
  clearTimeout(window.saveTimeout);
  window.saveTimeout = setTimeout(sauvegarderAutomatique, 1500);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITAIRE : Conversion couleur vers format Word (RRGGBB)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function colorToWordHex(color) {
  if (!color) return null;
  
  // Si dÃ©jÃ  au format RRGGBB (6 caractÃ¨res sans #)
  if (/^[0-9A-Fa-f]{6}$/.test(color)) {
    return color.toUpperCase();
  }
  
  // Utiliser hexToRgb pour convertir n'importe quel format
  const [r, g, b] = hexToRgb(color);
  
  // Convertir en hexadÃ©cimal RRGGBB
  const toHex = (n) => {
    const hex = n.toString(16).toUpperCase();
    return hex.length === 1 ? '0' + hex : hex;
  };
  
  return toHex(r) + toHex(g) + toHex(b);
}

// â”€â”€â”€â”€â”€â”€ EXPORT DOCX (OpenXML via JSZip) â”€â”€â”€â”€â”€â”€
function genererDOCX() {
  if (typeof JSZip === 'undefined') {
    alert('âš ï¸ La bibliothÃ¨que Word n\'est pas chargÃ©e.\n\nPour utiliser cette fonctionnalitÃ© :\n1. Assurez-vous d\'avoir une connexion internet\n2. Rechargez la page\n3. Attendez quelques secondes que les bibliothÃ¨ques se chargent');
    return;
  }

  const entete = collecterEntete();
  const etapes = collecterEtapes();
  const P = collecterParams();

  const rawColor = ((document.getElementById('p-color-main') && document.getElementById('p-color-main').value) || '#1565C0').replace('#','');

  // â”€â”€ Helpers â”€â”€
  function x(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
  }
  function strip(html) {
    if (!html) return '';
    const d = document.createElement('div');
    d.innerHTML = html;
    return d.textContent || d.innerText || '';
  }

  // â”€â”€ Dimensions en twips (1 cm = 567 twips) â”€â”€
  // A4 : 11906 Ã— 16838 twips  |  marges : 284 twips â‰ˆ 5 mm chaque cÃ´tÃ©
  const PG_W   = 11906;
  const MARGIN = 284;          // 5 mm â€” collÃ© aux bords
  const TW     = PG_W - MARGIN * 2;  // 11338 twips = largeur utile

  // En-tÃªte : label court (2cm) + valeur large
  const LBL_W  = Math.round(TW * 0.18);   // ~18% â‰ˆ 2040 twips
  const VAL_W  = TW - LBL_W;              // ~82%

  // Ligne double (prof|niveau, activitÃ©|support) : 4 colonnes
  const LBL2_W = Math.round(TW * 0.16);   // 16%
  const VAL2_W = Math.round(TW * 0.34);   // 34%  â†’ 2Ã—(16+34)=100%

  // Tableau Ã©tapes : colonnes dynamiques
  const colsSup = P.colsSup || [];
  const E0 = Math.round(TW * (P.cols[0]));   // Ã‰tapes
  const E1 = Math.round(TW * (P.cols[1]));   // DÃ©roulement
  const E2 = TW - E0 - E1 - colsSup.reduce((s, c) => s + Math.round(TW * c.width/100), 0); // DurÃ©e
  const ESup = colsSup.map(c => Math.round(TW * c.width / 100)); // Colonnes sup

  const BDR = (color) => `<w:tcBorders>
      <w:top    w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
      <w:left   w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
      <w:bottom w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
      <w:right  w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
    </w:tcBorders>`;

  const CELL_MAR = `<w:tcMar>
      <w:top    w:w="60"  w:type="dxa"/>
      <w:bottom w:w="60"  w:type="dxa"/>
      <w:left   w:w="100" w:type="dxa"/>
      <w:right  w:w="100" w:type="dxa"/>
    </w:tcMar>`;

  // Cellule gÃ©nÃ©rique : (texte, gras, fondColorÃ©, largeurDxa, alignCenter, italique)
  function cell(text, bold, colored, w, center, italic) {
    const fill  = colored ? rawColor : 'FFFFFF';
    const tClr  = colored ? 'FFFFFF' : '000000';
    const jc    = center  ? '<w:jc w:val="center"/>' : '';
    return `<w:tc>
      <w:tcPr>
        <w:tcW w:w="${w}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="${fill}"/>
        ${BDR(rawColor)}
        ${CELL_MAR}
      </w:tcPr>
      <w:p>
        <w:pPr><w:spacing w:before="40" w:after="40"/>${jc}</w:pPr>
        <w:r>
          <w:rPr>
            ${bold   ? '<w:b/>'   : ''}
            ${italic ? '<w:i/>'   : ''}
            <w:color w:val="${tClr}"/>
            <w:sz w:val="18"/><w:szCs w:val="18"/>
          </w:rPr>
          <w:t xml:space="preserve">${x(text)}</w:t>
        </w:r>
      </w:p>
    </w:tc>`;
  }

  // Cellule avec support du formatage HTML (gras/italique/couleur/surlignage)
  function cellWithFormat(htmlText, colored, w, center) {
    const fill  = colored ? rawColor : 'FFFFFF';
    const tClr  = colored ? 'FFFFFF' : '000000';
    const jc    = center  ? '<w:jc w:val="center"/>' : '';
    
    const temp = document.createElement('div');
    temp.innerHTML = htmlText || '';
    
    let runs = '';
    
    function processNode(node, isBold, isItalic, isUnderline, textColor, bgColor) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        if (text) {
          // Couleur du texte : prioritÃ© Ã  la couleur hÃ©ritÃ©e, sinon couleur par dÃ©faut de la cellule
          const resolvedColor = textColor ? colorToWordHex(textColor) : tClr;
          // Couleur de fond (surlignage)
          const bgXml = bgColor ? `<w:shd w:val="clear" w:color="auto" w:fill="${colorToWordHex(bgColor)}"/>` : '';
          runs += `<w:r>
            <w:rPr>
              ${isBold ? '<w:b/><w:bCs/>' : ''}
              ${isItalic ? '<w:i/><w:iCs/>' : ''}
              ${isUnderline ? '<w:u w:val="single"/>' : ''}
              <w:color w:val="${resolvedColor}"/>
              ${bgXml}
              <w:sz w:val="18"/><w:szCs w:val="18"/>
            </w:rPr>
            <w:t xml:space="preserve">${x(text)}</w:t>
          </w:r>`;
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName.toLowerCase();
        let bold      = isBold      || tag === 'b' || tag === 'strong';
        let italic    = isItalic    || tag === 'i' || tag === 'em';
        let underline = isUnderline || tag === 'u';
        let color     = textColor;
        let bg        = bgColor;
        
        // <font color="..."> gÃ©nÃ©rÃ© par execCommand('foreColor')
        if (tag === 'font') {
          if (node.getAttribute('color')) color = node.getAttribute('color');
          if (node.getAttribute('bgcolor')) bg = node.getAttribute('bgcolor');
        }
        // <span style="color:...; background-color:..."> gÃ©nÃ©rÃ© par execCommand moderne
        if (node.style && node.style.color) color = node.style.color;
        if (node.style && node.style.backgroundColor) bg = node.style.backgroundColor;
        
        // Saut de ligne
        if (tag === 'br') {
          runs += `<w:r><w:br/></w:r>`;
          return;
        }
        
        Array.from(node.childNodes).forEach(child => {
          processNode(child, bold, italic, underline, color, bg);
        });
      }
    }
    
    Array.from(temp.childNodes).forEach(child => {
      processNode(child, false, false, false, null, null);
    });
    
    if (!runs) {
      runs = `<w:r>
        <w:rPr>
          <w:color w:val="${tClr}"/>
          <w:sz w:val="18"/><w:szCs w:val="18"/>
        </w:rPr>
        <w:t xml:space="preserve"></w:t>
      </w:r>`;
    }
    
    return `<w:tc>
      <w:tcPr>
        <w:tcW w:w="${w}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="${fill}"/>
        ${BDR(rawColor)}
        ${CELL_MAR}
      </w:tcPr>
      <w:p>
        <w:pPr><w:spacing w:before="40" w:after="40"/>${jc}</w:pPr>
        ${runs}
      </w:p>
    </w:tc>`;
  }

  // â”€â”€ Convertit HTML Quill â†’ paragraphes OpenXML â”€â”€
  // CORRECTION COMPLÃˆTE: Parser le HTML Quill pour extraire texte, images ET tableaux
  // Collecteur global d'images pour les ajouter au ZIP
  let docxImages = [];
  let docxImageCounter = 0;
  
  // Fonction helper pour convertir HTML en runs Word â€” lit les couleurs du contenu, avec gras par dÃ©faut
  function htmlToRunsWithColor(htmlText, defaultColor) {
    const temp = document.createElement('div');
    temp.innerHTML = htmlText || '';
    
    let runs = '';
    
    function processNode(node, isBold, isItalic, isUnderline, textColor, bgColor) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        if (text) {
          // Couleur rÃ©solue : couleur hÃ©ritÃ©e du HTML, sinon defaultColor (couleur du thÃ¨me)
          const resolvedColor = textColor ? colorToWordHex(textColor) : defaultColor;
          const bgXml = bgColor ? `<w:shd w:val="clear" w:color="auto" w:fill="${colorToWordHex(bgColor)}"/>` : '';
          runs += `<w:r>
            <w:rPr>
              <w:b/><w:bCs/>
              ${isItalic ? '<w:i/><w:iCs/>' : ''}
              ${isUnderline ? '<w:u w:val="single"/>' : ''}
              <w:color w:val="${resolvedColor}"/>
              ${bgXml}
              <w:sz w:val="18"/><w:szCs w:val="18"/>
            </w:rPr>
            <w:t xml:space="preserve">${x(text)}</w:t>
          </w:r>`;
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName.toLowerCase();
        let bold      = isBold      || tag === 'b' || tag === 'strong';
        let italic    = isItalic    || tag === 'i' || tag === 'em';
        let underline = isUnderline || tag === 'u';
        let color     = textColor;
        let bg        = bgColor;
        
        // <font color="..."> gÃ©nÃ©rÃ© par execCommand('foreColor')
        if (tag === 'font') {
          if (node.getAttribute('color')) color = node.getAttribute('color');
          if (node.getAttribute('bgcolor')) bg = node.getAttribute('bgcolor');
        }
        // <span style="color:...; background-color:...">
        if (node.style && node.style.color) color = node.style.color;
        if (node.style && node.style.backgroundColor) bg = node.style.backgroundColor;
        
        if (tag === 'br') {
          runs += `<w:r><w:br/></w:r>`;
          return;
        }
        
        Array.from(node.childNodes).forEach(child => {
          processNode(child, bold, italic, underline, color, bg);
        });
      }
    }
    
    Array.from(temp.childNodes).forEach(child => {
      processNode(child, false, false, false, null, null);
    });
    
    if (!runs) {
      runs = `<w:r>
        <w:rPr>
          <w:b/><w:bCs/>
          <w:color w:val="${defaultColor}"/>
          <w:sz w:val="18"/><w:szCs w:val="18"/>
        </w:rPr>
        <w:t></w:t>
      </w:r>`;
    }
    
    return runs;
  }
  
  function htmlToWParagraphs(html, fontSize) {
    if (!html) return `<w:p><w:pPr><w:spacing w:before="40" w:after="40"/></w:pPr></w:p>`;
    const fs = fontSize || 18;
    
    // Utiliser la mÃªme fonction que le PDF pour parser le HTML
    const segments = htmlToRichSegmentsForDocx(html);
    
    let output = '';
    let currentParagraph = [];
    
    segments.forEach((seg, idx) => {
      // IMAGE
      if (seg.type === 'image') {
        // Flush paragraph en cours
        if (currentParagraph.length > 0) {
          output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
          currentParagraph = [];
        }
        
        // Ajouter l'image Ã  la collection globale
        docxImageCounter++;
        const imageId = docxImageCounter;
        const rId = `rId${imageId + 1}`;  // +1 car rId1 est rÃ©servÃ© pour styles.xml
        
        // DÃ©terminer l'extension
        let ext = 'png';
        if (seg.src.startsWith('data:image/jpeg') || seg.src.startsWith('data:image/jpg')) {
          ext = 'jpeg';
        } else if (seg.src.startsWith('data:image/gif')) {
          ext = 'gif';
        }
        
        // Dimensions : taille user (seg.w/seg.h en px CSS) ou naturelle
        let natW = 400, natH = 300;
        try {
          const tmpImg = new Image();
          tmpImg.src = seg.src;
          if (tmpImg.naturalWidth > 0) { natW = tmpImg.naturalWidth; natH = tmpImg.naturalHeight; }
        } catch(e) {}
        // Utiliser la taille dÃ©finie par l'utilisateur si disponible
        const usedW = (seg.w && seg.w > 0) ? seg.w : natW;
        const usedH = (seg.h && seg.h > 0) ? seg.h : Math.round(usedW * (natH / (natW || 1)));
        // 1 px CSS (96 DPI) = 9525 EMU ; largeur max ~14cm, hauteur max ~20cm
        const MAX_W_EMU = 5040000;
        const MAX_H_EMU = 7200000;
        const ratio = usedH / (usedW || 1);
        let widthEMU = Math.min(MAX_W_EMU, usedW * 9525);
        let heightEMU = Math.round(widthEMU * ratio);
        if (heightEMU > MAX_H_EMU) {
          heightEMU = MAX_H_EMU;
          widthEMU = Math.round(heightEMU / ratio);
        }
        
        docxImages.push({
          id: imageId,
          rId: rId,
          src: seg.src,
          ext: ext
        });
        
        // Structure XML EXACTEMENT comme le test qui fonctionne
        output += `<w:p>
      <w:r>
        <w:drawing>
          <wp:inline>
            <wp:extent cx="${widthEMU}" cy="${heightEMU}"/>
            <wp:docPr id="${imageId}" name="Picture ${imageId}"/>
            <a:graphic>
              <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
                <pic:pic>
                  <pic:nvPicPr>
                    <pic:cNvPr id="${imageId}" name="Picture ${imageId}"/>
                    <pic:cNvPicPr/>
                  </pic:nvPicPr>
                  <pic:blipFill>
                    <a:blip r:embed="${rId}"/>
                    <a:stretch>
                      <a:fillRect/>
                    </a:stretch>
                  </pic:blipFill>
                  <pic:spPr>
                    <a:xfrm>
                      <a:off x="0" y="0"/>
                      <a:ext cx="${widthEMU}" cy="${heightEMU}"/>
                    </a:xfrm>
                    <a:prstGeom prst="rect">
                      <a:avLst/>
                    </a:prstGeom>
                  </pic:spPr>
                </pic:pic>
              </a:graphicData>
            </a:graphic>
          </wp:inline>
        </w:drawing>
      </w:r>
    </w:p>`;
        return;
      }
      
      // TABLEAU
      if (seg.type === 'table') {
        // Flush paragraph en cours
        if (currentParagraph.length > 0) {
          output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
          currentParagraph = [];
        }
        
        // CrÃ©er un vrai tableau Word
        const tableData = seg.tableData;
        if (tableData && tableData.length > 0) {
          // Calculer le nombre de colonnes
          const numCols = Math.max(...tableData.map(row => row.length));
          const colWidth = Math.floor(9000 / numCols); // Largeur totale divisÃ©e par nb colonnes
          
          output += `<w:tbl>
            <w:tblPr>
              <w:tblW w:w="9000" w:type="dxa"/>
              <w:tblBorders>
                <w:top w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:left w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:bottom w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:right w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:insideH w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:insideV w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
              </w:tblBorders>
            </w:tblPr>
            <w:tblGrid>`;
          
          for (let i = 0; i < numCols; i++) {
            output += `<w:gridCol w:w="${colWidth}"/>`;
          }
          output += `</w:tblGrid>`;
          
          // Lignes du tableau â€” segments riches avec couleurs par run
          tableData.forEach((row, rowIdx) => {
            output += `<w:tr>`;
            row.forEach((cell, cellIdx) => {
              const isHeader = cell.isHeader || rowIdx === 0;
              // Fond de cellule : couleur personnalisÃ©e > header bleu pÃ¢le > blanc
              const bgFill = cell.bgColor
                ? colorToWordHex(cell.bgColor)
                : (isHeader ? 'E3F2FD' : 'FFFFFF');

              // Construire les runs riches depuis richContent
              const cellSegs = (cell.richContent && cell.richContent.length > 0)
                ? cell.richContent
                : [{ text: cell.text || '', bold: isHeader, italic: false, color: null, background: null }];

              let cellParagraphs = '';
              let curRuns = [];

              const flushCellPara = () => {
                const jc = isHeader ? '<w:jc w:val="center"/>' : '';
                cellParagraphs += `<w:p><w:pPr><w:spacing w:before="20" w:after="20"/>${jc}</w:pPr>${curRuns.join('')}</w:p>`;
                curRuns = [];
              };

              cellSegs.forEach(seg => {
                if (seg.text === '\n') { flushCellPara(); return; }
                if (!seg.text) return;
                const txtHex   = seg.color      ? colorToWordHex(seg.color)      : '000000';
                const bgHex    = seg.background ? colorToWordHex(seg.background) : null;
                const bgRunXml = bgHex ? `<w:shd w:val="clear" w:color="auto" w:fill="${bgHex}"/>` : '';
                const fontXml  = seg.font ? `<w:rFonts w:ascii="${seg.font}" w:hAnsi="${seg.font}" w:cs="${seg.font}"/>` : '';
                curRuns.push(`<w:r><w:rPr>${fontXml}${(seg.bold || isHeader) ? '<w:b/><w:bCs/>' : ''}${seg.italic ? '<w:i/><w:iCs/>' : ''}${seg.underline ? '<w:u w:val="single"/>' : ''}<w:color w:val="${txtHex}"/>${bgRunXml}<w:sz w:val="${fs}"/><w:szCs w:val="${fs}"/></w:rPr><w:t xml:space="preserve">${x(seg.text)}</w:t></w:r>`);
              });
              if (curRuns.length > 0) flushCellPara();
              if (!cellParagraphs) {
                cellParagraphs = `<w:p><w:pPr><w:spacing w:before="20" w:after="20"/></w:pPr><w:r><w:rPr><w:sz w:val="${fs}"/></w:rPr><w:t></w:t></w:r></w:p>`;
              }

              output += `<w:tc>
                <w:tcPr>
                  <w:tcW w:w="${colWidth}" w:type="dxa"/>
                  <w:shd w:val="clear" w:color="auto" w:fill="${bgFill}"/>
                </w:tcPr>
                ${cellParagraphs}
              </w:tc>`;
            });
            output += `</w:tr>`;
          });
          
          output += `</w:tbl>`;
          output += `<w:p><w:pPr><w:spacing w:before="0" w:after="100"/></w:pPr></w:p>`;
        }
        return;
      }
      
      // TEXTE
      if (seg.text) {
        if (seg.text === '\n') {
          if (currentParagraph.length > 0) {
            output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
            currentParagraph = [];
          }
        } else {
          const txt = x(seg.text);
          if (txt) {
            const segFs = seg.fontSize || fs;
            if (seg.listStart && currentParagraph.length > 0) {
              output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
              currentParagraph = [];
            }
            const fontXml = seg.font ? `<w:rFonts w:ascii="${seg.font}" w:hAnsi="${seg.font}" w:cs="${seg.font}"/>` : '';
            
            // Couleur du texte - Convertir en format Word (RRGGBB sans #)
            let colorXml = '';
            if (seg.color) {
              const colorHex = colorToWordHex(seg.color);
              if (colorHex) colorXml = `<w:color w:val="${colorHex}"/>`;
            }
            
            // Couleur de fond (surlignage) - Word utilise w:shd
            let bgXml = '';
            if (seg.background) {
              const bgHex = colorToWordHex(seg.background);
              if (bgHex) bgXml = `<w:shd w:val="clear" w:color="auto" w:fill="${bgHex}"/>`;
            }
            
            currentParagraph.push(`<w:r><w:rPr>${fontXml}${seg.bold?'<w:b/><w:bCs/>':''}${seg.italic?'<w:i/><w:iCs/>':''}${seg.underline?'<w:u w:val="single"/>':''}${colorXml}${bgXml}<w:sz w:val="${segFs}"/><w:szCs w:val="${segFs}"/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`);
          }
        }
      }
    });
    
    // Flush dernier paragraphe
    if (currentParagraph.length > 0) {
      output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
    }
    
    return output || `<w:p><w:pPr><w:spacing w:before="40" w:after="40"/></w:pPr></w:p>`;
  }
  
  // Parser HTML Quill en segments (texte, images, tableaux)
  function htmlToRichSegmentsForDocx(html) {
    if (!html || html.trim() === '') return [];
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const segments = [];

    const quillSizeMap = { 'small': 14, 'large': 24, 'huge': 30 }; // demi-points Word
    const headerSizeMap = { '1': 32, '2': 26, '3': 22 }; // demi-points Word

    function walk(node, ctx) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        if (text) segments.push({ 
          text, 
          bold: ctx.bold, 
          italic: ctx.italic, 
          underline: ctx.underline, 
          fontSize: ctx.fontSize, 
          isHeader: ctx.isHeader, 
          font: ctx.font || null,
          color: ctx.color || null,
          background: ctx.background || null
        });
        return;
      }
      if (node.nodeType !== Node.ELEMENT_NODE) return;
      const tag = node.tagName.toLowerCase();
      let c = Object.assign({}, ctx);

      if (tag === 'strong' || tag === 'b') c.bold = true;
      if (tag === 'em'     || tag === 'i') c.italic = true;
      if (tag === 'u') c.underline = true;
      
      // Balise <font> avec attributs color et/ou bgcolor (gÃ©nÃ©rÃ© par execCommand)
      if (tag === 'font') {
        if (node.getAttribute('color')) {
          c.color = node.getAttribute('color');
        }
        if (node.getAttribute('bgcolor')) {
          c.background = node.getAttribute('bgcolor');
        }
      }
      
      // Balise <span> avec attributs style (gÃ©nÃ©rÃ© par execCommand moderne)
      if (tag === 'span') {
        if (node.style.color) {
          c.color = node.style.color;
        }
        if (node.style.backgroundColor) {
          c.background = node.style.backgroundColor;
        }
      }

      // Headers
      if (tag === 'h1') { c.bold = true; c.fontSize = headerSizeMap['1']; c.isHeader = true; }
      if (tag === 'h2') { c.bold = true; c.fontSize = headerSizeMap['2']; c.isHeader = true; }
      if (tag === 'h3') { c.bold = true; c.fontSize = headerSizeMap['3']; c.isHeader = true; }

      // Taille via classe ql-size
      if (node.classList) {
        if (node.classList.contains('ql-size-small')) c.fontSize = quillSizeMap['small'];
        if (node.classList.contains('ql-size-large')) c.fontSize = quillSizeMap['large'];
        if (node.classList.contains('ql-size-huge'))  c.fontSize = quillSizeMap['huge'];
        // Police
        if (node.classList.contains('ql-font-times'))        c.font = 'Times New Roman';
        if (node.classList.contains('ql-font-georgia'))      c.font = 'Georgia';
        if (node.classList.contains('ql-font-merriweather')) c.font = 'Merriweather';
        if (node.classList.contains('ql-font-roboto'))       c.font = 'Roboto';
        if (node.classList.contains('ql-font-lato'))         c.font = 'Lato';
        if (node.classList.contains('ql-font-opensans'))     c.font = 'Open Sans';
        if (node.classList.contains('ql-font-courier'))      c.font = 'Courier New';
        
        // Couleurs Quill
        const colorClass = Array.from(node.classList).find(cls => cls.startsWith('ql-color-'));
        if (colorClass) {
          const colorValue = colorClass.replace('ql-color-', '').replace(/_/g, '');
          c.color = '#' + colorValue;
        }
        const bgClass = Array.from(node.classList).find(cls => cls.startsWith('ql-bg-'));
        if (bgClass) {
          const bgValue = bgClass.replace('ql-bg-', '').replace(/_/g, '');
          c.background = '#' + bgValue;
        }
      }
      
      // Couleur via style inline
      if (node.style) {
        if (node.style.color) c.color = node.style.color;
        if (node.style.backgroundColor) c.background = node.style.backgroundColor;
      }

      if (tag === 'br') {
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        return;
      }
      if (tag === 'p' || tag === 'h1' || tag === 'h2' || tag === 'h3') {
        Array.from(node.childNodes).forEach(ch => walk(ch, c));
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        return;
      }

      // â”€â”€ LISTES Quill v2 : <ol> avec <li data-list="ordered|bullet"> â”€â”€
      if (tag === 'ol' || tag === 'ul') {
        let orderedIdx = 1;
        Array.from(node.children).forEach(li => {
          const dataList = li.getAttribute('data-list') || (tag === 'ol' ? 'ordered' : 'bullet');
          const isOrdered = dataList === 'ordered';
          const prefix = isOrdered ? (orderedIdx++) + '. ' : 'â€¢ ';
          segments.push({ text: prefix, bold: c.bold, italic: c.italic, underline: c.underline, fontSize: c.fontSize, listStart: true, isOrdered });
          Array.from(li.childNodes).forEach(ch => walk(ch, c));
          segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        });
        return;
      }
      // Li isolÃ©
      if (tag === 'li') {
        const dataList = node.getAttribute('data-list') || 'bullet';
        const isOrdered = dataList === 'ordered';
        segments.push({ text: isOrdered ? '1. ' : 'â€¢ ', bold: c.bold, italic: c.italic, underline: c.underline, fontSize: c.fontSize, listStart: true, isOrdered });
        Array.from(node.childNodes).forEach(ch => walk(ch, c));
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        return;
      }

      if (tag === 'img') {
        const src = node.getAttribute('src') || '';
        if (src.startsWith('data:image')) {
          // Lire la taille dÃ©finie par l'utilisateur (data-w/data-h ou style)
          const imgW = parseInt(node.getAttribute('data-w'))  || parseInt(node.style.width)  || node.naturalWidth  || 0;
          const imgH = parseInt(node.getAttribute('data-h'))  || parseInt(node.style.height) || node.naturalHeight || 0;
          segments.push({ type: 'image', src: src, w: imgW, h: imgH });
          segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        }
        return;
      }
      if (tag === 'table') {
        const tableData = [];
        node.querySelectorAll('tr').forEach(tr => {
          const rowData = [];
          tr.querySelectorAll('td, th').forEach(cell => {
            const isHeader = cell.tagName.toLowerCase() === 'th';
            let cellBg = null;
            if (cell.style && cell.style.backgroundColor) cellBg = cell.style.backgroundColor;
            const cellCtx = Object.assign({}, c, {
              bold:       isHeader || c.bold,
              color:      (cell.style && cell.style.color) ? cell.style.color : c.color,
              background: null
            });
            // Extraire les segments riches du contenu de la cellule
            const before = segments.length;
            Array.from(cell.childNodes).forEach(ch => walk(ch, cellCtx));
            const richContent = segments.splice(before);
            while (richContent.length && richContent[richContent.length-1].text === '\n') richContent.pop();
            rowData.push({
              text:        cell.textContent.trim(),
              isHeader:    isHeader,
              bgColor:     cellBg,
              richContent: richContent
            });
          });
          if (rowData.length > 0) tableData.push(rowData);
        });
        if (tableData.length > 0) {
          segments.push({ type: 'table', tableData });
          segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        }
        return;
      }
      Array.from(node.childNodes).forEach(ch => walk(ch, c));
    }

    const baseCtx = { bold: false, italic: false, underline: false, fontSize: null, isHeader: false };
    Array.from(temp.childNodes).forEach(n => walk(n, baseCtx));
    while (segments.length && segments[segments.length-1].text === '\n') segments.pop();
    return segments;
  }

  // RÃ©initialiser le compteur d'images AVANT de construire les tables (qui appellent htmlToWParagraphs)
  docxImages = [];
  docxImageCounter = 0;

  // Ligne simple : [LABEL | valeur pleine largeur]
  const rowFull = (lbl, val) => `<w:tr>${cell(lbl,true,true,LBL_W,false,false)}${cellWithFormat(val,false,VAL_W,false)}</w:tr>`;

  // Ligne simple avec valeur HTML riche (objectif)
  const rowFullRich = (lbl, htmlVal) => `<w:tr>
    ${cell(lbl,true,true,LBL_W,false,false)}
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${VAL_W}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
      </w:tcPr>
      ${htmlToWParagraphs(htmlVal, 18)}
    </w:tc>
  </w:tr>`;

  // Ligne double : [LABEL | val | LABEL | val]
  const rowDbl  = (l1,v1,l2,v2) => `<w:tr>
    ${cell(l1,true,true,LBL2_W,false,false)}
    ${cellWithFormat(v1,false,VAL2_W,false)}
    ${cell(l2,true,true,LBL2_W,false,false)}
    ${cellWithFormat(v2,false,VAL2_W,false)}
  </w:tr>`;

  // Lignes libres
  let llXML = '';
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        llXML += rowFull(ll.label || 'Champ', ll.val1 || '');
      } else {
        llXML += rowDbl(ll.label1||'A', ll.val1||'', ll.label2||'B', ll.val2||'');
      }
    });
  }

  const TBL_PR = (extraW) => `<w:tblPr>
    <w:tblW w:w="${extraW || TW}" w:type="dxa"/>
    <w:tblLayout w:type="fixed"/>
    <w:tblBorders>
      <w:top    w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:left   w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:bottom w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:right  w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:insideH w:val="single" w:sz="4" w:space="0" w:color="${rawColor}"/>
      <w:insideV w:val="single" w:sz="4" w:space="0" w:color="${rawColor}"/>
    </w:tblBorders>
    <w:tblCellMar>
      <w:top    w:w="0" w:type="dxa"/>
      <w:bottom w:w="0" w:type="dxa"/>
      <w:left   w:w="0" w:type="dxa"/>
      <w:right  w:w="0" w:type="dxa"/>
    </w:tblCellMar>
  </w:tblPr>`;

  // Tableau en-tÃªte
  const enteteTable = `<w:tbl>
    ${TBL_PR()}
    ${rowDbl(x(entete.labelProf||'PROF'), entete.prof||'', x(entete.labelNiveau||'NIVEAU'), entete.niveau||'')}
    ${rowFull(x(entete.labelModule||'MODULE'),   entete.module||'')}
    ${rowFull(x(entete.labelSequence||'SÃ‰QUENCE'), entete.sequence||'')}
    ${rowDbl(x(entete.labelActivite||'ACTIVITÃ‰'), entete.activite||'', x(entete.labelSupport||'SUPPORT'), entete.support||'')}
    ${llXML}
    ${rowFullRich(x(entete.labelObjectif||'OBJECTIF(S)'), entete.objectif||'')}
  </w:tbl>`;

  // Tableau Ã©tapes â€” en-tÃªte dynamique
  const headerEtapes = `<w:tr>
    ${cell(x(P.labelColEtapes),       true,true,  E0, true,  false)}
    ${cell(x(P.labelColDeroulement),  true,true,  E1, true,  false)}
    ${colsSup.map((col, i) => cell(x(col.label), true, true, ESup[i], true, false)).join('')}
    ${cell(x(P.labelColDuree),        true,true,  E2, true,  false)}
  </w:tr>`;

  // â”€â”€ Convertit HTML Quill â†’ paragraphes OpenXML â”€â”€
  // GÃ¨re : <p>, <br>, <strong>/<b>, <em>/<i>, <u>, <li>, texte brut
  const etapesRows = (etapes||[]).map(e => {
    // Colonnes supplÃ©mentaires
    const supCells = colsSup.map((col, i) => `<w:tc>
      <w:tcPr>
        <w:tcW w:w="${ESup[i]}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
        <w:vAlign w:val="top"/>
      </w:tcPr>
      <w:p>
        <w:pPr><w:spacing w:before="40" w:after="40"/></w:pPr>
        <w:r>
          <w:rPr><w:sz w:val="18"/><w:szCs w:val="18"/></w:rPr>
          <w:t xml:space="preserve">${x((e.supVals && e.supVals[col.n]) || '')}</w:t>
        </w:r>
      </w:p>
    </w:tc>`).join('');

    return `<w:tr>
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${E0}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
        <w:vAlign w:val="center"/>
      </w:tcPr>
      <w:p>
        <w:pPr><w:jc w:val="center"/><w:spacing w:before="40" w:after="40"/></w:pPr>
        ${htmlToRunsWithColor(e.nom||'', rawColor)}
      </w:p>
    </w:tc>
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${E1}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
      </w:tcPr>
      ${htmlToWParagraphs(e.enseignant||'', 18)}
    </w:tc>
    ${supCells}
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${E2}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
        <w:vAlign w:val="center"/>
      </w:tcPr>
      <w:p>
        <w:pPr><w:jc w:val="center"/><w:spacing w:before="40" w:after="40"/></w:pPr>
        <w:r>
          <w:rPr><w:i/><w:sz w:val="18"/><w:szCs w:val="18"/></w:rPr>
          <w:t>${x(e.duree||'')}</w:t>
        </w:r>
      </w:p>
    </w:tc>
  </w:tr>`;
  }).join('');

  const etapesTable = `<w:tbl>
    ${TBL_PR()}
    ${headerEtapes}
    ${etapesRows}
  </w:tbl>`;

  // â”€â”€ document.xml â”€â”€ (les images ont dÃ©jÃ  Ã©tÃ© collectÃ©es lors de la construction des tables)
  const documentXML = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
  <w:body>
    <w:p>
      <w:pPr>
        <w:jc w:val="center"/>
        <w:spacing w:before="0" w:after="100"/>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:b/><w:color w:val="${rawColor}"/>
          <w:sz w:val="24"/><w:szCs w:val="24"/>
        </w:rPr>
        <w:t>FICHE PÃ‰DAGOGIQUE</w:t>
      </w:r>
    </w:p>
    ${enteteTable}
    <w:p><w:pPr><w:spacing w:before="0" w:after="60"/></w:pPr></w:p>
    ${etapesTable}
    <w:sectPr>
      <w:pgSz w:w="${PG_W}" w:h="16838"/>
      <w:pgMar w:top="${MARGIN}" w:right="${MARGIN}" w:bottom="${MARGIN}" w:left="${MARGIN}"
               w:header="0" w:footer="0" w:gutter="0"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  // â”€â”€ Package DOCX â”€â”€
  // Ajouter les types MIME des images si nÃ©cessaire
  let contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml"  ContentType="application/xml"/>`;
  
  // Ajouter les extensions d'images
  const imageExtensions = new Set(docxImages.map(img => img.ext));
  if (imageExtensions.has('png')) {
    contentTypes += `\n  <Default Extension="png" ContentType="image/png"/>`;
  }
  if (imageExtensions.has('jpeg')) {
    contentTypes += `\n  <Default Extension="jpeg" ContentType="image/jpeg"/>`;
  }
  if (imageExtensions.has('jpg')) {
    contentTypes += `\n  <Default Extension="jpg" ContentType="image/jpeg"/>`;
  }
  if (imageExtensions.has('gif')) {
    contentTypes += `\n  <Default Extension="gif" ContentType="image/gif"/>`;
  }
  
  contentTypes += `
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml"   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

  const rootRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  // GÃ©nÃ©rer les relationships pour les images
  let wordRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>`;
  
  docxImages.forEach(img => {
    wordRels += `\n  <Relationship Id="${img.rId}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image${img.id}.${img.ext}"/>`;
  });
  
  wordRels += `
</Relationships>`;

  const stylesXML = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:docDefaults>
    <w:rPrDefault>
      <w:rPr>
        <w:rFonts w:ascii="Times New Roman" w:hAnsi="Times New Roman" w:cs="Times New Roman"/>
        <w:sz w:val="18"/><w:szCs w:val="18"/>
      </w:rPr>
    </w:rPrDefault>
    <w:pPrDefault>
      <w:pPr><w:spacing w:before="0" w:after="0" w:line="240" w:lineRule="auto"/></w:pPr>
    </w:pPrDefault>
  </w:docDefaults>
</w:styles>`;

  const zip = new JSZip();
  zip.file('[Content_Types].xml',          contentTypes);
  zip.file('_rels/.rels',                  rootRels);
  zip.file('word/document.xml',            documentXML);
  zip.file('word/styles.xml',              stylesXML);
  zip.file('word/_rels/document.xml.rels', wordRels);
  
  // Ajouter les images au ZIP
  docxImages.forEach(img => {
    // Convertir base64 en binary
    const base64Data = img.src.split(',')[1];
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    zip.file(`word/media/image${img.id}.${img.ext}`, bytes, {binary: true});
  });

  zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
    .then(function(blob) {
      const safeName = (entete.activite || 'fiche').replace(/[^a-zA-Z0-9\u00C0-\u024F]/gi,'_').slice(0,40);
      const docxFileName = `FichePedagogique_${safeName}_${Date.now()}.docx`;

      // TÃ©lÃ©chargement direct en un clic
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = docxFileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 1000);

      const toast = document.getElementById('toast');
      toast.textContent = 'ğŸ“˜ Fiche exportÃ©e en DOCX (Word)';
      showToast();
    })
    .catch(function(err) {
      console.error('Erreur DOCX:', err);
      alert('Erreur lors de la gÃ©nÃ©ration DOCX : ' + err.message);
    });
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODÃˆLES DE FICHES PÃ‰DAGOGIQUES â€” ANGLAIS / LYCÃ‰E / ENVIRONNEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODELES_FICHES = [

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. FRANÃ‡AIS â€” Lecture / ComprÃ©hension de texte
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'fr1', titre:'Lecture analytique â€” La description dans le roman rÃ©aliste',
    sousTitre:'FranÃ§ais Â· Lecture / Analyse littÃ©raire Â· LycÃ©e', icone:'ğŸ“–',
    matiere:'FranÃ§ais', niveau:'2BAC', categorie:'francais',
    description:'SÃ©ance de lecture analytique d\'un extrait de roman rÃ©aliste (Balzac / Zola). Les Ã©lÃ¨ves identifient les procÃ©dÃ©s de la description, analysent leur fonction narrative et construisent un commentaire structurÃ©.',
    tags:['francais','2BAC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'2 BAC',module:'Module 2 â€” Le Roman et ses personnages',sequence:'SÃ©quence 3 : La description rÃ©aliste',activite:'Lecture analytique',support:'Extrait : Balzac, "Le PÃ¨re Goriot" â€” description de la pension Vauquer',
        objectif:'<ul><li>Identifier les caractÃ©ristiques de la description rÃ©aliste (accumulation, lexique, focalisation)</li><li>Analyser la fonction de la description dans l\'Ã©conomie du rÃ©cit</li><li>Construire un commentaire littÃ©raire structurÃ© Ã  partir d\'un extrait</li><li>MaÃ®triser le vocabulaire de l\'analyse littÃ©raire (champ lexical, mÃ©taphore, isotopieâ€¦)</li></ul>'},
      etapes:[
        {nom:'Mise en route',enseignant:'<p><strong>ğŸ–¼ï¸ EntrÃ©e dans le texte â€” L\'image dÃ©clencheur</strong></p><p>â€¢ Projeter une image d\'intÃ©rieur bourgeois du XIXe siÃ¨cle</p><p>â€¢ Questions orales : <em>Â« Que voyez-vous ? Quelle atmosphÃ¨re se dÃ©gage ? Ã€ quelle Ã©poque situez-vous cette scÃ¨ne ? Â»</em></p><p>â€¢ Mise en commun â€” introduction de la notion de "roman rÃ©aliste" : peindre le rÃ©el</p><p>â€¢ Annonce de l\'objectif : comprendre comment Balzac fait "voir" un lieu</p>',duree:'8 min'},
        {nom:'Lecture & dÃ©couverte',enseignant:'<p><strong>ğŸ“„ Lecture silencieuse puis lecture expressive</strong></p><p>â€¢ Lecture individuelle silencieuse (2 min) â€” repÃ©rage des mots inconnus</p><p>â€¢ Lecture expressive par l\'enseignant â€” mise en voix du texte</p><p>â€¢ Questions de comprÃ©hension globale :</p><ul><li>Quel lieu est dÃ©crit ? Par qui ?</li><li>Quelle est l\'impression dominante qui se dÃ©gage ?</li><li>Relevez trois mots qui caractÃ©risent ce lieu</li></ul>',duree:'10 min'},
        {nom:'Analyse',enseignant:'<p><strong>ğŸ” Analyse des procÃ©dÃ©s d\'Ã©criture</strong></p><p>â€¢ Travail en groupes (3â€“4 Ã©lÃ¨ves) â€” chaque groupe analyse un aspect :</p><ul><li>Groupe 1 : Le champ lexical dominant</li><li>Groupe 2 : Les figures de style (comparaisons, mÃ©taphores)</li><li>Groupe 3 : L\'organisation spatiale de la description</li><li>Groupe 4 : Le point de vue narratif et ses effets</li></ul><p>â€¢ Mise en commun avec prise de notes au tableau</p>',duree:'15 min'},
        {nom:'InterprÃ©tation',enseignant:'<p><strong>ğŸ’¡ Sens et fonctions de la description</strong></p><p>â€¢ Discussion guidÃ©e :</p><ul><li><em>Â« Pourquoi Balzac consacre-t-il autant de place Ã  dÃ©crire ce lieu ? Â»</em></li><li><em>Â« Que nous apprend cette description sur les personnages qui y vivent ? Â»</em></li><li><em>Â« Quel effet produit cette description sur le lecteur ? Â»</em></li></ul><p>â€¢ Ã‰laboration collective d\'une rÃ©ponse Ã  la problÃ©matique : la description comme rÃ©vÃ©lateur social</p>',duree:'10 min'},
        {nom:'SynthÃ¨se',enseignant:'<p><strong>ğŸ“ Construction du commentaire</strong></p><p>â€¢ Formulation collective du plan du commentaire :</p><ul><li>Axe I : Une description rÃ©aliste minutieuse</li><li>Axe II : Un lieu rÃ©vÃ©lateur de la misÃ¨re sociale</li></ul><p>â€¢ Chaque Ã©lÃ¨ve rÃ©dige l\'introduction et un paragraphe de commentaire</p><p>â€¢ Bilan de sÃ©ance â€” retour sur les outils d\'analyse acquis</p>',duree:'7 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#4A148C',colorAccent:'#C9A84C',colorGrid:'#CE93D8',colorEtapeText:'#4A148C',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'2 BAC',module:'Module 2 â€” Le Roman et ses personnages'
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. MATHÃ‰MATIQUES â€” Fonctions du second degrÃ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'ma1', titre:'Les fonctions du second degrÃ© â€” Forme canonique et reprÃ©sentation',
    sousTitre:'MathÃ©matiques Â· AlgÃ¨bre Â· 2 BAC', icone:'ğŸ“',
    matiere:'MathÃ©matiques', niveau:'2BAC', categorie:'maths',
    description:'SÃ©ance d\'algÃ¨bre sur les fonctions du second degrÃ©. Les Ã©lÃ¨ves passent de la forme dÃ©veloppÃ©e Ã  la forme canonique, en dÃ©duisent les propriÃ©tÃ©s de la parabole et rÃ©solvent des problÃ¨mes d\'optimisation.',
    tags:['maths','2BAC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'2 BAC',module:'Module 1 â€” Analyse et fonctions',sequence:'SÃ©quence 4 : Fonctions polynÃ´mes du second degrÃ©',activite:'Cours + Exercices â€” Forme canonique',support:'Manuel + Fiche exercices "Parabole et optimisation"',
        objectif:'<ul><li>Passer de la forme dÃ©veloppÃ©e axÂ²+bx+c Ã  la forme canonique a(x-Î±)Â²+Î²</li><li>Identifier le sommet de la parabole et l\'axe de symÃ©trie</li><li>DÃ©terminer les extrema (maximum ou minimum) d\'une fonction du second degrÃ©</li><li>RÃ©soudre des problÃ¨mes d\'optimisation faisant intervenir une fonction du second degrÃ©</li></ul>'},
      etapes:[
        {nom:'Rappel & activation',enseignant:'<p><strong>ğŸ” RÃ©vision â€” Forme dÃ©veloppÃ©e</strong></p><p>â€¢ Questions flash au tableau (5 min) :</p><ul><li>DÃ©velopper : (x+3)Â² ; (2x-1)Â² ; (x+a)Â²</li><li>Factoriser : xÂ²-4 ; xÂ²+6x+9</li></ul><p>â€¢ Correction collective â€” rappel des identitÃ©s remarquables</p><p>â€¢ Transition : <em>Â« Comment trouver le minimum de f(x) = xÂ²-6x+11 ? Â»</em></p>',duree:'8 min'},
        {nom:'DÃ©couverte',enseignant:'<p><strong>ğŸ’¡ Construction de la forme canonique</strong></p><p>â€¢ DÃ©monstration au tableau â€” mÃ©thode de complÃ©tion du carrÃ© :</p><p>f(x) = xÂ²-6x+11 = (xÂ²-6x+9)+2 = (x-3)Â²+2</p><p>â€¢ Questions guidÃ©es :</p><ul><li>Quel est le minimum de (x-3)Â² ? Pour quelle valeur de x ?</li><li>Quel est donc le minimum de f ? En quel point ?</li></ul><p>â€¢ Formule gÃ©nÃ©rale : Î± = -b/2a ; Î² = f(Î±)</p>',duree:'12 min'},
        {nom:'EntraÃ®nement guidÃ©',enseignant:'<p><strong>âœï¸ Exercices progressifs (par niveaux)</strong></p><p>â€¢ Niveau 1 : Mettre sous forme canonique (a=1) :<br>f(x) = xÂ²-4x+7 ; g(x) = xÂ²+8x+3</p><p>â€¢ Niveau 2 : Cas gÃ©nÃ©ral (aâ‰ 1) :<br>h(x) = 2xÂ²-12x+5 ; k(x) = -3xÂ²+6x+1</p><p>â€¢ Niveau 3 : DÃ©duire le sommet, le sens de variation, le minimum/maximum</p><p>â€¢ Correction au tableau â€” erreurs frÃ©quentes signalÃ©es</p>',duree:'15 min'},
        {nom:'ProblÃ¨me',enseignant:'<p><strong>ğŸ§® ProblÃ¨me d\'optimisation</strong></p><p>â€¢ ProblÃ¨me contextualisÃ© :</p><p><em>Â« Un rectangle a un pÃ©rimÃ¨tre de 20 cm. Exprimer son aire en fonction de la longueur d\'un cÃ´tÃ©, puis dÃ©terminer les dimensions qui maximisent l\'aire. Â»</em></p><p>â€¢ RÃ©solution guidÃ©e : modÃ©lisation â†’ forme canonique â†’ conclusion</p><p>â€¢ Correction collective â€” interprÃ©tation gÃ©omÃ©trique de la solution</p>',duree:'10 min'},
        {nom:'Bilan',enseignant:'<p><strong>ğŸ“Š SynthÃ¨se & devoir</strong></p><p>â€¢ Fiche rÃ©capitulative : tableau forme dÃ©veloppÃ©e â†” canonique â†” propriÃ©tÃ©s</p><p>â€¢ Auto-Ã©valuation : 3 questions flash (vrai/faux)</p><p>â€¢ Devoir maison : 3 exercices de mise sous forme canonique + 1 problÃ¨me d\'optimisation</p>',duree:'5 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#0D47A1',colorAccent:'#C9A84C',colorGrid:'#90CAF9',colorEtapeText:'#0D47A1',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'2 BAC',module:'Module 1 â€” Analyse et fonctions'
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. SVT â€” La mitose et la reproduction cellulaire
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'sv1', titre:'La mitose â€” Division cellulaire et cycle cellulaire',
    sousTitre:'SVT Â· Biologie cellulaire Â· 1 BAC', icone:'ğŸ”¬',
    matiere:'SVT', niveau:'1BAC', categorie:'svt',
    description:'SÃ©ance de biologie sur la mitose. Les Ã©lÃ¨ves observent les diffÃ©rentes phases de la division cellulaire sur des prÃ©parations microscopiques, schÃ©matisent et expliquent les mÃ©canismes de transmission de l\'information gÃ©nÃ©tique.',
    tags:['svt','1BAC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'1 BAC',module:'Module 1 â€” Reproduction et gÃ©nÃ©tique',sequence:'SÃ©quence 2 : La division cellulaire',activite:'TP + Cours â€” La mitose',support:'Microscope + PrÃ©parations oignon / SchÃ©mas + VidÃ©o animation mitose',
        objectif:'<ul><li>DÃ©crire et schÃ©matiser les diffÃ©rentes phases de la mitose (interphase, prophase, mÃ©taphase, anaphase, tÃ©lophase)</li><li>Comprendre le rÃ´le de la mitose dans la croissance et la rÃ©gÃ©nÃ©ration des tissus</li><li>Relier la mitose Ã  la conservation du caryotype (2n chromosomes)</li><li>RÃ©aliser une observation microscopique et en faire un schÃ©ma lÃ©gendÃ©</li></ul>'},
      etapes:[
        {nom:'ProblÃ©matique',enseignant:'<p><strong>â“ Mise en situation â€” ProblÃ¨me biologique</strong></p><p>â€¢ Question dÃ©clencheur : <em>Â« Comment une cellule unique (zygote) peut-elle donner un organisme de plusieurs milliards de cellules identiques ? Â»</em></p><p>â€¢ Recueil des reprÃ©sentations initiales des Ã©lÃ¨ves â€” carte mentale collective</p><p>â€¢ Annonce du plan : observer â†’ schÃ©matiser â†’ expliquer</p>',duree:'5 min'},
        {nom:'Observation TP',enseignant:'<p><strong>ğŸ”¬ Travaux pratiques â€” Observation microscopique</strong></p><p>â€¢ Distribution des prÃ©parations microscopiques (racine d\'oignon)</p><p>â€¢ Consignes :</p><ul><li>Observer Ã  diffÃ©rents grossissements</li><li>RepÃ©rer des cellules Ã  diffÃ©rents stades</li><li>Dessiner une cellule par phase observÃ©e avec lÃ©gendes</li></ul><p>â€¢ Circuler dans les rangs â€” aide Ã  l\'identification des phases</p>',duree:'15 min'},
        {nom:'Cours',enseignant:'<p><strong>ğŸ“‹ Construction du cours â€” Les 5 phases</strong></p><p>â€¢ PrÃ©sentation animÃ©e des phases :</p><ul><li><strong>Interphase :</strong> rÃ©plication de l\'ADN (2n â†’ 4n chromatides)</li><li><strong>Prophase :</strong> condensation des chromosomes, disparition membrane nuclÃ©aire</li><li><strong>MÃ©taphase :</strong> alignement sur la plaque Ã©quatoriale</li><li><strong>Anaphase :</strong> migration des chromatides aux pÃ´les</li><li><strong>TÃ©lophase :</strong> cytocinÃ¨se â€” 2 cellules filles (2n)</li></ul><p>â€¢ SchÃ©ma bilan Ã  complÃ©ter par les Ã©lÃ¨ves</p>',duree:'15 min'},
        {nom:'Exercices',enseignant:'<p><strong>âœï¸ Application et exercices</strong></p><p>â€¢ Ex 1 : LÃ©gender un schÃ©ma de mitose</p><p>â€¢ Ex 2 : Ordonner des photos de phases dans le bon ordre</p><p>â€¢ Ex 3 : Calculer le nombre de chromosomes Ã  chaque phase pour une espÃ¨ce 2n=46</p><p>â€¢ Correction collective</p>',duree:'10 min'},
        {nom:'Bilan',enseignant:'<p><strong>ğŸ“Š SynthÃ¨se â€” RÃ´le biologique de la mitose</strong></p><p>â€¢ Discussion : <em>Â« Mitose et croissance / rÃ©gÃ©nÃ©ration / reproduction asexuÃ©e Â»</em></p><p>â€¢ Bilan schÃ©matique au tableau : cycle cellulaire complet (G1, S, G2, M)</p><p>â€¢ Questions flash auto-Ã©valuation</p><p>â€¢ DM : rÃ©diger un texte expliquant la mitose Ã  partir du schÃ©ma bilan</p>',duree:'5 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#1B5E20',colorAccent:'#C9A84C',colorGrid:'#A5D6A7',colorEtapeText:'#1B5E20',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'1 BAC',module:'Module 1 â€” Reproduction et gÃ©nÃ©tique'
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. HISTOIRE â€” La PremiÃ¨re Guerre mondiale
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'hi1', titre:'La PremiÃ¨re Guerre mondiale â€” Une guerre totale',
    sousTitre:'Histoire Â· TC / 1 BAC', icone:'ğŸ›ï¸',
    matiere:'Histoire', niveau:'TC', categorie:'histoire',
    description:'SÃ©ance d\'histoire sur la notion de "guerre totale" lors de la PremiÃ¨re Guerre mondiale. Ã€ partir de documents variÃ©s (carte, tÃ©moignage, affiche de propagande), les Ã©lÃ¨ves construisent et argumentent ce concept.',
    tags:['histoire','TC','1BAC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'Tronc Commun / 1 BAC',module:'Module 3 â€” Les guerres mondiales du XXe siÃ¨cle',sequence:'SÃ©quence 1 : La PremiÃ¨re Guerre mondiale (1914â€“1918)',activite:'Ã‰tude documentaire â€” La notion de guerre totale',support:'Dossier documentaire : carte du front, tÃ©moignage de soldat, affiche de propagande, statistiques de pertes',
        objectif:'<ul><li>Comprendre et dÃ©finir le concept de "guerre totale"</li><li>Analyser des documents historiques de nature diffÃ©rente (carte, tÃ©moignage, affiche)</li><li>Identifier les dimensions militaires, Ã©conomiques, sociales et psychologiques du conflit</li><li>Construire un raisonnement historique argumentÃ© Ã  partir de documents</li></ul>'},
      etapes:[
        {nom:'Mise en situation',enseignant:'<p><strong>ğŸ—ºï¸ EntrÃ©e dans le cours â€” Situation gÃ©ographique</strong></p><p>â€¢ Afficher la carte de l\'Europe en 1914 â€” identifier les empires, les alliances</p><p>â€¢ Chronologie rapide : attentats de Sarajevo (28 juin 1914) â†’ dÃ©clarations de guerre</p><p>â€¢ Question-problÃ¨me : <em>Â« En quoi la guerre de 1914â€“1918 est-elle diffÃ©rente des guerres prÃ©cÃ©dentes ? Â»</em></p><p>â€¢ Recueil des hypothÃ¨ses des Ã©lÃ¨ves</p>',duree:'8 min'},
        {nom:'Ã‰tude de docs',enseignant:'<p><strong>ğŸ“„ Analyse documentaire en groupes</strong></p><p>â€¢ 4 groupes â€” chaque groupe analyse un document :</p><ul><li>Groupe 1 : Carte des fronts â€” les tranchÃ©es, la guerre de position</li><li>Groupe 2 : TÃ©moignage de soldat â€” conditions de vie dans les tranchÃ©es</li><li>Groupe 3 : Affiche de propagande â€” mobilisation des civils</li><li>Groupe 4 : Statistiques des pertes â€” ampleur des destructions humaines</li></ul><p>â€¢ Questions-guide pour chaque document (fiche distribuÃ©e)</p>',duree:'15 min'},
        {nom:'Mise en commun',enseignant:'<p><strong>ğŸ—£ï¸ PrÃ©sentation et construction du concept</strong></p><p>â€¢ Chaque groupe prÃ©sente ses conclusions (2 min par groupe)</p><p>â€¢ Construction collective au tableau de la notion de "guerre totale" :</p><ul><li>Dimension militaire : industrialisation de la guerre, nouvelles armes</li><li>Dimension Ã©conomique : Ã©conomie de guerre, rationnement</li><li>Dimension sociale : rÃ´le des femmes, travailleurs coloniaux</li><li>Dimension psychologique : propagande, moral des troupes</li></ul>',duree:'12 min'},
        {nom:'Cours structurÃ©',enseignant:'<p><strong>ğŸ“‹ Bilan de cours â€” Trace Ã©crite</strong></p><p>â€¢ DictÃ©e de la trace Ã©crite structurÃ©e en 3 parties :</p><ul><li>I. Une guerre industrielle et meurtriÃ¨re</li><li>II. La mobilisation totale des sociÃ©tÃ©s</li><li>III. Un bilan humain et matÃ©riel sans prÃ©cÃ©dent</li></ul><p>â€¢ ComplÃ©ter le schÃ©ma bilan : "Guerre totale" au centre, 4 dimensions rayonnantes</p>',duree:'10 min'},
        {nom:'Ã‰valuation formative',enseignant:'<p><strong>âœï¸ Exercice de rÃ©daction courte</strong></p><p>â€¢ Consigne : <em>Â« En vous appuyant sur les documents Ã©tudiÃ©s, expliquez en 8â€“10 lignes pourquoi la PremiÃ¨re Guerre mondiale est qualifiÃ©e de guerre totale. Â»</em></p><p>â€¢ Ã‰change de copies â€” correction entre pairs avec grille de critÃ¨res</p><p>â€¢ Bilan et annonce de la prochaine sÃ©ance : les consÃ©quences du conflit</p>',duree:'5 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#BF360C',colorAccent:'#C9A84C',colorGrid:'#FFCCBC',colorEtapeText:'#BF360C',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'TC / 1 BAC',module:'Module 3 â€” Les guerres mondiales du XXe siÃ¨cle'
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. PHYSIQUE-CHIMIE â€” Les lois de l'Ã©lectricitÃ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'ph1', titre:'Loi d\'Ohm et circuits Ã©lectriques â€” SÃ©rie et parallÃ¨le',
    sousTitre:'Physique-Chimie Â· Ã‰lectricitÃ© Â· Tronc Commun', icone:'âš—ï¸',
    matiere:'Physique-Chimie', niveau:'TC', categorie:'physique',
    description:'SÃ©ance d\'Ã©lectricitÃ© sur la loi d\'Ohm et les circuits sÃ©rie/parallÃ¨le. Approche expÃ©rimentale : les Ã©lÃ¨ves rÃ©alisent des montages, mesurent les grandeurs et vÃ©rifient les lois par l\'expÃ©rience avant de les formaliser.',
    tags:['physique','TC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'Tronc Commun',module:'Module 2 â€” Ã‰lectricitÃ©',sequence:'SÃ©quence 3 : Loi d\'Ohm â€” Circuits sÃ©rie et parallÃ¨le',activite:'TP + Cours â€” VÃ©rification expÃ©rimentale de la loi d\'Ohm',support:'MatÃ©riel TP : gÃ©nÃ©rateur, rÃ©sistances, ampÃ¨remÃ¨tre, voltmÃ¨tre, fils + Fiche TP',
        objectif:'<ul><li>Ã‰noncer et appliquer la loi d\'Ohm : U = R Ã— I</li><li>Distinguer les caractÃ©ristiques d\'un circuit sÃ©rie (mÃªme intensitÃ©) et parallÃ¨le (mÃªme tension)</li><li>RÃ©aliser un montage Ã©lectrique en respectant les conventions de branchement</li><li>Analyser des rÃ©sultats expÃ©rimentaux et calculer une rÃ©sistance</li></ul>'},
      etapes:[
        {nom:'ProblÃ©matique',enseignant:'<p><strong>âš¡ Mise en situation expÃ©rimentale</strong></p><p>â€¢ PrÃ©senter deux ampoules : l\'une dans un circuit sÃ©rie, l\'autre en parallÃ¨le</p><p>â€¢ Observation : <em>Â« Que se passe-t-il quand on enlÃ¨ve une ampoule dans chaque circuit ? Â»</em></p><p>â€¢ ProblÃ©matique : <em>Â« Quelles lois rÃ©gissent la tension et l\'intensitÃ© dans ces circuits ? Â»</em></p><p>â€¢ HypothÃ¨ses des Ã©lÃ¨ves notÃ©es au tableau</p>',duree:'7 min'},
        {nom:'TP Circuit sÃ©rie',enseignant:'<p><strong>ğŸ”Œ TP 1 â€” Circuit sÃ©rie</strong></p><p>â€¢ RÃ©aliser le montage : gÃ©nÃ©rateur + 2 rÃ©sistances en sÃ©rie + ampÃ¨remÃ¨tre</p><p>â€¢ Mesures Ã  effectuer :</p><ul><li>IntensitÃ© Iâ‚, Iâ‚‚ en diffÃ©rents points â†’ conclusion sur I</li><li>Tensions Uâ‚, Uâ‚‚, U_total â†’ loi des tensions en sÃ©rie</li></ul><p>â€¢ Appliquer U = RÃ—I pour calculer chaque rÃ©sistance</p><p>â€¢ Tableau de rÃ©sultats Ã  complÃ©ter sur la fiche TP</p>',duree:'13 min'},
        {nom:'TP Circuit parallÃ¨le',enseignant:'<p><strong>ğŸ”Œ TP 2 â€” Circuit parallÃ¨le</strong></p><p>â€¢ Modifier le montage : 2 rÃ©sistances en dÃ©rivation</p><p>â€¢ Mesures :</p><ul><li>Tensions Uâ‚, Uâ‚‚ â†’ loi des tensions en parallÃ¨le</li><li>IntensitÃ©s Iâ‚, Iâ‚‚, I_total â†’ loi des intensitÃ©s (nÅ“uds)</li></ul><p>â€¢ Calcul de la rÃ©sistance Ã©quivalente R_eq = Râ‚Râ‚‚/(Râ‚+Râ‚‚)</p><p>â€¢ Comparaison des rÃ©sultats thÃ©oriques/expÃ©rimentaux</p>',duree:'13 min'},
        {nom:'Formalisation',enseignant:'<p><strong>ğŸ“‹ Construction du cours â€” SynthÃ¨se thÃ©orique</strong></p><p>â€¢ Loi d\'Ohm : U = R Ã— I â€” unitÃ©s (V, Î©, A)</p><p>â€¢ Circuit sÃ©rie : I = cst ; U_tot = Uâ‚+Uâ‚‚+â€¦ ; R_eq = Râ‚+Râ‚‚+â€¦</p><p>â€¢ Circuit parallÃ¨le : U = cst ; I_tot = Iâ‚+Iâ‚‚+â€¦ ; 1/R_eq = 1/Râ‚+1/Râ‚‚+â€¦</p><p>â€¢ Exemples d\'applications domestiques (Ã©clairage, prise de courant)</p>',duree:'10 min'},
        {nom:'Exercices',enseignant:'<p><strong>âœï¸ Application numÃ©rique</strong></p><p>â€¢ Ex 1 : R = 220 Î©, U = 12 V â†’ calculer I</p><p>â€¢ Ex 2 : Deux rÃ©sistances 100 Î© en sÃ©rie â€” U_total = 6 V â†’ calculer I et Uâ‚</p><p>â€¢ Ex 3 : RÃ©sistance Ã©quivalente de 3 rÃ©sistances en parallÃ¨le</p><p>â€¢ Correction rapide â€” bilan + devoir maison</p>',duree:'7 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#37474F',colorAccent:'#C9A84C',colorGrid:'#B0BEC5',colorEtapeText:'#37474F',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'Tronc Commun',module:'Module 2 â€” Ã‰lectricitÃ©'
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 6. MATHÃ‰MATIQUES â€” Statistiques et probabilitÃ©s
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'ma2', titre:'Statistiques descriptives â€” Moyenne, mÃ©diane, Ã©tendue',
    sousTitre:'MathÃ©matiques Â· Statistiques Â· Tronc Commun', icone:'ğŸ“Š',
    matiere:'MathÃ©matiques', niveau:'TC', categorie:'maths',
    description:'SÃ©ance de statistiques sur les indicateurs de tendance centrale et de dispersion. Approche active : les Ã©lÃ¨ves collectent des donnÃ©es rÃ©elles, calculent les indicateurs et les interprÃ¨tent dans un contexte concret.',
    tags:['maths','TC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'Tronc Commun',module:'Module 3 â€” Statistiques et probabilitÃ©s',sequence:'SÃ©quence 1 : Statistiques descriptives',activite:'Cours + ActivitÃ© â€” Indicateurs statistiques',support:'DonnÃ©es rÃ©elles : notes de classe + Fiche activitÃ© + Calculatrice',
        objectif:'<ul><li>Calculer et interprÃ©ter la moyenne, la mÃ©diane et l\'Ã©tendue d\'une sÃ©rie statistique</li><li>ReprÃ©senter graphiquement une sÃ©rie statistique (histogramme, diagramme circulaire)</li><li>Choisir l\'indicateur le plus adaptÃ© selon la situation</li><li>Lire et interprÃ©ter un tableau statistique ou un graphique</li></ul>'},
      etapes:[
        {nom:'Situation rÃ©elle',enseignant:'<p><strong>ğŸ“Š Collecte de donnÃ©es rÃ©elles</strong></p><p>â€¢ Demander aux Ã©lÃ¨ves leur note de mathÃ©matiques du dernier contrÃ´le</p><p>â€¢ Saisir les donnÃ©es au tableau â€” les classer</p><p>â€¢ Question : <em>Â« Comment rÃ©sumer ces donnÃ©es en un seul chiffre ? Lequel choisiriez-vous ? Â»</em></p><p>â€¢ Discussion : intuition de la "note moyenne" vs "note du milieu"</p>',duree:'8 min'},
        {nom:'Cours â€” Moyenne',enseignant:'<p><strong>ğŸ“ La moyenne arithmÃ©tique</strong></p><p>â€¢ DÃ©finition et formule : xÌ„ = (Î£xáµ¢)/n</p><p>â€¢ Calcul sur les donnÃ©es de la classe</p><p>â€¢ Exemple guidÃ© : sÃ©rie de tempÃ©ratures mensuelles</p><p>â€¢ PropriÃ©tÃ©s : sensibilitÃ© aux valeurs extrÃªmes (exemple avec une valeur aberrante)</p><p>â€¢ Exercices d\'application immÃ©diats (2 sÃ©ries)</p>',duree:'10 min'},
        {nom:'Cours â€” MÃ©diane',enseignant:'<p><strong>ğŸ“ La mÃ©diane et l\'Ã©tendue</strong></p><p>â€¢ DÃ©finition de la mÃ©diane : valeur qui partage la sÃ©rie en deux moitiÃ©s Ã©gales</p><p>â€¢ MÃ©thode : trier la sÃ©rie â†’ trouver la valeur centrale (n impair) ou la moyenne des deux (n pair)</p><p>â€¢ Calcul de la mÃ©diane et de l\'Ã©tendue sur les donnÃ©es de la classe</p><p>â€¢ Comparaison moyenne/mÃ©diane : quand prÃ©fÃ©rer l\'une ou l\'autre ?</p>',duree:'10 min'},
        {nom:'ReprÃ©sentation',enseignant:'<p><strong>ğŸ“‰ ReprÃ©sentations graphiques</strong></p><p>â€¢ Construire l\'histogramme des notes de la classe</p><p>â€¢ Construction du diagramme circulaire (rÃ©partition par tranches)</p><p>â€¢ Lecture et interprÃ©tation : <em>Â« Quelle information donne chaque type de graphique ? Â»</em></p><p>â€¢ Exercice : lire un graphique statistique et rÃ©pondre Ã  des questions</p>',duree:'12 min'},
        {nom:'SynthÃ¨se',enseignant:'<p><strong>ğŸ“ Bilan et exercice rÃ©capitulatif</strong></p><p>â€¢ Tableau rÃ©capitulatif des indicateurs : dÃ©finition, formule, usage</p><p>â€¢ Exercice rÃ©capitulatif : sÃ©rie de donnÃ©es â†’ calculer moyenne, mÃ©diane, Ã©tendue, tracer histogramme</p><p>â€¢ Auto-correction</p><p>â€¢ DM : 2 exercices de statistiques sur des donnÃ©es rÃ©elles (tempÃ©ratures, population)</p>',duree:'10 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#1565C0',colorAccent:'#C9A84C',colorGrid:'#90CAF9',colorEtapeText:'#1565C0',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'Tronc Commun',module:'Module 3 â€” Statistiques et probabilitÃ©s'
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 7. ANGLAIS â€” ComprÃ©hension orale (1 seul modÃ¨le)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {
    id:'an1', titre:'Listening & Comprehension â€” Climate Change',
    sousTitre:'Anglais Â· ComprÃ©hension de l\'oral Â· 1 BAC', icone:'ğŸ‡¬ğŸ‡§',
    matiere:'Anglais', niveau:'1BAC', categorie:'anglais',
    description:'SÃ©ance de comprÃ©hension de l\'oral sur le changement climatique. Les Ã©lÃ¨ves Ã©coutent un reportage audio, extraient les informations clÃ©s et rÃ©pondent Ã  des questions de comprÃ©hension globale et dÃ©taillÃ©e.',
    tags:['anglais','1BAC','LycÃ©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'1 BAC',module:'Module 2 â€” Our Environment',sequence:'SÃ©quence 3 : Climate Change & Global Warming',activite:'Listening Comprehension',support:'Audio : "Climate Crisis" â€” BBC Learning English',
        objectif:'<ul><li>Identifier les informations clÃ©s dans un document audio authentique</li><li>Comprendre le vocabulaire liÃ© Ã  l\'environnement et au changement climatique</li><li>RÃ©pondre Ã  des questions de comprÃ©hension globale et dÃ©taillÃ©e</li><li>DÃ©velopper des stratÃ©gies d\'Ã©coute active</li></ul>'},
      etapes:[
        {nom:'Warm-up',enseignant:'<p><strong>ğŸŒ¡ï¸ Pre-listening â€” Brain Activation</strong></p><p>â€¢ Afficher des images : fonte des glaces, canicules, inondations</p><p>â€¢ Questions : <em>"What do you see? What problems do they illustrate? What do you know about climate change?"</em></p><p>â€¢ Brainstorming collectif â€” recueil des hypothÃ¨ses au tableau</p>',duree:'8 min'},
        {nom:'Pre-listening',enseignant:'<p><strong>ğŸ“– Vocabulary & Context Preparation</strong></p><p>â€¢ Vocabulaire clÃ© : <em>greenhouse gases, carbon dioxide (COâ‚‚), fossil fuels, renewable energy, deforestation, biodiversity</em></p><p>â€¢ PrÃ©diction du contenu Ã  partir du titre</p><p>â€¢ Distribution de la fiche d\'Ã©coute (questions + grille de prise de notes)</p>',duree:'10 min'},
        {nom:'1Ã¨re Ã©coute',enseignant:'<p><strong>ğŸ™ï¸ First Listening â€” Global Comprehension</strong></p><p>â€¢ Ã‰coute complÃ¨te <strong>sans interruption</strong></p><p>â€¢ TÃ¢che : identifier le thÃ¨me gÃ©nÃ©ral, le ton, l\'idÃ©e principale</p><p>â€¢ Mise en commun orale â€” correction collective</p>',duree:'10 min'},
        {nom:'2Ã¨me Ã©coute',enseignant:'<p><strong>ğŸ” Second Listening â€” Detailed Comprehension</strong></p><p>â€¢ RÃ©Ã©couter avec pauses possibles</p><p>â€¢ Questions de dÃ©tail : causes, consÃ©quences, solutions citÃ©es dans le document</p><p>â€¢ Travail individuel puis correction en binÃ´mes</p>',duree:'12 min'},
        {nom:'Post-listening',enseignant:'<p><strong>ğŸ’¬ Reaction & Personal Expression</strong></p><p>â€¢ Discussion : <em>"What surprised you? What can WE do to fight climate change?"</em></p><p>â€¢ Notes sur des actions concrÃ¨tes (at home / at school / in the community)</p><p>â€¢ Bilan â€” auto-Ã©valuation rapide (pouce levÃ©)</p>',duree:'10 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#1565C0',colorAccent:'#C9A84C',colorGrid:'#AAAAAA',colorEtapeText:'#1565C0',labelColEtapes:'Ã‰tapes',labelColDerou:'DÃ©roulement de la sÃ©ance',labelColDuree:'DurÃ©e'},
      resume:'5 Ã©tapes Â· 50 min',niveau:'1 BAC',module:'Module 2 â€” Our Environment'
    }
  }

];

var filtreModeleActif = 'all';

function rendreTousLesModeles() { renderModeles(MODELES_FICHES); }

function filtrerModeles(filtre, btnEl) {
  filtreModeleActif = filtre;
  document.querySelectorAll('.modele-filter-btn').forEach(function(b){ b.classList.remove('active'); });
  if (btnEl) btnEl.classList.add('active');
  var filtres = filtre === 'all' ? MODELES_FICHES : MODELES_FICHES.filter(function(m){ return m.tags.indexOf(filtre) !== -1; });
  renderModeles(filtres);
}

function renderModeles(liste) {
  var container = document.getElementById('modeles-liste');
  if (!container) return;
  if (!liste || liste.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:30px;color:#aaa;font-size:14px;">Aucun modÃ¨le pour ce filtre.</div>';
    return;
  }
  container.innerHTML = liste.map(function(m) {
    var etapesHtml = m.data.etapes.map(function(e, i) {
      var desc = e.enseignant.replace(/<[^>]*>/g,'').substring(0, 70) + 'â€¦';
      return '<div class="modele-etape-row"><div class="modele-etape-num">'+(i+1)+'</div><div class="modele-etape-name">'+e.nom+'</div><div class="modele-etape-desc">'+desc+'</div><div class="modele-etape-duree">'+e.duree+'</div></div>';
    }).join('');
    return '<div class="modele-card">'+
      '<div class="modele-card-header">'+
        '<div class="modele-card-icon">'+m.icone+'</div>'+
        '<div><div class="modele-card-title">'+m.titre+'</div><div class="modele-card-subtitle">'+m.sousTitre+'</div></div>'+
      '</div>'+
      '<div class="modele-card-body">'+
        '<div style="margin-bottom:8px;">'+
          '<span class="modele-tag modele-tag-matiere">ğŸ‡¬ğŸ‡§ '+m.matiere+'</span>'+
          '<span class="modele-tag modele-tag-niveau">ğŸ“š '+m.niveau+'</span>'+
          '<span class="modele-tag modele-tag-duree">â± '+m.data.resume+'</span>'+
        '</div>'+
        '<div class="modele-desc">'+m.description+'</div>'+
        '<div class="modele-etapes-preview">'+
          '<div style="font-size:10px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">AperÃ§u des Ã©tapes</div>'+
          etapesHtml+
        '</div>'+
      '</div>'+
      '<div class="modele-card-actions">'+
        '<button class="btn-modele-charger" onclick="chargerModele(\''+m.id+'\')">ğŸ“‚ Charger ce modÃ¨le</button>'+
        '<button class="btn-modele-sauver" onclick="sauverModeleRepertoire(\''+m.id+'\')">ğŸ’¾ Sauver</button>'+
      '</div>'+
    '</div>';
  }).join('');
}

function chargerModele(id) {
  var modele = null;
  for (var i=0; i<MODELES_FICHES.length; i++) { if (MODELES_FICHES[i].id === id) { modele = MODELES_FICHES[i]; break; } }
  if (!modele) return;
  if (!confirm('ğŸ“‚ Charger le modÃ¨le "'+modele.titre+'" ?\n\nLe contenu actuel sera remplacÃ©.')) return;
  var data = JSON.parse(JSON.stringify(modele.data));
  restaurerFiche(data);
  showTab('entete');
  var toast = document.getElementById('toast');
  if (toast) toast.textContent = 'âœ… ModÃ¨le chargÃ© â€” personnalisez et exportez !';
  showToast();
}

function sauverModeleRepertoire(id) {
  var modele = null;
  for (var i=0; i<MODELES_FICHES.length; i++) { if (MODELES_FICHES[i].id === id) { modele = MODELES_FICHES[i]; break; } }
  if (!modele) return;
  var fiches = lireRepertoire();
  var nomFinal = '[MODÃˆLE] ' + modele.titre;
  var existant = -1;
  for (var j=0; j<fiches.length; j++) { if (fiches[j].nom === nomFinal) { existant = j; break; } }
  if (existant !== -1) {
    if (!confirm('âš ï¸ Ce modÃ¨le est dÃ©jÃ  dans le rÃ©pertoire.\nVoulez-vous le remplacer ?')) return;
    fiches.splice(existant, 1);
  }
  var data = JSON.parse(JSON.stringify(modele.data));
  data.nom = nomFinal;
  data.savedAt = new Date().toLocaleString('fr-FR');
  data.resume = modele.data.resume;
  data.niveau = modele.niveau;
  data.module = modele.data.entete.module;
  fiches.push(data);
  ecrireRepertoire(fiches);
  mettreAJourBadgeRepertoire();
  var toast = document.getElementById('toast');
  if (toast) toast.textContent = 'ğŸ’¾ ModÃ¨le sauvegardÃ© dans le rÃ©pertoire !';
  showToast();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOUVELLES FONCTIONNALITÃ‰S v3.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ EXPORT / IMPORT JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function exporterToutesLesFinches() {
  try {
    const fiches = lireRepertoire();
    const autosave = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null');
    const exportData = {
      version: '3.0',
      exportedAt: new Date().toLocaleString('fr-FR'),
      author: 'EZ-ZAKY AZIZ',
      fiches: fiches,
      autosave: autosave
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const dateStr = new Date().toISOString().slice(0,10);
    a.download = 'backup_fiches_pedagogiques_' + dateStr + '.json';
    a.click();
    URL.revokeObjectURL(url);
    localStorage.setItem('fp_last_backup', new Date().toLocaleString('fr-FR'));
    afficherExportStatus('âœ… Backup exportÃ© avec succÃ¨s ! (' + fiches.length + ' fiche(s))', '#2E7D32');
    mettreAJourStatsPartage();
  } catch(e) {
    afficherExportStatus('âŒ Erreur lors de l\'export : ' + e.message, '#C62828');
  }
}

function exporterFicheActuelle() {
  try {
    const data = collecterTout();
    data.exportedAt = new Date().toLocaleString('fr-FR');
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const nom = (data.entete && data.entete.activite) ? data.entete.activite.replace(/[^a-zA-Z0-9\u00C0-\u024F]/gi,'_').slice(0,30) : 'fiche';
    a.download = 'fiche_' + nom + '_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    afficherExportStatus('âœ… Fiche actuelle exportÃ©e !', '#2E7D32');
  } catch(e) {
    afficherExportStatus('âŒ Erreur lors de l\'export : ' + e.message, '#C62828');
  }
}

function importerFichesJSON() {
  document.getElementById('import-json-input').value = '';
  document.getElementById('import-json-input').click();
}

function lireJSONImporte(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const raw = e.target.result;
      const data = JSON.parse(raw);

      // â”€â”€ CAS 1 : Backup complet (exporterToutesLesFinches) â”€â”€
      // Structure : { version, exportedAt, author, fiches:[], autosave }
      if (data.fiches && Array.isArray(data.fiches)) {
        const n = data.fiches.length;
        const msg = n === 0
          ? 'ğŸ“¥ Ce backup est vide (0 fiche). Rien Ã  importer.'
          : 'ğŸ“¥ Importer ' + n + ' fiche(s) depuis ce backup ?\n\nCes fiches seront AJOUTÃ‰ES Ã  votre rÃ©pertoire (vos fiches actuelles sont conservÃ©es).';
        if (n === 0) { afficherExportStatus(msg, '#E65100'); return; }
        if (!confirm(msg)) return;
        const existing = lireRepertoire();
        // Ã‰viter les doublons par nom
        const existingNames = new Set(existing.map(function(f) { return f.nom; }));
        const toAdd = data.fiches.filter(function(f) { return !existingNames.has(f.nom); });
        const dupes = data.fiches.length - toAdd.length;
        const merged = [...toAdd, ...existing];
        ecrireRepertoire(merged);
        // Restaurer l'autosave si existant et utile
        if (data.autosave && !localStorage.getItem(SAVE_KEY)) {
          localStorage.setItem(SAVE_KEY, JSON.stringify(data.autosave));
        }
        mettreAJourBadgeRepertoire();
        mettreAJourStatsPartage();
        let msg2 = 'âœ… ' + toAdd.length + ' fiche(s) importÃ©e(s) !';
        if (dupes > 0) msg2 += ' (' + dupes + ' doublon(s) ignorÃ©(s))';
        afficherExportStatus(msg2, '#2E7D32');
        return;
      }

      // â”€â”€ CAS 2 : Fiche individuelle (exporterFicheActuelle) â”€â”€
      // Structure : { v, entete, etapes, params, exportedAt, nom? }
      if (data.entete && typeof data.entete === 'object') {
        if (!confirm('ğŸ“¥ Charger cette fiche dans l\'Ã©diteur ?\n"' + (data.nom || data.entete.activite || 'Sans titre') + '"\n\nLe contenu actuel sera remplacÃ©.')) return;
        restaurerFiche(data);
        showTab('entete');
        afficherExportStatus('âœ… Fiche "' + (data.nom || data.entete.activite || 'Sans titre') + '" chargÃ©e !', '#1565C0');
        return;
      }

      // â”€â”€ CAS 3 : Ancienne structure v2.x (v + entete + etapes) â”€â”€
      if ((data.v || data.version) && data.etapes && Array.isArray(data.etapes)) {
        if (!confirm('ğŸ“¥ Charger cette fiche dans l\'Ã©diteur ?\n\nLe contenu actuel sera remplacÃ©.')) return;
        restaurerFiche(data);
        showTab('entete');
        afficherExportStatus('âœ… Fiche chargÃ©e depuis le backup v2 !', '#1565C0');
        return;
      }

      // â”€â”€ Aucun format reconnu â”€â”€
      afficherExportStatus('âŒ Format non reconnu. VÃ©rifiez que c\'est bien un fichier exportÃ© depuis cette application.', '#C62828');

    } catch(err) {
      afficherExportStatus('âŒ Fichier JSON invalide ou corrompu : ' + err.message, '#C62828');
    }
  };
  reader.onerror = function() {
    afficherExportStatus('âŒ Impossible de lire le fichier.', '#C62828');
  };
  reader.readAsText(file, 'UTF-8');
}

function confirmerEffacerTout() {
  if (!confirm('âš ï¸ ATTENTION !\n\nVoulez-vous vraiment supprimer TOUTES vos fiches sauvegardÃ©es ?\n\nCette action est IRRÃ‰VERSIBLE.\n\nPensez Ã  exporter un backup avant !')) return;
  if (!confirm('ğŸ”´ DerniÃ¨re confirmation : effacer toutes les fiches ?')) return;
  localStorage.removeItem(REP_KEY);
  localStorage.removeItem(SAVE_KEY);
  mettreAJourBadgeRepertoire();
  mettreAJourStatsPartage();
  afficherExportStatus('ğŸ—‘ï¸ Toutes les fiches ont Ã©tÃ© supprimÃ©es.', '#E65100');
}

function afficherExportStatus(msg, color) {
  const el = document.getElementById('export-status');
  if (!el) return;
  el.style.display = 'block';
  el.style.background = color + '15';
  el.style.border = '1px solid ' + color + '40';
  el.style.color = color;
  el.textContent = msg;
  setTimeout(function() { if (el) el.style.display = 'none'; }, 4000);
}

function mettreAJourStatsPartage() {
  const fiches = lireRepertoire();
  const el1 = document.getElementById('stat-fiches');
  const el2 = document.getElementById('stat-taille');
  const el3 = document.getElementById('stat-backup');
  if (el1) el1.textContent = fiches.length;
  if (el2) {
    try {
      const totalSize = (localStorage.getItem(REP_KEY) || '').length * 2;
      el2.textContent = totalSize > 1024 ? Math.round(totalSize/1024) + ' Ko' : totalSize + ' o';
    } catch(e2) { if (el2) el2.textContent = 'â€”'; }
  }
  if (el3) {
    const lastBackup = localStorage.getItem('fp_last_backup');
    el3.textContent = lastBackup ? lastBackup.split(' ')[0] : 'â€”';
  }
}

// â”€â”€ PARTAGE PAR LIEN ET QR CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function switchShareMethod(method, btn) {
  document.querySelectorAll('.share-method-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.share-panel').forEach(function(p) { p.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  const panel = document.getElementById('share-panel-' + method);
  if (panel) panel.classList.add('active');
}

function compresserFiche() {
  const data = collecterTout();
  const slim = {
    v: data.v,
    entete: data.entete,
    etapes: data.etapes.map(function(e) { return {
      nom: e.nom,
      enseignant: (e.enseignant || '').replace(/src="data:image[^"]*"/g, 'src="[IMG]"'),
      duree: e.duree
    }; }),
    params: data.params
  };
  const json = JSON.stringify(slim);
  try { return btoa(unescape(encodeURIComponent(json))); }
  catch(err) { return btoa(json); }
}

function genererURL() {
  try {
    const encoded = compresserFiche();
    const baseUrl = window.location.href.split('?')[0].split('#')[0];
    const url = baseUrl + '?fiche=' + encoded;
    const urlContainer = document.getElementById('url-container');
    const urlDisplay = document.getElementById('share-url-display');
    const sizeInfo = document.getElementById('url-size-info');
    if (urlContainer) urlContainer.style.display = 'block';
    if (urlDisplay) urlDisplay.textContent = url;
    if (sizeInfo) {
      const kb = Math.round(url.length / 1024 * 10) / 10;
      sizeInfo.textContent = 'Taille du lien : ' + kb + ' Ko';
      if (url.length > 50000) {
        sizeInfo.textContent += ' âš ï¸ Lien trÃ¨s long â€” prÃ©fÃ©rez l\'export JSON.';
        sizeInfo.style.color = '#E65100';
      } else {
        sizeInfo.style.color = 'var(--muted)';
      }
    }
  } catch(e) {
    afficherExportStatus('âŒ Erreur lors de la gÃ©nÃ©ration du lien : ' + e.message, '#C62828');
  }
}

function copierURL() {
  const urlEl = document.getElementById('share-url-display');
  if (!urlEl) return;
  const url = urlEl.textContent;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(function() {
      afficherExportStatus('âœ… Lien copiÃ© dans le presse-papiers !', '#2E7D32');
    }).catch(function() {
      selectionnerEtCopier(urlEl);
    });
  } else {
    selectionnerEtCopier(urlEl);
  }
}

function selectionnerEtCopier(el) {
  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  try {
    document.execCommand('copy');
    afficherExportStatus('âœ… Lien copiÃ© !', '#2E7D32');
  } catch(e) {
    afficherExportStatus('SÃ©lectionnez le texte manuellement et copiez-le.', '#1565C0');
  }
  sel.removeAllRanges();
}

function ouvrirURL() {
  const urlEl = document.getElementById('share-url-display');
  if (urlEl && urlEl.textContent) window.open(urlEl.textContent, '_blank');
}

function partagerEmail(mode) {
  var entete = {};
  try { entete = collecterEntete ? collecterEntete() : {}; } catch(e2) {}
  const nom = (entete.activite || entete.module || 'Fiche pÃ©dagogique');
  const sujet = encodeURIComponent('Fiche pÃ©dagogique : ' + nom);
  const corps = encodeURIComponent('Bonjour,\n\nJe partage la fiche pÃ©dagogique "' + nom + '".\n\nVeuillez trouver le fichier JSON en piÃ¨ce jointe.\nPour l\'importer :\n1. Ouvrez l\'application Fiche PÃ©dagogique\n2. Allez dans l\'onglet "Partage"\n3. Cliquez sur "Importer un backup (.json)"\n4. SÃ©lectionnez le fichier reÃ§u\n\nCordialement,\n' + (entete.prof || ''));
  afficherExportStatus('ğŸ“§ Export en cours... Joignez le fichier JSON tÃ©lÃ©chargÃ© Ã  votre email.', '#1565C0');
  setTimeout(function() { exporterFicheActuelle(); }, 200);
  setTimeout(function() { window.location.href = 'mailto:?subject=' + sujet + '&body=' + corps; }, 800);
}

// â”€â”€ QR RÃ‰SUMÃ‰ (v3.2 â€” fonctionne toujours car encode seulement les infos essentielles) â”€â”€

function genererQRResume() {
  try {
    // Collecter seulement les infos essentielles de l'en-tÃªte
    var entete = {};
    try { entete = collecterEntete ? collecterEntete() : {}; } catch(e2) {}
    var etapes = [];
    try { etapes = collecterEtapes ? collecterEtapes() : []; } catch(e2) {}

    function stripHtml(html) {
      if (!html) return '';
      const d = document.createElement('div');
      d.innerHTML = html;
      return (d.textContent || d.innerText || '').trim().slice(0, 120);
    }

    // Construire un texte compact et lisible (pas de JSON, juste du texte)
    const prof     = stripHtml(entete.prof     || '').slice(0, 40);
    const niveau   = stripHtml(entete.niveau   || '').slice(0, 20);
    const module_  = stripHtml(entete.module   || '').slice(0, 60);
    const sequence = stripHtml(entete.sequence || '').slice(0, 60);
    const activite = stripHtml(entete.activite || '').slice(0, 60);
    const objectif = stripHtml(entete.objectif || '').slice(0, 150);
    const dureeTotal = etapes.reduce(function(s, e) {
      const m = (e.duree || '').match(/(\d+[\.,]?\d*)/);
      return s + (m ? parseFloat(m[1].replace(',','.')) : 0);
    }, 0);

    // Construire les lignes du rÃ©sumÃ©
    const lines = [];
    lines.push('=== FICHE PÃ‰DAGOGIQUE ===');
    if (prof)     lines.push('Prof : ' + prof);
    if (niveau)   lines.push('Niveau : ' + niveau);
    if (module_)  lines.push('Module : ' + module_);
    if (sequence) lines.push('SÃ©quence : ' + sequence);
    if (activite) lines.push('ActivitÃ© : ' + activite);
    if (objectif) lines.push('Objectif : ' + objectif);
    if (etapes.length > 0) {
      lines.push('---');
      lines.push('Ã‰tapes (' + etapes.length + ')' + (dureeTotal > 0 ? ' Â· ' + dureeTotal + ' min' : '') + ' :');
      etapes.forEach(function(et, i) {
        const nom = stripHtml(et.nom || '').slice(0, 30) || ('Ã‰tape ' + (i+1));
        lines.push((i+1) + '. ' + nom + (et.duree ? ' (' + et.duree + ')' : ''));
      });
    }
    lines.push('---');
    lines.push('App : Fiche PÃ©dagogique v3.2');
    lines.push('Â© EZ-ZAKY AZIZ');

    const qrText = lines.join('\n');

    // VÃ©rification de taille â€” ce texte sera toujours court
    const preview = document.getElementById('qr-content-preview');
    if (preview) preview.textContent = qrText;

    const container = document.getElementById('qr-container');
    const canvas    = document.getElementById('qr-canvas');
    const infoEl    = document.getElementById('qr-info-text');
    const ctx       = canvas.getContext('2d');

    // Appel Ã  l'API QR (texte court = QR simple, toujours lisible)
    const qrApiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&ecc=M&margin=10&data='
                   + encodeURIComponent(qrText);

    // Afficher un loader pendant le chargement
    ctx.fillStyle = '#F5F8FF';
    ctx.fillRect(0, 0, 220, 220);
    ctx.fillStyle = '#1565C0';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('GÃ©nÃ©rationâ€¦', 110, 115);
    if (container) container.style.display = 'flex';

    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
      ctx.clearRect(0, 0, 220, 220);
      ctx.drawImage(img, 0, 0, 220, 220);
      if (infoEl) infoEl.textContent = 
        'RÃ©sumÃ© : ' + (prof || 'â€”') + ' Â· ' + (niveau || 'â€”') + 
        (activite ? ' Â· ' + activite.slice(0,30) : '') +
        ' Â· ' + etapes.length + ' Ã©tape(s)' +
        (dureeTotal > 0 ? ' Â· ' + dureeTotal + ' min' : '');
      afficherExportStatus('âœ… QR RÃ©sumÃ© gÃ©nÃ©rÃ© ! Ã€ imprimer ou afficher en classe.', '#2E7D32');
    };
    img.onerror = function() {
      // Hors ligne â€” dessiner un QR factice avec message
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, 220, 220);
      // Bordure bleue
      ctx.strokeStyle = '#1565C0';
      ctx.lineWidth = 3;
      ctx.strokeRect(4, 4, 212, 212);
      // Coins de QR
      [
        [10,10],[170,10],[10,170]
      ].forEach(function(pos) {
        ctx.fillStyle = '#1565C0';
        ctx.fillRect(pos[0], pos[1], 40, 40);
        ctx.fillStyle = 'white';
        ctx.fillRect(pos[0]+6, pos[1]+6, 28, 28);
        ctx.fillStyle = '#1565C0';
        ctx.fillRect(pos[0]+12, pos[1]+12, 16, 16);
      });
      // Message centrÃ©
      ctx.fillStyle = '#1565C0';
      ctx.font = 'bold 11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Connexion requise', 110, 90);
      ctx.font = '10px sans-serif';
      ctx.fillStyle = '#555';
      ctx.fillText('pour gÃ©nÃ©rer le QR.', 110, 106);
      ctx.fillText('Reconnectez-vous', 110, 126);
      ctx.fillText('puis rÃ©essayez.', 110, 142);
      if (infoEl) infoEl.textContent = 'âš ï¸ Connexion internet requise pour gÃ©nÃ©rer le QR Code.';
      if (container) container.style.display = 'flex';
      afficherExportStatus('âš ï¸ QR non disponible hors ligne. Utilisez "ğŸ”‘ Code court" Ã  la place.', '#E65100');
    };
    img.src = qrApiUrl;

  } catch(e) {
    afficherExportStatus('âŒ Erreur : ' + e.message, '#C62828');
  }
}

// Garder la compatibilitÃ© si genererQRCode est appelÃ© ailleurs
function genererQRCode() { genererQRResume(); }

function telechargerQR() {
  const canvas = document.getElementById('qr-canvas');
  if (!canvas) return;
  try {
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    const entete = {};
    try { Object.assign(entete, collecterEntete ? collecterEntete() : {}); } catch(e2) {}
    const nom = (entete.activite || entete.niveau || 'fiche').replace(/[^a-zA-Z0-9]/gi,'_').slice(0,20);
    a.download = 'QR_resume_' + nom + '.png';
    a.click();
    afficherExportStatus('âœ… QR tÃ©lÃ©chargÃ© !', '#2E7D32');
  } catch(e) {
    afficherExportStatus('âŒ TÃ©lÃ©chargement impossible : ' + e.message, '#C62828');
  }
}

// â”€â”€ CODE COURT DE PARTAGE (fonctionne sur Android WebView) â”€â”€â”€â”€â”€â”€â”€

// Le code est stockÃ© dans localStorage avec une clÃ© unique.
// Votre collÃ¨gue entre le code dans son application sur le mÃªme appareil
// ou transfÃ¨re le fichier JSON manuellement.
// Note : localStorage n'est pas partagÃ© entre appareils.
// Le "code" est donc un raccourci pour sauvegarder/retrouver une fiche
// sur le MÃŠME appareil, ou via copier-coller du code + import.

const CODE_PREFIX = 'fp_share_code_';

function genererCodeCourt() {
  try {
    const data = collecterTout();
    // GÃ©nÃ©rer un code de 8 caractÃ¨res alphanumÃ©riques
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // sans I, O, 0, 1 pour Ã©viter confusion
    let code = '';
    for (let i = 0; i < 8; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    // Stocker dans localStorage avec expiration 48h
    const expiry = Date.now() + 48 * 60 * 60 * 1000;
    const payload = { data: data, code: code, expiry: expiry, createdAt: new Date().toLocaleString('fr-FR') };
    localStorage.setItem(CODE_PREFIX + code, JSON.stringify(payload));
    
    // Afficher le code
    const display = document.getElementById('code-court-display');
    const expiryEl = document.getElementById('code-court-expiry');
    const container = document.getElementById('code-court-container');
    if (display) display.textContent = code;
    if (expiryEl) expiryEl.textContent = 'Valide 48h sur cet appareil Â· CrÃ©Ã© le ' + new Date().toLocaleString('fr-FR');
    if (container) container.style.display = 'block';
    
    // Nettoyer les anciens codes expirÃ©s
    nettoyerCodesExpires();
    
  } catch(e) {
    afficherExportStatus('âŒ Erreur gÃ©nÃ©ration code : ' + e.message, '#C62828');
  }
}

function nettoyerCodesExpires() {
  try {
    const keys = Object.keys(localStorage).filter(function(k) { return k.startsWith(CODE_PREFIX); });
    keys.forEach(function(k) {
      try {
        const p = JSON.parse(localStorage.getItem(k));
        if (p && p.expiry && p.expiry < Date.now()) localStorage.removeItem(k);
      } catch(e2) { localStorage.removeItem(k); }
    });
  } catch(e) {}
}

function copierCode() {
  const display = document.getElementById('code-court-display');
  if (!display) return;
  const code = display.textContent;
  if (!code || code === 'â€”â€”') return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(function() {
      afficherExportStatus('âœ… Code "' + code + '" copiÃ© !', '#2E7D32');
    }).catch(function() {
      afficherExportStatus('Code : ' + code + ' (copiez-le manuellement)', '#1565C0');
    });
  } else {
    afficherExportStatus('Votre code : ' + code, '#1565C0');
  }
}

function partagerCodeWhatsApp() {
  const display = document.getElementById('code-court-display');
  if (!display) return;
  const code = display.textContent;
  if (!code || code === 'â€”â€”') { afficherExportStatus('GÃ©nÃ©rez d\'abord un code.', '#E65100'); return; }
  const entete = {};
  try { Object.assign(entete, collecterEntete ? collecterEntete() : {}); } catch(e2) {}
  const nom = entete.activite || entete.module || 'Fiche pÃ©dagogique';
  const msg = 'Bonjour ! Je partage la fiche "' + nom + '".\n\nCode de partage : *' + code + '*\n\nOuvrez l\'application â†’ onglet Partage â†’ Code court â†’ entrez ce code.\n\n(Valide 48h sur cet appareil)';
  window.location.href = 'whatsapp://send?text=' + encodeURIComponent(msg);
}

function chargerParCode() {
  const input = document.getElementById('code-import-input');
  const statusEl = document.getElementById('code-import-status');
  if (!input || !statusEl) return;
  const code = (input.value || '').trim().toUpperCase();
  if (!code || code.length < 4) {
    statusEl.style.color = '#E65100';
    statusEl.textContent = 'âš ï¸ Entrez un code valide.';
    return;
  }
  
  nettoyerCodesExpires();
  
  try {
    const stored = localStorage.getItem(CODE_PREFIX + code);
    if (!stored) {
      statusEl.style.color = '#C62828';
      statusEl.textContent = 'âŒ Code introuvable ou expirÃ©. VÃ©rifiez le code ou demandez-en un nouveau.';
      return;
    }
    const payload = JSON.parse(stored);
    if (!payload || !payload.data) {
      statusEl.style.color = '#C62828';
      statusEl.textContent = 'âŒ DonnÃ©es corrompues.';
      return;
    }
    if (payload.expiry && payload.expiry < Date.now()) {
      localStorage.removeItem(CODE_PREFIX + code);
      statusEl.style.color = '#E65100';
      statusEl.textContent = 'â±ï¸ Ce code a expirÃ©. Demandez un nouveau code.';
      return;
    }
    if (!confirm('ğŸ“¥ Charger la fiche associÃ©e au code "' + code + '" ?\n\nLe contenu actuel sera remplacÃ©.')) return;
    restaurerFiche(payload.data);
    showTab('entete');
    statusEl.style.color = '#2E7D32';
    statusEl.textContent = 'âœ… Fiche chargÃ©e !';
    input.value = '';
    afficherStatutSauvegarde('ğŸ“¥ Fiche chargÃ©e via code "' + code + '"', '#1565C0');
  } catch(e) {
    statusEl.style.color = '#C62828';
    statusEl.textContent = 'âŒ Erreur : ' + e.message;
  }
}

function partagerEmailCode() {
  const display = document.getElementById('code-court-display');
  const code = display ? display.textContent : '';
  var entete = {};
  try { Object.assign(entete, collecterEntete ? collecterEntete() : {}); } catch(e2) {}
  const nom = entete.activite || entete.module || 'Fiche pÃ©dagogique';
  const sujet = encodeURIComponent('Code de partage - Fiche : ' + nom);
  const corps = encodeURIComponent(
    'Bonjour,\n\nJe partage la fiche pÃ©dagogique "' + nom + '".\n\n' +
    'Code de partage : ' + (code && code !== 'â€”â€”' ? code : '(gÃ©nÃ©rez d\'abord un code)') + '\n\n' +
    'Pour charger la fiche :\n' +
    '1. Ouvrez l\'application Fiche PÃ©dagogique\n' +
    '2. Allez dans l\'onglet "Partage"\n' +
    '3. Cliquez sur "ğŸ”‘ Code court"\n' +
    '4. Entrez le code ci-dessus\n\n' +
    'Note : le code est valide 48h.\n\nCordialement,\n' + (entete.prof || '')
  );
  if (!code || code === 'â€”â€”') {
    afficherExportStatus('âš ï¸ GÃ©nÃ©rez d\'abord un code via "ğŸ”‘ GÃ©nÃ©rer un code de partage".', '#E65100');
    return;
  }
  window.location.href = 'mailto:?subject=' + sujet + '&body=' + corps;
}

// â”€â”€ CHARGEMENT DEPUIS URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function chargerDepuisURL() {
  try {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('fiche');
    if (!encoded) return;
    const json = decodeURIComponent(escape(atob(encoded)));
    const data = JSON.parse(json);
    if (data && (data.entete || data.v)) {
      setTimeout(function() {
        if (confirm('ğŸ“¥ Un lien de partage a Ã©tÃ© dÃ©tectÃ©.\n\nVoulez-vous charger la fiche partagÃ©e ?')) {
          restaurerFiche(data);
          showTab('entete');
          const cleanUrl = window.location.href.split('?')[0];
          if (window.history && window.history.replaceState) {
            window.history.replaceState({}, document.title, cleanUrl);
          }
          afficherStatutSauvegarde('ğŸ“¥ Fiche chargÃ©e depuis un lien de partage !', '#1565C0');
        }
      }, 1200);
    }
  } catch(e) {
    // URL invalide, ignorer
  }
}

// â”€â”€ APERÃ‡U PDF SIMULÃ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function genererPreviewSimulee() {
  const container = document.getElementById('pdf-preview-container');
  if (!container) return;
  try {
    var entete = {};
    var etapes = [];
    try { entete = collecterEntete ? collecterEntete() : {}; } catch(e2) {}
    try { etapes = collecterEtapes ? collecterEtapes() : []; } catch(e2) {}
    const mainColor = (document.getElementById('p-color-main') || {}).value || '#1565C0';
    function stripHtml(html) {
      if (!html) return '';
      const d = document.createElement('div');
      d.innerHTML = html;
      return (d.textContent || d.innerText || '').trim();
    }
    // Labels des colonnes
    const etapesLabel = (document.getElementById('label-col-etapes') || {}).value || 'Ã‰tapes';
    const deroulLabel = (document.getElementById('label-col-deroulement') || {}).value || 'DÃ©roulement de la sÃ©ance';
    const dureeLabel = (document.getElementById('label-col-duree') || {}).value || 'DurÃ©e';
    // Labels de l'en-tÃªte
    const getLabel = function(selector, fallback) {
      const els = document.querySelectorAll(selector);
      const el = els[0];
      return el ? (el.textContent || '').trim() || fallback : fallback;
    };
    const profLabel = getLabel('#fgrp-ligne1 .label-text', 'Professeur');
    const niveauLabel = (document.querySelectorAll('#fgrp-ligne1 .label-text')[1] || {textContent: 'Niveau'}).textContent.trim() || 'Niveau';
    const moduleLabel = getLabel('#fgrp-module .label-text', 'Module');
    const sequenceLabel = getLabel('#fgrp-sequence .label-text', 'SÃ©quence');
    const activiteLabel = getLabel('#fgrp-activite .label-text', 'ActivitÃ©');
    const supportLabel = getLabel('#fgrp-support .label-text', 'Support');
    const objectifLabel = getLabel('#fgrp-objectif .label-text', 'Objectif');
    const lbl = 'background:' + mainColor + ';color:white;padding:4px 6px;font-size:8px;font-weight:700;min-width:60px;display:flex;align-items:center;white-space:nowrap;';
    const val = 'padding:4px 6px;font-size:8px;flex:1;border-left:1px solid ' + mainColor + ';word-break:break-word;';
    const borderStyle = 'border:1.5px solid ' + mainColor + ';border-radius:2px;margin-bottom:8px;overflow:hidden;font-family:Times New Roman,serif;';
    const rowStyle = 'display:flex;border-bottom:1px solid ' + mainColor + ';';
    let headerHtml = '<div style="' + borderStyle + '">';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + profLabel + '</span><span style="' + val + '">' + (stripHtml(entete.prof)||'â€”') + '</span><span style="' + lbl + '">' + niveauLabel + '</span><span style="' + val + '">' + (stripHtml(entete.niveau)||'â€”') + '</span></div>';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + moduleLabel + '</span><span style="' + val + 'flex:3">' + (stripHtml(entete.module)||'â€”') + '</span></div>';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + sequenceLabel + '</span><span style="' + val + 'flex:3">' + (stripHtml(entete.sequence)||'â€”') + '</span></div>';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + activiteLabel + '</span><span style="' + val + '">' + (stripHtml(entete.activite)||'â€”') + '</span><span style="' + lbl + '">' + supportLabel + '</span><span style="' + val + '">' + (stripHtml(entete.support)||'â€”') + '</span></div>';
    headerHtml += '<div style="display:flex;min-height:30px;"><span style="' + lbl + 'align-items:flex-start;padding-top:5px;">' + objectifLabel + '</span><span style="' + val + 'flex:3;white-space:pre-wrap;">' + (stripHtml(entete.objectif)||'â€”') + '</span></div>';
    headerHtml += '</div>';
    let tableHtml = '<table style="width:100%;border-collapse:collapse;border:1px solid ' + mainColor + ';font-family:Times New Roman,serif;">';
    tableHtml += '<thead><tr><th style="background:' + mainColor + ';color:white;padding:4px;font-size:8px;width:18%;border:1px solid rgba(255,255,255,0.3);">' + etapesLabel + '</th><th style="background:' + mainColor + ';color:white;padding:4px;font-size:8px;width:72%;border:1px solid rgba(255,255,255,0.3);">' + deroulLabel + '</th><th style="background:' + mainColor + ';color:white;padding:4px;font-size:8px;width:10%;border:1px solid rgba(255,255,255,0.3);">' + dureeLabel + '</th></tr></thead><tbody>';
    if (etapes.length === 0) {
      tableHtml += '<tr><td colspan="3" style="padding:10px;text-align:center;font-size:8px;color:#aaa;">Aucune Ã©tape dÃ©finie</td></tr>';
    } else {
      etapes.forEach(function(et, i) {
        const d = stripHtml(et.enseignant || '');
        const dt = d.length > 180 ? d.slice(0,180) + 'â€¦' : d;
        tableHtml += '<tr><td style="border:1px solid #ddd;padding:4px 3px;font-size:8px;font-weight:700;color:' + mainColor + ';text-align:center;">' + (stripHtml(et.nom)||(i+1)) + '</td><td style="border:1px solid #ddd;padding:4px 3px;font-size:7px;">' + dt + '</td><td style="border:1px solid #ddd;padding:4px 3px;font-size:8px;text-align:center;">' + (et.duree||'â€”') + '</td></tr>';
      });
    }
    tableHtml += '</tbody></table>';
    container.innerHTML = '<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:10px;">' +
      '<button class="pdf-preview-update-btn" onclick="genererPreviewSimulee()">ğŸ”„ Actualiser</button>' +
      '<button class="pdf-preview-update-btn" onclick="genererPDF()" style="background:#2E7D32;">ğŸ“„ GÃ©nÃ©rer le vrai PDF</button>' +
      '</div>' +
      '<div class="pdf-page-sim">' +
      '<div style="text-align:center;font-size:9px;color:#aaa;margin-bottom:8px;">â€” AperÃ§u simulÃ© Â· non contractuel â€”</div>' +
      headerHtml + tableHtml +
      '<div style="text-align:center;font-size:7px;color:#bbb;margin-top:8px;">Â© EZ-ZAKY AZIZ Â· v3.0 Â· ' + new Date().toLocaleDateString('fr-FR') + '</div>' +
      '</div>' +
      '<div class="pdf-sim-info">ğŸ“ AperÃ§u approximatif A4 Â· Le PDF rÃ©el peut lÃ©gÃ¨rement diffÃ©rer</div>';
  } catch(err) {
    container.innerHTML = '<div class="pdf-sim-info" style="color:#E65100;">âŒ ' + err.message + '</div>';
  }
}

// â”€â”€ INITIALISATION v3.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.addEventListener('load', function() {
  setTimeout(chargerDepuisURL, 600);
  setTimeout(mettreAJourStatsPartage, 1200);
});

(function() {
  const banner = document.getElementById('offline-banner');
  let restoreTimer = null;

  function showOffline() {
    if (!banner) return;
    banner.classList.remove('online-restored');
    banner.textContent = 'ğŸ“µ Mode hors ligne â€” La gÃ©nÃ©ration PDF reste disponible';
    banner.classList.add('show');
    clearTimeout(restoreTimer);
  }

  function showOnline() {
    if (!banner) return;
    banner.classList.add('online-restored');
    banner.textContent = 'âœ… Connexion rÃ©tablie';
    banner.classList.add('show');
    clearTimeout(restoreTimer);
    restoreTimer = setTimeout(() => banner.classList.remove('show'), 3000);
  }

  window.addEventListener('offline', showOffline);
  window.addEventListener('online',  showOnline);

  // VÃ©rification initiale
  if (!navigator.onLine) showOffline();

  // Chargement de jsPDF avec fallback inline si le script externe Ã©choue
  function injectJsPdfFallback() {
    // Si jsPDF n'est pas chargÃ©, afficher un avertissement clair
    setTimeout(() => {
      if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
        const warn = document.getElementById('jspdf-warn');
        if (warn) warn.style.display = 'block';
      }
    }, 4000);
  }

  window.addEventListener('load', injectJsPdfFallback);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MESSAGE DE BIENVENUE & LICENCE (Premier lancement)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.addEventListener('load', function() {
    // VÃ©rifier si c'est la premiÃ¨re visite
    const hasSeenWelcome = localStorage.getItem('fp_welcome_seen');
    
    if (!hasSeenWelcome) {
      // Attendre 800ms pour que la page soit bien chargÃ©e
      setTimeout(function() {
        const acceptLicense = confirm(
          'ğŸ“‹ BIENVENUE dans le GÃ©nÃ©rateur de Fiches PÃ©dagogiques !\n\n' +
          'Â© 2025-2026 EZ-ZAKY AZIZ â€” Version 3.0\n\n' +
          'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
          'LICENCE D\'UTILISATION\n' +
          'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n' +
          'Cette application est gratuite et distribuÃ©e sous licence\n' +
          'Creative Commons BY-NC-SA 4.0.\n\n' +
          'âœ… VOUS POUVEZ :\n' +
          '   â€¢ Utiliser l\'application gratuitement\n' +
          '   â€¢ La partager avec vos collÃ¨gues\n' +
          '   â€¢ La modifier pour vos besoins\n\n' +
          'âš ï¸ VOUS DEVEZ :\n' +
          '   â€¢ Toujours crÃ©diter l\'auteur (EZ-ZAKY AZIZ)\n' +
          '   â€¢ Partager vos modifications sous la mÃªme licence\n\n' +
          'âŒ INTERDIT :\n' +
          '   â€¢ Usage commercial (vente de l\'application)\n' +
          '   â€¢ Retirer le nom de l\'auteur\n\n' +
          'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n' +
          'Pour plus de dÃ©tails, consultez l\'onglet "Ã€ propos".\n\n' +
          'Acceptez-vous ces conditions d\'utilisation ?'
        );
        
        if (acceptLicense) {
          // Marquer comme vu
          localStorage.setItem('fp_welcome_seen', 'true');
          localStorage.setItem('fp_license_accepted', new Date().toISOString());
          
          // Message de bienvenue
          alert(
            'ğŸ‰ Merci et bienvenue !\n\n' +
            'Consultez l\'onglet "ğŸ“– Guide" pour dÃ©couvrir\n' +
            'toutes les fonctionnalitÃ©s de l\'application.\n\n' +
            'Bonne crÃ©ation de fiches pÃ©dagogiques ! ğŸ“š'
          );
        } else {
          // L'utilisateur a refusÃ©
          alert(
            'âš ï¸ Conditions non acceptÃ©es\n\n' +
            'Vous devez accepter la licence pour utiliser cette application.\n\n' +
            'L\'application va maintenant se fermer.'
          );
          // Rediriger vers une page blanche
          document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;text-align:center;padding:20px;"><div><h1 style="color:#1565C0;">ğŸ“‹</h1><h2>Licence non acceptÃ©e</h2><p style="color:#666;">Vous devez accepter les conditions d\'utilisation<br>pour utiliser cette application.</p><button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#1565C0;color:white;border:none;border-radius:5px;cursor:pointer;font-size:14px;">ğŸ”„ Recharger et accepter</button></div></div>';
        }
      }, 800);
    }
  });
})();
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- FOOTER PERMANENT â€” VERSION & COPYRIGHT              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-footer">
  <div>
    Â© 2025 <a href="#" onclick="showTab('apropos'); return false;">EZ-ZAKY AZIZ</a> â€” Tous droits rÃ©servÃ©s
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <span class="version-badge">v3.0</span>
    <span style="color:#aaa;">|</span>
    <a href="#" onclick="showTab('apropos'); return false;">Licence CC BY-NC-SA 4.0</a>
  </div>
</div>

</body>
</html>
