<!DOCTYPE html>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    G√âN√âRATEUR DE FICHES P√âDAGOGIQUES                          ‚ïë
‚ïë                                                                               ‚ïë
‚ïë  ¬© 2025 EZ-ZAKY AZIZ ‚Äî Tous droits r√©serv√©s                                  ‚ïë
‚ïë  Licence : Creative Commons BY-NC-SA 4.0                                      ‚ïë
‚ïë                                                                               ‚ïë
‚ïë  Cette application est prot√©g√©e par le droit d'auteur.                       ‚ïë
‚ïë  Vous pouvez l'utiliser, la modifier et la partager UNIQUEMENT si vous :     ‚ïë
‚ïë  ‚úì Cr√©ditez l'auteur original (EZ-ZAKY AZIZ)                                ‚ïë
‚ïë  ‚úì N'en faites pas un usage commercial                                       ‚ïë
‚ïë  ‚úì Partagez vos modifications sous la m√™me licence                           ‚ïë
‚ïë                                                                               ‚ïë
‚ïë  Application cr√©√©e avec ‚ù§Ô∏è pour les enseignants                              ‚ïë
‚ïë  Version 3.0 ‚Äî F√©vrier 2026                                                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Fiche P√©dagogique v3.0 ‚Äî EZ-ZAKY AZIZ</title>
<meta name="description" content="G√©n√©rateur de fiches p√©dagogiques PDF">
<meta name="author" content="EZ-ZAKY AZIZ">
<meta name="copyright" content="¬© 2025 EZ-ZAKY AZIZ. Tous droits r√©serv√©s.">
<meta name="license" content="CC BY-NC-SA 4.0">
<meta name="theme-color" content="#1565C0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fiche P√©da">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231565C0'/%3E%3Crect x='28' y='36' width='136' height='10' rx='5' fill='%23C9A84C'/%3E%3Crect x='28' y='56' width='136' height='8' rx='4' fill='white' opacity='.9'/%3E%3Crect x='28' y='74' width='136' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='92' width='90' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='112' width='136' height='60' rx='6' fill='white' opacity='.15'/%3E%3Ctext x='96' y='152' font-family='serif' font-size='28' font-weight='bold' fill='%23C9A84C' text-anchor='middle'%3EPDF%3C/text%3E%3C/svg%3E">
<link rel="manifest" id="pwa-manifest">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&family=Georgia:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,400;0,700;1,400&family=Open+Sans:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<!-- Quill.js pour l'√©dition de texte riche -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<!-- JSZip pour cr√©er des fichiers DOCX valides -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// ‚îÄ‚îÄ PWA : Manifest inline ‚îÄ‚îÄ
(function() {
  const manifest = {
    name: "Fiche P√©dagogique ‚Äî EZ-ZAKY AZIZ",
    short_name: "Fiche P√©da",
    description: "G√©n√©rateur de fiches p√©dagogiques PDF",
    start_url: "./",
    display: "standalone",
    background_color: "#F7F5F0",
    theme_color: "#1565C0",
    orientation: "portrait",
    icons: [
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='32' fill='%231565C0'/%3E%3Crect x='28' y='36' width='136' height='10' rx='5' fill='%23C9A84C'/%3E%3Crect x='28' y='56' width='136' height='8' rx='4' fill='white' opacity='.9'/%3E%3Crect x='28' y='74' width='136' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='92' width='90' height='8' rx='4' fill='white' opacity='.7'/%3E%3Crect x='28' y='112' width='136' height='60' rx='6' fill='white' opacity='.15'/%3E%3Ctext x='96' y='152' font-family='serif' font-size='28' font-weight='bold' fill='%23C9A84C' text-anchor='middle'%3EPDF%3C/text%3E%3C/svg%3E",
        sizes: "192x192",
        type: "image/svg+xml",
        purpose: "any maskable"
      },
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%231565C0'/%3E%3Crect x='72' y='96' width='368' height='28' rx='14' fill='%23C9A84C'/%3E%3Crect x='72' y='144' width='368' height='22' rx='11' fill='white' opacity='.9'/%3E%3Crect x='72' y='178' width='368' height='22' rx='11' fill='white' opacity='.7'/%3E%3Crect x='72' y='212' width='240' height='22' rx='11' fill='white' opacity='.7'/%3E%3Crect x='72' y='256' width='368' height='160' rx='16' fill='white' opacity='.15'/%3E%3Ctext x='256' y='356' font-family='serif' font-size='72' font-weight='bold' fill='%23C9A84C' text-anchor='middle'%3EPDF%3C/text%3E%3C/svg%3E",
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "any maskable"
      }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  document.getElementById('pwa-manifest').setAttribute('href', url);
})();

// ‚îÄ‚îÄ PWA : Service Worker inline (offline-first) ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'fiche-peda-v4';
    const EXTERNAL = [
      'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
      'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&display=swap',
      'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css',
      'https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js'
    ];

    // Pr√©-cache au premier chargement (page + ressources externes)
    self.addEventListener('install', e => {
      self.skipWaiting();
      e.waitUntil(
        caches.open(CACHE).then(cache => {
          cache.add(self.location.href).catch(() => {});
          return Promise.allSettled(
            EXTERNAL.map(url =>
              fetch(url, { mode: 'cors' })
                .then(r => r.ok ? cache.put(url, r) : null)
                .catch(() => null)
            )
          );
        })
      );
    });

    // Nettoyage des anciens caches
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(keys =>
          Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        ).then(() => self.clients.claim())
      );
    });

    // Strat√©gie : Cache-first pour ressources externes, Network-first pour la page
    self.addEventListener('fetch', e => {
      const url = e.request.url;
      const isExternal = EXTERNAL.some(ext => url.startsWith(ext.split('?')[0]));
      const isFont = url.includes('fonts.googleapis.com') || url.includes('fonts.gstatic.com');

      if (isExternal || isFont) {
        // Cache-first : si en cache ‚Üí sert depuis cache, sinon r√©seau puis mise en cache
        e.respondWith(
          caches.open(CACHE).then(cache =>
            cache.match(e.request).then(cached => {
              if (cached) return cached;
              return fetch(e.request).then(response => {
                if (response && response.ok) {
                  cache.put(e.request, response.clone());
                }
                return response;
              }).catch(() => cached || new Response('', { status: 503 }));
            })
          )
        );
      } else {
        // Network-first pour la page principale : r√©seau d'abord, cache en fallback
        e.respondWith(
          fetch(e.request)
            .then(response => {
              if (response && response.ok) {
                const clone = response.clone();
                caches.open(CACHE).then(cache => cache.put(e.request, clone));
              }
              return response;
            })
            .catch(() => caches.match(e.request).then(r => r || new Response('Hors ligne', { status: 503 })))
        );
      }
    });
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl)
    .then(reg => {
      // V√©rifie p√©riodiquement si une mise √† jour est disponible
      setInterval(() => reg.update(), 60 * 60 * 1000);
    })
    .catch(() => {});
}
</script>
<style>
  :root {
    --blue: #1565C0;
    --blue-light: #1976D2;
    --blue-dark: #0D47A1;
    --blue-pale: #E3F2FD;
    --gold: #C9A84C;
    --white: #FFFFFF;
    --off-white: #F7F5F0;
    --ink: #1A1A2E;
    --muted: #6B7280;
    --border: #DDD8CE;
    --success: #2E7D32;
    --shadow: 0 4px 24px rgba(21,101,192,0.12);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Source Serif 4', Georgia, serif;
    background: var(--off-white);
    color: var(--ink);
    min-height: 100vh;
    padding-bottom: 32px; /* Espace pour le footer fixe */
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  .app-header {
    background: var(--blue);
    padding: 18px 24px 14px;
    display: flex;
    align-items: center;
    gap: 14px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }
  .app-header .logo {
    width: 38px; height: 38px;
    background: var(--gold);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .app-header h1 {
    font-family: 'Playfair Display', serif;
    color: white;
    font-size: 17px;
    font-weight: 700;
    line-height: 1.2;
    flex: 1;
  }
  .app-header h1 span {
    display: block;
    font-size: 11px;
    font-weight: 400;
    color: rgba(255,255,255,0.65);
    font-family: 'Source Serif 4', serif;
    letter-spacing: 0.04em;
    margin-top: 2px;
  }

  /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    background: white;
    border-bottom: 2px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab-btn {
    flex: 1;
    min-width: 90px;
    padding: 12px 8px;
    background: none;
    border: none;
    font-family: 'Source Serif 4', serif;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; gap: 4px;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--blue);
    border-bottom-color: var(--blue);
  }
  .tab-btn .tab-icon { font-size: 18px; }

  /* ‚îÄ‚îÄ‚îÄ CONTENT PANELS ‚îÄ‚îÄ‚îÄ */
  .panel { display: none; padding: 16px; }
  .panel.active { display: block; }

  /* ‚îÄ‚îÄ‚îÄ SECTION CARD ‚îÄ‚îÄ‚îÄ */
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
    overflow: hidden;
  }
  .card-header {
    background: var(--blue);
    padding: 10px 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .card-header h2 {
    font-family: 'Playfair Display', serif;
    color: white;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .card-header .badge {
    background: var(--gold);
    color: white;
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 20px;
    font-family: 'Source Serif 4', serif;
  }
  .card-body { padding: 14px; }

  /* ‚îÄ‚îÄ‚îÄ FORM FIELDS ‚îÄ‚îÄ‚îÄ */
  .field { margin-bottom: 14px; }
  .field:last-child { margin-bottom: 0; }
  .field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .field label .required { color: #E53935; margin-left: 2px; }
  .field input, .field textarea, .field select {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    color: var(--ink);
    background: var(--off-white);
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }
  .field input:focus, .field textarea:focus, .field select:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.1);
    background: white;
  }
  .field textarea {
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }
  .field textarea.tall { min-height: 120px; }
  .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .field-hint {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
    font-style: italic;
  }

  /* ‚îÄ‚îÄ‚îÄ √âTAPES ‚îÄ‚îÄ‚îÄ */
  .etape-card {
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .etape-header {
    background: var(--blue-pale);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }
  .etape-header h3 {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    color: var(--blue-dark);
  }
  .etape-num {
    background: var(--blue);
    color: white;
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .etape-body { padding: 12px; }
  .btn-remove-etape {
    background: none;
    border: 1px solid #FFCDD2;
    color: #C62828;
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    font-family: 'Source Serif 4', serif;
  }
  .btn-move-etape {
    background: none;
    border: 1px solid #BBDEFB;
    color: #1565C0;
    border-radius: 6px;
    padding: 3px 7px;
    font-size: 11px;
    cursor: pointer;
    line-height: 1;
  }
  .btn-move-etape:active { background: #E3F2FD; }
  /* Badge dur√©e totale */
  #duree-totale-badge {
    display:inline-flex;align-items:center;gap:6px;
    background:linear-gradient(90deg,#1565C0,#1976D2);
    color:#fff;border-radius:20px;padding:5px 14px;
    font-size:13px;font-weight:700;margin-bottom:12px;
    box-shadow:0 2px 8px rgba(21,101,192,0.25);
  }
  .btn-add-etape {
    width: 100%;
    padding: 12px;
    background: white;
    border: 2px dashed var(--blue-light);
    color: var(--blue);
    border-radius: 10px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 16px;
  }
  .btn-add-etape:hover { background: var(--blue-pale); }

  /* ‚îÄ‚îÄ‚îÄ PARAM√àTRES ‚îÄ‚îÄ‚îÄ */
  .param-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .param-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .param-item label {
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .param-item input[type="number"],
  .param-item input[type="color"],
  .param-item select {
    padding: 8px 10px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    background: var(--off-white);
  }
  .param-item input[type="color"] {
    height: 40px;
    padding: 4px;
    cursor: pointer;
  }
  .param-section-title {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    color: var(--blue-dark);
    padding: 8px 0 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
    margin-top: 6px;
  }

  /* ‚îÄ‚îÄ‚îÄ BOUTON G√âN√âRER ‚îÄ‚îÄ‚îÄ */
  .btn-generate {
    width: 100%;
    padding: 16px;
    background: var(--blue);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 16px rgba(21,101,192,0.35);
    transition: all 0.2s;
    margin-bottom: 20px;
  }
  .btn-generate:active { transform: scale(0.98); }
  .btn-generate:disabled { opacity: 0.6; cursor: not-allowed; }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 20px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--success);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 13px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
    z-index: 999;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ‚îÄ PREVIEW PANEL ‚îÄ‚îÄ‚îÄ */
  .preview-info {
    background: var(--blue-pale);
    border: 1px solid #BBDEFB;
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 16px;
    font-size: 13px;
    color: var(--blue-dark);
    line-height: 1.6;
  }
  .preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    border: 1.5px solid var(--blue);
  }
  .preview-table th {
    background: var(--blue);
    color: white;
    padding: 6px 4px;
    text-align: center;
    font-family: 'Source Serif 4', serif;
    font-weight: 600;
    border: 1px solid rgba(255,255,255,0.3);
  }
  .preview-table td {
    border: 1px solid var(--border);
    padding: 5px 4px;
    vertical-align: top;
    line-height: 1.4;
  }
  .preview-table tr.etape-sep td {
    border-top: 2px solid var(--blue);
  }
  .etape-label {
    font-weight: 700;
    color: var(--blue-dark);
    font-size: 10px;
  }

  /* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ‚îÄ‚îÄ‚îÄ EN-T√äTE FLEXIBLE ‚îÄ‚îÄ‚îÄ */
  .editable-field-wrap { position: relative; }
  .editable-label {
    display: flex; align-items: center; gap: 5px;
    cursor: default;
  }
  .editable-label .label-edit-hint {
    font-size: 10px; opacity: 0; transition: opacity 0.2s;
    cursor: pointer;
  }
  .editable-field-wrap:hover .label-edit-hint { opacity: 0.6; }
  .editable-label.editing-mode .label-edit-hint { display: none; }
  .label-edit-input {
    border: 1.5px solid var(--gold);
    border-radius: 5px;
    padding: 2px 7px;
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-family: 'Source Serif 4', serif;
    background: white;
    outline: none;
    min-width: 80px;
    box-shadow: 0 0 0 2px rgba(201,168,76,0.2);
  }
  .fgrp-title {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px dashed var(--border);
  }
  .fixed-row-group { margin-bottom: 18px; }
  .fixed-row-group:last-child { margin-bottom: 0; }

  /* Lignes libres */
  .ligne-libre-card {
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
    background: white;
  }
  .ligne-libre-header {
    background: var(--blue-pale);
    padding: 7px 12px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }
  .ligne-libre-header .ll-title {
    font-size: 12px; font-weight: 600; color: var(--blue-dark);
    font-family: 'Playfair Display', serif;
  }
  .ll-actions { display: flex; gap: 6px; align-items: center; }
  .btn-ll-move {
    background: none; border: 1px solid var(--border); color: var(--muted);
    border-radius: 5px; padding: 2px 7px; font-size: 12px; cursor: pointer;
    line-height: 1;
  }
  .btn-ll-move:hover { background: var(--blue-pale); color: var(--blue); }
  .btn-ll-del {
    background: none; border: 1px solid #FFCDD2; color: #C62828;
    border-radius: 5px; padding: 2px 8px; font-size: 11px; cursor: pointer;
  }
  .ligne-libre-body { padding: 12px; }
  .ll-double { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* Live preview de l'en-t√™te */
  .live-preview-table {
    width: 100%; border-collapse: collapse;
    font-size: 11px; border: 2px solid var(--blue);
    border-radius: 4px; overflow: hidden;
  }
  .live-preview-row { display: flex; }
  .lp-cell-label {
    background: var(--blue); color: white;
    padding: 5px 8px;
    font-weight: 700; font-size: 10px;
    white-space: nowrap; min-width: 70px;
    display: flex; align-items: center;
  }
  .lp-cell-value {
    background: white; color: var(--ink);
    padding: 5px 8px; flex: 1;
    font-size: 10px; border-bottom: 1px solid var(--border);
    border-left: 1.5px solid var(--blue);
    min-height: 24px; word-break: break-word;
  }
  .lp-cell-value.empty { color: var(--muted); font-style: italic; }
  .lp-row-outer { border-bottom: 1px solid var(--blue); display: flex; }
  .lp-row-outer:last-child { border-bottom: none; }
  .lp-half { flex: 1; display: flex; }
  .lp-half + .lp-half { border-left: 1.5px solid var(--blue); }
  .lp-title-row {
    background: var(--blue); color: white;
    padding: 6px 10px; font-weight: 700; font-size: 11px;
    display: flex; justify-content: space-between;
    border-bottom: 2px solid var(--gold);
  }
  .lp-objectif-label {
    background: var(--blue); color: white;
    padding: 6px 8px; font-weight: 700; font-size: 10px;
    min-width: 70px; display: flex; align-items: flex-start;
  }
  .lp-objectif-value {
    background: white; padding: 6px 8px; flex: 1;
    font-size: 10px; min-height: 36px; word-break: break-word;
    border-left: 1.5px solid var(--blue); color: var(--ink);
  }
  .lp-objectif-value.empty { color: var(--muted); font-style: italic; }

  /* ‚îÄ‚îÄ‚îÄ BANNI√àRE HORS LIGNE ‚îÄ‚îÄ‚îÄ */
  #offline-banner {
    display: none;
    background: #E65100;
    color: white;
    text-align: center;
    padding: 7px 16px;
    font-size: 12px;
    font-family: 'Source Serif 4', serif;
    letter-spacing: 0.03em;
    position: sticky;
    top: 72px;
    z-index: 99;
  }
  #offline-banner.show { display: block; }
  #offline-banner.online-restored { background: #2E7D32; }

  /* ‚îÄ‚îÄ‚îÄ TH√àMES ‚îÄ‚îÄ‚îÄ */
  .theme-swatch {
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2.5px solid transparent;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .theme-swatch:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.18); }
  .theme-swatch.active { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.3); }
  .theme-swatch-bar { height: 22px; display:flex; align-items:center; padding: 0 7px; gap:5px; }
  .theme-swatch-dot { width:7px; height:7px; border-radius:50%; background:rgba(255,255,255,0.6); flex-shrink:0; }
  .theme-swatch-body { background:white; padding:5px 7px; display:flex; flex-direction:column; gap:3px; }
  .theme-swatch-line { height:5px; border-radius:2px; }
  .theme-swatch-row { display:flex; gap:4px; }
  .theme-swatch-name { font-size:10px; font-weight:700; color:var(--ink); text-align:center; padding:4px 2px 2px; background:white; }

  /* ‚îÄ‚îÄ‚îÄ BOUTONS DE FORMATAGE (B et I) ‚îÄ‚îÄ‚îÄ */
  .format-btn {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    min-width: 32px;
    height: 28px;
    transition: all 0.2s;
  }
  .format-btn:hover {
    background: var(--blue-pale);
    border-color: var(--blue);
  }
  .format-btn:active {
    background: var(--blue);
    color: white;
  }
  
  /* ‚îÄ‚îÄ‚îÄ S√âLECTEURS DE COULEUR COMPACTS ‚îÄ‚îÄ‚îÄ */
  .color-picker-btn {
    width: 32px;
    height: 28px;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    cursor: pointer;
    padding: 2px;
    background: white;
  }
  .color-picker-btn:hover {
    border-color: var(--blue);
    box-shadow: 0 0 0 2px var(--blue-pale);
  }

  /* ‚îÄ‚îÄ‚îÄ CHAMPS √âDITABLES (contenteditable) ‚îÄ‚îÄ‚îÄ */
  .editable-input {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    line-height: 1.6;
    min-height: 42px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .editable-input:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
  }
  .editable-input:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
  }

  /* ‚îÄ‚îÄ‚îÄ STYLES QUILL.JS POUR TEXTE RICHE ‚îÄ‚îÄ‚îÄ */

  /* Polices dans l'√©diteur Quill */
  .ql-font-times      { font-family: 'Times New Roman', Times, serif; }
  .ql-font-georgia    { font-family: Georgia, 'Times New Roman', serif; }
  .ql-font-merriweather { font-family: 'Merriweather', Georgia, serif; }
  .ql-font-roboto     { font-family: 'Roboto', Arial, sans-serif; }
  .ql-font-lato       { font-family: 'Lato', Arial, sans-serif; }
  .ql-font-opensans   { font-family: 'Open Sans', Arial, sans-serif; }
  .ql-font-courier    { font-family: 'Courier New', Courier, monospace; }
  /* Affichage des options dans le select */
  .ql-picker.ql-font .ql-picker-label::before,
  .ql-picker.ql-font .ql-picker-item::before { content: 'Sans-s√©rif'; }
  .ql-picker.ql-font .ql-picker-label[data-value=times]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=times]::before { content: 'Times Roman'; font-family:'Times New Roman',serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=georgia]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=georgia]::before { content: 'Georgia'; font-family:Georgia,serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=merriweather]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=merriweather]::before { content: 'Merriweather'; font-family:'Merriweather',serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=roboto]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=roboto]::before { content: 'Roboto'; font-family:'Roboto',sans-serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=lato]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=lato]::before { content: 'Lato'; font-family:'Lato',sans-serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=opensans]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=opensans]::before { content: 'Open Sans'; font-family:'Open Sans',sans-serif; }
  .ql-picker.ql-font .ql-picker-label[data-value=courier]::before,
  .ql-picker.ql-font .ql-picker-item[data-value=courier]::before { content: 'Courier'; font-family:'Courier New',monospace; }
  .quill-wrapper {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--off-white);
    overflow: hidden;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .quill-wrapper:focus-within {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.1);
    background: white;
  }
  /* Toolbar custom (pre-rendue) */
  .quill-wrapper .ql-custom-toolbar-wrap {
    background: #f8f9fa;
    border-bottom: 1px solid var(--border);
    padding: 4px 6px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 2px;
  }
  /* Quill injecte .ql-toolbar sur notre div toolbar, conserver le style */
  .quill-wrapper .ql-toolbar {
    background: #f8f9fa;
    border: none;
    border-bottom: 1px solid var(--border);
    padding: 4px 6px;
  }
  .quill-wrapper .ql-container {
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    border: none;
  }
  .quill-wrapper .ql-editor {
    min-height: 80px;
    padding: 10px 12px;
    line-height: 1.6;
  }
  .quill-wrapper .ql-editor.ql-blank::before {
    color: #999;
    font-style: italic;
  }
  /* Ajustement pour les textarea larges avec Quill */
  .quill-wrapper.tall .ql-editor {
    min-height: 120px;
  }

  /* ‚îÄ‚îÄ‚îÄ TABLEAU DANS L'√âDITEUR QUILL ‚îÄ‚îÄ‚îÄ */
  .ql-editor table {
    border-collapse: collapse;
    width: 100%;
    margin: 8px 0;
    font-size: 13px;
  }
  .ql-editor table td, .ql-editor table th {
    border: 1.5px solid #1565C0;
    padding: 5px 8px;
    min-width: 40px;
    min-height: 22px;
    vertical-align: top;
    word-break: break-word;
  }
  .ql-editor table th {
    background: #E3F2FD;
    font-weight: 700;
    text-align: center;
  }
  .ql-editor img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    border: 1.5px solid var(--border);
    margin: 4px 0;
    display: block;
  }

  /* ‚îÄ‚îÄ‚îÄ BOUTONS PERSONNALIS√âS DANS LA TOOLBAR QUILL ‚îÄ‚îÄ‚îÄ */
  .ql-toolbar .ql-custom-table,
  .ql-toolbar .ql-custom-image,
  .ql-toolbar .ql-custom-symbol,
  .ql-toolbar .ql-custom-size {
    background: none;
    border: 1px solid var(--border) !important;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 5px;
    font-size: 16px;
    line-height: 1;
    color: #444;
    transition: background 0.15s, border-color 0.15s;
    min-width: 32px;
    min-height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 2px;
    vertical-align: middle;
  }
  .ql-toolbar .ql-custom-table:hover,
  .ql-toolbar .ql-custom-image:hover,
  .ql-toolbar .ql-custom-symbol:hover,
  .ql-toolbar .ql-custom-size:hover,
  .ql-toolbar .ql-custom-table:active,
  .ql-toolbar .ql-custom-image:active,
  .ql-toolbar .ql-custom-symbol:active,
  .ql-toolbar .ql-custom-size:active {
    background: #e8f0fe !important;
    border-color: var(--blue) !important;
    color: var(--blue);
  }
  .ql-toolbar .ql-custom-symbol.active {
    background: var(--blue-pale) !important;
    border-color: var(--blue) !important;
    color: var(--blue);
  }

  /* ‚îÄ‚îÄ‚îÄ PANNEAU S√âLECTEUR DE SYMBOLES ‚îÄ‚îÄ‚îÄ */
  .symbol-picker {
    display: none;
    position: fixed;
    z-index: 8500;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(21,101,192,0.20), 0 2px 8px rgba(0,0,0,0.10);
    width: 300px;
    max-width: 95vw;
    max-height: 380px;
    overflow: hidden;
    flex-direction: column;
    font-family: 'Source Serif 4', serif;
    border: 1.5px solid var(--border);
  }
  .symbol-picker.show { display: flex; }
  .symbol-picker-header {
    background: var(--blue);
    padding: 9px 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .symbol-picker-header span {
    color: white;
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    font-weight: 700;
  }
  .symbol-picker-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 18px;
    cursor: pointer;
    line-height: 1;
    padding: 0 2px;
  }
  .symbol-picker-close:hover { color: white; }
  .symbol-picker-tabs {
    display: flex;
    background: #f4f6fa;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
    flex-shrink: 0;
  }
  .symbol-picker-tabs::-webkit-scrollbar { display: none; }
  .sym-tab {
    flex-shrink: 0;
    padding: 7px 11px;
    font-size: 11px;
    font-weight: 600;
    color: var(--muted);
    background: none;
    border: none;
    border-bottom: 2.5px solid transparent;
    cursor: pointer;
    font-family: 'Source Serif 4', serif;
    white-space: nowrap;
    transition: color 0.15s;
  }
  .sym-tab.active {
    color: var(--blue);
    border-bottom-color: var(--blue);
    background: white;
  }
  .sym-tab:hover:not(.active) { color: var(--blue-light); }
  .symbol-picker-body {
    overflow-y: auto;
    padding: 10px;
    flex: 1;
  }
  .sym-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
  }
  .sym-btn {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    border-radius: 6px;
    border: 1px solid transparent;
    cursor: pointer;
    background: none;
    transition: background 0.1s, border-color 0.1s;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    min-height: 38px;
  }
  .sym-btn:hover, .sym-btn:active {
    background: var(--blue-pale);
    border-color: var(--blue);
  }
  .sym-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 8px 0 5px;
    padding-bottom: 3px;
    border-bottom: 1px solid var(--border);
  }
  .sym-label:first-child { margin-top: 0; }

  /* ‚îÄ‚îÄ‚îÄ MODAL INSERTION TABLEAU ‚îÄ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 9000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal-box {
    background: white;
    border-radius: 14px;
    box-shadow: 0 8px 40px rgba(21,101,192,0.22);
    padding: 24px 22px 18px;
    width: 300px;
    max-width: 95vw;
    font-family: 'Source Serif 4', serif;
  }
  .modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--blue-dark);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .modal-field {
    margin-bottom: 12px;
  }
  .modal-field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--blue-dark);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 5px;
  }
  .modal-field input[type="number"] {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    background: var(--off-white);
  }
  .modal-field input[type="number"]:focus {
    outline: none;
    border-color: var(--blue);
    background: white;
  }
  .modal-check {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--ink);
    margin-bottom: 14px;
    cursor: pointer;
  }
  .modal-check input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--blue); }
  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }
  .btn-modal-ok {
    flex: 1;
    padding: 10px;
    background: var(--blue);
    color: white;
    border: none;
    border-radius: 8px;
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-modal-ok:hover { background: var(--blue-dark); }
  .btn-modal-cancel {
    flex: 1;
    padding: 10px;
    background: var(--off-white);
    color: var(--muted);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    cursor: pointer;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AM√âLIORATIONS VISUELLES - CODES COULEURS TH√âMATIQUES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  
  /* Couleurs pour sections PDF */
  :root {
    --color-mise-situation: #E8F5E9;  /* Vert clair */
    --color-identification: #E3F2FD;  /* Bleu clair */
    --color-axes: #FFF3E0;            /* Orange clair */
    --color-synthese: #F3E5F5;        /* Violet clair */
  }

  /* Ic√¥nes p√©dagogiques */
  .icone-lecture::before { content: 'üìñ '; }
  .icone-reflexion::before { content: 'üí≠ '; }
  .icone-ecriture::before { content: '‚úçÔ∏è '; }
  .icone-groupe::before { content: 'üë• '; }
  .icone-duree::before { content: '‚è±Ô∏è '; }

  /* Alternance de couleurs pour lignes de tableau */
  .tableau-alterne tr:nth-child(even) {
    background-color: rgba(21, 101, 192, 0.03);
  }
  .tableau-alterne tr:nth-child(odd) {
    background-color: white;
  }

  /* Bordures arrondies et ombres */
  .carte-section {
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 16px;
    overflow: hidden;
  }

  /* Typographie am√©lior√©e */
  .titre-section-principal {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--blue);
  }
  .titre-section-secondaire {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--ink);
  }
  .mot-cle {
    font-weight: 700;
    color: var(--blue);
  }

  /* En-t√™te visuel personnalisable */
  .entete-personnalise {
    background: linear-gradient(135deg, var(--blue) 0%, var(--blue-dark) 100%);
    padding: 20px;
    border-radius: 12px 12px 0 0;
    color: white;
    text-align: center;
    margin-bottom: 20px;
  }
  .logo-etablissement {
    max-width: 80px;
    max-height: 80px;
    margin-bottom: 10px;
    border-radius: 8px;
  }

  /* Boutons export multiples */
  .btn-export-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  .btn-export {
    flex: 1;
    min-width: 150px;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-export-pdf {
    background: #D32F2F;
    color: white;
    box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
  }
  .btn-export-pdf:hover {
    background: #B71C1C;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
  }
  .btn-export-docx {
    background: #1976D2;
    color: white;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
  }
  .btn-export-docx:hover {
    background: #1565C0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
  }
  .btn-export-save {
    background: #2E7D32;
    color: white;
    box-shadow: 0 2px 8px rgba(46,125,50,0.3);
  }
  .btn-export-save:hover {
    background: #1B5E20;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(46,125,50,0.4);
  }
  /* R√©pertoire des fiches */
  .repertoire-card {
    background: #fff;
    border: 1.5px solid #E3EAF6;
    border-radius: 12px;
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .repertoire-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: #F5F8FF;
    border-bottom: 1px solid #E3EAF6;
  }
  .repertoire-card-title {
    font-weight: 700;
    color: #1565C0;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 55%;
  }
  .repertoire-card-date {
    font-size: 11px;
    color: #999;
  }
  .repertoire-card-body {
    padding: 8px 14px 10px;
    font-size: 12px;
    color: #555;
    line-height: 1.5;
  }
  .repertoire-card-actions {
    display: flex;
    gap: 6px;
    padding: 0 14px 10px;
    flex-wrap: wrap;
  }
  .btn-rep {
    border: none;
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-rep-ouvrir  { background: #1565C0; color: #fff; }
  .btn-rep-suppr   { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
  .repertoire-empty {
    text-align: center;
    padding: 40px 20px;
    color: #aaa;
    font-size: 14px;
  }


  /* Pr√©visualisation temps r√©el */
  .preview-live {
    background: white;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }
  .preview-live-header {
    background: linear-gradient(135deg, var(--blue) 0%, var(--blue-dark) 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
  }
  .preview-section {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--blue);
  }
  .preview-section.mise-situation {
    background: var(--color-mise-situation);
    border-left-color: #4CAF50;
  }
  .preview-section.identification {
    background: var(--color-identification);
    border-left-color: #2196F3;
  }
  .preview-section.axes {
    background: var(--color-axes);
    border-left-color: #FF9800;
  }
  .preview-section.synthese {
    background: var(--color-synthese);
    border-left-color: #9C27B0;
  }


  /* ‚îÄ‚îÄ‚îÄ MOD√àLES DE FICHES ‚îÄ‚îÄ‚îÄ */
  .modele-tag {
    display: inline-block; font-size: 10px; font-weight: 600;
    padding: 2px 8px; border-radius: 10px; margin-right: 4px; margin-bottom: 3px;
  }
  .modele-tag-matiere { background: #E3F2FD; color: #1565C0; }
  .modele-tag-niveau  { background: #E8F5E9; color: #2E7D32; }
  .modele-tag-duree   { background: #FFF3E0; color: #E65100; }
  .modele-card {
    background: white; border: 1.5px solid #E3EAF6; border-radius: 14px;
    margin-bottom: 14px; overflow: hidden;
    box-shadow: 0 2px 10px rgba(21,101,192,0.08);
    transition: box-shadow 0.2s, transform 0.2s;
  }
  .modele-card:hover { box-shadow: 0 6px 22px rgba(21,101,192,0.18); transform: translateY(-2px); }
  .modele-card-header {
    background: linear-gradient(90deg, #1565C0, #1976D2);
    padding: 12px 16px; display: flex; align-items: center; gap: 10px;
  }
  .modele-card-icon {
    font-size: 24px; width: 44px; height: 44px;
    background: rgba(255,255,255,0.15); border-radius: 10px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .modele-card-title { font-family: 'Playfair Display',serif; color: white; font-size: 14px; font-weight: 700; line-height: 1.3; flex: 1; }
  .modele-card-subtitle { color: rgba(255,255,255,0.8); font-size: 11px; margin-top: 2px; }
  .modele-card-body { padding: 12px 14px 8px; }
  .modele-desc { font-size: 12px; color: #555; line-height: 1.55; margin-bottom: 10px; }
  .modele-etapes-preview { background: #F5F8FF; border-radius: 8px; padding: 8px 10px; margin-bottom: 10px; border: 1px solid #E3EAF6; }
  .modele-etape-row { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 11px; color: #444; border-bottom: 1px dashed #E3EAF6; }
  .modele-etape-row:last-child { border-bottom: none; }
  .modele-etape-num { background: #1565C0; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; }
  .modele-etape-name { font-weight: 600; color: #1565C0; min-width: 80px; flex-shrink: 0; }
  .modele-etape-desc { flex: 1; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .modele-etape-duree { color: #E65100; font-weight: 600; flex-shrink: 0; }
  .modele-card-actions { display: flex; gap: 8px; padding: 0 14px 12px; }
  .btn-modele-charger {
    flex: 1; background: #1565C0; color: white; border: none; border-radius: 8px;
    padding: 9px 16px; font-family: 'Source Serif 4',serif; font-size: 12px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s;
  }
  .btn-modele-charger:hover { background: #0D47A1; }
  .btn-modele-sauver {
    background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9;
    border-radius: 8px; padding: 9px 14px; font-family: 'Source Serif 4',serif;
    font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: background 0.2s;
  }
  .btn-modele-sauver:hover { background: #C8E6C9; }
  .modeles-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
  .modele-filter-btn {
    padding: 5px 14px; border-radius: 20px; border: 1.5px solid var(--border);
    background: white; font-size: 12px; font-family: 'Source Serif 4',serif;
    cursor: pointer; transition: all 0.18s; color: var(--muted);
  }
  .modele-filter-btn.active, .modele-filter-btn:hover { background: #1565C0; color: white; border-color: #1565C0; }

  /* Ajustement marges */
  .marge-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }
  .marge-control {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .marge-control label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
  }
  .marge-control input {
    padding: 8px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-size: 13px;
  }

  /* ‚îÄ‚îÄ Footer permanent avec version ‚îÄ‚îÄ */
  .app-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    border-top: 1px solid rgba(21, 101, 192, 0.15);
    padding: 4px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 10px;
    color: #888;
    z-index: 999;
    backdrop-filter: blur(10px);
  }
  .app-footer a {
    color: #1565C0;
    text-decoration: none;
    font-weight: 600;
  }
  .app-footer a:hover {
    text-decoration: underline;
  }
  .version-badge {
    background: rgba(21, 101, 192, 0.1);
    color: #1565C0;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.03em;
  }



  /* ‚îÄ‚îÄ‚îÄ REDIMENSIONNEMENT D'IMAGE ‚îÄ‚îÄ‚îÄ */
  .ql-editor img { cursor: pointer; transition: outline 0.15s; }
  .ql-editor img.img-selected { outline: 2px solid var(--blue); outline-offset: 2px; }
  #img-resize-panel {
    display: none; position: fixed; z-index: 9999;
    background: white; border: 1.5px solid var(--blue);
    border-radius: 10px; box-shadow: 0 6px 24px rgba(21,101,192,0.20);
    padding: 12px 16px; min-width: 250px;
    font-family: 'Source Serif 4', serif; font-size: 12px;
  }
  #img-resize-panel.show { display: block; }
  #img-resize-panel .rp-head {
    font-weight: 700; color: var(--blue-dark); font-size: 11px;
    text-transform: uppercase; letter-spacing: 0.05em;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
  }
  #img-resize-panel .rp-dims { font-weight: 400; color: var(--muted); font-size: 10px; }
  #img-resize-panel .rp-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  #img-resize-panel .rp-lbl { color: var(--muted); font-size: 11px; min-width: 56px; }
  #img-resize-panel input[type="range"] { flex: 1; accent-color: var(--blue); height: 4px; }
  #img-resize-panel input[type="number"] {
    width: 60px; padding: 3px 6px; border: 1.5px solid var(--border);
    border-radius: 5px; font-size: 12px; font-family: inherit; text-align: center;
    color: var(--ink);
  }
  #img-resize-panel .rp-unit { font-size: 10px; color: var(--muted); }
  #img-resize-panel .rp-presets { display: flex; gap: 5px; margin: 4px 0 10px; }
  #img-resize-panel .rp-pre {
    flex: 1; padding: 4px 0; background: var(--blue-pale); border: 1px solid var(--border);
    border-radius: 5px; font-size: 11px; cursor: pointer; text-align: center;
    color: var(--blue-dark); transition: all 0.15s; font-family: inherit;
  }
  #img-resize-panel .rp-pre:hover, #img-resize-panel .rp-pre.active {
    background: var(--blue); color: white; border-color: var(--blue);
  }
  #img-resize-panel .rp-info { font-size: 10px; color: var(--muted); margin-bottom: 10px; }
  #img-resize-panel .rp-btns { display: flex; gap: 8px; }
  #img-resize-panel .rp-btn {
    flex: 1; padding: 6px 0; border: none; border-radius: 6px;
    font-size: 12px; cursor: pointer; font-family: inherit; font-weight: 600;
    transition: opacity 0.15s;
  }
  #img-resize-panel .rp-ok { background: var(--blue); color: white; }
  #img-resize-panel .rp-cancel { background: var(--off-white); color: var(--muted); border: 1px solid var(--border); font-weight: 400; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     NOUVELLES FONCTIONNALIT√âS v3.0
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  /* ‚îÄ‚îÄ‚îÄ LAYOUT TABLETTE (‚â•768px) ‚îÄ‚îÄ‚îÄ */
  @media (min-width: 768px) {
    body { display: flex; flex-direction: column; }
    
    .app-header h1 { font-size: 20px; }
    .app-header h1 span { font-size: 13px; }
    
    /* Navigation lat√©rale au lieu des onglets horizontaux */
    .tabs {
      position: fixed;
      left: 0; top: 72px; bottom: 28px;
      width: 130px;
      flex-direction: column;
      border-right: 2px solid var(--border);
      border-bottom: none;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 50;
      box-shadow: 2px 0 12px rgba(0,0,0,0.08);
    }
    .tab-btn {
      min-width: unset;
      width: 100%;
      padding: 14px 8px;
      border-bottom: none;
      border-right: 3px solid transparent;
      border-left: none;
      margin-bottom: 0;
      margin-right: -2px;
      flex-direction: column;
      font-size: 11px;
      border-top: 1px solid var(--border);
    }
    .tab-btn.active {
      border-right-color: var(--blue);
      border-bottom: none;
      background: var(--blue-pale);
    }
    .tab-btn .tab-icon { font-size: 22px; }
    
    /* Contenu principal d√©cal√© √† droite de la nav */
    .panel {
      margin-left: 130px;
      padding: 20px 24px;
    }
    #offline-banner {
      margin-left: 130px;
      top: 72px;
    }
    #save-bar { margin-left: 130px; }
    
    /* Layout 2 colonnes pour En-t√™te + Aper√ßu live c√¥te √† c√¥te */
    #panel-entete.active {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      align-items: start;
    }
    #card-entete-preview {
      position: sticky;
      top: 90px;
      grid-row: 1 / 20;
      grid-column: 2;
    }
    
    /* Aper√ßu PDF en 2 colonnes */
    #panel-apercu.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: start;
    }
    
    .app-footer { padding-left: 142px; }
    
    /* Boutons plus grands sur tablette */
    .btn-generate { font-size: 16px; padding: 14px; }
  }

  @media (min-width: 1024px) {
    .tabs { width: 160px; }
    .panel { margin-left: 160px; padding: 24px 32px; }
    #offline-banner, #save-bar { margin-left: 160px; }
    #card-entete-preview { position: sticky; top: 90px; }
    .app-footer { padding-left: 172px; }
    #panel-apercu.active { grid-template-columns: 1fr 1fr; }
  }

  /* ‚îÄ‚îÄ‚îÄ MODAL G√âN√âRIQUE v3 ‚îÄ‚îÄ‚îÄ */
  .modal-v3-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    padding: 16px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-v3-overlay.show { opacity: 1; pointer-events: all; }
  .modal-v3-box {
    background: white;
    border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    padding: 24px;
    max-width: 520px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    transform: translateY(20px);
    transition: transform 0.25s;
  }
  .modal-v3-overlay.show .modal-v3-box { transform: translateY(0); }
  .modal-v3-title {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--blue-dark);
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 10px;
  }
  .modal-v3-actions {
    display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;
  }
  .btn-v3 {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    font-family: 'Source Serif 4', serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn-v3-primary { background: var(--blue); color: white; }
  .btn-v3-primary:hover { background: var(--blue-dark); }
  .btn-v3-success { background: #2E7D32; color: white; }
  .btn-v3-success:hover { background: #1B5E20; }
  .btn-v3-warn { background: #E65100; color: white; }
  .btn-v3-warn:hover { background: #BF360C; }
  .btn-v3-ghost { background: var(--off-white); color: var(--muted); border: 1px solid var(--border); }
  .btn-v3-ghost:hover { background: var(--border); }

  /* ‚îÄ‚îÄ‚îÄ EXPORT/IMPORT SECTION ‚îÄ‚îÄ‚îÄ */
  .export-section {
    background: white;
    border-radius: 14px;
    border: 1.5px solid #E3EAF6;
    margin-bottom: 16px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(21,101,192,0.08);
  }
  .export-section-header {
    background: linear-gradient(90deg, #1565C0, #1976D2);
    padding: 12px 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .export-section-header span { color: white; font-weight: 700; font-size: 14px; }
  .export-section-body { padding: 16px; }
  .export-btn-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 12px;
  }
  @media (max-width: 400px) { .export-btn-grid { grid-template-columns: 1fr; } }

  /* ‚îÄ‚îÄ‚îÄ QR CODE ‚îÄ‚îÄ‚îÄ */
  .qr-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #F5F8FF;
    border-radius: 12px;
    border: 1px solid #E3EAF6;
  }
  #qr-canvas {
    border: 4px solid white;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  }
  .qr-info {
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    line-height: 1.5;
  }
  .qr-url-box {
    width: 100%;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 11px;
    color: var(--muted);
    word-break: break-all;
    max-height: 80px;
    overflow-y: auto;
    font-family: monospace;
  }

  /* ‚îÄ‚îÄ‚îÄ APER√áU PDF SIMUL√â ‚îÄ‚îÄ‚îÄ */
  .pdf-preview-container {
    background: #888;
    border-radius: 12px;
    padding: 16px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  .pdf-page-sim {
    background: white;
    width: 100%;
    max-width: 595px;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    padding: 28px 24px;
    font-family: 'Times New Roman', Times, serif;
    font-size: 11px;
    line-height: 1.4;
    min-height: 300px;
  }
  .pdf-sim-header {
    border: 2px solid var(--sim-color, #1565C0);
    margin-bottom: 8px;
    border-radius: 2px;
  }
  .pdf-sim-header-row {
    display: flex;
    border-bottom: 1px solid var(--sim-color, #1565C0);
  }
  .pdf-sim-header-row:last-child { border-bottom: none; }
  .pdf-sim-label {
    background: var(--sim-color, #1565C0);
    color: white;
    padding: 4px 8px;
    font-size: 9px;
    font-weight: 700;
    min-width: 80px;
    display: flex;
    align-items: center;
    white-space: nowrap;
  }
  .pdf-sim-value {
    padding: 4px 8px;
    font-size: 9px;
    flex: 1;
    border-left: 1px solid var(--sim-color, #1565C0);
    word-break: break-word;
  }
  .pdf-sim-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--sim-color, #1565C0);
    font-size: 9px;
    margin-top: 8px;
  }
  .pdf-sim-table th {
    background: var(--sim-color, #1565C0);
    color: white;
    padding: 5px 4px;
    text-align: center;
    font-size: 8px;
    border: 1px solid rgba(255,255,255,0.3);
  }
  .pdf-sim-table td {
    border: 1px solid #ddd;
    padding: 4px 5px;
    vertical-align: top;
    font-size: 8px;
    line-height: 1.3;
  }
  .pdf-sim-etape {
    font-weight: 700;
    color: var(--sim-color, #1565C0);
    text-align: center;
  }
  .pdf-sim-toolbar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 8px;
  }
  .pdf-sim-info {
    font-size: 11px;
    color: #ddd;
    text-align: center;
    margin-top: 4px;
  }
  .pdf-preview-update-btn {
    background: var(--blue);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 12px;
    font-family: 'Source Serif 4', serif;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
  }
  .pdf-preview-update-btn:hover { background: var(--blue-dark); }

  /* ‚îÄ‚îÄ‚îÄ BARRE D'OUTILS TABLETTE ‚îÄ‚îÄ‚îÄ */
  .tablet-toolbar {
    display: none;
  }
  @media (min-width: 768px) {
    .tablet-toolbar {
      display: flex;
      gap: 8px;
      padding: 8px 16px 8px 146px;
      background: white;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      align-items: center;
      position: sticky;
      top: 72px;
      z-index: 49;
    }
    .tablet-toolbar-label {
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .offline-banner-tablet { top: 108px !important; }
    #offline-banner { top: 108px; }
    #save-bar { top: 108px; position: sticky; z-index: 48; }
    .panel { padding-top: 16px; }
  }

  /* ‚îÄ‚îÄ‚îÄ BACKUP WARNING CARD ‚îÄ‚îÄ‚îÄ */
  .backup-warn {
    background: #FFF3E0;
    border: 1px solid #FFB74D;
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 12px;
    color: #E65100;
    line-height: 1.6;
    margin-bottom: 12px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  .backup-warn-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }

  /* ‚îÄ‚îÄ‚îÄ PARTAGE ‚îÄ‚îÄ‚îÄ */
  .share-method-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
  }
  .share-method-tab {
    flex: 1;
    padding: 8px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--off-white);
    font-family: 'Source Serif 4', serif;
    font-size: 12px;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    color: var(--muted);
  }
  .share-method-tab.active {
    background: var(--blue);
    color: white;
    border-color: var(--blue);
  }
  .share-panel { display: none; }
  .share-panel.active { display: block; }

</style>
</head>
<body>

<div class="app-header">
  <div class="logo">üìã</div>
  <h1>Fiche P√©dagogique
    <span>EZ-ZAKY AZIZ ‚Äî v3.0 ¬∑ PDF ¬∑ Tablette ¬∑ Partage</span>
  </h1>
  <button onclick="nouvelleFiche()" title="Effacer et recommencer une nouvelle fiche" style="background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.5);color:#fff;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap;">
    üîÑ Nouvelle fiche
  </button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TABS DE NAVIGATION                                 -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tabs">
  <button class="tab-btn active" onclick="showTab('entete')" id="tab-entete">
    <span class="tab-icon">üìù</span>En-t√™te
  </button>
  <button class="tab-btn" onclick="showTab('etapes')" id="tab-etapes">
    <span class="tab-icon">üìö</span>√âtapes
  </button>
  <button class="tab-btn" onclick="showTab('params')" id="tab-params">
    <span class="tab-icon">‚öôÔ∏è</span>Param√®tres
  </button>
  <button class="tab-btn" onclick="showTab('apercu')" id="tab-apercu">
    <span class="tab-icon">üëÅÔ∏è</span>Aper√ßu
  </button>
  <button class="tab-btn" onclick="showTab('repertoire')" id="tab-repertoire">
    <span class="tab-icon">üìÅ</span>R√©pertoire
  </button>
  <button class="tab-btn" onclick="showTab('modeles')" id="tab-modeles">
    <span class="tab-icon">üóÇÔ∏è</span>Mod√®les
  </button>
  <button class="tab-btn" onclick="showTab('guide')" id="tab-guide">
    <span class="tab-icon">üìñ</span>Guide
  </button>
  <button class="tab-btn" onclick="showTab('apropos')" id="tab-apropos">
    <span class="tab-icon">‚ÑπÔ∏è</span>√Ä propos
  </button>
  <button class="tab-btn" onclick="showTab('partage')" id="tab-partage">
    <span class="tab-icon">üîó</span>Partage
  </button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- BARRE D'OUTILS RAPIDE (tablette uniquement)        -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tablet-toolbar" id="tablet-toolbar">
  <span class="tablet-toolbar-label">Actions rapides :</span>
  <button class="btn-v3 btn-v3-primary" onclick="genererPDF()" style="padding:7px 14px;font-size:12px;">
    üìÑ G√©n√©rer PDF
  </button>
  <button class="btn-v3 btn-v3-success" onclick="enregistrerDansRepertoire()" style="padding:7px 14px;font-size:12px;">
    üíæ Sauvegarder
  </button>
  <button class="btn-v3" onclick="showTab('apercu');genererPreviewSimulee();" style="padding:7px 14px;font-size:12px;background:#E8F5E9;color:#2E7D32;border:1px solid #C8E6C9;">
    üëÅÔ∏è Aper√ßu PDF
  </button>
  <button class="btn-v3 btn-v3-ghost" onclick="exporterToutesLesFinches()" style="padding:7px 14px;font-size:12px;">
    üì¶ Exporter backup
  </button>
  <button class="btn-v3 btn-v3-ghost" onclick="showTab('partage');switchShareMethod('code',document.querySelector('.share-method-tab:nth-child(2)'));" style="padding:7px 14px;font-size:12px;">
    üîë Partager (code)
  </button>
</div>

<div id="offline-banner">üìµ Mode hors ligne ‚Äî La g√©n√©ration PDF reste disponible</div>
<div id="save-bar" style="display:none;background:#E8F5E9;border-bottom:1px solid #A5D6A7;padding:5px 14px;font-size:11px;color:#2E7D32;text-align:center;">
  <span id="save-status">‚úÖ Fiche sauvegard√©e automatiquement</span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL 1 : EN-T√äTE FLEXIBLE -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel-entete">

  <!-- Aper√ßu live de l'en-t√™te -->
  <div class="card" id="card-entete-preview">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>APER√áU DE L'EN-T√äTE</h2>
        <span class="badge">Live</span>
      </div>
      <span style="font-size:10px;color:rgba(255,255,255,0.7);font-style:italic;">cliquez sur un champ pour √©diter</span>
    </div>
    <div class="card-body" style="padding:10px;">
      <div id="entete-live-preview"></div>
    </div>
  </div>

  <!-- Champs fixes (labels editables) -->
  <div class="card">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>CHAMPS FIXES</h2>
        <span class="badge">Labels modifiables</span>
      </div>
      <span style="font-size:10px;color:rgba(255,255,255,0.7);font-style:italic;">‚úèÔ∏è double-cliquez le label</span>
    </div>
    <div class="card-body" id="fixed-fields-container">

      <!-- Ligne 1 : Prof + Niveau (c√¥te √† c√¥te) -->
      <div class="fixed-row-group" id="fgrp-ligne1">
        <div class="fgrp-title">Ligne 1 ‚Äî Identification</div>
        <div class="field-row">
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Professeur</span>
              <span class="label-edit-hint">‚úèÔ∏è</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('prof', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('prof', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('prof', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('prof', this.value)" title="Couleur de surlignage" value="#FFFFFF">
              <button type="button" class="format-btn" onclick="removeColorFromContentEditable('prof')" title="Supprimer les couleurs" style="font-size:11px;">üö´</button>
            </div>
            <div id="prof" contenteditable="true" class="editable-input" oninput="updateLivePreview()">EZ-ZAKY AZIZ</div>
          </div>
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Niveau</span>
              <span class="label-edit-hint">‚úèÔ∏è</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('niveau', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('niveau', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('niveau', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('niveau', this.value)" title="Couleur de surlignage" value="#FFFFFF">
            </div><div id="niveau" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Ex : 1BAC, 2BAC, TC‚Ä¶"></div>
          </div>
        </div>
      </div>

      <!-- Ligne 2 : Module -->
      <div class="fixed-row-group" id="fgrp-module">
        <div class="fgrp-title">Ligne 2</div>
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
            <span class="label-text">Module</span>
            <span class="label-edit-hint">‚úèÔ∏è</span>
          </label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
            <button type="button" class="format-btn" onclick="toggleFormat('module', 'bold')" title="Gras"><b>B</b></button>
            <button type="button" class="format-btn" onclick="toggleFormat('module', 'italic')" title="Italique"><i>I</i></button>
            <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('module', this.value)" title="Couleur du texte" value="#000000">
            <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('module', this.value)" title="Couleur de surlignage" value="#FFFFFF">
          </div><div id="module" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Intitul√© exact du module"></div>
        </div>
      </div>

      <!-- Ligne 3 : S√©quence -->
      <div class="fixed-row-group" id="fgrp-sequence">
        <div class="fgrp-title">Ligne 3</div>
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
            <span class="label-text">S√©quence</span>
            <span class="label-edit-hint">‚úèÔ∏è</span>
          </label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
            <button type="button" class="format-btn" onclick="toggleFormat('sequence', 'bold')" title="Gras"><b>B</b></button>
            <button type="button" class="format-btn" onclick="toggleFormat('sequence', 'italic')" title="Italique"><i>I</i></button>
            <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('sequence', this.value)" title="Couleur du texte" value="#000000">
            <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('sequence', this.value)" title="Couleur de surlignage" value="#FFFFFF">
          </div><div id="sequence" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Intitul√© exact de la s√©quence"></div>
        </div>
      </div>

      <!-- Ligne 4 : Activit√© + Support -->
      <div class="fixed-row-group" id="fgrp-ligne4">
        <div class="fgrp-title">Ligne 4</div>
        <div class="field-row">
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Activit√©</span>
              <span class="label-edit-hint">‚úèÔ∏è</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('activite', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('activite', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('activite', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('activite', this.value)" title="Couleur de surlignage" value="#FFFFFF">
            </div><div id="activite" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Intitul√© de l'activit√©"></div>
          </div>
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
              <span class="label-text">Support</span>
              <span class="label-edit-hint">‚úèÔ∏è</span>
            </label>
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
              <button type="button" class="format-btn" onclick="toggleFormat('support', 'bold')" title="Gras"><b>B</b></button>
              <button type="button" class="format-btn" onclick="toggleFormat('support', 'italic')" title="Italique"><i>I</i></button>
              <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('support', this.value)" title="Couleur du texte" value="#000000">
              <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('support', this.value)" title="Couleur de surlignage" value="#FFFFFF">
            </div><div id="support" contenteditable="true" class="editable-input" oninput="updateLivePreview()" data-placeholder="Titre / r√©f√©rence support"></div>
          </div>
        </div>
      </div>

      <!-- Ligne 5 : Objectif -->
      <div class="fixed-row-group" id="fgrp-objectif">
        <div class="fgrp-title">Ligne 5 ‚Äî Objectif</div>
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier">
            <span class="label-text">Objectif(s)</span>
            <span class="label-edit-hint">‚úèÔ∏è</span>
          </label>
          <div id="objectif-wrapper" class="quill-wrapper tall"></div>
          <div class="field-hint">Zone √©tendue dans le PDF. Utilisez la barre d'outils pour mettre en forme.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Lignes suppl√©mentaires libres -->
  <div class="card">
    <div class="card-header" style="justify-content:space-between; flex-wrap:wrap; gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>LIGNES SUPPL√âMENTAIRES</h2>
        <span class="badge">Optionnel</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="ajouterLigneLibre('simple')" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">+ Champ simple</button>
        <button onclick="ajouterLigneLibre('double')" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">+ 2 champs c√¥te √† c√¥te</button>
      </div>
    </div>
    <div class="card-body" id="lignes-libres-container">
      <p id="no-lignes-libres-msg" style="color:var(--muted);font-size:12px;text-align:center;padding:12px 0;">
        Aucune ligne suppl√©mentaire. Utilisez les boutons ci-dessus pour en ajouter.
      </p>
    </div>
  </div>

  <button class="btn-generate" onclick="showTab('etapes')">
    Suivant : Saisir les √©tapes ‚Üí
  </button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL 2 : √âTAPES -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-etapes">

  <div class="card" style="margin-bottom:16px;">
    <div class="card-header"><h2>TABLEAU P√âDAGOGIQUE ‚Äî √âTAPES DE LA S√âANCE</h2></div>
    <div class="card-body" style="padding:10px 14px; font-size:12px; color:var(--muted); line-height:1.6;">
      Chaque √©tape correspond √† un bloc de lignes dans le tableau PDF.<br>
      Collez votre contenu tel quel dans chaque champ.
    </div>
  </div>

  <div id="etapes-container"></div>

  <!-- Badge dur√©e totale -->
  <div style="text-align:center;margin:10px 0 4px;">
    <span id="duree-totale-badge">‚è±Ô∏è Dur√©e totale : <span id="duree-totale-val">‚Äî</span></span>
  </div>

  <button class="btn-add-etape" onclick="ajouterEtape()">
    + Ajouter une √©tape
  </button>

  <!-- Boutons export multiples -->
  <div class="btn-export-group">
    <button class="btn-export btn-export-save" onclick="enregistrerDansRepertoire()">
      üíæ Enregistrer la fiche
    </button>
    <button class="btn-export btn-export-pdf" onclick="genererPDF()">
      üìÑ Exporter en PDF
    </button>
    <button class="btn-export btn-export-docx" onclick="genererDOCX()">
      üìò Exporter en Word (.docx)
    </button>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-params">

  <!-- Bouton r√©initialisation -->
  <div style="text-align:right;margin-bottom:10px;">
    <button onclick="reinitialiserParams()" style="background:#fff;border:1.5px solid #1565C0;color:#1565C0;border-radius:8px;padding:7px 16px;font-size:12px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:6px;">
      üîÑ Param√®tres par d√©faut
    </button>
  </div>

  <div class="card">
    <div class="card-header"><h2>MISE EN PAGE ‚Äî MARGES</h2></div>
    <div class="card-body">
      <div class="param-grid">
        <div class="param-item">
          <label>Marge (pts)</label>
          <input type="number" id="p-marge" value="8.5" min="0" max="50" step="0.5">
        </div>
        <div class="param-item">
          <label>Esp. en-t√™te/tableau (pts)</label>
          <input type="number" id="p-gap" value="5" min="0" max="30" step="1">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>TYPOGRAPHIE</h2></div>
    <div class="card-body">
      <div class="param-section-title">En-t√™te de la fiche</div>
      <div class="param-grid">
        <div class="param-item">
          <label>Taille √©tiquettes (pt)</label>
          <input type="number" id="p-font-entete-label" value="11" min="6" max="18" step="0.5">
        </div>
        <div class="param-item">
          <label>Taille contenu (pt)</label>
          <input type="number" id="p-font-entete-content" value="10" min="6" max="16" step="0.5">
        </div>
      </div>
      <div class="param-section-title">Tableau p√©dagogique</div>
      <div class="param-grid">
        <div class="param-item">
          <label>En-t√™tes colonnes (pt)</label>
          <input type="number" id="p-font-table-header" value="10" min="6" max="16" step="0.5">
        </div>
        <div class="param-item">
          <label>Contenu cellules (pt)</label>
          <input type="number" id="p-font-table-content" value="9" min="6" max="14" step="0.5">
        </div>
        <div class="param-item">
          <label>Hauteur ligne donn√©es (pt)</label>
          <input type="number" id="p-row-height" value="8" min="6" max="20" step="0.5">
        </div>
        <div class="param-item">
          <label>Hauteur en-t√™te tableau (pt)</label>
          <input type="number" id="p-table-header-h" value="18" min="12" max="30" step="1">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>EN-T√äTE ‚Äî DIMENSIONS</h2></div>
    <div class="card-body">
      <div class="param-grid">
        <div class="param-item">
          <label>Hauteur totale en-t√™te (pt)</label>
          <input type="number" id="p-header-h" value="100" min="60" max="160" step="2">
        </div>
        <div class="param-item">
          <label>Hauteur ligne 1 (pt)</label>
          <input type="number" id="p-l1h" value="22" min="14" max="40" step="1">
        </div>
        <div class="param-item">
          <label>Hauteur lignes 2/3/4 (pt)</label>
          <input type="number" id="p-l234h" value="18" min="12" max="30" step="1">
        </div>
        <div class="param-item">
          <label>Hauteur ligne 5 / Objectif (pt)</label>
          <input type="number" id="p-l5h" value="40" min="24" max="80" step="2">
        </div>
        <div class="param-item">
          <label>S√©parateur 1 (% largeur)</label>
          <input type="number" id="p-sep1" value="32" min="10" max="60" step="1">
        </div>
        <div class="param-item">
          <label>S√©parateur 2 (% largeur)</label>
          <input type="number" id="p-sep2" value="60" min="30" max="80" step="1">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>PROPORTIONS DES COLONNES DU TABLEAU</h2></div>
    <div class="card-body">
      <div class="param-grid">
        <div class="param-item">
          <label>√âtapes (%)</label>
          <input type="number" id="p-col1" value="20" min="10" max="30" step="1">
        </div>
        <div class="param-item">
          <label>D√©roulement (%)</label>
          <input type="number" id="p-col2" value="65" min="50" max="75" step="1">
        </div>
      </div>
      <div class="field-hint" style="margin-top:8px;">La colonne ¬´ Dur√©e ¬ª prend le reste (100 % ‚àí somme des autres).</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>üìù LABELS DES COLONNES D'√âTAPES</h2></div>
    <div class="card-body">
      <p style="margin-bottom: 12px; color: var(--muted); font-size: 13px;">
        Personnalisez les noms des colonnes dans le tableau des √©tapes (PDF et Word).
      </p>
      <div class="field">
        <label>Nom de la colonne 1 (√âtapes)</label>
        <input type="text" id="label-col-etapes" value="√âtapes" placeholder="Ex: Phases, Moments, Parties...">
      </div>
      <div class="field">
        <label>Nom de la colonne 2 (D√©roulement)</label>
        <input type="text" id="label-col-deroulement" value="D√©roulement de la s√©ance" placeholder="Ex: Activit√©s, Description, Contenu...">
      </div>
      <div class="field">
        <label>Nom de la colonne 3 (Dur√©e)</label>
        <input type="text" id="label-col-duree" value="Dur√©e" placeholder="Ex: Temps, Timing...">
      </div>
      
      <!-- ‚îÄ‚îÄ COLONNES SUPPL√âMENTAIRES ‚îÄ‚îÄ -->
      <div style="margin-top:18px; border-top:1px dashed var(--border); padding-top:14px;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; flex-wrap:wrap; gap:8px;">
          <p style="font-size:12px; color:var(--blue-dark); font-weight:600; margin:0;">
            ‚ûï Colonnes suppl√©mentaires
          </p>
          <button onclick="ajouterColonneSup()" style="background:var(--blue);color:white;border:none;border-radius:6px;padding:5px 12px;font-size:11px;cursor:pointer;font-family:'Source Serif 4',serif;">
            + Ajouter une colonne
          </button>
        </div>
        <p style="font-size:11px; color:var(--muted); margin-bottom:10px;">
          Les colonnes suppl√©mentaires s'ajoutent apr√®s ¬´ D√©roulement ¬ª et avant ¬´ Dur√©e ¬ª dans le tableau PDF et Word. Max 3 colonnes ajout√©es.
        </p>
        <div id="colonnes-sup-container"></div>
        <p id="no-col-sup-msg" style="font-size:11px; color:var(--muted); text-align:center; padding:8px 0; font-style:italic;">
          Aucune colonne suppl√©mentaire. Cliquez sur ¬´ + Ajouter une colonne ¬ª pour en cr√©er.
        </p>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>üé® TH√àME DE MISE EN PAGE</h2></div>
    <div class="card-body">

      <!-- Th√®mes pr√©d√©finis -->
      <div class="param-section-title">Th√®mes pr√©d√©finis</div>
      <div id="theme-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px;"></div>

      <!-- Couleurs personnalis√©es -->
      <div class="param-section-title">Personnaliser</div>
      <div class="param-grid" style="margin-top:8px;">
        <div class="param-item">
          <label>Couleur principale</label>
          <input type="color" id="p-color-main" value="#1565C0" oninput="applyThemePreview()">
        </div>
        <div class="param-item">
          <label>Couleur accent (or)</label>
          <input type="color" id="p-color-accent" value="#C9A84C" oninput="applyThemePreview()">
        </div>
        <div class="param-item">
          <label>Couleur bordures</label>
          <input type="color" id="p-color-grid" value="#AAAAAA" oninput="applyThemePreview()">
        </div>
        <div class="param-item">
          <label>Texte √©tapes (tableau)</label>
          <input type="color" id="p-color-etape-text" value="#1565C0" oninput="applyThemePreview()">
        </div>
      </div>

      <!-- Aper√ßu mini -->
      <div style="margin-top:14px;">
        <div class="param-section-title">Aper√ßu du th√®me</div>
        <div id="theme-preview" style="margin-top:8px; border-radius:8px; overflow:hidden; border:1.5px solid var(--border);">
          <div id="tp-header" style="padding:7px 10px; display:flex; gap:8px; align-items:center;">
            <div id="tp-badge" style="width:12px;height:12px;border-radius:3px;flex-shrink:0;"></div>
            <span id="tp-title" style="color:white;font-size:11px;font-weight:700;">FICHE P√âDAGOGIQUE</span>
            <span id="tp-sub" style="color:rgba(255,255,255,0.7);font-size:10px;margin-left:auto;">EZ-ZAKY AZIZ</span>
          </div>
          <div style="background:white;padding:6px 10px;display:flex;flex-direction:column;gap:4px;">
            <div style="display:flex;gap:6px;align-items:center;">
              <span id="tp-label1" style="font-size:9px;font-weight:700;">MODULE :</span>
              <div style="flex:1;height:10px;background:#f0f0f0;border-radius:2px;border:0.5px solid #ddd;"></div>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              <span id="tp-label2" style="font-size:9px;font-weight:700;">OBJECTIF :</span>
              <div style="flex:1;height:10px;background:#f0f0f0;border-radius:2px;border:0.5px solid #ddd;"></div>
            </div>
          </div>
          <div id="tp-table-header" style="padding:5px 10px;display:flex;gap:0;">
            <span style="color:white;font-size:9px;font-weight:700;flex:2;text-align:center;">√âtapes</span>
            <span style="color:white;font-size:9px;font-weight:700;flex:5;text-align:center;">D√©roulement</span>
            <span style="color:white;font-size:9px;font-weight:700;flex:1;text-align:center;">Dur√©e</span>
          </div>
          <div style="background:white;display:flex;padding:5px 10px;gap:0;align-items:center;">
            <span id="tp-etape" style="flex:2;font-size:9px;font-weight:700;text-align:center;">I. Intro</span>
            <span style="flex:5;font-size:9px;color:#333;padding-left:4px;">Activit√© d'amorce...</span>
            <span style="flex:1;font-size:9px;color:#666;text-align:center;">5 min</span>
          </div>
        </div>
      </div>

    </div>
  </div>



  <button class="btn-generate" onclick="genererPDF()">
    üìÑ G√©n√©rer la Fiche PDF
  </button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL 4 : APER√áU -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-apercu">

  <div class="preview-info" id="preview-summary">
    Remplissez l'en-t√™te et les √©tapes, puis revenez ici pour voir un aper√ßu avant g√©n√©ration.
  </div>

  <!-- ‚îÄ‚îÄ NOUVELLE : Aper√ßu PDF simul√© en temps r√©el ‚îÄ‚îÄ -->
  <div class="card" id="card-pdf-sim">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2>APER√áU PDF SIMUL√â</h2>
        <span class="badge">Temps r√©el</span>
      </div>
      <button onclick="genererPreviewSimulee()" class="pdf-preview-update-btn" style="font-size:11px;padding:5px 10px;">
        üîÑ Actualiser
      </button>
    </div>
    <div style="padding:12px;">
      <div class="pdf-preview-container" id="pdf-preview-container">
        <div class="pdf-sim-info">Cliquez sur "Actualiser" pour g√©n√©rer l'aper√ßu</div>
      </div>
    </div>
  </div>

  <!-- Aper√ßu avec codes couleurs th√©matiques -->
  <div id="preview-live-container" class="preview-live">
    <div class="preview-live-header">
      <h2 style="margin: 0;">üìã APER√áU DE LA FICHE</h2>
      <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">
        Pr√©visualisation avec codes couleurs par section
      </p>
    </div>
    <div id="preview-live-content">
      <!-- Le contenu sera g√©n√©r√© dynamiquement -->
    </div>
  </div>

  <div id="preview-table-container"></div>

  <!-- Boutons export multiples (mis √† jour) -->
  <div class="btn-export-group">
    <button class="btn-export btn-export-save" onclick="enregistrerDansRepertoire()">
      üíæ Enregistrer la fiche
    </button>
    <button class="btn-export btn-export-pdf" onclick="genererPDF()">
      üìÑ Exporter en PDF
    </button>
    <button class="btn-export btn-export-docx" onclick="genererDOCX()">
      üìò Exporter en Word (.docx)
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL 6 : R√âPERTOIRE DES FICHES                    -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-repertoire">
  <div style="background:linear-gradient(90deg,#1565C0,#1976D2);border-radius:12px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div style="color:#fff;font-weight:700;font-size:15px;">üìÅ R√©pertoire des fiches</div>
      <div style="color:rgba(255,255,255,0.8);font-size:11px;margin-top:2px;">Fiches enregistr√©es manuellement sur cet appareil</div>
    </div>
    <span id="rep-compteur" style="background:rgba(255,255,255,0.2);color:#fff;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700;">0 fiche</span>
  </div>
  <div id="repertoire-liste">
    <div class="repertoire-empty">
      <div style="font-size:40px;margin-bottom:8px;">üìÇ</div>
      <div>Aucune fiche enregistr√©e.</div>
      <div style="font-size:12px;margin-top:6px;color:#bbb;">Utilisez le bouton <strong>üíæ Enregistrer la fiche</strong><br>depuis l'onglet √âtapes ou Aper√ßu.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL MOD√àLES : FICHES PR√äTES √Ä L'EMPLOI          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-modeles">
  <div style="background:linear-gradient(135deg,#1565C0 0%,#0D47A1 100%);border-radius:14px;padding:18px 16px 14px;margin-bottom:16px;box-shadow:0 4px 18px rgba(21,101,192,0.3);">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <div style="font-size:32px;">üóÇÔ∏è</div>
      <div>
        <div style="color:#fff;font-weight:800;font-size:16px;font-family:'Playfair Display',serif;">Mod√®les de Fiches P√©dagogiques</div>
        <div style="color:rgba(255,255,255,0.8);font-size:11px;margin-top:2px;">Fiches pr√™tes √† l'emploi ¬∑ Chargez, personnalisez, exportez</div>
      </div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:600;">üìñ Fran√ßais</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:600;">üìê Maths</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:600;">üî¨ SVT ¬∑ üèõÔ∏è Histoire ¬∑ ‚öóÔ∏è Physique ¬∑ üá¨üáß Anglais</span>
      <span style="background:rgba(201,168,76,0.85);color:#fff;border-radius:14px;padding:3px 10px;font-size:10px;font-weight:700;">7 mod√®les</span>
    </div>
  </div>
  <div class="modeles-filter-bar">
    <button class="modele-filter-btn active" onclick="filtrerModeles('all',this)">üìã Tous</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('francais',this)">üìñ Fran√ßais</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('maths',this)">üìê Maths</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('svt',this)">üî¨ SVT</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('histoire',this)">üèõÔ∏è Histoire</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('anglais',this)">üá¨üáß Anglais</button>
    <button class="modele-filter-btn" onclick="filtrerModeles('physique',this)">‚öóÔ∏è Physique</button>
  </div>
  <div id="modeles-liste"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL 5 : GUIDE D'UTILISATION                      -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-guide">
<div id="guide-content">

  <!-- ‚îÄ‚îÄ HERO ‚îÄ‚îÄ -->
  <div style="background:linear-gradient(135deg,#1565C0 0%,#0D47A1 60%,#1565C0 100%);border-radius:16px;padding:28px 20px 22px;margin-bottom:18px;text-align:center;box-shadow:0 6px 24px rgba(21,101,192,0.35);">
    <div style="font-size:52px;margin-bottom:8px;">üìã</div>
    <h1 style="color:#fff;font-size:20px;font-weight:800;margin:0 0 6px;letter-spacing:0.02em;">G√©n√©rateur de Fiches P√©dagogiques</h1>
    <p style="color:rgba(255,255,255,0.85);font-size:13px;margin:0 0 14px;">par <strong>EZ-ZAKY AZIZ</strong></p>
    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">üìÑ Export PDF</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">üìò Export Word</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">‚úíÔ∏è Texte riche</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">üñºÔ∏è Images</span>
      <span style="background:rgba(255,255,255,0.18);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;">üé® 9 Th√®mes</span>
      <span style="background:rgba(201,168,76,0.85);color:#fff;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:700;">üÜï v3.0 : Tablette ¬∑ Partage ¬∑ Backup</span>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CARACT√âRISTIQUES ‚îÄ‚îÄ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#1565C0,#1976D2);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">‚≠ê</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">CARACT√âRISTIQUES</span>
    </div>
    <div style="padding:14px 16px;display:grid;gap:10px;">

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E3F2FD;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üìù</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">En-t√™te enti√®rement personnalisable</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Labels modifiables par double-clic (Professeur, Niveau, Module, S√©quence, Activit√©, Support, Objectif). Possibilit√© d'ajouter des lignes libres simples ou doubles.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E8F5E9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üìö</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Tableau d'√©tapes dynamique</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Ajoutez, supprimez et r√©ordonnez vos √©tapes. Chaque √©tape dispose d'un √©diteur de texte riche (gras, italique, soulign√©, listes, tableaux, images, symboles).</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#FFF3E0;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">‚ûï</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Colonnes suppl√©mentaires (jusqu'√† 3)</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Ajoutez des colonnes personnalis√©es dans le tableau des √©tapes : Mat√©riel, Supports, Outils p√©dagogiques, etc. Largeur r√©glable de 5 √† 25 %.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#F3E5F5;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üé®</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">9 th√®mes de couleurs professionnels</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Bleu classique, Marine & or, Vert acad√©mique, Bordeaux, Violet royal, Ardoise, Noir & or, Turquoise, Rouge vif. Couleurs personnalisables manuellement.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E8F5E9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üìê</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Mise en page param√©trable</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">Orientation (portrait/paysage), taille de police, largeurs des colonnes, marges, num√©rotation des pages. Format A4 standard.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#E3F2FD;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üíæ</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Export double format</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">G√©n√©ration PDF fid√®le en un clic pour impression et partage. Export Word (.docx) √©ditable avec images int√©gr√©es, compatible Microsoft Word et LibreOffice.</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;">
        <div style="width:36px;height:36px;min-width:36px;background:#FFF8E1;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üìµ</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:2px;">Mode hors ligne</div>
          <div style="color:#555;font-size:12px;line-height:1.5;">La g√©n√©ration PDF fonctionne m√™me sans connexion internet. L'export Word n√©cessite le chargement initial des biblioth√®ques.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ GUIDE √âTAPE PAR √âTAPE ‚îÄ‚îÄ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#1565C0,#1976D2);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">üó∫Ô∏è</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">GUIDE D'UTILISATION ‚Äî √âTAPE PAR √âTAPE</span>
    </div>
    <div style="padding:14px 16px;display:grid;gap:0;">

      <!-- √âtape 1 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">1</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">üìù Remplir l'en-t√™te (onglet En-t√™te)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Saisissez les informations de la fiche : Professeur, Niveau, Module, S√©quence, Activit√©, Support et Objectif(s).<br>
            <strong>üí° Astuce :</strong> double-cliquez sur un label (ex : ¬´ Professeur ¬ª) pour le renommer selon votre √©tablissement.<br>
            <strong>‚ûï</strong> Utilisez ¬´ Ajouter une ligne ¬ª pour des champs suppl√©mentaires (√âtablissement, Date, Groupe‚Ä¶).
          </div>
        </div>
      </div>

      <!-- √âtape 2 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">2</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">üìö Cr√©er les √©tapes (onglet √âtapes)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Cliquez sur <strong>¬´ + Ajouter une √©tape ¬ª</strong> pour cr√©er chaque √©tape du d√©roulement.<br>
            Pour chaque √©tape, renseignez :<br>
            &nbsp;&nbsp;‚Ä¢ <strong>Nom</strong> de l'√©tape (Mise en route, Pr√©sentation, Production‚Ä¶)<br>
            &nbsp;&nbsp;‚Ä¢ <strong>D√©roulement</strong> : d√©crivez l'activit√© avec l'√©diteur riche<br>
            &nbsp;&nbsp;‚Ä¢ <strong>Dur√©e</strong> : temps allou√© (ex : 15 min)<br>
            <strong>üñºÔ∏è</strong> Ins√©rez des images dans le d√©roulement via le bouton image de la barre d'outils.<br>
            <strong>Œ©</strong> Utilisez le s√©lecteur de symboles pour enrichir le texte.
          </div>
        </div>
      </div>

      <!-- √âtape 3 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">3</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">‚öôÔ∏è Configurer les param√®tres (onglet Param√®tres)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            <strong>Th√®me :</strong> choisissez parmi les 9 th√®mes ou personnalisez les couleurs manuellement.<br>
            <strong>Mise en page :</strong> orientation, taille de police, largeurs des colonnes, marges.<br>
            <strong>Labels du tableau :</strong> renommez les en-t√™tes des colonnes (√âtapes, D√©roulement, Dur√©e).<br>
            <strong>Colonnes sup. :</strong> ajoutez jusqu'√† 3 colonnes personnalis√©es avec leur nom et leur largeur.
          </div>
        </div>
      </div>

      <!-- √âtape 4 -->
      <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F0F4FA;">
        <div style="min-width:34px;height:34px;background:#1565C0;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">4</div>
        <div>
          <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">üëÅÔ∏è V√©rifier l'aper√ßu (onglet Aper√ßu)</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Consultez le rendu complet de votre fiche avant export : en-t√™te et tableau des √©tapes avec les couleurs du th√®me choisi.<br>
            L'aper√ßu se met √† jour automatiquement √† chaque modification.
          </div>
        </div>
      </div>

      <!-- √âtape 5 -->
      <div style="display:flex;gap:12px;padding:12px 0;">
        <div style="min-width:34px;height:34px;background:#C9A84C;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">5</div>
        <div>
          <div style="font-weight:700;color:#C9A84C;font-size:13px;margin-bottom:4px;">üíæ Exporter la fiche</div>
          <div style="color:#444;font-size:12px;line-height:1.6;">
            Depuis l'onglet <strong>Aper√ßu</strong>, cliquez sur :<br>
            &nbsp;&nbsp;‚Ä¢ <strong>üìÑ Exporter en PDF</strong> ‚Äî pour impression ou partage imm√©diat<br>
            &nbsp;&nbsp;‚Ä¢ <strong>üìò Exporter en Word (.docx)</strong> ‚Äî pour modifier et r√©utiliser la fiche<br>
            Le fichier se t√©l√©charge directement en un seul clic.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ CONSEILS PRO ‚îÄ‚îÄ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#C9A84C,#E6B84C);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">üèÜ</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">CONSEILS D'UTILISATION PROFESSIONNELLE</span>
    </div>
    <div style="padding:14px 16px;display:grid;gap:10px;">

      <div style="background:#FFFDE7;border-left:4px solid #C9A84C;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#795548;font-size:12px;margin-bottom:3px;">üìå Standardisation institutionnelle</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Renommez tous les labels une fois pour toutes selon les normes de votre √©tablissement. Ainsi chaque fiche produite sera conforme au m√™me standard.</div>
      </div>

      <div style="background:#E8F5E9;border-left:4px solid #2E7D32;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#2E7D32;font-size:12px;margin-bottom:3px;">üîÑ R√©utilisation des fiches</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Exportez en Word (.docx) pour archiver vos fiches et les modifier facilement d'une s√©quence √† l'autre sans repartir de z√©ro.</div>
      </div>

      <div style="background:#E3F2FD;border-left:4px solid #1565C0;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#1565C0;font-size:12px;margin-bottom:3px;">üé® Coh√©rence visuelle</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Utilisez le m√™me th√®me de couleurs pour toutes vos fiches afin de cr√©er une identit√© visuelle professionnelle et reconnaissable.</div>
      </div>

      <div style="background:#F3E5F5;border-left:4px solid #7B1FA2;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#7B1FA2;font-size:12px;margin-bottom:3px;">üì∏ Images dans le d√©roulement</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Int√©grez des captures d'√©crans, sch√©mas ou illustrations directement dans le d√©roulement de la s√©ance. Elles apparaissent dans le PDF et le Word.</div>
      </div>

      <div style="background:#FFF3E0;border-left:4px solid #E65100;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#E65100;font-size:12px;margin-bottom:3px;">‚ûï Colonnes personnalis√©es</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Ajoutez une colonne ¬´ Mat√©riel ¬ª ou ¬´ Comp√©tences ¬ª dans l'onglet Param√®tres ‚Üí Colonnes suppl√©mentaires pour enrichir le tableau sans surcharger la mise en page.</div>
      </div>

      <div style="background:#E8F5E9;border-left:4px solid #1B5E20;border-radius:0 8px 8px 0;padding:10px 12px;">
        <div style="font-weight:700;color:#1B5E20;font-size:12px;margin-bottom:3px;">üñ®Ô∏è Impression optimale</div>
        <div style="color:#555;font-size:12px;line-height:1.5;">Utilisez l'orientation <strong>Paysage</strong> si votre tableau comporte beaucoup de colonnes. Le format PDF A4 est pr√™t √† imprimer directement.</div>
      </div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ RACCOURCIS √âDITEUR ‚îÄ‚îÄ -->
  <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
    <div style="background:linear-gradient(90deg,#37474F,#546E7A);padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px;">‚å®Ô∏è</span>
      <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">RACCOURCIS DE L'√âDITEUR DE TEXTE</span>
    </div>
    <div style="padding:14px 16px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <kbd style="background:#1565C0;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">G</kbd>
          <span style="font-size:12px;color:#444;">Gras</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <kbd style="background:#1565C0;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;font-style:italic;">I</kbd>
          <span style="font-size:12px;color:#444;">Italique</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <kbd style="background:#1565C0;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;text-decoration:underline;">S</kbd>
          <span style="font-size:12px;color:#444;">Soulign√©</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">‚â°</span>
          <span style="font-size:12px;color:#444;">Liste √† puces</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">‚äû</span>
          <span style="font-size:12px;color:#444;">Tableau</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">üñº</span>
          <span style="font-size:12px;color:#444;">Image</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">Œ©</span>
          <span style="font-size:12px;color:#444;">Symboles</span>
        </div>
        <div style="background:#F5F7FA;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
          <span style="background:#37474F;color:#fff;border-radius:4px;padding:2px 7px;font-size:11px;font-weight:700;">A¬≤</span>
          <span style="font-size:12px;color:#444;">Exposant</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PIED ‚îÄ‚îÄ -->
  <div style="text-align:center;padding:16px 12px 24px;color:#999;font-size:11px;">
    <div style="font-size:28px;margin-bottom:6px;">üìã</div>
    <div style="font-weight:700;color:#1565C0;font-size:13px;margin-bottom:4px;">G√©n√©rateur de Fiches P√©dagogiques</div>
    <div>D√©velopp√© par <strong style="color:#1565C0;">EZ-ZAKY AZIZ</strong></div>
    <div style="margin-top:4px;">Application 100 % locale ‚Äî vos donn√©es restent sur votre appareil</div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL : √Ä PROPOS (COPYRIGHT & LICENCE)             -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-apropos">
  <div id="apropos-content">

    <!-- ‚îÄ‚îÄ HERO √Ä PROPOS ‚îÄ‚îÄ -->
    <div style="background:linear-gradient(135deg,#1565C0 0%,#0D47A1 60%,#1565C0 100%);border-radius:16px;padding:32px 20px;margin-bottom:18px;text-align:center;box-shadow:0 8px 28px rgba(21,101,192,0.4);">
      <div style="font-size:64px;margin-bottom:12px;">üìã</div>
      <h1 style="color:#fff;font-size:22px;font-weight:800;margin:0 0 8px;letter-spacing:0.02em;">G√©n√©rateur de Fiches P√©dagogiques</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:14px;margin:0 0 6px;font-weight:600;">Version 2.11 ‚Äî F√©vrier 2025</p>
      <p style="color:rgba(255,255,255,0.85);font-size:13px;margin:0;">Con√ßu et d√©velopp√© par <strong>EZ-ZAKY AZIZ</strong></p>
    </div>

    <!-- ‚îÄ‚îÄ COPYRIGHT ‚îÄ‚îÄ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#1565C0,#1976D2);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">¬©</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">COPYRIGHT & PROPRI√âT√â INTELLECTUELLE</span>
      </div>
      <div style="padding:18px 16px;">
        <div style="background:#E3F2FD;border-left:4px solid #1565C0;border-radius:0 8px 8px 0;padding:14px 16px;margin-bottom:14px;">
          <div style="font-size:13px;color:#1565C0;font-weight:700;margin-bottom:8px;">¬© 2025 EZ-ZAKY AZIZ ‚Äî Tous droits r√©serv√©s</div>
          <div style="font-size:12px;color:#444;line-height:1.7;">
            Cette application et tous ses composants (code source, design, documentation, mod√®les) sont la propri√©t√© intellectuelle de <strong>EZ-ZAKY AZIZ</strong>.<br><br>
            <strong>Cr√©ateur :</strong> EZ-ZAKY AZIZ<br>
            <strong>Date de cr√©ation :</strong> 2024-2025<br>
            <strong>Contact :</strong> Pour toute question ou demande de collaboration, veuillez me contacter directement.
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ LICENCE D'UTILISATION ‚îÄ‚îÄ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#2E7D32,#388E3C);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">üìú</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">LICENCE D'UTILISATION</span>
      </div>
      <div style="padding:18px 16px;">
        <div style="font-size:13px;font-weight:700;color:#2E7D32;margin-bottom:10px;">Creative Commons BY-NC-SA 4.0</div>
        <div style="font-size:12px;color:#444;line-height:1.7;margin-bottom:14px;">
          Cette application est distribu√©e sous licence <strong>Creative Commons Attribution - Pas d'Utilisation Commerciale - Partage dans les M√™mes Conditions 4.0 International (CC BY-NC-SA 4.0)</strong>.
        </div>

        <div style="display:grid;gap:10px;">
          <!-- Autoris√© -->
          <div style="background:#E8F5E9;border-left:4px solid #2E7D32;border-radius:0 8px 8px 0;padding:12px 14px;">
            <div style="font-weight:700;color:#2E7D32;font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;">‚úÖ</span> VOUS POUVEZ (Usage autoris√©)
            </div>
            <div style="font-size:12px;color:#555;line-height:1.6;">
              ‚Ä¢ <strong>Utiliser</strong> l'application pour cr√©er vos fiches p√©dagogiques<br>
              ‚Ä¢ <strong>Partager</strong> l'application avec vos coll√®gues enseignants<br>
              ‚Ä¢ <strong>Modifier</strong> et adapter l'application √† vos besoins personnels<br>
              ‚Ä¢ <strong>Distribuer</strong> vos versions modifi√©es sous la m√™me licence
            </div>
          </div>

          <!-- Obligations -->
          <div style="background:#FFF3E0;border-left:4px solid #F57C00;border-radius:0 8px 8px 0;padding:12px 14px;">
            <div style="font-weight:700;color:#E65100;font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;">‚ö†Ô∏è</span> VOUS DEVEZ (Obligations)
            </div>
            <div style="font-size:12px;color:#555;line-height:1.6;">
              ‚Ä¢ <strong>Cr√©diter</strong> l'auteur original : "Application cr√©√©e par EZ-ZAKY AZIZ"<br>
              ‚Ä¢ <strong>Indiquer</strong> si des modifications ont √©t√© apport√©es<br>
              ‚Ä¢ <strong>Fournir</strong> un lien vers la licence CC BY-NC-SA 4.0<br>
              ‚Ä¢ <strong>Distribuer vos modifications</strong> sous la m√™me licence
            </div>
          </div>

          <!-- Interdit -->
          <div style="background:#FFEBEE;border-left:4px solid #C62828;border-radius:0 8px 8px 0;padding:12px 14px;">
            <div style="font-weight:700;color:#C62828;font-size:12px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
              <span style="font-size:16px;">‚ùå</span> VOUS NE POUVEZ PAS (Interdit)
            </div>
            <div style="font-size:12px;color:#555;line-height:1.6;">
              ‚Ä¢ <strong>Utilisation commerciale</strong> : vendre l'application ou l'utiliser dans un cadre commercial<br>
              ‚Ä¢ <strong>Supprimer les cr√©dits</strong> : retirer le nom de l'auteur original<br>
              ‚Ä¢ <strong>Pr√©tendre √™tre l'auteur</strong> : vous ne pouvez pas vous pr√©senter comme le cr√©ateur original<br>
              ‚Ä¢ <strong>Appliquer des restrictions suppl√©mentaires</strong> : vous ne pouvez pas restreindre davantage les droits
            </div>
          </div>
        </div>

        <div style="margin-top:14px;padding:12px;background:#F5F7FA;border-radius:8px;font-size:11px;color:#666;line-height:1.6;">
          <strong>Note :</strong> Cette licence s'applique au code source et √† l'application elle-m√™me. Les fiches p√©dagogiques que vous cr√©ez avec cette application vous appartiennent enti√®rement et ne sont pas soumises √† cette licence.
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ INFORMATIONS TECHNIQUES ‚îÄ‚îÄ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#7B1FA2,#9C27B0);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">üíª</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">INFORMATIONS TECHNIQUES</span>
      </div>
      <div style="padding:14px 16px;">
        <div style="display:grid;gap:8px;font-size:12px;color:#444;">
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Version</span>
            <span>Version 3.0 ‚Äî F√©vrier 2026 (am√©lior√© par IA)</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Type d'application</span>
            <span>PWA (Progressive Web App)</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Technologies utilis√©es</span>
            <span>HTML5, CSS3, JavaScript, jsPDF, Quill.js</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Compatibilit√©</span>
            <span>Tous navigateurs modernes, Android, iOS</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Mode hors ligne</span>
            <span>‚úÖ Disponible</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 10px;background:#F5F7FA;border-radius:6px;">
            <span style="font-weight:600;">Donn√©es</span>
            <span>100% locales (navigateur)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ REMERCIEMENTS ‚îÄ‚îÄ -->
    <div style="background:#fff;border-radius:14px;border:1.5px solid #E3EAF6;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06);">
      <div style="background:linear-gradient(90deg,#C9A84C,#E6B84C);padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px;">üôè</span>
        <span style="color:#fff;font-weight:700;font-size:14px;letter-spacing:0.04em;">REMERCIEMENTS</span>
      </div>
      <div style="padding:14px 16px;font-size:12px;color:#444;line-height:1.7;">
        Cette application a √©t√© d√©velopp√©e avec passion pour faciliter le travail des enseignants.<br><br>
        Un grand merci √† tous les coll√®gues enseignants qui ont test√© l'application et fourni leurs pr√©cieux retours pour l'am√©liorer.<br><br>
        <strong>Biblioth√®ques open source utilis√©es :</strong><br>
        ‚Ä¢ jsPDF ‚Äî G√©n√©ration de fichiers PDF<br>
        ‚Ä¢ Quill.js ‚Äî √âditeur de texte riche<br>
        ‚Ä¢ JSZip ‚Äî Cr√©ation de fichiers DOCX
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PIED √Ä PROPOS ‚îÄ‚îÄ -->
    <div style="text-align:center;padding:20px 12px 24px;">
      <div style="font-size:32px;margin-bottom:10px;">üìã</div>
      <div style="font-weight:700;color:#1565C0;font-size:14px;margin-bottom:6px;">G√©n√©rateur de Fiches P√©dagogiques</div>
      <div style="color:#666;font-size:12px;margin-bottom:4px;">¬© 2025-2026 <strong style="color:#1565C0;">EZ-ZAKY AZIZ</strong></div>
      <div style="color:#999;font-size:11px;">Tous droits r√©serv√©s ‚Äî Licence CC BY-NC-SA 4.0 ‚Äî v3.0</div>
      <div style="margin-top:12px;padding:10px;background:#F5F7FA;border-radius:8px;display:inline-block;">
        <div style="font-size:11px;color:#666;line-height:1.6;">
          Application 100% locale ‚Äî Vos donn√©es restent sur votre appareil<br>
          Aucune connexion serveur ‚Äî Respect total de votre vie priv√©e
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- PANEL : PARTAGE & SAUVEGARDE AVANC√âE (v3.0)       -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-partage">

  <!-- Avertissement backup -->
  <div class="backup-warn">
    <span class="backup-warn-icon">‚ö†Ô∏è</span>
    <div>
      <strong>Rappel important :</strong> Vos fiches sont stock√©es dans votre navigateur (localStorage). 
      Si vous videz les donn√©es du navigateur ou changez d'appareil, vos fiches seront perdues. 
      <strong>Exportez r√©guli√®rement un backup JSON</strong> pour les conserver en s√©curit√©.
    </div>
  </div>

  <!-- Section Export/Import -->
  <div class="export-section">
    <div class="export-section-header">
      <span style="font-size:18px;">üíæ</span>
      <span>SAUVEGARDE & RESTAURATION</span>
    </div>
    <div class="export-section-body">
      <p style="font-size:12px;color:#555;margin-bottom:14px;line-height:1.6;">
        Exportez toutes vos fiches dans un fichier <strong>.json</strong> que vous pouvez stocker 
        sur votre t√©l√©phone, Google Drive, ou envoyer par email. Pour restaurer, importez ce fichier.
      </p>
      <div class="export-btn-grid">
        <button class="btn-v3 btn-v3-primary" onclick="exporterToutesLesFinches()" style="width:100%;justify-content:center;">
          üì¶ Exporter toutes les fiches (.json)
        </button>
        <button class="btn-v3 btn-v3-success" onclick="importerFichesJSON()" style="width:100%;justify-content:center;">
          üì• Importer un backup (.json)
        </button>
      </div>
      <div class="export-btn-grid">
        <button class="btn-v3 btn-v3-ghost" onclick="exporterFicheActuelle()" style="width:100%;justify-content:center;">
          üìÑ Exporter la fiche actuelle
        </button>
        <button class="btn-v3 btn-v3-warn" onclick="confirmerEffacerTout()" style="width:100%;justify-content:center;">
          üóëÔ∏è Effacer toutes les fiches
        </button>
      </div>
      <div id="export-status" style="display:none;margin-top:10px;padding:10px;border-radius:8px;font-size:12px;text-align:center;"></div>
      
      <!-- Stats du r√©pertoire -->
      <div style="margin-top:14px;background:#F5F8FF;border-radius:8px;padding:12px;display:flex;gap:16px;flex-wrap:wrap;">
        <div style="text-align:center;flex:1;">
          <div id="stat-fiches" style="font-size:24px;font-weight:700;color:var(--blue);">0</div>
          <div style="font-size:11px;color:var(--muted);">Fiches sauvegard√©es</div>
        </div>
        <div style="text-align:center;flex:1;">
          <div id="stat-taille" style="font-size:24px;font-weight:700;color:var(--gold);">0 Ko</div>
          <div style="font-size:11px;color:var(--muted);">Espace utilis√©</div>
        </div>
        <div style="text-align:center;flex:1;">
          <div id="stat-backup" style="font-size:24px;font-weight:700;color:#2E7D32;">‚Äî</div>
          <div style="font-size:11px;color:var(--muted);">Dernier backup</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Partage par lien / QR Code -->
  <div class="export-section">
    <div class="export-section-header">
      <span style="font-size:18px;">üîó</span>
      <span>PARTAGER CETTE FICHE</span>
    </div>
    <div class="export-section-body">
      <p style="font-size:12px;color:#555;margin-bottom:14px;line-height:1.6;">
        Choisissez votre m√©thode de partage selon votre situation.
      </p>
      
      <div class="share-method-tabs">
        <button class="share-method-tab active" onclick="switchShareMethod('qr', this)">üè∑Ô∏è QR R√©sum√©</button>
        <button class="share-method-tab" onclick="switchShareMethod('code', this)">üîë Code court</button>
        <button class="share-method-tab" onclick="switchShareMethod('email', this)">üìß Email</button>
      </div>
      
      <!-- QR R√©sum√© (NOUVEAU - toujours fonctionne car encode seulement les infos essentielles) -->
      <div class="share-panel active" id="share-panel-qr">
        <div style="background:#E8F5E9;border-radius:8px;padding:10px 12px;font-size:11px;color:#2E7D32;margin-bottom:12px;line-height:1.5;">
          ‚úÖ <strong>Ce QR Code fonctionne toujours</strong> car il encode uniquement le <strong>r√©sum√© de la fiche</strong> 
          (Professeur, Niveau, Module, Objectif) ‚Äî pas le contenu complet. 
          Utile pour <strong>afficher en classe</strong>, coller sur un cahier, ou partager rapidement les infos.
        </div>
        <button class="btn-v3 btn-v3-primary" onclick="genererQRResume()" style="width:100%;justify-content:center;margin-bottom:14px;">
          üè∑Ô∏è G√©n√©rer le QR R√©sum√©
        </button>
        <div class="qr-container" id="qr-container" style="display:none;">
          <canvas id="qr-canvas" width="220" height="220"></canvas>
          <div class="qr-info" id="qr-info-text">Le QR Code contient le r√©sum√© de la fiche.</div>
          <div id="qr-content-preview" style="width:100%;background:#F5F8FF;border-radius:8px;border:1px solid #E3EAF6;padding:10px;font-size:10px;color:#444;line-height:1.7;font-family:monospace;max-height:100px;overflow-y:auto;"></div>
          <button class="btn-v3 btn-v3-ghost" onclick="telechargerQR()" style="width:100%;justify-content:center;">‚¨áÔ∏è T√©l√©charger QR (PNG)</button>
        </div>
        <div style="margin-top:14px;background:#FFF3E0;border:1px solid #FFB74D;border-radius:8px;padding:10px;font-size:11px;color:#E65100;line-height:1.5;">
          üí° <strong>Pour partager la fiche compl√®te</strong> (avec tout le contenu) : utilisez <strong>"üîë Code court"</strong> 
          (m√™me appareil) ou <strong>"üìß Email"</strong> avec export JSON (entre appareils).
        </div>
      </div>
      
      <!-- Code court (fonctionne sur Android WebView / APK) -->
      <div class="share-panel" id="share-panel-code">
        <div style="background:#E8F5E9;border-radius:8px;padding:10px 12px;font-size:11px;color:#2E7D32;margin-bottom:12px;line-height:1.5;">
          ‚úÖ <strong>M√©thode recommand√©e sur Android/APK.</strong> G√©n√©rez un code court, envoyez-le par SMS ou WhatsApp. Votre coll√®gue l'entre dans son application.
        </div>
        <button class="btn-v3 btn-v3-primary" onclick="genererCodeCourt()" style="width:100%;justify-content:center;margin-bottom:14px;">
          üîë G√©n√©rer un code de partage
        </button>
        <div id="code-court-container" style="display:none;">
          <div style="text-align:center;margin-bottom:14px;">
            <div style="font-size:38px;font-weight:900;letter-spacing:6px;color:var(--blue);font-family:monospace;background:#E3F2FD;border-radius:12px;padding:16px;border:2px dashed var(--blue);" id="code-court-display">‚Äî‚Äî</div>
            <div style="font-size:11px;color:var(--muted);margin-top:6px;" id="code-court-expiry"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-v3 btn-v3-primary" onclick="copierCode()" style="flex:1;justify-content:center;">üìã Copier le code</button>
            <button class="btn-v3 btn-v3-ghost" onclick="partagerCodeWhatsApp()" style="flex:1;justify-content:center;">üí¨ WhatsApp</button>
          </div>
        </div>
        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px;">
          <div style="font-size:12px;font-weight:600;color:var(--blue-dark);margin-bottom:8px;">üì• Charger une fiche par code</div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="code-import-input" placeholder="Code (ex: A3F7X2K9)" maxlength="12"
              style="flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:monospace;font-size:18px;font-weight:700;text-transform:uppercase;letter-spacing:4px;text-align:center;"
              oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
            <button class="btn-v3 btn-v3-success" onclick="chargerParCode()">‚úÖ Charger</button>
          </div>
          <div id="code-import-status" style="font-size:11px;color:var(--muted);margin-top:6px;text-align:center;min-height:16px;"></div>
        </div>
      </div>
      
      <!-- Email -->
      <div class="share-panel" id="share-panel-email">
        <p style="font-size:12px;color:#555;margin-bottom:12px;line-height:1.6;">
          M√©thode la plus fiable : exportez le fichier JSON et envoyez-le par email. Votre coll√®gue l'importe dans son application.
        </p>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <button class="btn-v3 btn-v3-primary" onclick="partagerEmail('json')" style="justify-content:center;">
            üìß Pr√©parer email (fichier JSON)
          </button>
          <button class="btn-v3 btn-v3-ghost" onclick="partagerEmailCode()" style="justify-content:center;">
            üìß Envoyer le code par email
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Aper√ßu am√©lior√© -->
  <div class="export-section">
    <div class="export-section-header">
      <span style="font-size:18px;">üñ®Ô∏è</span>
      <span>G√âN√âRATION RAPIDE</span>
    </div>
    <div class="export-section-body">
      <div class="export-btn-grid">
        <button class="btn-v3 btn-v3-primary" onclick="genererPDF()" style="width:100%;justify-content:center;">
          üìÑ G√©n√©rer PDF
        </button>
        <button class="btn-v3" onclick="genererDOCX()" style="width:100%;justify-content:center;background:#1B5E20;color:white;">
          üìù G√©n√©rer DOCX
        </button>
      </div>
    </div>
  </div>

</div>

<!-- INPUT FILE cach√© pour l'import JSON -->
<input type="file" id="import-json-input" accept=".json" style="display:none" onchange="lireJSONImporte(event)">
  <div class="symbol-picker-header">
    <span>Œ© Ins√©rer un symbole</span>
    <button class="symbol-picker-close" onclick="fermerSymbolPicker()" type="button">‚úï</button>
  </div>
  <div class="symbol-picker-tabs" id="sym-tabs">
    <button class="sym-tab active" onclick="showSymTab('fleches',this)" type="button">Fl√®ches</button>
    <button class="sym-tab" onclick="showSymTab('puces',this)" type="button">Puces</button>
    <button class="sym-tab" onclick="showSymTab('maths',this)" type="button">Maths</button>
    <button class="sym-tab" onclick="showSymTab('etoiles',this)" type="button">√âtoiles</button>
    <button class="sym-tab" onclick="showSymTab('ponctuation',this)" type="button">Ponctuation</button>
    <button class="sym-tab" onclick="showSymTab('exposants',this)" type="button">Exposants</button>
  </div>
  <div class="symbol-picker-body" id="sym-body"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL : INSERTION DE TABLEAU                       -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-tableau">
  <div class="modal-box">
    <div class="modal-title">‚äû Ins√©rer un tableau</div>
    <div class="modal-field">
      <label>Nombre de colonnes</label>
      <input type="number" id="tbl-cols" value="3" min="1" max="10">
    </div>
    <div class="modal-field">
      <label>Nombre de lignes</label>
      <input type="number" id="tbl-rows" value="3" min="1" max="20">
    </div>
    <label class="modal-check">
      <input type="checkbox" id="tbl-header" checked>
      Premi√®re ligne en en-t√™te
    </label>
    <div class="modal-actions">
      <button class="btn-modal-cancel" onclick="fermerModalTableau()">Annuler</button>
      <button class="btn-modal-ok" onclick="insererTableauQuill()">‚äû Ins√©rer</button>
    </div>
  </div>
</div>


<!-- PANNEAU REDIMENSIONNEMENT IMAGE -->
<div id="img-resize-panel">
  <div class="rp-head">
    <span>üñº Taille de l'image</span>
    <span class="rp-dims" id="rp-dims-orig"></span>
  </div>
  <div class="rp-row">
    <span class="rp-lbl">Largeur</span>
    <input type="range" id="rp-range" min="5" max="100" value="100" step="1"
           oninput="rpUpdateFromRange(this.value)">
  </div>
  <div class="rp-row">
    <span class="rp-lbl">En pixels</span>
    <input type="number" id="rp-px" min="10" max="3000" step="1"
           oninput="rpUpdateFromPx(this.value)">
    <span class="rp-unit">px</span>
    <span style="color:var(--muted);font-size:10px;">√ó</span>
    <input type="number" id="rp-py" min="10" max="3000" step="1" style="width:60px"
           oninput="rpUpdateFromPy(this.value)">
    <span class="rp-unit">px</span>
  </div>
  <div class="rp-presets">
    <button class="rp-pre" onclick="rpSetPct(25)">25%</button>
    <button class="rp-pre" onclick="rpSetPct(50)">50%</button>
    <button class="rp-pre" onclick="rpSetPct(75)">75%</button>
    <button class="rp-pre" onclick="rpSetPct(100)">100%</button>
  </div>
  <div class="rp-info" id="rp-preview-size"></div>
  <div class="rp-btns">
    <button class="rp-btn rp-cancel" onclick="rpFermer(false)">Annuler</button>
    <button class="rp-btn rp-ok" onclick="rpAppliquer()">‚úî Appliquer</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">‚úÖ PDF g√©n√©r√© et t√©l√©charg√© !</div>

<!-- Biblioth√®ques externes ‚Äî charg√©es depuis le cache du Service Worker si hors ligne -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
  onerror="document.getElementById('libs-warn').style.display='block'"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
  onerror="document.getElementById('libs-warn').style.display='block'"></script>

<div id="libs-warn" style="display:none; background:#FFF3E0; border-left:4px solid #E65100; padding:12px 16px; margin:12px 16px; border-radius:8px; font-size:13px; color:#BF360C; font-family:'Source Serif 4',serif;">
  ‚ö†Ô∏è <strong>Biblioth√®ques non charg√©es (PDF & Word).</strong><br>
  ‚Ä¢ Si vous √™tes <strong>hors ligne</strong> : Ces biblioth√®ques seront disponibles apr√®s une premi√®re visite en ligne.<br>
  ‚Ä¢ Si vous √™tes <strong>en ligne</strong> : Rechargez la page et attendez quelques secondes.
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  var panel = document.getElementById('panel-' + name);
  var tab   = document.getElementById('tab-'   + name);
  if (panel) panel.classList.add('active');
  if (tab)   tab.classList.add('active');
  if (name === 'apercu')    { rafraichirApercu(); genererPreviewLive(); }
  if (name === 'repertoire') afficherRepertoire();
  if (name === 'modeles')    rendreTousLesModeles();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GESTION DES √âTAPES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let etapeCount = 0;

function ajouterEtape(data) {
  etapeCount++;
  const n = etapeCount;
  const d = data || {};
  const container = document.getElementById('etapes-container');

  const div = document.createElement('div');
  div.className = 'etape-card';
  div.id = 'etape-' + n;
  div.innerHTML = `
    <div class="etape-header">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="etape-num etape-num-${n}">${n}</div>
        <h3 class="etape-titre-${n}">√âtape ${n}</h3>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <button class="btn-move-etape" onclick="monterEtape('etape-${n}')" title="Monter">‚ñ≤</button>
        <button class="btn-move-etape" onclick="descendreEtape('etape-${n}')" title="Descendre">‚ñº</button>
        <button class="btn-remove-etape" onclick="supprimerEtape(${n})">‚úï Supprimer</button>
      </div>
    </div>
    <div class="etape-body">
      <div class="field">
        <label>Nom de l'√©tape <span class="required">*</span></label>
        <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
          <button type="button" class="format-btn" onclick="toggleFormat('e${n}-nom', 'bold')" title="Gras"><b>B</b></button>
          <button type="button" class="format-btn" onclick="toggleFormat('e${n}-nom', 'italic')" title="Italique"><i>I</i></button>
          <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('e${n}-nom', this.value)" title="Couleur du texte" value="#000000">
          <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('e${n}-nom', this.value)" title="Couleur de surlignage" value="#FFFFFF">
        </div>
        <div id="e${n}-nom" contenteditable="true" class="editable-input" data-placeholder="Ex : Mise en route, Pr√©sentation‚Ä¶">${d.nom||''}</div>
      </div>
      <div class="field">
        <label>D√©roulement de la s√©ance <span class="required">*</span></label>
        <div id="e${n}-enseignant-wrapper" class="quill-wrapper tall"></div>
      </div>
      <div class="field field-duree">
        <label>Dur√©e</label>
        <input type="text" id="e${n}-duree" placeholder="Ex : 10 min" value="${d.duree||''}">
      </div>
    </div>
  `;
  container.appendChild(div);
  
  // Initialiser l'√©diteur Quill pour cette √©tape
  setTimeout(() => {
    initQuillEditor(`e${n}-enseignant-wrapper`, 'Coller ici le d√©roulement complet de la s√©ance : actions de l\'enseignant, t√¢ches des apprenants, consignes, questions, exercices‚Ä¶');
    // Si on restaure des donn√©es, les injecter
    if (d.enseignant) {
      setQuillHTML(`e${n}-enseignant-wrapper`, d.enseignant);
    }
    // Ajouter les champs colonnes suppl√©mentaires si existantes
    rafraichirChampsEtapes();
  }, 0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUILL.JS ‚Äî INITIALISATION DES √âDITEURS RICHES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let quillInstances = {};

// ‚îÄ‚îÄ Enregistrer les polices personnalis√©es dans Quill ‚îÄ‚îÄ
const QuillFont = Quill.import('formats/font');
QuillFont.whitelist = ['times','georgia','merriweather','roboto','lato','opensans','courier'];
Quill.register(QuillFont, true);

let activeQuillWrapper = null;
let toolbarCount = 0;

function initQuillEditor(wrapperId, placeholder = '') {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return null;

  // ‚îÄ‚îÄ Cr√©er la toolbar HTML AVANT Quill, dans le wrapper parent ‚îÄ‚îÄ
  // On ins√®re un div toolbar au-dessus du wrapper, puis on cr√©e un div √©diteur dedans.
  toolbarCount++;
  const tbId = 'ql-tb-' + toolbarCount;
  const edId = 'ql-ed-' + toolbarCount;

  // Vider le wrapper et y injecter toolbar + zone √©diteur
  wrapper.innerHTML = `
    <div id="${tbId}" class="ql-custom-toolbar-wrap">
      <span class="ql-formats">
        <select class="ql-font" title="Police">
          <option selected value="">Sans-s√©rif</option>
          <option value="times">Times Roman</option>
          <option value="georgia">Georgia</option>
          <option value="merriweather">Merriweather</option>
          <option value="roboto">Roboto</option>
          <option value="lato">Lato</option>
          <option value="opensans">Open Sans</option>
          <option value="courier">Courier</option>
        </select>
      </span>
      <span class="ql-formats">
        <select class="ql-header" title="Style d'√©criture">
          <option value="1">Titre 1</option>
          <option value="2">Titre 2</option>
          <option value="3">Titre 3</option>
          <option selected value="">Normal</option>
        </select>
      </span>
      <span class="ql-formats">
        <button class="ql-custom-size" data-size="small"  title="Petit"     type="button" onclick="appliquerTaille('${wrapperId}','small');  return false;"><span style="font-size:9px;font-weight:700;">A</span></button>
        <button class="ql-custom-size" data-size=""        title="Normal"    type="button" onclick="appliquerTaille('${wrapperId}','');       return false;"><span style="font-size:12px;font-weight:700;">A</span></button>
        <button class="ql-custom-size" data-size="large"  title="Grand"     type="button" onclick="appliquerTaille('${wrapperId}','large');  return false;"><span style="font-size:15px;font-weight:700;">A</span></button>
        <button class="ql-custom-size" data-size="huge"   title="Tr√®s grand" type="button" onclick="appliquerTaille('${wrapperId}','huge');   return false;"><span style="font-size:18px;font-weight:700;">A</span></button>
      </span>
      <span class="ql-formats">
        <button class="ql-bold"      title="Gras"></button>
        <button class="ql-italic"    title="Italique"></button>
        <button class="ql-underline" title="Soulign√©"></button>
      </span>
      <span class="ql-formats">
        <select class="ql-color" title="Couleur du texte">
          <option value="#000000"></option>
          <option value="#e60000"></option>
          <option value="#ff9900"></option>
          <option value="#ffff00"></option>
          <option value="#008a00"></option>
          <option value="#0066cc"></option>
          <option value="#9933ff"></option>
          <option value="#ffffff"></option>
          <option value="#facccc"></option>
          <option value="#ffebcc"></option>
          <option value="#ffffcc"></option>
          <option value="#cce8cc"></option>
          <option value="#cce0f5"></option>
          <option value="#ebd6ff"></option>
          <option value="#bbbbbb"></option>
          <option value="#f06666"></option>
          <option value="#ffc266"></option>
          <option value="#ffff66"></option>
          <option value="#66b966"></option>
          <option value="#66a3e0"></option>
          <option value="#c285ff"></option>
          <option value="#888888"></option>
          <option value="#a10000"></option>
          <option value="#b26b00"></option>
          <option value="#b2b200"></option>
          <option value="#006100"></option>
          <option value="#0047b2"></option>
          <option value="#6b24b2"></option>
          <option value="#444444"></option>
          <option value="#5c0000"></option>
          <option value="#663d00"></option>
          <option value="#666600"></option>
          <option value="#003700"></option>
          <option value="#002966"></option>
          <option value="#3d1466"></option>
          <option selected></option>
        </select>
        <select class="ql-background" title="Couleur de surlignage">
          <option value="#000000"></option>
          <option value="#e60000"></option>
          <option value="#ff9900"></option>
          <option value="#ffff00"></option>
          <option value="#008a00"></option>
          <option value="#0066cc"></option>
          <option value="#9933ff"></option>
          <option value="#ffffff"></option>
          <option value="#facccc"></option>
          <option value="#ffebcc"></option>
          <option value="#ffffcc"></option>
          <option value="#cce8cc"></option>
          <option value="#cce0f5"></option>
          <option value="#ebd6ff"></option>
          <option value="#bbbbbb"></option>
          <option value="#f06666"></option>
          <option value="#ffc266"></option>
          <option value="#ffff66"></option>
          <option value="#66b966"></option>
          <option value="#66a3e0"></option>
          <option value="#c285ff"></option>
          <option value="#888888"></option>
          <option value="#a10000"></option>
          <option value="#b26b00"></option>
          <option value="#b2b200"></option>
          <option value="#006100"></option>
          <option value="#0047b2"></option>
          <option value="#6b24b2"></option>
          <option value="#444444"></option>
          <option value="#5c0000"></option>
          <option value="#663d00"></option>
          <option value="#666600"></option>
          <option value="#003700"></option>
          <option value="#002966"></option>
          <option value="#3d1466"></option>
          <option selected></option>
        </select>
      </span>
      <span class="ql-formats">
        <button class="ql-list" value="ordered" title="Liste num√©rot√©e"></button>
        <button class="ql-list" value="bullet"  title="Liste √† puces"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-custom-image"  title="Ins√©rer une image"   type="button" onclick="(function(){ activeQuillWrapper='${wrapperId}'; ouvrirSelecteurImage('${wrapperId}'); })(); return false;">üñº</button>
        <button class="ql-custom-table"  title="Ins√©rer un tableau"  type="button" onclick="(function(){ activeQuillWrapper='${wrapperId}'; ouvrirModalTableau(); })(); return false;">‚äû</button>
        <button class="ql-custom-symbol" title="Ins√©rer un symbole"  type="button" id="sym-btn-${wrapperId}" onclick="(function(btn){ activeQuillWrapper='${wrapperId}'; ouvrirSymbolPicker(btn); })(this); return false;">Œ©</button>
      </span>
      <span class="ql-formats">
        <button class="ql-clean" title="Effacer le formatage"></button>
      </span>
    </div>
    <div id="${edId}"></div>
  `;

  // Initialiser Quill sur le div √©diteur, en pointant vers la toolbar custom
  const quill = new Quill('#' + edId, {
    theme: 'snow',
    modules: {
      toolbar: '#' + tbId
    },
    placeholder: placeholder
  });

  // D√©clencher updateLivePreview quand le contenu change
  quill.on('text-change', function() {
    if (wrapperId === 'objectif-wrapper') {
      updateLivePreview();
    }
  });

  quillInstances[wrapperId] = quill;
  return quill;

}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE ‚Äî S√âLECTION ET INSERTION DANS QUILL

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE ‚Äî S√âLECTION ET INSERTION DANS QUILL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ouvrirSelecteurImage(wrapperId) {
  // Cr√©er un input file temporaire
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/png,image/jpeg,image/gif,image/webp';
  input.style.display = 'none';
  document.body.appendChild(input);
  input.addEventListener('change', function() {
    const file = input.files[0];
    if (!file) { document.body.removeChild(input); return; }
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      insererImageQuill(wrapperId, dataUrl);
      document.body.removeChild(input);
    };
    reader.readAsDataURL(file);
  });
  input.click();
}

function insererImageQuill(wrapperId, dataUrl) {
  const quill = quillInstances[wrapperId];
  if (!quill) return;
  const range = quill.getSelection(true);
  const index = range ? range.index : quill.getLength();
  quill.insertEmbed(index, 'image', dataUrl, Quill.sources.USER);
  quill.setSelection(index + 1, Quill.sources.SILENT);
  // Ouvrir automatiquement le panneau de redimensionnement apr√®s insertion
  setTimeout(() => {
    const imgs = quill.root.querySelectorAll('img');
    const img = imgs[imgs.length - 1];
    if (img) rpOuvrir(img, wrapperId);
  }, 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REDIMENSIONNEMENT D'IMAGE ‚Äî PANNEAU FLOTTANT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _rpImg   = null;   // <img> en cours
let _rpWId   = null;   // wrapperId Quill
let _rpNatW  = 1;      // largeur naturelle originale
let _rpNatH  = 1;      // hauteur naturelle originale
let _rpSavedW = null;  // taille avant ouverture (pour annuler)
let _rpSavedH = null;

function rpOuvrir(imgEl, wrapperId) {
  _rpImg  = imgEl;
  _rpWId  = wrapperId;

  // Charger les dimensions naturelles (stock√©es en data ou lues)
  const tmp = new Image();
  tmp.src = imgEl.src;
  _rpNatW = parseInt(imgEl.getAttribute('data-nat-w')) || tmp.naturalWidth  || imgEl.naturalWidth  || 400;
  _rpNatH = parseInt(imgEl.getAttribute('data-nat-h')) || tmp.naturalHeight || imgEl.naturalHeight || 300;
  // Stocker les dims naturelles sur l'√©l√©ment pour usage futur
  if (!imgEl.getAttribute('data-nat-w')) imgEl.setAttribute('data-nat-w', _rpNatW);
  if (!imgEl.getAttribute('data-nat-h')) imgEl.setAttribute('data-nat-h', _rpNatH);

  // Taille actuelle
  const curW = parseInt(imgEl.getAttribute('data-w') || imgEl.style.width) || _rpNatW;
  const curH = parseInt(imgEl.getAttribute('data-h') || imgEl.style.height) || _rpNatH;
  _rpSavedW = curW; _rpSavedH = curH;

  // Mettre en √©vidence l'image
  document.querySelectorAll('.ql-editor img').forEach(i => i.classList.remove('img-selected'));
  imgEl.classList.add('img-selected');

  // Remplir le panneau
  document.getElementById('rp-dims-orig').textContent = _rpNatW + ' √ó ' + _rpNatH + ' px (original)';
  document.getElementById('rp-px').value = curW;
  document.getElementById('rp-py').value = curH;
  const pct = Math.round((curW / _rpNatW) * 100);
  document.getElementById('rp-range').value = Math.min(pct, 100);
  rpUpdateInfo(curW, curH);
  rpHighlightPreset(pct);

  // Positionner le panneau (fixed, pr√®s de l'image)
  const panel = document.getElementById('img-resize-panel');
  const rect  = imgEl.getBoundingClientRect();
  let top  = rect.bottom + 8;
  let left = rect.left;
  // Garder dans la fen√™tre
  const pw = 270;
  if (left + pw > window.innerWidth - 12) left = window.innerWidth - pw - 12;
  if (left < 8) left = 8;
  if (top + 280 > window.innerHeight) top = Math.max(8, rect.top - 290);
  panel.style.top  = top  + 'px';
  panel.style.left = left + 'px';
  panel.classList.add('show');
}

function rpFermer(apply) {
  if (!apply && _rpImg && _rpSavedW) {
    // Restaurer la taille d'avant
    _rpImg.style.width  = _rpSavedW + 'px';
    _rpImg.style.height = _rpSavedH + 'px';
  }
  document.querySelectorAll('.ql-editor img').forEach(i => i.classList.remove('img-selected'));
  document.getElementById('img-resize-panel').classList.remove('show');
  _rpImg = null; _rpWId = null;
}

function rpAppliquer() {
  if (!_rpImg) { rpFermer(true); return; }
  const w = parseInt(document.getElementById('rp-px').value) || _rpNatW;
  const h = parseInt(document.getElementById('rp-py').value) || _rpNatH;
  _rpImg.style.width  = w + 'px';
  _rpImg.style.height = h + 'px';
  _rpImg.setAttribute('data-w', w);
  _rpImg.setAttribute('data-h', h);
  // Forcer la mise √† jour Quill
  const quill = _rpWId ? quillInstances[_rpWId] : null;
  if (quill) quill.update();
  rpFermer(true);
}

function rpUpdateFromRange(pct) {
  const w = Math.max(10, Math.round((parseInt(pct) / 100) * _rpNatW));
  const h = Math.round(w * (_rpNatH / (_rpNatW || 1)));
  document.getElementById('rp-px').value = w;
  document.getElementById('rp-py').value = h;
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(parseInt(pct));
}

function rpUpdateFromPx(val) {
  const w = Math.max(10, parseInt(val) || 10);
  const h = Math.round(w * (_rpNatH / (_rpNatW || 1)));
  document.getElementById('rp-py').value = h;
  const pct = Math.round((w / _rpNatW) * 100);
  document.getElementById('rp-range').value = Math.min(pct, 100);
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(pct);
}

function rpUpdateFromPy(val) {
  const h = Math.max(10, parseInt(val) || 10);
  const w = Math.round(h * (_rpNatW / (_rpNatH || 1)));
  document.getElementById('rp-px').value = w;
  const pct = Math.round((w / _rpNatW) * 100);
  document.getElementById('rp-range').value = Math.min(pct, 100);
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(pct);
}

function rpSetPct(pct) {
  const w = Math.round((pct / 100) * _rpNatW);
  const h = Math.round(w * (_rpNatH / (_rpNatW || 1)));
  document.getElementById('rp-px').value    = w;
  document.getElementById('rp-py').value    = h;
  document.getElementById('rp-range').value = pct;
  rpPreviewLive(w, h);
  rpUpdateInfo(w, h);
  rpHighlightPreset(pct);
}

function rpPreviewLive(w, h) {
  if (!_rpImg) return;
  _rpImg.style.width  = w + 'px';
  _rpImg.style.height = h + 'px';
}

function rpUpdateInfo(w, h) {
  document.getElementById('rp-preview-size').textContent =
    'Aper√ßu : ' + w + ' √ó ' + h + ' px';
}

function rpHighlightPreset(pct) {
  document.querySelectorAll('#img-resize-panel .rp-pre').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.textContent) === pct);
  });
}

// √âcoute globale : clic sur image Quill ‚Üí ouvrir panneau
document.addEventListener('click', function(e) {
  const target = e.target;
  const panel  = document.getElementById('img-resize-panel');
  if (target.tagName === 'IMG' && target.closest('.ql-editor')) {
    e.preventDefault(); e.stopPropagation();
    const wrapper = target.closest('.quill-wrapper');
    rpOuvrir(target, wrapper ? wrapper.id : null);
    return;
  }
  // Fermer si clic hors panneau et hors image
  if (panel && panel.classList.contains('show') && !panel.contains(target) && target.tagName !== 'IMG') {
    rpFermer(false);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABLEAU ‚Äî MODAL ET INSERTION DANS QUILL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ouvrirModalTableau() {
  document.getElementById('modal-tableau').classList.add('show');
}

function fermerModalTableau() {
  document.getElementById('modal-tableau').classList.remove('show');
}

// Fermer le modal en cliquant l'overlay
document.getElementById('modal-tableau').addEventListener('click', function(e) {
  if (e.target === this) fermerModalTableau();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// S√âLECTEUR DE SYMBOLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SYMBOLES = {
  fleches: {
    label: 'Fl√®ches',
    groupes: [
      { titre: 'Directions simples', syms: ['‚Üí','‚Üê','‚Üë','‚Üì','‚Üî','‚Üï','‚Üó','‚Üò','‚Üô','‚Üñ'] },
      { titre: 'Doubles', syms: ['‚áí','‚áê','‚áë','‚áì','‚áî','‚áï','‚áó','‚áò'] },
      { titre: 'Longues', syms: ['‚ü∂','‚üµ','‚ü∑','‚üπ','‚ü∏','‚ü∫'] },
      { titre: 'Stylis√©es', syms: ['‚ûú','‚û°','‚û¢','‚û§','‚û•','‚û¶','‚ûß','‚û®','‚û©','‚û™','‚û´','‚û¨','‚û≠','‚ûÆ','‚ûØ','‚û±'] },
      { titre: 'Triangles / Pointeurs', syms: ['‚ñ∂','‚óÄ','‚ñ≤','‚ñº','‚ñ∫','‚óÑ','‚ñ∏','‚óÇ','‚ñ¥','‚ñæ','‚ä≥','‚ä≤'] },
      { titre: 'Courb√©es / Sp√©ciales', syms: ['‚Ü©','‚Ü™','‚Ü´','‚Ü¨','‚Ü≠','‚Ü∞','‚Ü±','‚Ü≤','‚Ü≥','‚Ü¥','‚Üµ','‚Ü∑','‚Ü∂','‚ü≥','‚ü≤','‚Ü∫','‚Üª'] },
    ]
  },
  puces: {
    label: 'Puces & Listes',
    groupes: [
      { titre: 'Puces classiques', syms: ['‚Ä¢','‚ó¶','‚ñ™','‚ñ´','‚ñ∏','‚ñπ','‚Ä£','‚ÅÉ','‚¶æ','‚¶ø'] },
      { titre: 'Carr√©s & Rectangles', syms: ['‚ñ†','‚ñ°','‚ñ™','‚ñ´','‚ñ¨','‚ñ≠','‚ñÆ','‚ñØ','‚óº','‚óª','‚óæ','‚óΩ'] },
      { titre: 'Cercles & Ovales', syms: ['‚óè','‚óã','‚óâ','‚óé','‚óå','‚óç','‚óî','‚óï','‚¨§','‚≠ï'] },
      { titre: 'Losanges & √âtoiles', syms: ['‚óÜ','‚óá','‚óà','‚¨•','‚¨¶','‚ùñ','‚ú¶','‚úß','‚ú∂','‚ú∑'] },
      { titre: 'Coches & Croix', syms: ['‚úì','‚úî','‚úó','‚úò','‚òë','‚òí','‚úÖ','‚ùå','‚ùé','‚òê'] },
    ]
  },
  maths: {
    label: 'Math√©matiques',
    groupes: [
      { titre: 'Op√©rateurs', syms: ['¬±','√ó','√∑','¬∑','‚àô','‚àö','‚àõ','‚àú','‚àû','%','‚Ä∞','‚Ä±'] },
      { titre: 'Relations', syms: ['=','‚â†','‚â°','‚â¢','‚âà','‚ââ','‚â§','‚â•','‚â™','‚â´','‚â∫','‚âª','‚äÇ','‚äÉ','‚äÑ','‚äÖ','‚äÜ','‚äá'] },
      { titre: 'Logique & Ensembles', syms: ['‚àß','‚à®','¬¨','‚àÄ','‚àÉ','‚àÑ','‚àÖ','‚à©','‚à™','‚àà','‚àâ','‚àã','‚àå'] },
      { titre: 'Lettres grecques', syms: ['Œ±','Œ≤','Œ≥','Œ¥','Œµ','Œ∂','Œ∑','Œ∏','Œπ','Œ∫','Œª','Œº','ŒΩ','Œæ','œÄ','œÅ','œÉ','œÑ','œÖ','œÜ','œá','œà','œâ','Œî','Œ£','Œ†','Œ©'] },
      { titre: 'Calcul', syms: ['‚àÇ','‚àá','‚à´','‚à¨','‚à≠','‚àÆ','‚àë','‚àè','‚àê','‚åÄ','‚åÅ'] },
      { titre: 'Fractions', syms: ['¬Ω','‚Öì','‚Öî','¬º','¬æ','‚Öï','‚Öñ','‚Öó','‚Öò','‚Öô','‚Öö','‚Öõ','‚Öú','‚Öù','‚Öû'] },
    ]
  },
  etoiles: {
    label: '√âtoiles & Formes',
    groupes: [
      { titre: '√âtoiles', syms: ['‚òÖ','‚òÜ','‚ú©','‚ú™','‚ú´','‚ú¨','‚ú≠','‚úÆ','‚úØ','‚ú∞','‚≠ê','üåü'] },
      { titre: 'C≈ìurs', syms: ['‚ô•','‚ô°','‚ù§','‚ù•','‚ù£','‚ù¶','‚ùß','üíô','üíö','üíõ','üíú','üñ§'] },
      { titre: 'Fleurs & Nature', syms: ['‚úø','‚ùÄ','‚ùÅ','‚ùÇ','‚ùÉ','‚úæ','‚öò','‚òò','üåø','üçÄ'] },
      { titre: 'Symboles divers', syms: ['‚òÄ','‚òÅ','‚òÇ','‚òÉ','‚òÑ','‚ö°','‚ö°','‚òé','‚úâ','‚úÇ','‚úè','‚úí','üîë','üîí','üîì'] },
      { titre: 'M√©dailles & Troph√©es', syms: ['üèÜ','ü•á','ü•à','ü•â','üéñ','üèÖ','üéó','üéØ','üé™','üé®'] },
    ]
  },
  ponctuation: {
    label: 'Ponctuation',
    groupes: [
      { titre: 'Guillemets', syms: ['¬´','¬ª','‚Äπ','‚Ä∫','"','"','‚Äû','‚Äü','‚Äö','\'','\u2018','\u2019'] },
      { titre: 'Tirets & Traits', syms: ['‚Äì','‚Äî','‚Äï','‚Äí','‚Äë','‚Äê','-','_','~','‚âà','‚â°'] },
      { titre: 'Points & Ellipses', syms: ['‚Ä¶','¬∑','‚Ä¢','‚Ä•','‚ÅÄ','‚Åê','‚Åì'] },
      { titre: 'Symboles sp√©ciaux', syms: ['¬©','¬Æ','‚Ñ¢','‚ÑÉ','‚Ñâ','¬∞','‚Ññ','‚Ñó','‚Ñ†','‚Ñ°'] },
      { titre: 'Monnaies', syms: ['‚Ç¨','¬£','¬•','¬¢','‚Çπ','‚ÇΩ','‚Çø','‚Ç∫','‚Ç©','‚Ç™'] },
    ]
  },
  exposants: {
    label: 'Exp. & Indices',
    groupes: [
      { titre: 'Exposants chiffres', syms: ['‚Å∞','¬π','¬≤','¬≥','‚Å¥','‚Åµ','‚Å∂','‚Å∑','‚Å∏','‚Åπ'] },
      { titre: 'Exposants lettres', syms: ['·µÉ','·µá','·∂ú','·µà','·µâ','·∂†','·µç',' ∞','‚Å±',' ≤','·µè','À°','·µê','‚Åø','·µí','·µñ',' ≥','À¢','·µó','·µò','·µõ',' ∑','À£',' ∏','·∂ª'] },
      { titre: 'Indices chiffres', syms: ['‚ÇÄ','‚ÇÅ','‚ÇÇ','‚ÇÉ','‚ÇÑ','‚ÇÖ','‚ÇÜ','‚Çá','‚Çà','‚Çâ'] },
      { titre: 'Indices lettres', syms: ['‚Çê','‚Çë','‚Çí','‚Çì','‚Çô','‚Çò','‚Çñ','‚Çú','‚Çõ','·µ¢','·µ§','·µ•'] },
    ]
  }
};

let activeSymTab = 'fleches';
let symPickerBtnEl = null;

function showSymTab(tabId, btnEl) {
  activeSymTab = tabId;
  // Mettre √† jour les onglets actifs
  document.querySelectorAll('.sym-tab').forEach(b => b.classList.remove('active'));
  btnEl.classList.add('active');
  renderSymTab(tabId);
}

function renderSymTab(tabId) {
  const body = document.getElementById('sym-body');
  const data = SYMBOLES[tabId];
  if (!data) return;
  let html = '';
  data.groupes.forEach(grp => {
    html += `<div class="sym-label">${grp.titre}</div>`;
    html += `<div class="sym-grid">`;
    grp.syms.forEach(sym => {
      // Encoder le symbole pour l'attribut data
      html += `<button class="sym-btn" title="${sym}" type="button" onclick="insererSymbole(this.dataset.sym)" data-sym="${encodeURIComponent(sym)}">${sym}</button>`;
    });
    html += `</div>`;
  });
  body.innerHTML = html;
}

// ‚îÄ‚îÄ TAILLE DE POLICE VIA BOUTONS A ‚îÄ‚îÄ
function appliquerTaille(wrapperId, size) {
  const quill = quillInstances[wrapperId];
  if (!quill) return;
  const selection = quill.getSelection(true);
  if (selection && selection.length > 0) {
    quill.format('size', size || false);
  } else {
    quill.format('size', size || false);
  }
  // Feedback visuel : marquer le bouton actif
  const wrapper = document.getElementById(wrapperId);
  if (wrapper) {
    wrapper.querySelectorAll('.ql-custom-size').forEach(btn => {
      btn.style.background = btn.dataset.size === size ? '#E3F2FD' : '';
      btn.style.borderColor = btn.dataset.size === size ? '#1565C0' : '';
    });
  }
}

function ouvrirSymbolPicker(btnEl) {
  const picker = document.getElementById('symbol-picker');
  const isOpen = picker.classList.contains('show');

  // Retirer la classe active de tous les anciens boutons Œ©
  document.querySelectorAll('.ql-custom-symbol').forEach(b => b.classList.remove('active'));

  if (isOpen && symPickerBtnEl === btnEl) {
    // D√©j√† ouvert sur ce bouton ‚Üí fermer
    fermerSymbolPicker();
    return;
  }

  symPickerBtnEl = btnEl;
  btnEl.classList.add('active');

  // Rendre le contenu de l'onglet actif
  renderSymTab(activeSymTab);

  // Positionner le panneau sous le bouton
  const rect = btnEl.getBoundingClientRect();
  const pickerW = 300;
  const pickerH = 380;
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  let left = rect.left;
  let top = rect.bottom + 4;

  // Ajustement horizontal si d√©bordement
  if (left + pickerW > vw - 8) left = vw - pickerW - 8;
  if (left < 8) left = 8;

  // Ajustement vertical : si pas assez de place en bas, afficher au-dessus
  if (top + pickerH > vh - 8) top = rect.top - pickerH - 4;
  if (top < 8) top = 8;

  picker.style.left = left + 'px';
  picker.style.top = top + 'px';
  picker.classList.add('show');

  // Fermer si clic en dehors (avec un l√©ger d√©lai pour √©viter l'auto-fermeture)
  setTimeout(() => {
    document.addEventListener('mousedown', fermerSymPickerSiExterieur);
    document.addEventListener('touchstart', fermerSymPickerSiExterieur, { passive: true });
  }, 100);
}

function fermerSymPickerSiExterieur(e) {
  const picker = document.getElementById('symbol-picker');
  if (!picker.contains(e.target) && e.target !== symPickerBtnEl) {
    fermerSymbolPicker();
  }
}

function fermerSymbolPicker() {
  const picker = document.getElementById('symbol-picker');
  picker.classList.remove('show');
  if (symPickerBtnEl) symPickerBtnEl.classList.remove('active');
  symPickerBtnEl = null;
  document.removeEventListener('mousedown', fermerSymPickerSiExterieur);
  document.removeEventListener('touchstart', fermerSymPickerSiExterieur);
}

function insererSymbole(encodedSym) {
  const sym = decodeURIComponent(encodedSym);
  const quill = quillInstances[activeQuillWrapper];
  if (!quill) return;
  const range = quill.getSelection(true);
  const index = range ? range.index : quill.getLength();
  quill.insertText(index, sym, Quill.sources.USER);
  quill.setSelection(index + sym.length, Quill.sources.SILENT);
  // Ne pas fermer ‚Üí permet d'ins√©rer plusieurs symboles √† la suite
}

function insererTableauQuill() {
  const cols   = Math.max(1, Math.min(10, parseInt(document.getElementById('tbl-cols').value)  || 3));
  const rows   = Math.max(1, Math.min(20, parseInt(document.getElementById('tbl-rows').value)  || 3));
  const header = document.getElementById('tbl-header').checked;

  const quill = quillInstances[activeQuillWrapper];
  if (!quill) { fermerModalTableau(); return; }

  // Construire le HTML du tableau
  let html = '<table><tbody>';
  for (let r = 0; r < rows; r++) {
    html += '<tr>';
    for (let c = 0; c < cols; c++) {
      if (r === 0 && header) {
        html += '<th style="border:1.5px solid #1565C0;padding:5px 8px;background:#E3F2FD;font-weight:700;text-align:center;">En-t√™te ' + (c+1) + '</th>';
      } else {
        html += '<td style="border:1.5px solid #1565C0;padding:5px 8px;min-width:50px;">&nbsp;</td>';
      }
    }
    html += '</tr>';
  }
  html += '</tbody></table><p><br></p>';

  // Ins√©rer √† la position courante
  const range = quill.getSelection(true);
  const index = range ? range.index : quill.getLength();
  quill.clipboard.dangerouslyPasteHTML(index, html, Quill.sources.USER);
  quill.setSelection(index + 1, Quill.sources.SILENT);

  fermerModalTableau();
}

// Fonction pour obtenir le HTML d'un √©diteur Quill
function getQuillHTML(wrapperId) {
  const quill = quillInstances[wrapperId];
  if (!quill) return '';
  return quill.root.innerHTML;
}

// Fonction pour obtenir le texte brut d'un √©diteur Quill
function getQuillText(wrapperId) {
  const quill = quillInstances[wrapperId];
  if (!quill) return '';
  return quill.getText().trim();
}

// Fonction pour d√©finir le contenu HTML d'un √©diteur Quill
function setQuillHTML(wrapperId, html) {
  const quill = quillInstances[wrapperId];
  if (!quill) return;
  if (html) {
    quill.root.innerHTML = html;
  }
}

// Initialiser l'√©diteur Quill pour l'objectif au chargement
document.addEventListener('DOMContentLoaded', function() {
  initQuillEditor('objectif-wrapper', 'Objectif de la s√©ance‚Ä¶');
});


function supprimerEtape(n) {
  const el = document.getElementById('etape-' + n);
  if (el) el.remove();
  mettreAJourNumeros();
  calculerDureeTotale();
  sauvegarderAutomatique();
}

// ‚îÄ‚îÄ MONTER / DESCENDRE UNE √âTAPE ‚îÄ‚îÄ
function monterEtape(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const prev = el.previousElementSibling;
  if (prev && prev.classList.contains('etape-card')) {
    el.parentNode.insertBefore(el, prev);
    mettreAJourNumeros();
    sauvegarderAutomatique();
  }
}
function descendreEtape(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const next = el.nextElementSibling;
  if (next && next.classList.contains('etape-card')) {
    el.parentNode.insertBefore(next, el);
    mettreAJourNumeros();
    sauvegarderAutomatique();
  }
}
// Recalculer les num√©ros affich√©s apr√®s d√©placement
function mettreAJourNumeros() {
  document.querySelectorAll('.etape-card').forEach((card, i) => {
    const num = card.querySelector('.etape-num');
    if (num) num.textContent = i + 1;
  });
}

// ‚îÄ‚îÄ CALCUL DUR√âE TOTALE ‚îÄ‚îÄ
function calculerDureeTotale() {
  let totalMin = 0;
  let hasVal = false;
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    const dureeStr = (document.getElementById('e' + id + '-duree')?.value || '').trim();
    if (!dureeStr) return;
    const match = dureeStr.match(/(\d+[\.,]?\d*)/);
    if (match) {
      totalMin += parseFloat(match[1].replace(',', '.'));
      hasVal = true;
    }
  });
  const el = document.getElementById('duree-totale-val');
  if (!el) return;
  if (!hasVal) { el.textContent = '‚Äî'; return; }
  if (totalMin >= 60) {
    const h = Math.floor(totalMin / 60);
    const m = Math.round(totalMin % 60);
    el.textContent = m > 0 ? `${h}h${String(m).padStart(2,'0')} (${Math.round(totalMin)} min)` : `${h}h00 (${Math.round(totalMin)} min)`;
  } else {
    el.textContent = `${Math.round(totalMin)} min`;
  }
}

// ‚îÄ‚îÄ SAUVEGARDE AUTOMATIQUE (localStorage) ‚îÄ‚îÄ
const SAVE_KEY = 'fiche_ped_autosave';

function sauvegarderAutomatique() {
  try {
    const data = collecterTout();
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    afficherStatutSauvegarde('‚úÖ Sauvegard√© automatiquement', '#2E7D32');
  } catch(e) { /* silencieux */ }
}

function afficherStatutSauvegarde(msg, color) {
  const bar = document.getElementById('save-bar');
  const st  = document.getElementById('save-status');
  if (!bar || !st) return;
  bar.style.display = 'flex';
  st.textContent = msg;
  st.style.color = color;
}

function collecterTout() {
  const etapes = [];
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    etapes.push({
      nom:       document.getElementById('e' + id + '-nom')?.value || '',
      enseignant: getQuillHTML('e' + id + '-enseignant-wrapper') || '',
      duree:     document.getElementById('e' + id + '-duree')?.value || ''
    });
  });
  return {
    v: 2,
    entete: {
      prof:     document.getElementById('prof')?.value || '',
      niveau:   document.getElementById('niveau')?.value || '',
      module:   document.getElementById('module')?.value || '',
      sequence: document.getElementById('sequence')?.value || '',
      activite: document.getElementById('activite')?.value || '',
      support:  document.getElementById('support')?.value || '',
      objectif: getQuillHTML('objectif-wrapper') || ''
    },
    etapes,
    params: {
      marge:           document.getElementById('p-marge')?.value || '8.5',
      gap:             document.getElementById('p-gap')?.value || '5',
      fontEnteteLabel: document.getElementById('p-font-entete-label')?.value || '11',
      fontEnteteContent:document.getElementById('p-font-entete-content')?.value || '10',
      fontTableHeader: document.getElementById('p-font-table-header')?.value || '10',
      fontTableContent:document.getElementById('p-font-table-content')?.value || '9',
      rowHeight:       document.getElementById('p-row-height')?.value || '8',
      tableHeaderH:    document.getElementById('p-table-header-h')?.value || '18',
      headerH:         document.getElementById('p-header-h')?.value || '100',
      l1h:             document.getElementById('p-l1h')?.value || '22',
      l234h:           document.getElementById('p-l234h')?.value || '18',
      l5h:             document.getElementById('p-l5h')?.value || '40',
      sep1:            document.getElementById('p-sep1')?.value || '32',
      sep2:            document.getElementById('p-sep2')?.value || '60',
      col1:            document.getElementById('p-col1')?.value || '20',
      col2:            document.getElementById('p-col2')?.value || '65',
      colorMain:       document.getElementById('p-color-main')?.value || '#1565C0',
      colorAccent:     document.getElementById('p-color-accent')?.value || '#C9A84C',
      colorGrid:       document.getElementById('p-color-grid')?.value || '#AAAAAA',
      colorEtapeText:  document.getElementById('p-color-etape-text')?.value || '#1565C0',
      labelColEtapes:  document.getElementById('label-col-etapes')?.value || '√âtapes',
      labelColDerou:   document.getElementById('label-col-deroulement')?.value || 'D√©roulement de la s√©ance',
      labelColDuree:   document.getElementById('label-col-duree')?.value || 'Dur√©e'
    },
    savedAt: new Date().toLocaleString('fr-FR')
  };
}

function restaurerFiche(data) {
  if (!data) return;
  // En-t√™te ‚Äî champs contenteditable
  const e = data.entete || {};
  const setContent = (id, val) => {
    var el = document.getElementById(id);
    if (!el || val === undefined) return;
    if (el.contentEditable === 'true') el.innerHTML = val;
    else el.value = val;
  };
  setContent('prof',     e.prof);
  setContent('niveau',   e.niveau);
  setContent('module',   e.module);
  setContent('sequence', e.sequence);
  setContent('activite', e.activite);
  setContent('support',  e.support);
  if (e.objectif) setTimeout(() => setQuillHTML('objectif-wrapper', e.objectif), 200);
  // √âtapes
  if (data.etapes && data.etapes.length > 0) {
    document.getElementById('etapes-container').innerHTML = '';
    etapeCount = 0;
    data.etapes.forEach(et => ajouterEtape(et));
  }
  // Param√®tres
  const p = data.params || {};
  const setVal = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined) el.value = val; };
  setVal('p-marge', p.marge); setVal('p-gap', p.gap);
  setVal('p-font-entete-label', p.fontEnteteLabel); setVal('p-font-entete-content', p.fontEnteteContent);
  setVal('p-font-table-header', p.fontTableHeader); setVal('p-font-table-content', p.fontTableContent);
  setVal('p-row-height', p.rowHeight); setVal('p-table-header-h', p.tableHeaderH);
  setVal('p-header-h', p.headerH); setVal('p-l1h', p.l1h); setVal('p-l234h', p.l234h); setVal('p-l5h', p.l5h);
  setVal('p-sep1', p.sep1); setVal('p-sep2', p.sep2);
  setVal('p-col1', p.col1); setVal('p-col2', p.col2);
  setVal('p-color-main', p.colorMain); setVal('p-color-accent', p.colorAccent);
  setVal('p-color-grid', p.colorGrid); setVal('p-color-etape-text', p.colorEtapeText);
  setVal('label-col-etapes', p.labelColEtapes); setVal('label-col-deroulement', p.labelColDerou);
  setVal('label-col-duree', p.labelColDuree);
  if (p.colorMain) applyThemePreview();
  updateLivePreview();
  calculerDureeTotale();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// R√âPERTOIRE DES FICHES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REP_KEY = 'fiche_ped_repertoire';

function lireRepertoire() {
  try {
    return JSON.parse(localStorage.getItem(REP_KEY) || '[]');
  } catch(e) { return []; }
}

function ecrireRepertoire(fiches) {
  localStorage.setItem(REP_KEY, JSON.stringify(fiches));
}

function enregistrerDansRepertoire() {
  const entete   = collecterEntete();
  const etapes   = collecterEtapes();
  const activite = entete.activite || entete.module || 'Sans titre';
  const niveau   = entete.niveau   || '';

  // Demander un nom pour la fiche
  const nomSuggere = [activite, niveau].filter(Boolean).join(' ‚Äî ');
  const nom = prompt('üíæ Nom de la fiche √† enregistrer :', nomSuggere);
  if (nom === null) return; // annul√©
  const nomFinal = nom.trim() || nomSuggere || 'Fiche sans titre';

  const fiches = lireRepertoire();

  // V√©rifier si une fiche avec ce nom existe d√©j√†
  const existant = fiches.findIndex(f => f.nom === nomFinal);
  if (existant !== -1) {
    if (!confirm(`‚ö†Ô∏è Une fiche nomm√©e "${nomFinal}" existe d√©j√†.\nVoulez-vous la remplacer ?`)) return;
    fiches.splice(existant, 1);
  }

  const data = collecterTout();
  data.nom     = nomFinal;
  data.savedAt = new Date().toLocaleString('fr-FR');

  // R√©sum√© lisible
  const totalMin = etapes.reduce((s, e) => {
    const m = (e.duree || '').match(/(\d+[\.,]?\d*)/);
    return s + (m ? parseFloat(m[1].replace(',','.')) : 0);
  }, 0);
  data.resume = `${etapes.length} √©tape${etapes.length>1?'s':''} ¬∑ ${totalMin>0?totalMin+' min':'dur√©e non d√©finie'}`;
  data.niveau  = niveau;
  data.module  = entete.module || '';

  fiches.unshift(data); // plus r√©cent en premier
  ecrireRepertoire(fiches);

  // Feedback
  afficherStatutSauvegarde(`‚úÖ Fiche "${nomFinal}" enregistr√©e dans le r√©pertoire !`, '#2E7D32');
  // Badge onglet
  mettreAJourBadgeRepertoire();
}

function afficherRepertoire() {
  const fiches  = lireRepertoire();
  const liste   = document.getElementById('repertoire-liste');
  const compteur = document.getElementById('rep-compteur');
  if (!liste) return;

  if (compteur) compteur.textContent = fiches.length + ' fiche' + (fiches.length > 1 ? 's' : '');

  if (fiches.length === 0) {
    liste.innerHTML = `<div class="repertoire-empty">
      <div style="font-size:40px;margin-bottom:8px;">üìÇ</div>
      <div>Aucune fiche enregistr√©e.</div>
      <div style="font-size:12px;margin-top:6px;color:#bbb;">Utilisez le bouton <strong>üíæ Enregistrer la fiche</strong><br>depuis l'onglet √âtapes ou Aper√ßu.</div>
    </div>`;
    return;
  }

  liste.innerHTML = fiches.map((f, i) => `
    <div class="repertoire-card">
      <div class="repertoire-card-header">
        <div class="repertoire-card-title">üìã ${f.nom || 'Fiche ' + (i+1)}</div>
        <div class="repertoire-card-date">üïê ${f.savedAt || '‚Äî'}</div>
      </div>
      <div class="repertoire-card-body">
        ${f.niveau ? `<span style="background:#E3F2FD;color:#1565C0;border-radius:4px;padding:1px 7px;font-size:11px;font-weight:600;margin-right:6px;">${f.niveau}</span>` : ''}
        ${f.module ? `<span style="color:#555;">${f.module}</span>` : ''}
        <br><span style="color:#888;font-size:11px;">${f.resume || ''}</span>
      </div>
      <div class="repertoire-card-actions">
        <button class="btn-rep btn-rep-ouvrir" onclick="ouvrirFicheRepertoire(${i})">üìÇ Ouvrir</button>
        <button class="btn-rep" onclick="dupliquerFicheRepertoire(${i})" style="background:#E8F5E9;color:#2E7D32;border:1px solid #C8E6C9;">üìã Dupliquer</button>
        <button class="btn-rep btn-rep-suppr" onclick="supprimerFicheRepertoire(${i})">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  `).join('');
}

function ouvrirFicheRepertoire(index) {
  const fiches = lireRepertoire();
  const f = fiches[index];
  if (!f) return;
  if (!confirm(`üìÇ Ouvrir la fiche "${f.nom}" ?\nLe contenu actuel sera remplac√©.`)) return;
  restaurerFiche(f);
  showTab('etapes');
  afficherStatutSauvegarde(`üìÇ Fiche "${f.nom}" ouverte`, '#1565C0');
}

function dupliquerFicheRepertoire(index) {
  const fiches = lireRepertoire();
  const f = JSON.parse(JSON.stringify(fiches[index])); // copie profonde
  f.nom     = f.nom + ' (copie)';
  f.savedAt = new Date().toLocaleString('fr-FR');
  fiches.splice(index + 1, 0, f);
  ecrireRepertoire(fiches);
  afficherRepertoire();
  mettreAJourBadgeRepertoire();
}

function supprimerFicheRepertoire(index) {
  const fiches = lireRepertoire();
  const f = fiches[index];
  if (!confirm(`üóëÔ∏è Supprimer la fiche "${f.nom}" ?\nCette action est irr√©versible.`)) return;
  fiches.splice(index, 1);
  ecrireRepertoire(fiches);
  afficherRepertoire();
  mettreAJourBadgeRepertoire();
}

function mettreAJourBadgeRepertoire() {
  const n = lireRepertoire().length;
  const btn = document.getElementById('tab-repertoire');
  if (!btn) return;
  // Afficher un badge num√©rique sur l'onglet si des fiches existent
  const existing = btn.querySelector('.rep-badge');
  if (existing) existing.remove();
  if (n > 0) {
    const badge = document.createElement('span');
    badge.className = 'rep-badge';
    badge.style.cssText = 'background:#C9A84C;color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700;margin-left:4px;';
    badge.textContent = n;
    btn.appendChild(badge);
  }
}

// ‚îÄ‚îÄ NOUVELLE FICHE (remise √† z√©ro compl√®te) ‚îÄ‚îÄ
function nouvelleFiche() {
  if (!confirm('üîÑ Commencer une nouvelle fiche ?\n\nLe contenu actuel sera effac√©.\n‚ö†Ô∏è Pensez √† l\'enregistrer dans le r√©pertoire si vous voulez le conserver.')) return;

  // R√©initialiser les champs de l'en-t√™te (sauf le prof)
  ['niveau','module','sequence','activite','support'].forEach(id => {
    var el = document.getElementById(id);
    if (!el) return;
    if (el.contentEditable === 'true') el.innerHTML = '';
    else el.value = '';
  });
  // Vider l'objectif
  setQuillHTML('objectif-wrapper', '');

  // Supprimer toutes les √©tapes et repartir sur les √©tapes par d√©faut
  document.getElementById('etapes-container').innerHTML = '';
  etapeCount = 0;
  ajouterEtape({ nom:'Mise en route', enseignant:'', duree:'5 min' });
  ajouterEtape({ nom:'Pr√©sentation',  enseignant:'', duree:'15 min' });
  ajouterEtape({ nom:'Entra√Ænement',  enseignant:'', duree:'20 min' });
  ajouterEtape({ nom:'Production',    enseignant:'', duree:'10 min' });
  ajouterEtape({ nom:'Cl√¥ture',       enseignant:'', duree:'5 min' });
  setTimeout(calculerDureeTotale, 300);

  // Effacer la sauvegarde automatique
  try { localStorage.removeItem(SAVE_KEY); } catch(e) {}

  // Mettre √† jour l'aper√ßu live de l'en-t√™te
  updateLivePreview();

  // Retourner sur l'onglet En-t√™te
  showTab('entete');

  afficherStatutSauvegarde('üîÑ Nouvelle fiche ‚Äî contenu r√©initialis√©', '#1565C0');
}

// ‚îÄ‚îÄ PARAM√àTRES PAR D√âFAUT ‚îÄ‚îÄ
function reinitialiserParams() {
  if (!confirm('üîÑ Remettre tous les param√®tres √† leurs valeurs par d√©faut ?\nLes couleurs et les labels seront aussi r√©initialis√©s.')) return;
  const defs = {
    'p-marge':'8.5','p-gap':'5',
    'p-font-entete-label':'11','p-font-entete-content':'10',
    'p-font-table-header':'10','p-font-table-content':'9',
    'p-row-height':'8','p-table-header-h':'18',
    'p-header-h':'100','p-l1h':'22','p-l234h':'18','p-l5h':'40',
    'p-sep1':'32','p-sep2':'60',
    'p-col1':'20','p-col2':'65',
    'p-color-main':'#1565C0','p-color-accent':'#C9A84C',
    'p-color-grid':'#AAAAAA','p-color-etape-text':'#1565C0',
    'label-col-etapes':'√âtapes',
    'label-col-deroulement':'D√©roulement de la s√©ance',
    'label-col-duree':'Dur√©e'
  };
  Object.entries(defs).forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) el.value = val;
  });
  applyThemePreview();
  // Feedback visuel
  const btn = event?.target?.closest('button');
  if (btn) { btn.textContent = '‚úÖ R√©initialis√© !'; setTimeout(() => { btn.innerHTML = 'üîÑ Param√®tres par d√©faut'; }, 1500); }
}

// ‚îÄ‚îÄ RESTAURATION AU D√âMARRAGE ‚îÄ‚îÄ
(function chargerSauvegardeAuDemarrage() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data || !data.v) return;
    setTimeout(() => {
      restaurerFiche(data);
      afficherStatutSauvegarde(`‚úÖ Fiche restaur√©e (sauvegard√©e le ${data.savedAt || '?'})`, '#2E7D32');
      mettreAJourBadgeRepertoire();
    }, 400);
  } catch(e) { /* silencieux */ }
})();

function collecterEtapes() {
  const colsSup = collecterColonnesSup();
  const etapes = [];
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    const nom = (document.getElementById('e'+id+'-nom')?.innerHTML || '').trim();
    const enseignantHTML = getQuillHTML('e'+id+'-enseignant-wrapper');
    const enseignant = getQuillText('e'+id+'-enseignant-wrapper');
    const duree = (document.getElementById('e'+id+'-duree')?.value || '').trim();
    // Collecter les valeurs des colonnes suppl√©mentaires
    const supVals = {};
    colsSup.forEach(col => {
      supVals[col.n] = (document.getElementById('e'+id+'-colsup-'+col.n)?.value || '').trim();
    });
    if (nom || enseignant) {
      etapes.push({ nom, enseignant: enseignantHTML || enseignant, duree, supVals });
    }
  });
  return etapes;
}

// √âtapes exemples par d√©faut
ajouterEtape({ nom:'Mise en route', enseignant:'', duree:'5 min' });
ajouterEtape({ nom:'Pr√©sentation', enseignant:'', duree:'15 min' });
ajouterEtape({ nom:'Entra√Ænement', enseignant:'', duree:'20 min' });
ajouterEtape({ nom:'Production', enseignant:'', duree:'10 min' });
ajouterEtape({ nom:'Cl√¥ture', enseignant:'', duree:'5 min' });
setTimeout(calculerDureeTotale, 300);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APER√áU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rafraichirApercu() {
  const entete = collecterEntete();
  const etapes = collecterEtapes();
  const P = collecterParams();

  // R√©sum√© avec labels personnalis√©s
  let summary = `<strong>üìã ${entete[entete.labelNiveau ? 'niveau' : 'niveau'] || '‚Äî'}</strong> | ${entete.module || '‚Äî'}<br>
    ${entete.labelSequence||'S√©quence'} : ${entete.sequence || '‚Äî'}<br>
    ${entete.labelActivite||'Activit√©'} : ${entete.activite || '‚Äî'} | ${entete.labelSupport||'Support'} : ${entete.support || '‚Äî'}<br>`;
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        summary += `${ll.label} : ${ll.val1 || '‚Äî'}<br>`;
      } else {
        summary += `${ll.label1} : ${ll.val1 || '‚Äî'} | ${ll.label2} : ${ll.val2 || '‚Äî'}<br>`;
      }
    });
  }
  summary += `${entete.labelObjectif||'Objectif'} : <em>${(getQuillText('objectif-wrapper')||'‚Äî').substring(0,120)}${getQuillText('objectif-wrapper') && getQuillText('objectif-wrapper').length>120?'‚Ä¶':''}</em>`;
  document.getElementById('preview-summary').innerHTML = summary;

  if (!etapes.length) {
    document.getElementById('preview-table-container').innerHTML = '<p style="color:var(--muted);font-size:13px;text-align:center;padding:20px;">Aucune √©tape saisie.</p>';
    return;
  }

  let html = `<div style="overflow-x:auto;">
    <table class="preview-table">
      <thead>
        <tr>
          <th style="width:20%">${P.labelColEtapes || '√âtapes'}</th>
          <th style="width:${Math.max(20, 65 - (P.colsSup||[]).reduce((s,c)=>s+c.width,0))}%">${P.labelColDeroulement || 'D√©roulement de la s√©ance'}</th>
          ${(P.colsSup||[]).map(col => `<th style="width:${col.width}%">${col.label}</th>`).join('')}
          <th style="width:15%">${P.labelColDuree || 'Dur√©e'}</th>
        </tr>
      </thead>
      <tbody>`;
  etapes.forEach((e, i) => {
    html += `<tr class="${i>0?'etape-sep':''}">
      <td class="etape-label">${e.nom}</td>
      <td>${e.enseignant.replace(/\n/g,'<br>')}</td>
      ${(P.colsSup||[]).map(col => `<td>${(e.supVals && e.supVals[col.n]) ? e.supVals[col.n] : ''}</td>`).join('')}
      <td>${e.duree}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  document.getElementById('preview-table-container').innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EN-T√äTE FLEXIBLE ‚Äî GESTION DES LABELS √âDITABLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function editLabel(labelEl) {
  const span = labelEl.querySelector('.label-text');
  if (!span) return;
  const currentText = span.textContent.trim();
  // Cr√©er un input en ligne
  const inp = document.createElement('input');
  inp.type = 'text';
  inp.className = 'label-edit-input';
  inp.value = currentText;
  labelEl.classList.add('editing-mode');
  span.replaceWith(inp);
  inp.focus(); inp.select();

  function finishEdit() {
    const newText = inp.value.trim() || currentText;
    const newSpan = document.createElement('span');
    newSpan.className = 'label-text';
    newSpan.textContent = newText;
    inp.replaceWith(newSpan);
    labelEl.classList.remove('editing-mode');
    updateLivePreview();
  }
  inp.addEventListener('blur', finishEdit);
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); finishEdit(); }
    if (e.key === 'Escape') { inp.value = currentText; finishEdit(); }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIGNES LIBRES SUPPL√âMENTAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ligneLibreCount = 0;

function ajouterLigneLibre(type) {
  ligneLibreCount++;
  const n = ligneLibreCount;
  const container = document.getElementById('lignes-libres-container');
  const msg = document.getElementById('no-lignes-libres-msg');
  if (msg) msg.style.display = 'none';

  const div = document.createElement('div');
  div.className = 'ligne-libre-card';
  div.id = 'll-card-' + n;
  div.dataset.type = type;

  // Toolbar de formatage r√©utilisable pour un champ contenteditable
  const llToolbar = (fieldId) => `
    <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
      <button type="button" class="format-btn" onclick="toggleFormat('${fieldId}','bold')" title="Gras"><b>B</b></button>
      <button type="button" class="format-btn" onclick="toggleFormat('${fieldId}','italic')" title="Italique"><i>I</i></button>
      <input type="color" class="color-picker-btn" onchange="applyColorToContentEditable('${fieldId}',this.value)" title="Couleur du texte" value="#000000">
      <input type="color" class="color-picker-btn" onchange="applyBackgroundToContentEditable('${fieldId}',this.value)" title="Couleur de surlignage" value="#FFFFFF">
      <button type="button" class="format-btn" onclick="removeColorFromContentEditable('${fieldId}')" title="Supprimer les couleurs" style="font-size:11px;">üö´</button>
    </div>`;

  if (type === 'simple') {
    div.innerHTML = `
      <div class="ligne-libre-header">
        <span class="ll-title">Ligne libre #${n} ‚Äî Champ simple</span>
        <div class="ll-actions">
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},-1)" title="Monter">‚Üë</button>
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},1)" title="Descendre">‚Üì</button>
          <button class="btn-ll-del" onclick="supprimerLigneLibre(${n})">‚úï Suppr.</button>
        </div>
      </div>
      <div class="ligne-libre-body">
        <div class="field editable-field-wrap">
          <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier le label">
            <span class="label-text">Champ ${n}</span>
            <span class="label-edit-hint">‚úèÔ∏è</span>
          </label>
          ${llToolbar('ll'+n+'-val1')}
          <div id="ll${n}-val1" contenteditable="true" class="editable-input" data-placeholder="Contenu du champ‚Ä¶" oninput="updateLivePreview()"></div>
        </div>
      </div>`;
  } else {
    div.innerHTML = `
      <div class="ligne-libre-header">
        <span class="ll-title">Ligne libre #${n} ‚Äî 2 champs c√¥te √† c√¥te</span>
        <div class="ll-actions">
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},-1)" title="Monter">‚Üë</button>
          <button class="btn-ll-move" onclick="moveLigneLibre(${n},1)" title="Descendre">‚Üì</button>
          <button class="btn-ll-del" onclick="supprimerLigneLibre(${n})">‚úï Suppr.</button>
        </div>
      </div>
      <div class="ligne-libre-body">
        <div class="ll-double">
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier le label">
              <span class="label-text">Champ ${n}a</span>
              <span class="label-edit-hint">‚úèÔ∏è</span>
            </label>
            ${llToolbar('ll'+n+'-val1')}
            <div id="ll${n}-val1" contenteditable="true" class="editable-input" data-placeholder="Contenu gauche‚Ä¶" oninput="updateLivePreview()"></div>
          </div>
          <div class="field editable-field-wrap">
            <label class="editable-label" ondblclick="editLabel(this)" title="Double-clic pour modifier le label">
              <span class="label-text">Champ ${n}b</span>
              <span class="label-edit-hint">‚úèÔ∏è</span>
            </label>
            ${llToolbar('ll'+n+'-val2')}
            <div id="ll${n}-val2" contenteditable="true" class="editable-input" data-placeholder="Contenu droit‚Ä¶" oninput="updateLivePreview()"></div>
          </div>
        </div>
      </div>`;
  }
  container.appendChild(div);
  updateLivePreview();
}

function supprimerLigneLibre(n) {
  const el = document.getElementById('ll-card-' + n);
  if (el) el.remove();
  const container = document.getElementById('lignes-libres-container');
  if (!container.querySelector('.ligne-libre-card')) {
    const msg = document.getElementById('no-lignes-libres-msg');
    if (msg) msg.style.display = '';
  }
  updateLivePreview();
}

function moveLigneLibre(n, dir) {
  const card = document.getElementById('ll-card-' + n);
  if (!card) return;
  const container = document.getElementById('lignes-libres-container');
  const cards = [...container.querySelectorAll('.ligne-libre-card')];
  const idx = cards.indexOf(card);
  if (dir === -1 && idx > 0) {
    container.insertBefore(card, cards[idx - 1]);
  } else if (dir === 1 && idx < cards.length - 1) {
    container.insertBefore(cards[idx + 1], card);
  }
  updateLivePreview();
}

function getLabelText(labelEl) {
  const span = labelEl ? labelEl.querySelector('.label-text') : null;
  return span ? span.textContent.trim() : '';
}

function collecterLignesLibres() {
  const lines = [];
  document.querySelectorAll('#lignes-libres-container .ligne-libre-card').forEach(card => {
    const n = card.id.replace('ll-card-', '');
    const type = card.dataset.type;
    const labels = card.querySelectorAll('.editable-label');
    const val1El = document.getElementById('ll'+n+'-val1');
    const val2El = document.getElementById('ll'+n+'-val2');
    // Lire innerHTML si contenteditable, sinon value (r√©trocompatibilit√©)
    const readVal = (el) => {
      if (!el) return '';
      if (el.contentEditable === 'true') return el.innerHTML.trim();
      return el.value ? el.value.trim() : '';
    };
    if (type === 'simple') {
      lines.push({
        type: 'simple',
        label: getLabelText(labels[0]),
        val1: readVal(val1El)
      });
    } else {
      lines.push({
        type: 'double',
        label1: getLabelText(labels[0]),
        val1: readVal(val1El),
        label2: getLabelText(labels[1]),
        val2: readVal(val2El)
      });
    }
  });
  return lines;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APER√áU LIVE DE L'EN-T√äTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLivePreview() {
  const entete = collecterEntete();
  const lignesLibres = collecterLignesLibres();
  const container = document.getElementById('entete-live-preview');
  if (!container) return;

  const blue = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#1565C0';
  const gold = getComputedStyle(document.documentElement).getPropertyValue('--gold').trim() || '#C9A84C';

  function lpCell(label, value, flex1, flex2) {
    const val = value || '';
    return `<div class="lp-half" style="flex:${flex1||1}">
      <div class="lp-cell-label" style="background:${blue};">${label}</div>
      <div class="lp-cell-value${!val?' empty':''}">${val || '‚Äî'}</div>
    </div>`;
  }

  let html = `<div style="border:2px solid ${blue};border-radius:5px;overflow:hidden;">`;
  // Ligne titre
  html += `<div class="lp-title-row" style="background:${blue};border-bottom:2px solid ${gold};">
    <span>üìã FICHE P√âDAGOGIQUE</span>
    <span style="font-size:10px;opacity:0.8;">${entete.prof||'‚Äî'}</span>
  </div>`;

  // Ligne 1 : Prof + Niveau
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    ${lpCell(entete.labelProf||'PROF', entete.prof, 1.4)}
    <div class="lp-half" style="flex:1; border-left:1.5px solid ${blue};">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelNiveau||'NIVEAU'}</div>
      <div class="lp-cell-value${!entete.niveau?' empty':''}">${entete.niveau||'‚Äî'}</div>
    </div>
  </div>`;

  // Ligne 2 : Module
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    <div class="lp-half" style="flex:1;">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelModule||'MODULE'}</div>
      <div class="lp-cell-value${!entete.module?' empty':''}">${entete.module||'‚Äî'}</div>
    </div>
  </div>`;

  // Ligne 3 : S√©quence
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    <div class="lp-half" style="flex:1;">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelSequence||'S√âQUENCE'}</div>
      <div class="lp-cell-value${!entete.sequence?' empty':''}">${entete.sequence||'‚Äî'}</div>
    </div>
  </div>`;

  // Ligne 4 : Activit√© + Support
  html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
    ${lpCell(entete.labelActivite||'ACTIVIT√â', entete.activite, 1.2)}
    <div class="lp-half" style="flex:1; border-left:1.5px solid ${blue};">
      <div class="lp-cell-label" style="background:${blue};">${entete.labelSupport||'SUPPORT'}</div>
      <div class="lp-cell-value${!entete.support?' empty':''}">${entete.support||'‚Äî'}</div>
    </div>
  </div>`;

  // Lignes libres suppl√©mentaires
  lignesLibres.forEach(ll => {
    if (ll.type === 'simple') {
      html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
        <div class="lp-half" style="flex:1;">
          <div class="lp-cell-label" style="background:${blue};">${ll.label||'CHAMP'}</div>
          <div class="lp-cell-value${!ll.val1?' empty':''}">${ll.val1||'‚Äî'}</div>
        </div>
      </div>`;
    } else {
      html += `<div class="lp-row-outer" style="border-bottom:1px solid ${blue};">
        ${lpCell(ll.label1||'CHAMP A', ll.val1, 1)}
        <div class="lp-half" style="flex:1; border-left:1.5px solid ${blue};">
          <div class="lp-cell-label" style="background:${blue};">${ll.label2||'CHAMP B'}</div>
          <div class="lp-cell-value${!ll.val2?' empty':''}">${ll.val2||'‚Äî'}</div>
        </div>
      </div>`;
    }
  });

  // Ligne Objectif
  const obj = getQuillText('objectif-wrapper') || '';
  html += `<div style="display:flex; border-top:1px solid ${blue};">
    <div class="lp-objectif-label" style="background:${blue};">${entete.labelObjectif||'OBJECTIF'}</div>
    <div class="lp-objectif-value${!obj?' empty':''}">${obj.replace(/\n/g,'<br>')||'‚Äî'}</div>
  </div>`;

  html += `</div>`;
  container.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLLECTE DES DONN√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFixedLabel(groupId, index) {
  const grp = document.getElementById(groupId);
  if (!grp) return '';
  const labels = grp.querySelectorAll('.editable-label .label-text');
  return labels[index] ? labels[index].textContent.trim() : '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORMATAGE GRAS ET ITALIQUE POUR LES CHAMPS CONTENTEDITABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFormat(fieldId, format) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  if (format === 'bold') {
    document.execCommand('bold', false, null);
  } else if (format === 'italic') {
    document.execCommand('italic', false, null);
  }
  
  // D√©clencher la mise √† jour de l'aper√ßu
  updateLivePreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COULEURS POUR LES CHAMPS CONTENTEDITABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyColorToContentEditable(fieldId, color) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  // Utiliser execCommand pour appliquer la couleur
  document.execCommand('foreColor', false, color);
  
  updateLivePreview();
}

function applyBackgroundToContentEditable(fieldId, color) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  // Utiliser execCommand pour appliquer le surlignage
  document.execCommand('backColor', false, color);
  
  updateLivePreview();
}

function removeColorFromContentEditable(fieldId) {
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  field.focus();
  
  // Supprimer les couleurs
  document.execCommand('foreColor', false, '#000000');
  document.execCommand('backColor', false, '#ffffff');
  document.execCommand('removeFormat', false, null);
  
  updateLivePreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLLECTE DES DONN√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collecterEntete() {
  const objectifHTML = getQuillHTML('objectif-wrapper');
  const objectifText = getQuillText('objectif-wrapper');
  
  return {
    // Valeurs r√©cup√©r√©es depuis les champs contenteditable (avec HTML pour le formatage)
    prof:       document.getElementById('prof')?.innerHTML.trim() || 'EZ-ZAKY AZIZ',
    niveau:     document.getElementById('niveau')?.innerHTML.trim() || '',
    module:     document.getElementById('module')?.innerHTML.trim() || '',
    sequence:   document.getElementById('sequence')?.innerHTML.trim() || '',
    activite:   document.getElementById('activite')?.innerHTML.trim() || '',
    support:    document.getElementById('support')?.innerHTML.trim() || '',
    objectif:   objectifHTML || objectifText || '',
    // Labels personnalis√©s
    labelProf:      getFixedLabel('fgrp-ligne1', 0)     || 'PROF',
    labelNiveau:    getFixedLabel('fgrp-ligne1', 1)     || 'NIVEAU',
    labelModule:    getFixedLabel('fgrp-module', 0)     || 'MODULE',
    labelSequence:  getFixedLabel('fgrp-sequence', 0)   || 'S√âQUENCE',
    labelActivite:  getFixedLabel('fgrp-ligne4', 0)     || 'ACTIVIT√â',
    labelSupport:   getFixedLabel('fgrp-ligne4', 1)     || 'SUPPORT',
    labelObjectif:  getFixedLabel('fgrp-objectif', 0)   || 'OBJECTIF(S)',
    // Lignes libres
    lignesLibres: collecterLignesLibres(),
  };
}

// Initialiser l'aper√ßu live
setTimeout(updateLivePreview, 100);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLONNES SUPPL√âMENTAIRES DU TABLEAU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let colSupCount = 0;
const MAX_COL_SUP = 3;

function ajouterColonneSup() {
  const container = document.getElementById('colonnes-sup-container');
  const current = container ? container.querySelectorAll('.col-sup-card').length : 0;
  if (current >= MAX_COL_SUP) {
    alert('Maximum ' + MAX_COL_SUP + ' colonnes suppl√©mentaires autoris√©es.');
    return;
  }
  colSupCount++;
  const n = colSupCount;
  const msg = document.getElementById('no-col-sup-msg');
  if (msg) msg.style.display = 'none';

  const div = document.createElement('div');
  div.className = 'col-sup-card';
  div.id = 'col-sup-' + n;
  div.style.cssText = 'border:1.5px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;';
  div.innerHTML = `
    <div style="background:var(--blue-pale);padding:7px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
      <span style="font-size:12px;font-weight:600;color:var(--blue-dark);">Colonne sup. #${n}</span>
      <button onclick="supprimerColonneSup(${n})" style="background:none;border:1px solid #FFCDD2;color:#C62828;border-radius:5px;padding:2px 8px;font-size:11px;cursor:pointer;">‚úï Suppr.</button>
    </div>
    <div style="padding:10px;">
      <div class="field" style="margin-bottom:8px;">
        <label style="font-size:11px;font-weight:600;color:var(--blue-dark);letter-spacing:0.04em;text-transform:uppercase;display:block;margin-bottom:4px;">Nom de la colonne</label>
        <input type="text" id="col-sup-${n}-label" value="Colonne ${n}" placeholder="Ex : Supports, Outils, Mat√©riel...">
      </div>
      <div class="field" style="margin-bottom:0;">
        <label style="font-size:11px;font-weight:600;color:var(--blue-dark);letter-spacing:0.04em;text-transform:uppercase;display:block;margin-bottom:4px;">Largeur (%)</label>
        <input type="number" id="col-sup-${n}-width" value="10" min="5" max="25" step="1">
        <p class="field-hint">La largeur sera d√©duite de la colonne ¬´ D√©roulement ¬ª.</p>
      </div>
    </div>
  `;
  container.appendChild(div);
  rafraichirChampsEtapes();
}

function supprimerColonneSup(n) {
  const el = document.getElementById('col-sup-' + n);
  if (el) el.remove();
  const container = document.getElementById('colonnes-sup-container');
  if (container && !container.querySelector('.col-sup-card')) {
    const msg = document.getElementById('no-col-sup-msg');
    if (msg) msg.style.display = '';
  }
  rafraichirChampsEtapes();
}

function collecterColonnesSup() {
  const cols = [];
  const container = document.getElementById('colonnes-sup-container');
  if (!container) return cols;
  container.querySelectorAll('.col-sup-card').forEach(card => {
    const n = card.id.replace('col-sup-', '');
    const label = document.getElementById('col-sup-' + n + '-label')?.value.trim() || ('Colonne ' + n);
    const width = parseFloat(document.getElementById('col-sup-' + n + '-width')?.value) || 10;
    cols.push({ n, label, width });
  });
  return cols;
}

function rafraichirChampsEtapes() {
  const colsSup = collecterColonnesSup();
  document.querySelectorAll('.etape-card').forEach(card => {
    const id = card.id.replace('etape-', '');
    card.querySelectorAll('.col-sup-field').forEach(f => f.remove());
    const body = card.querySelector('.etape-body');
    if (!body) return;
    const dureeField = body.querySelector('.field-duree');
    colsSup.forEach(col => {
      const div = document.createElement('div');
      div.className = 'field col-sup-field';
      div.innerHTML = `
        <label>${col.label}</label>
        <input type="text" id="e${id}-colsup-${col.n}" placeholder="Contenu pour ¬´ ${col.label} ¬ª‚Ä¶">
      `;
      if (dureeField) {
        body.insertBefore(div, dureeField);
      } else {
        body.appendChild(div);
      }
    });
  });
}

function collecterParams() {
  const colsSup = collecterColonnesSup();
  const totalSupPct = colsSup.reduce((s, c) => s + c.width, 0);
  const col1 = parseInt(document.getElementById('p-col1').value) || 20;
  const col2Raw = parseInt(document.getElementById('p-col2').value) || 65;
  const col2 = Math.max(10, col2Raw - totalSupPct);
  const col3 = 100 - col1 - col2Raw; // Dur√©e (reste)
  return {
    marge: parseFloat(document.getElementById('p-marge').value) || 8.5,
    gap: parseFloat(document.getElementById('p-gap').value) || 5,
    fontEnteteLabel: parseFloat(document.getElementById('p-font-entete-label').value) || 11,
    fontEnteteContent: parseFloat(document.getElementById('p-font-entete-content').value) || 10,
    fontTableHeader: parseFloat(document.getElementById('p-font-table-header').value) || 10,
    fontTableContent: parseFloat(document.getElementById('p-font-table-content').value) || 9,
    rowHeight: parseFloat(document.getElementById('p-row-height').value) || 8,
    tableHeaderH: parseFloat(document.getElementById('p-table-header-h').value) || 18,
    headerH: parseFloat(document.getElementById('p-header-h').value) || 100,
    l1h: parseFloat(document.getElementById('p-l1h').value) || 22,
    l234h: parseFloat(document.getElementById('p-l234h').value) || 18,
    l5h: parseFloat(document.getElementById('p-l5h').value) || 40,
    sep1Pct: parseFloat(document.getElementById('p-sep1').value) / 100 || 0.32,
    sep2Pct: parseFloat(document.getElementById('p-sep2').value) / 100 || 0.60,
    cols: [col1/100, col2/100, col3/100],
    colorMain: document.getElementById('p-color-main').value || '#1565C0',
    colorGrid: document.getElementById('p-color-grid').value || '#AAAAAA',
    colorAccent: document.getElementById('p-color-accent').value || '#C9A84C',
    colorEtapeText: document.getElementById('p-color-etape-text').value || '#1565C0',
    // Labels personnalis√©s des colonnes d'√©tapes
    labelColEtapes: document.getElementById('label-col-etapes')?.value || '√âtapes',
    labelColDeroulement: document.getElementById('label-col-deroulement')?.value || 'D√©roulement de la s√©ance',
    labelColDuree: document.getElementById('label-col-duree')?.value || 'Dur√©e',
    // Colonnes suppl√©mentaires
    colsSup: colsSup,
    colsSupPct: colsSup.map(c => c.width / 100),
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITAIRES COULEURS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hexToRgb(color) {
  if (!color) return [0, 0, 0]; // Retourner noir par d√©faut
  
  // Convertir rgb(r,g,b) ou rgba(r,g,b,a)
  if (color.startsWith('rgb')) {
    const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
      return [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
    }
  }
  
  // Convertir #RRGGBB ou #RGB
  if (color.startsWith('#')) {
    let hex = color.substring(1);
    // Convertir #RGB en #RRGGBB
    if (hex.length === 3) {
      hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
    }
    if (hex.length === 6) {
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      return [r, g, b];
    }
  }
  
  // Fallback
  return [0, 0, 0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NORMALISATION DES SYMBOLES UNICODE POUR PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Convertit les symboles Unicode en alternatives compatibles PDF
function normaliserTexte(text) {
  if (!text) return text;
  return text
    // ‚îÄ‚îÄ FL√àCHES SIMPLES ‚îÄ‚îÄ
    .replace(/‚Üí/g, '->').replace(/‚Üê/g, '<-').replace(/‚Üë/g, '^').replace(/‚Üì/g, 'v')
    .replace(/‚Üî/g, '<->').replace(/‚Üï/g, '^v').replace(/‚Üó/g, '/^').replace(/‚Üò/g, '\\v')
    .replace(/‚Üô/g, '/v').replace(/‚Üñ/g, '\\^').replace(/‚Ü©/g, '<-,').replace(/‚Ü™/g, ',->') 
    .replace(/‚Ü´/g, '<~').replace(/‚Ü¨/g, '~>').replace(/‚Ü≠/g, '<~>').replace(/‚Ü∞/g, 'L^')
    .replace(/‚Ü±/g, 'R^').replace(/‚Ü≤/g, 'Lv').replace(/‚Ü≥/g, 'Rv').replace(/‚Ü¥/g, 'v|')
    .replace(/‚Üµ/g, '<-|').replace(/‚Ü∑/g, '~>').replace(/‚Ü∂/g, '<~')
    .replace(/‚Ü∫/g, 'o<').replace(/‚Üª/g, 'o>').replace(/‚ü≥/g, 'o>').replace(/‚ü≤/g, 'o<')
    // ‚îÄ‚îÄ FL√àCHES DOUBLES ‚îÄ‚îÄ
    .replace(/‚áí/g, '=>').replace(/‚áê/g, '<=').replace(/‚áë/g, '^=').replace(/‚áì/g, 'v=')
    .replace(/‚áî/g, '<=>').replace(/‚áï/g, '^v=').replace(/‚áó/g, '/^=').replace(/‚áò/g, '\\v=')
    // ‚îÄ‚îÄ FL√àCHES LONGUES ‚îÄ‚îÄ
    .replace(/‚ü∂/g, '-->').replace(/‚üµ/g, '<--').replace(/‚ü∑/g, '<-->') 
    .replace(/‚üπ/g, '=>>').replace(/‚ü∏/g, '<<=' ).replace(/‚ü∫/g, '<<=>>')
    // ‚îÄ‚îÄ FL√àCHES STYLIS√âES ‚îÄ‚îÄ
    .replace(/‚ûú/g, '->').replace(/‚û°/g, '->').replace(/‚û¢/g, '->').replace(/‚û§/g, '->')
    .replace(/‚û•/g, '->').replace(/‚û¶/g, '<-').replace(/‚ûß/g, '->').replace(/‚û®/g, '=>')
    .replace(/‚û©/g, '->').replace(/‚û™/g, '->').replace(/‚û´/g, '->').replace(/‚û¨/g, '->')
    .replace(/‚û≠/g, '<-').replace(/‚ûÆ/g, '->').replace(/‚ûØ/g, '->').replace(/‚û±/g, '->')
    // ‚îÄ‚îÄ TRIANGLES / POINTEURS ‚îÄ‚îÄ
    .replace(/‚ñ∂/g, '>').replace(/‚óÄ/g, '<').replace(/‚ñ≤/g, '^').replace(/‚ñº/g, 'v')
    .replace(/‚ñ∫/g, '>').replace(/‚óÑ/g, '<').replace(/‚ñ∏/g, '>').replace(/‚óÇ/g, '<')
    .replace(/‚ñ¥/g, '^').replace(/‚ñæ/g, 'v').replace(/‚ä≥/g, '>').replace(/‚ä≤/g, '<')
    // ‚îÄ‚îÄ PUCES / LISTES ‚îÄ‚îÄ
    .replace(/‚Ä¢/g, '*').replace(/‚ó¶/g, 'o').replace(/‚ñ™/g, '-').replace(/‚ñ´/g, '-')
    .replace(/‚Ä£/g, '>').replace(/‚ÅÉ/g, '-').replace(/‚¶æ/g, 'O').replace(/‚¶ø/g, '@')
    // ‚îÄ‚îÄ CARR√âS ‚îÄ‚îÄ
    .replace(/‚ñ†/g, '[*]').replace(/‚ñ°/g, '[ ]').replace(/‚ñ¨/g, '[-]').replace(/‚ñ≠/g, '[-]')
    .replace(/‚ñÆ/g, '[|]').replace(/‚ñØ/g, '[ ]').replace(/‚óº/g, '[*]').replace(/‚óª/g, '[ ]')
    .replace(/‚óæ/g, '[*]').replace(/‚óΩ/g, '[ ]')
    // ‚îÄ‚îÄ CERCLES ‚îÄ‚îÄ
    .replace(/‚óè/g, '(*)').replace(/‚óã/g, '( )').replace(/‚óâ/g, '(.)').replace(/‚óé/g, '(o)')
    .replace(/‚óå/g, '(-)').replace(/‚óç/g, '(+)').replace(/‚óî/g, '(1/4)').replace(/‚óï/g, '(3/4)')
    .replace(/‚¨§/g, '(*)').replace(/‚≠ï/g, '(O)')
    // ‚îÄ‚îÄ LOSANGES ‚îÄ‚îÄ
    .replace(/‚óÜ/g, '<>').replace(/‚óá/g, '<>').replace(/‚óà/g, '<.>').replace(/‚¨•/g, '<>')
    .replace(/‚¨¶/g, '<>').replace(/‚ùñ/g, '<+>')
    // ‚îÄ‚îÄ COCHES / CROIX ‚îÄ‚îÄ
    .replace(/‚úì/g, 'v').replace(/‚úî/g, 'V').replace(/‚úó/g, 'x').replace(/‚úò/g, 'X')
    .replace(/‚òë/g, '[v]').replace(/‚òí/g, '[x]').replace(/‚úÖ/g, '[V]').replace(/‚ùå/g, '[X]')
    .replace(/‚ùé/g, '[X]').replace(/‚òê/g, '[ ]')
    // ‚îÄ‚îÄ √âTOILES ‚îÄ‚îÄ
    .replace(/‚òÖ/g, '*').replace(/‚òÜ/g, '*').replace(/‚ú©/g, '*').replace(/‚ú™/g, '(*)') 
    .replace(/‚ú´/g, '*').replace(/‚ú¨/g, '*').replace(/‚ú≠/g, '*').replace(/‚úÆ/g, '*')
    .replace(/‚úØ/g, '*').replace(/‚ú∞/g, '*').replace(/‚≠ê/g, '*').replace(/üåü/g, '*')
    .replace(/‚ú¶/g, '*').replace(/‚úß/g, '*').replace(/‚ú∂/g, '*').replace(/‚ú∑/g, '*')
    // ‚îÄ‚îÄ COEURS ‚îÄ‚îÄ
    .replace(/‚ô•/g, '<3').replace(/‚ô°/g, '<3').replace(/‚ù§/g, '<3').replace(/‚ù•/g, '<3')
    .replace(/‚ù£/g, '<!').replace(/‚ù¶/g, '<3').replace(/‚ùß/g, '<3')
    .replace(/üíô/g, '<3').replace(/üíö/g, '<3').replace(/üíõ/g, '<3')
    .replace(/üíú/g, '<3').replace(/üñ§/g, '<3')
    // ‚îÄ‚îÄ FLEURS / NATURE ‚îÄ‚îÄ
    .replace(/‚úø/g, '*').replace(/‚ùÄ/g, '*').replace(/‚ùÅ/g, '*').replace(/‚ùÇ/g, '(*)') 
    .replace(/‚ùÉ/g, '*').replace(/‚úæ/g, '*').replace(/‚öò/g, '*').replace(/‚òò/g, '*')
    .replace(/üåø/g, '*').replace(/üçÄ/g, '*')
    // ‚îÄ‚îÄ SYMBOLES M√âT√âO / DIVERS ‚îÄ‚îÄ
    .replace(/‚òÄ/g, 'O)').replace(/‚òÅ/g, '(~)').replace(/‚òÇ/g, '(u)').replace(/‚òÉ/g, '(8)')
    .replace(/‚òÑ/g, '(*)').replace(/‚ö°/g, '/\\')
    .replace(/‚òé/g, 'TEL').replace(/‚úâ/g, '@').replace(/‚úÇ/g, '>|<')
    .replace(/‚úè/g, '/').replace(/‚úí/g, '/')
    // ‚îÄ‚îÄ MATH√âMATIQUES ‚îÄ‚îÄ
    .replace(/¬±/g, '+/-').replace(/√ó/g, 'x').replace(/√∑/g, '/').replace(/¬∑/g, '.')
    .replace(/‚àô/g, '.').replace(/‚àö/g, 'sqrt').replace(/‚àõ/g, 'cbrt').replace(/‚àú/g, '4rt')
    .replace(/‚àû/g, 'inf').replace(/‚Ä∞/g, '0/00').replace(/‚Ä±/g, '0/000')
    // ‚îÄ‚îÄ RELATIONS MATH√âMATIQUES ‚îÄ‚îÄ
    .replace(/‚â†/g, '!=').replace(/‚â°/g, '===').replace(/‚â¢/g, '!==').replace(/‚âà/g, '~=')
    .replace(/‚ââ/g, '!~=').replace(/‚â§/g, '<=').replace(/‚â•/g, '>=').replace(/‚â™/g, '<<')
    .replace(/‚â´/g, '>>').replace(/‚â∫/g, '<').replace(/‚âª/g, '>') 
    .replace(/‚äÇ/g, 'C').replace(/‚äÉ/g, ')').replace(/‚äÑ/g, '!C').replace(/‚äÖ/g, '!)')
    .replace(/‚äÜ/g, 'C=').replace(/‚äá/g, ')=')
    // ‚îÄ‚îÄ LOGIQUE / ENSEMBLES ‚îÄ‚îÄ
    .replace(/‚àß/g, '/\\').replace(/‚à®/g, '\\/').replace(/¬¨/g, '!').replace(/‚àÄ/g, 'V')
    .replace(/‚àÉ/g, 'E').replace(/‚àÑ/g, '!E').replace(/‚àÖ/g, '{}').replace(/‚à©/g, 'n')
    .replace(/‚à™/g, 'U').replace(/‚àà/g, 'e').replace(/‚àâ/g, '!e').replace(/‚àã/g, 'ni')
    .replace(/‚àå/g, '!ni')
    // ‚îÄ‚îÄ LETTRES GRECQUES ‚îÄ‚îÄ
    .replace(/Œ±/g, 'alpha').replace(/Œ≤/g, 'beta').replace(/Œ≥/g, 'gamma')
    .replace(/Œ¥/g, 'delta').replace(/Œµ/g, 'epsilon').replace(/Œ∂/g, 'zeta')
    .replace(/Œ∑/g, 'eta').replace(/Œ∏/g, 'theta').replace(/Œπ/g, 'iota')
    .replace(/Œ∫/g, 'kappa').replace(/Œª/g, 'lambda').replace(/Œº/g, 'mu')
    .replace(/ŒΩ/g, 'nu').replace(/Œæ/g, 'xi').replace(/œÄ/g, 'pi')
    .replace(/œÅ/g, 'rho').replace(/œÉ/g, 'sigma').replace(/œÑ/g, 'tau')
    .replace(/œÖ/g, 'upsilon').replace(/œÜ/g, 'phi').replace(/œá/g, 'chi')
    .replace(/œà/g, 'psi').replace(/œâ/g, 'omega')
    .replace(/Œî/g, 'Delta').replace(/‚àÜ/g, 'Delta').replace(/Œ£/g, 'Sigma')
    .replace(/Œ†/g, 'Pi').replace(/Œ©/g, 'Omega')
    // ‚îÄ‚îÄ CALCUL ‚îÄ‚îÄ
    .replace(/‚àÇ/g, 'd').replace(/‚àá/g, 'V').replace(/‚à´/g, 'int')
    .replace(/‚à¨/g, 'iint').replace(/‚à≠/g, 'iiint').replace(/‚àÆ/g, 'oint')
    .replace(/‚àë/g, 'sum').replace(/‚àè/g, 'prod').replace(/‚àê/g, 'coprod')
    // ‚îÄ‚îÄ EXPOSANTS (chiffres) ‚îÄ‚îÄ
    .replace(/‚Å∞/g, '^0').replace(/¬π/g, '^1').replace(/¬≤/g, '^2').replace(/¬≥/g, '^3')
    .replace(/‚Å¥/g, '^4').replace(/‚Åµ/g, '^5').replace(/‚Å∂/g, '^6').replace(/‚Å∑/g, '^7')
    .replace(/‚Å∏/g, '^8').replace(/‚Åπ/g, '^9')
    // ‚îÄ‚îÄ EXPOSANTS (lettres) ‚îÄ‚îÄ
    .replace(/·µÉ/g, '^a').replace(/·µá/g, '^b').replace(/·∂ú/g, '^c').replace(/·µà/g, '^d')
    .replace(/·µâ/g, '^e').replace(/·∂†/g, '^f').replace(/·µç/g, '^g').replace(/ ∞/g, '^h')
    .replace(/‚Å±/g, '^i').replace(/ ≤/g, '^j').replace(/·µè/g, '^k').replace(/À°/g, '^l')
    .replace(/·µê/g, '^m').replace(/‚Åø/g, '^n').replace(/·µí/g, '^o').replace(/·µñ/g, '^p')
    .replace(/ ≥/g, '^r').replace(/À¢/g, '^s').replace(/·µó/g, '^t').replace(/·µò/g, '^u')
    .replace(/·µõ/g, '^v').replace(/ ∑/g, '^w').replace(/À£/g, '^x').replace(/ ∏/g, '^y')
    .replace(/·∂ª/g, '^z')
    // ‚îÄ‚îÄ INDICES (chiffres) ‚îÄ‚îÄ
    .replace(/‚ÇÄ/g, '_0').replace(/‚ÇÅ/g, '_1').replace(/‚ÇÇ/g, '_2').replace(/‚ÇÉ/g, '_3')
    .replace(/‚ÇÑ/g, '_4').replace(/‚ÇÖ/g, '_5').replace(/‚ÇÜ/g, '_6').replace(/‚Çá/g, '_7')
    .replace(/‚Çà/g, '_8').replace(/‚Çâ/g, '_9')
    // ‚îÄ‚îÄ INDICES (lettres) ‚îÄ‚îÄ
    .replace(/‚Çê/g, '_a').replace(/‚Çë/g, '_e').replace(/‚Çí/g, '_o').replace(/‚Çì/g, '_x')
    .replace(/‚Çô/g, '_n').replace(/‚Çò/g, '_m').replace(/‚Çñ/g, '_k').replace(/‚Çú/g, '_t')
    .replace(/‚Çõ/g, '_s').replace(/·µ¢/g, '_i').replace(/·µ§/g, '_u').replace(/·µ•/g, '_v')
    // ‚îÄ‚îÄ FRACTIONS ‚îÄ‚îÄ
    .replace(/¬Ω/g, '1/2').replace(/‚Öì/g, '1/3').replace(/‚Öî/g, '2/3')
    .replace(/¬º/g, '1/4').replace(/¬æ/g, '3/4').replace(/‚Öï/g, '1/5')
    .replace(/‚Öñ/g, '2/5').replace(/‚Öó/g, '3/5').replace(/‚Öò/g, '4/5')
    .replace(/‚Öô/g, '1/6').replace(/‚Öö/g, '5/6').replace(/‚Öõ/g, '1/8')
    .replace(/‚Öú/g, '3/8').replace(/‚Öù/g, '5/8').replace(/‚Öû/g, '7/8')
    // ‚îÄ‚îÄ GUILLEMETS ‚îÄ‚îÄ
    .replace(/¬´/g, '<<').replace(/¬ª/g, '>>').replace(/‚Äπ/g, '<').replace(/‚Ä∫/g, '>')
    .replace(/\u201C/g, '"').replace(/\u201D/g, '"').replace(/\u201E/g, '"').replace(/\u201F/g, '"')
    .replace(/\u2018/g, "'").replace(/\u2019/g, "'").replace(/\u201A/g, "'").replace(/\u201B/g, "'")
    .replace(/\u2032/g, "'").replace(/\u2035/g, "'")
    // ‚îÄ‚îÄ TIRETS ‚îÄ‚îÄ
    .replace(/[‚Äì‚Äî‚Äï‚Äí‚Äë‚Äê]/g, '-')
    // ‚îÄ‚îÄ ELLIPSES / POINTS ‚îÄ‚îÄ
    .replace(/‚Ä¶/g, '...').replace(/‚Ä•/g, '..').replace(/‚ÅÄ/g, '_').replace(/‚Åì/g, '~')
    // ‚îÄ‚îÄ SYMBOLES L√âGAUX / COMMERCE ‚îÄ‚îÄ
    .replace(/¬©/g, '(c)').replace(/¬Æ/g, '(R)').replace(/‚Ñ¢/g, '(TM)')
    .replace(/‚ÑÉ/g, 'degC').replace(/‚Ñâ/g, 'degF').replace(/¬∞/g, 'deg')
    .replace(/‚Ññ/g, 'No.').replace(/‚Ñó/g, '(P)').replace(/‚Ñ†/g, 'SM').replace(/‚Ñ°/g, 'TEL')
    // ‚îÄ‚îÄ MONNAIES ‚îÄ‚îÄ
    .replace(/‚Ç¨/g, 'EUR').replace(/¬£/g, 'GBP').replace(/¬•/g, 'JPY').replace(/¬¢/g, 'c')
    .replace(/‚Çπ/g, 'INR').replace(/‚ÇΩ/g, 'RUB').replace(/‚Çø/g, 'BTC').replace(/‚Ç∫/g, 'TRY')
    .replace(/‚Ç©/g, 'KRW').replace(/‚Ç™/g, 'ILS')
    // ‚îÄ‚îÄ DIVERS RESTANTS ‚îÄ‚îÄ
    .replace(/‚åÄ/g, 'diam').replace(/‚Åê/g, '.').replace(/‚Åë/g, '**')
    // ‚îÄ‚îÄ NETTOYAGE FINAL : tout ce qui reste hors Latin-1 ‚Üí underscore lisible ‚îÄ‚îÄ
    .replace(/[^\x00-\xFF]/g, '_');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERSION HTML (QUILL) VERS TEXTE FORMAT√â POUR PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Retourne une liste de segments format√©s :
// { text, bold, italic, underline, fontSize (pt), prefix }
// Utilis√© pour le rendu riche dans le PDF.
function htmlToFormattedText(html) {
  if (!html || html.trim() === '') return '';
  const temp = document.createElement('div');
  temp.innerHTML = html;
  let result = '';
  function processNode(node, indent) {
    if (node.nodeType === Node.TEXT_NODE) {
      const t = node.textContent;
      if (t) result += t;
    } else if (node.nodeType === Node.ELEMENT_NODE) {
      const tag = node.tagName.toLowerCase();
      if (tag === 'ol') {
        let idx = 1;
        Array.from(node.children).forEach(li => {
          result += indent + idx + '. ' + li.textContent.trim() + '\n';
          idx++;
        });
      } else if (tag === 'ul') {
        Array.from(node.children).forEach(li => {
          result += indent + '- ' + li.textContent.trim() + '\n';
        });
      } else if (tag === 'br') {
        result += '\n';
      } else if (tag === 'p') {
        Array.from(node.childNodes).forEach(c => processNode(c, indent));
        result += '\n';
      } else {
        Array.from(node.childNodes).forEach(c => processNode(c, indent));
      }
    }
  }
  Array.from(temp.childNodes).forEach(c => processNode(c, ''));
  return result.trim();
}

// Extrait des segments { text, bold, italic, underline, fontSize, prefix }
// depuis le HTML Quill pour un rendu PDF fid√®le au formatage.
function htmlToRichSegments(html) {
  if (!html || html.trim() === '') return [];
  const temp = document.createElement('div');
  temp.innerHTML = html;

  const segments = [];

  // Tailles Quill ‚Üí points PDF (base 9 pt)
  const quillSizeMap = { 'small': 7.5, 'large': 12, 'huge': 15 };
  // Headers ‚Üí taille et gras
  const headerSizeMap = { '1': 16, '2': 13, '3': 11 };

  function walk(node, ctx) {
    if (node.nodeType === Node.TEXT_NODE) {
      const text = node.textContent;
      if (text) {
        segments.push({
          text: text,
          bold: ctx.bold,
          italic: ctx.italic,
          underline: ctx.underline,
          fontSize: ctx.fontSize,
          font: ctx.font || null,
          color: ctx.color || null,
          background: ctx.background || null,
          prefix: ctx.prefix || ''
        });
      }
      return;
    }
    if (node.nodeType !== Node.ELEMENT_NODE) return;
    const tag = node.tagName.toLowerCase();

    let c = Object.assign({}, ctx);
    c.prefix = '';

    if (tag === 'strong' || tag === 'b') c.bold = true;
    if (tag === 'em' || tag === 'i') c.italic = true;
    if (tag === 'u') c.underline = true;
    
    // Balise <font> avec attributs color et/ou bgcolor (g√©n√©r√© par execCommand)
    if (tag === 'font') {
      if (node.getAttribute('color')) {
        c.color = node.getAttribute('color');
      }
      if (node.getAttribute('bgcolor')) {
        c.background = node.getAttribute('bgcolor');
      }
    }
    
    // Balise <span> avec attributs style (g√©n√©r√© par execCommand moderne)
    if (tag === 'span') {
      if (node.style.color) {
        c.color = node.style.color;
      }
      if (node.style.backgroundColor) {
        c.background = node.style.backgroundColor;
      }
    }

    // Headers h1/h2/h3
    if (tag === 'h1') { c.bold = true; c.fontSize = headerSizeMap['1']; }
    if (tag === 'h2') { c.bold = true; c.fontSize = headerSizeMap['2']; }
    if (tag === 'h3') { c.bold = true; c.fontSize = headerSizeMap['3']; }

    // Taille via classe ql-size
    if (node.classList) {
      if (node.classList.contains('ql-size-small'))  c.fontSize = quillSizeMap['small'];
      if (node.classList.contains('ql-size-large'))  c.fontSize = quillSizeMap['large'];
      if (node.classList.contains('ql-size-huge'))   c.fontSize = quillSizeMap['huge'];
      // Police
      if (node.classList.contains('ql-font-times'))        c.font = 'times';
      if (node.classList.contains('ql-font-georgia'))      c.font = 'times'; // approx serif
      if (node.classList.contains('ql-font-merriweather')) c.font = 'times';
      if (node.classList.contains('ql-font-roboto'))       c.font = 'helvetica';
      if (node.classList.contains('ql-font-lato'))         c.font = 'helvetica';
      if (node.classList.contains('ql-font-opensans'))     c.font = 'helvetica';
      if (node.classList.contains('ql-font-courier'))      c.font = 'courier';
    }
    // Taille via attribut data-size (Quill v2)
    if (node.dataset && node.dataset.size) {
      c.fontSize = quillSizeMap[node.dataset.size] || c.fontSize;
    }
    // Taille via style inline
    if (node.style && node.style.fontSize) {
      const fs = parseFloat(node.style.fontSize);
      if (!isNaN(fs)) c.fontSize = fs * 0.75;
    }

    // ‚îÄ‚îÄ COULEURS Quill ‚îÄ‚îÄ
    // Couleur du texte via classe .ql-color-xxx ou style.color
    if (node.classList) {
      // Quill g√©n√®re des classes comme ql-color-#e60000
      const colorClass = Array.from(node.classList).find(cls => cls.startsWith('ql-color-'));
      if (colorClass) {
        const colorValue = colorClass.replace('ql-color-', '').replace(/_/g, '');
        c.color = '#' + colorValue;
      }
      // Fond (surlignage) via classe .ql-bg-xxx
      const bgClass = Array.from(node.classList).find(cls => cls.startsWith('ql-bg-'));
      if (bgClass) {
        const bgValue = bgClass.replace('ql-bg-', '').replace(/_/g, '');
        c.background = '#' + bgValue;
      }
    }
    // Couleur via style inline
    if (node.style) {
      if (node.style.color) {
        c.color = node.style.color;
      }
      if (node.style.backgroundColor) {
        c.background = node.style.backgroundColor;
      }
    }

    // ‚îÄ‚îÄ LISTES Quill v2 : <ol> contient des <li data-list="bullet|ordered"> ‚îÄ‚îÄ
    if (tag === 'ol' || tag === 'ul') {
      let orderedIdx = 1;
      Array.from(node.children).forEach(li => {
        const dataList = li.getAttribute('data-list') || (tag === 'ol' ? 'ordered' : 'bullet');
        const isOrdered = dataList === 'ordered';
        const prefix = isOrdered ? (orderedIdx++) + '. ' : '‚Ä¢ ';
        let liCtx = Object.assign({}, c, { prefix: '' });
        segments.push({ text: prefix, bold: liCtx.bold, italic: liCtx.italic, underline: liCtx.underline, fontSize: liCtx.fontSize, prefix: '', listStart: true });
        Array.from(li.childNodes).forEach(ch => walk(ch, liCtx));
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: liCtx.fontSize, prefix: '' });
      });
      return;
    }
    // Li isol√© (hors ol/ul)
    if (tag === 'li') {
      const dataList = node.getAttribute('data-list') || 'bullet';
      const prefix = dataList === 'ordered' ? '1. ' : '‚Ä¢ ';
      segments.push({ text: prefix, bold: c.bold, italic: c.italic, underline: c.underline, fontSize: c.fontSize, prefix: '', listStart: true });
      Array.from(node.childNodes).forEach(ch => walk(ch, c));
      segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      return;
    }

    if (tag === 'br') {
      segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      return;
    }
    if (tag === 'p' || tag === 'h1' || tag === 'h2' || tag === 'h3') {
      Array.from(node.childNodes).forEach(ch => walk(ch, c));
      segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      return;
    }
    // Image base64
    if (tag === 'img') {
      const src = node.getAttribute('src') || '';
      if (src.startsWith('data:image')) {
        // Taille d√©finie par l'utilisateur (data-w/data-h ou style.width), sinon naturelle
        const userW = parseInt(node.getAttribute('data-w'))  || parseInt(node.style.width)  || node.naturalWidth  || 0;
        const userH = parseInt(node.getAttribute('data-h'))  || parseInt(node.style.height) || node.naturalHeight || 0;
        segments.push({ type: 'image', src: src, w: userW, h: userH });
      }
      return;
    }
    // Tableau HTML ‚Äî chaque cellule produit des segments riches (couleurs, gras, etc.)
    if (tag === 'table') {
      const tableData = [];
      node.querySelectorAll('tr').forEach(tr => {
        const rowData = [];
        tr.querySelectorAll('td, th').forEach(cell => {
          const isHeader = cell.tagName.toLowerCase() === 'th';
          // Couleur de fond de la cellule elle-m√™me
          let cellBg = null;
          if (cell.style && cell.style.backgroundColor) cellBg = cell.style.backgroundColor;
          // Contexte de base pour le contenu de la cellule
          const cellCtx = Object.assign({}, c, {
            bold:       isHeader || c.bold,
            color:      (cell.style && cell.style.color) ? cell.style.color : c.color,
            background: null,
            prefix:     ''
          });
          // Extraire les segments riches du contenu de la cellule
          const before = segments.length;
          Array.from(cell.childNodes).forEach(ch => walk(ch, cellCtx));
          const richContent = segments.splice(before);
          // Nettoyer les \n terminaux
          while (richContent.length && richContent[richContent.length-1].text === '\n') richContent.pop();
          rowData.push({
            text:        cell.textContent.trim(),
            isHeader:    isHeader,
            bgColor:     cellBg,
            richContent: richContent
          });
        });
        if (rowData.length > 0) tableData.push(rowData);
      });
      if (tableData.length > 0) {
        segments.push({ type: 'table', tableData: tableData, prefix: '' });
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize, prefix: '' });
      }
      return;
    }
    Array.from(node.childNodes).forEach(ch => walk(ch, c));
  }

  const baseCtx = { bold: false, italic: false, underline: false, fontSize: null, color: null, background: null, prefix: '' };
  Array.from(temp.childNodes).forEach(n => walk(n, baseCtx));

  // Nettoyer les \n finaux
  while (segments.length && segments[segments.length-1].text === '\n') segments.pop();

  return segments;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// G√âN√âRATION PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genererPDF() {
  // V√©rifier que jsPDF est charg√©
  if (typeof window.jspdf === 'undefined') {
    alert('‚ö†Ô∏è La biblioth√®que PDF n\'est pas charg√©e.\n\nPour utiliser cette fonctionnalit√© :\n1. Assurez-vous d\'avoir une connexion internet\n2. Rechargez la page\n3. Attendez quelques secondes que les biblioth√®ques se chargent\n\nVous pouvez aussi utiliser l\'export Word (.docx) qui fonctionne avec les m√™mes biblioth√®ques.');
    return;
  }

  const entete = collecterEntete();
  const etapes = collecterEtapes();
  const P = collecterParams();

  if (!entete.niveau || !entete.module || !entete.sequence || !entete.activite || !entete.objectif) {
    alert('Veuillez remplir au minimum : ' + (entete.labelNiveau||'Niveau') + ', ' + (entete.labelModule||'Module') + ', ' + (entete.labelSequence||'S√©quence') + ', ' + (entete.labelActivite||'Activit√©') + ' et ' + (entete.labelObjectif||'Objectif') + '.');
    showTab('entete'); return;
  }
  if (!etapes.length) {
    alert('Veuillez ajouter au moins une √©tape.');
    showTab('etapes'); return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4', putOnlyUsedFonts: true });

    const PW = doc.internal.pageSize.width;   // 595.28
    const PH = doc.internal.pageSize.height;  // 841.89
  const M = P.marge;
  const UW = PW - 2 * M; // largeur utile

  const [mr, mg, mb] = hexToRgb(P.colorMain);
  const [gr, gg, gb] = hexToRgb(P.colorGrid);
  const [er, eg, eb] = hexToRgb(P.colorEtapeText);

  function setBlue() { doc.setFillColor(mr, mg, mb); doc.setDrawColor(mr, mg, mb); }
  function setWhite() { doc.setFillColor(255,255,255); doc.setDrawColor(255,255,255); }
  function setGray() { doc.setDrawColor(gr, gg, gb); }
  function setBlueStroke(w) {
    doc.setDrawColor(mr, mg, mb);
    doc.setLineWidth(w);
  }

  function drawTextWhite(text, x, y, size, bold) {
    doc.setTextColor(255,255,255);
    doc.setFontSize(size);
    doc.setFont('times', bold ? 'bold' : 'normal');
    doc.text(normaliserTexte(text), x, y);
  }
  function drawTextBlack(text, x, y, size, bold) {
    doc.setTextColor(0,0,0);
    doc.setFontSize(size);
    doc.setFont('times', bold ? 'bold' : 'normal');
    doc.text(normaliserTexte(text), x, y);
  }
  function drawTextBlue(text, x, y, size, bold) {
    doc.setTextColor(mr, mg, mb);
    doc.setFontSize(size);
    doc.setFont('times', bold ? 'bold' : 'normal');
    doc.text(normaliserTexte(text), x, y);
  }

  // Dessine un rect blanc avec bordure bleue (zone de saisie remplie ou vide)
  // Fonction pour dessiner du texte avec formatage HTML (gras, italique, COULEURS)
  function drawFormattedText(htmlText, x, y, maxWidth, fontSize) {
    if (!htmlText) return;
    
    // Utiliser htmlToRichSegments pour d√©tecter tous les formats y compris les couleurs
    const segments = htmlToRichSegments(htmlText);
    if (segments.length === 0) return;
    
    let currentX = x;
    const currentY = y;
    
    segments.forEach(seg => {
      if (seg.text && seg.text !== '\n') {
        const fs = seg.fontSize || fontSize;
        const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
        
        doc.setFontSize(fs);
        doc.setFont('times', fontStyle);
        
        // Appliquer la couleur du texte si pr√©sente
        if (seg.color) {
          const [r, g, b] = hexToRgb(seg.color);
          doc.setTextColor(r, g, b);
        } else {
          doc.setTextColor(0, 0, 0);
        }
        
        const safeText = normaliserTexte(seg.text);
        const textWidth = doc.getTextWidth(safeText);
        
        // Appliquer le surlignage si pr√©sent
        if (seg.background) {
          const [br, bg, bb] = hexToRgb(seg.background);
          doc.setFillColor(br, bg, bb);
          doc.rect(currentX, currentY - fs * 0.85, textWidth, fs * 1.1, 'F');
        }
        
        doc.text(safeText, currentX, currentY);
        currentX += textWidth;
      }
    });
    
    doc.setFont('times', 'normal');
    doc.setTextColor(0, 0, 0);
  }

  // Fonction pour dessiner du texte centr√© avec formatage HTML
  function drawFormattedTextCentered(htmlText, centerX, y, maxWidth, fontSize, defaultColor) {
    if (!htmlText) return;
    
    // Utiliser htmlToRichSegments pour d√©tecter tous les formats y compris les couleurs
    const segments = htmlToRichSegments(htmlText);
    if (segments.length === 0) return;
    
    // Filtrer les segments de texte (pas les \n)
    const textSegments = segments.filter(seg => seg.text && seg.text !== '\n');
    
    // Calculer la largeur totale pour centrer
    let totalWidth = 0;
    textSegments.forEach(seg => {
      const fs = seg.fontSize || fontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      doc.setFont('times', fontStyle);
      doc.setFontSize(fs);
      totalWidth += doc.getTextWidth(normaliserTexte(seg.text));
    });
    
    // Dessiner en centrant
    let currentX = centerX - totalWidth / 2;
    
    textSegments.forEach(seg => {
      const fs = seg.fontSize || fontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      
      doc.setFont('times', fontStyle);
      doc.setFontSize(fs);
      
      // Appliquer la couleur du segment si pr√©sente, sinon la couleur par d√©faut
      if (seg.color) {
        const [r, g, b] = hexToRgb(seg.color);
        doc.setTextColor(r, g, b);
      } else if (defaultColor) {
        doc.setTextColor(defaultColor[0], defaultColor[1], defaultColor[2]);
      } else {
        doc.setTextColor(0, 0, 0);
      }
      
      const safeText = normaliserTexte(seg.text);
      const textWidth = doc.getTextWidth(safeText);
      
      // Appliquer le surlignage si pr√©sent
      if (seg.background) {
        const [br, bg, bb] = hexToRgb(seg.background);
        doc.setFillColor(br, bg, bb);
        doc.rect(currentX, y - fs * 0.85, textWidth, fs * 1.1, 'F');
      }
      
      doc.text(safeText, currentX, y);
      currentX += textWidth;
    });
    
    doc.setFont('times', 'normal');
    doc.setTextColor(0, 0, 0);
  }

  // Fonction pour dessiner du texte blanc avec formatage HTML et limite de largeur
  function drawFormattedTextWhite(htmlText, x, y, maxWidth, fontSize) {
    if (!htmlText) return;
    
    // Utiliser htmlToRichSegments pour d√©tecter tous les formats y compris les couleurs
    const segments = htmlToRichSegments(htmlText);
    if (segments.length === 0) return;
    
    let currentX = x;
    const currentY = y;
    
    segments.forEach(seg => {
      if (seg.text && seg.text !== '\n') {
        const fs = seg.fontSize || fontSize;
        const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
        
        doc.setFontSize(fs);
        doc.setFont('times', fontStyle);
        
        // Appliquer la couleur du texte si pr√©sente, sinon BLANC par d√©faut
        if (seg.color) {
          const [r, g, b] = hexToRgb(seg.color);
          doc.setTextColor(r, g, b);
        } else {
          doc.setTextColor(255, 255, 255); // BLANC par d√©faut pour fond bleu
        }
        
        const safeText = normaliserTexte(seg.text);
        const textWidth = doc.getTextWidth(safeText);
        
        // V√©rifier si on d√©passe la largeur max
        const remainingWidth = maxWidth - (currentX - x);
        if (textWidth > remainingWidth && remainingWidth > 0) {
          let truncated = safeText;
          while (doc.getTextWidth(truncated + '...') > remainingWidth && truncated.length > 0) {
            truncated = truncated.slice(0, -1);
          }
          
          // Appliquer surlignage si pr√©sent
          if (seg.background) {
            const [br, bg, bb] = hexToRgb(seg.background);
            doc.setFillColor(br, bg, bb);
            doc.rect(currentX, currentY - fs * 0.85, doc.getTextWidth(truncated + '...'), fs * 1.1, 'F');
          }
          
          doc.text(truncated + '...', currentX, currentY);
          return;
        }
        
        // Appliquer le surlignage si pr√©sent
        if (seg.background) {
          const [br, bg, bb] = hexToRgb(seg.background);
          doc.setFillColor(br, bg, bb);
          doc.rect(currentX, currentY - fs * 0.85, textWidth, fs * 1.1, 'F');
        }
        
        doc.text(safeText, currentX, currentY);
        currentX += textWidth;
      }
    });
    
    doc.setFont('times', 'normal');
    doc.setTextColor(0, 0, 0);
  }

  function drawInputBox(x, y, w, h, text, fontSize) {
    doc.setFillColor(255,255,255);
    setBlueStroke(0.5);
    doc.rect(x, y, w, h, 'FD');
    if (text) {
      // Parser le HTML pour extraire le formatage
      drawFormattedText(text, x + 2, y + (fontSize || P.fontEnteteContent) * 0.85 + 1, w - 4, fontSize || P.fontEnteteContent);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RENDU TEXTE RICHE DEPUIS SEGMENTS QUILL
  // Dessine des segments format√©s (gras/italique/soulign√©/taille)
  // dans une zone de largeur maxW depuis (x, startY).
  // Retourne la hauteur totale utilis√©e.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function drawRichTextSegments(segments, x, startY, maxW, baseFontSize, defaultColor) {
    if (!segments || segments.length === 0) return 0;
    const lineH = baseFontSize * 1.35;
    let curX = x;
    let curY = startY;

    // D√©couper les segments texte en lignes en respectant maxW
    const lines = [];
    let curLine = [];
    let curLineW = 0;

    // Accumulateur mixte : { type:'text-line', items } | { type:'image', src } | { type:'table', tableData }
    const blocks = [];
    let pendingLine = [];
    let pendingLineW = 0;

    function flushPendingLine() {
      if (pendingLine.length > 0) {
        blocks.push({ type: 'text-line', items: pendingLine });
        pendingLine = [];
        pendingLineW = 0;
      }
    }

    segments.forEach(seg => {
      // Segments sp√©ciaux (image, table)
      if (seg.type === 'image') {
        flushPendingLine();
        blocks.push({ type: 'image', src: seg.src });
        return;
      }
      if (seg.type === 'table') {
        flushPendingLine();
        blocks.push({ type: 'table', tableData: seg.tableData });
        return;
      }
      if (seg.text === '\n') {
        flushPendingLine();
        return;
      }
      const fs = seg.fontSize || baseFontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      const fontFace = seg.font || 'times';
      doc.setFontSize(fs);
      doc.setFont(fontFace, fontStyle);

      const words = seg.text.split(/(\s+)/);
      words.forEach(word => {
        if (word === '') return;
        const wW = doc.getTextWidth(normaliserTexte(word));
        if (pendingLineW + wW > maxW && pendingLine.length > 0 && word.trim() !== '') {
          flushPendingLine();
        }
        pendingLine.push({ 
          word, 
          bold: seg.bold, 
          italic: seg.italic, 
          underline: seg.underline, 
          fontSize: fs, 
          font: seg.font || 'times',
          color: seg.color || null,
          background: seg.background || null
        });
        pendingLineW += wW;
      });
    });
    flushPendingLine();

    // Dessiner les blocs
    blocks.forEach(block => {
      if (block.type === 'text-line') {
        let lx = x;
        block.items.forEach(item => {
          const fs = item.fontSize || baseFontSize;
          const fontStyle = item.bold && item.italic ? 'bolditalic' : item.bold ? 'bold' : item.italic ? 'italic' : 'normal';
          const fontFace = item.font || 'times';
          doc.setFontSize(fs);
          doc.setFont(fontFace, fontStyle);
          
          // Appliquer la couleur du texte
          if (item.color) {
            const [r, g, b] = hexToRgb(item.color);
            doc.setTextColor(r, g, b);
          } else if (defaultColor) {
            doc.setTextColor(...defaultColor);
          } else {
            doc.setTextColor(0, 0, 0);
          }
          
          const safeWord = normaliserTexte(item.word);
          const w = doc.getTextWidth(safeWord);
          
          // Appliquer le surlignage (background)
          if (item.background) {
            const [br, bg, bb] = hexToRgb(item.background);
            doc.setFillColor(br, bg, bb);
            doc.rect(lx, curY - fs * 0.85, w, fs * 1.1, 'F');
          }
          
          // Dessiner le texte
          doc.text(safeWord, lx, curY);
          
          // Soulignement
          if (item.underline) {
            const [ur, ug, ub] = item.color ? hexToRgb(item.color) : [0, 0, 0];
            doc.setDrawColor(ur, ug, ub);
            doc.setLineWidth(0.3);
            doc.line(lx, curY + 0.8, lx + w, curY + 0.8);
          }
          lx += w;
        });
        curY += lineH;

      } else if (block.type === 'image') {
        // Dimensions : taille user en px ‚Üí converti en pt (1px ‚âà 0.75pt), born√© √† maxW
        try {
          const imgEl = new Image();
          imgEl.src = block.src;
          const natW = imgEl.naturalWidth  || 200;
          const natH = imgEl.naturalHeight || 150;
          const ratio = natH / (natW || 1);
          let imgW, imgH;
          if (block.w && block.w > 0) {
            // Taille d√©finie par l'utilisateur : 1px CSS = 0.75pt PDF
            imgW = Math.min(maxW, block.w * 0.75);
            imgH = block.h ? block.h * 0.75 : imgW * ratio;
          } else {
            // Pas de taille d√©finie : limiter √† 160pt de large
            imgW = Math.min(maxW, 160);
            imgH = imgW * ratio;
          }
          let fmt = 'JPEG';
          if (block.src.includes('image/png'))  fmt = 'PNG';
          else if (block.src.includes('image/gif'))  fmt = 'GIF';
          else if (block.src.includes('image/webp')) fmt = 'WEBP';
          doc.addImage(block.src, fmt, x, curY, imgW, imgH);
          doc.setDrawColor(180,180,180); doc.setLineWidth(0.4);
          doc.rect(x, curY, imgW, imgH, 'S');
          curY += imgH + 3;
        } catch(e) {
          curY += lineH;
        }

      } else if (block.type === 'table') {
        // Dessiner le tableau : r√©partir √©quitablement les colonnes
        const tdata = block.tableData;
        if (!tdata || tdata.length === 0) return;
        const nCols = Math.max(...tdata.map(r => r.length));
        const colW = maxW / nCols;
        const cellPadTop = 2;
        const cellPadLeft = 3;
        const cellFontSize = baseFontSize * 0.88;

        tdata.forEach(row => {
          // Calculer la hauteur de la ligne (multi-wrap) en se basant sur le texte brut
          let maxLinesInRow = 1;
          row.forEach(cell => {
            doc.setFontSize(cellFontSize);
            doc.setFont('times', cell.isHeader ? 'bold' : 'normal');
            const wrapped = doc.splitTextToSize(normaliserTexte(cell.text || ''), colW - cellPadLeft*2);
            maxLinesInRow = Math.max(maxLinesInRow, wrapped.length);
          });
          const rowH = maxLinesInRow * cellFontSize * 1.3 + cellPadTop * 2;

          // Dessiner les cellules
          let cx = x;
          row.forEach((cell, ci) => {
            const cw = colW;
            // Fond de la cellule : couleur personnalis√©e > header bleu p√¢le > blanc
            if (cell.bgColor) {
              const [br2, bg2, bb2] = hexToRgb(cell.bgColor);
              doc.setFillColor(br2, bg2, bb2);
            } else if (cell.isHeader) {
              doc.setFillColor(227, 242, 253);
            } else {
              doc.setFillColor(255, 255, 255);
            }
            doc.rect(cx, curY, cw, rowH, 'F');
            // Bordure cellule
            doc.setDrawColor(mr, mg, mb); doc.setLineWidth(0.5);
            doc.rect(cx, curY, cw, rowH, 'S');

            // Texte riche : parcourir les segments de la cellule
            const segs = (cell.richContent && cell.richContent.length > 0)
              ? cell.richContent
              : [{ text: cell.text || '', bold: cell.isHeader, italic: false, color: null }];

            let ty = curY + cellPadTop + cellFontSize * 0.85;
            let lineX = cx + cellPadLeft;
            let lineW = 0;

            segs.forEach(seg => {
              if (!seg.text || seg.text === '\n') {
                if (seg.text === '\n') { ty += cellFontSize * 1.3; lineX = cx + cellPadLeft; lineW = 0; }
                return;
              }
              const fontStyle = (seg.bold && seg.italic) ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
              doc.setFontSize(cellFontSize);
              doc.setFont('times', fontStyle);
              // Couleur du texte
              if (seg.color) {
                const [tr2, tg2, tb2] = hexToRgb(seg.color);
                doc.setTextColor(tr2, tg2, tb2);
              } else {
                doc.setTextColor(0, 0, 0);
              }
              // Fond du run (surlignage dans la cellule)
              if (seg.background) {
                const [hr2, hg2, hb2] = hexToRgb(seg.background);
                const runW = doc.getTextWidth(normaliserTexte(seg.text));
                doc.setFillColor(hr2, hg2, hb2);
                doc.rect(lineX + lineW, ty - cellFontSize * 0.8, runW, cellFontSize * 1.1, 'F');
                // R√©tablir la couleur du texte apr√®s avoir dessin√© le fond
                if (seg.color) {
                  const [tr2, tg2, tb2] = hexToRgb(seg.color);
                  doc.setTextColor(tr2, tg2, tb2);
                } else {
                  doc.setTextColor(0, 0, 0);
                }
              }
              // Wrap simple dans la largeur de la cellule
              const words = doc.splitTextToSize(normaliserTexte(seg.text), cw - cellPadLeft * 2);
              words.forEach((line, li) => {
                if (li > 0) { ty += cellFontSize * 1.3; lineX = cx + cellPadLeft; lineW = 0; }
                doc.text(line, lineX + lineW, ty);
                lineW += doc.getTextWidth(line);
              });
            });
            cx += cw;
          });
          curY += rowH;
        });
        curY += 3; // espace apr√®s tableau
      }
    });

    return curY - startY;
  }

  // Calcule la hauteur qu'occuperait drawRichTextSegments sans dessiner
  function measureRichTextSegments(segments, maxW, baseFontSize) {
    if (!segments || segments.length === 0) return baseFontSize * 1.35;
    const lineH = baseFontSize * 1.35;
    let totalH = 0;
    let curLineW = 0;
    let lineCount = 0;

    function flushLines() {
      if (lineCount > 0 || curLineW > 0) {
        totalH += (lineCount + (curLineW > 0 ? 1 : 0)) * lineH;
        lineCount = 0;
        curLineW = 0;
      }
    }

    segments.forEach(seg => {
      if (seg.type === 'image') {
        flushLines();
        // Estimation hauteur image : taille user en pt ou 120pt par d√©faut
        if (seg.w && seg.h && seg.w > 0) {
          const maxW2 = maxW || 160;
          const imgW2 = Math.min(maxW2, seg.w * 0.75);
          const imgH2 = seg.h * 0.75 * (imgW2 / (seg.w * 0.75));
          totalH += imgH2 + 3;
        } else {
          totalH += 123;
        }
        return;
      }
      if (seg.type === 'table') {
        flushLines();
        // Estimer la hauteur du tableau
        const tdata = seg.tableData || [];
        const nCols = Math.max(1, ...tdata.map(r => r.length));
        const colW = maxW / nCols;
        const cellFontSize = baseFontSize * 0.88;
        tdata.forEach(row => {
          let maxLines = 1;
          row.forEach(cell => {
            doc.setFontSize(cellFontSize);
            doc.setFont('times', cell.isHeader ? 'bold' : 'normal');
            const wrapped = doc.splitTextToSize(normaliserTexte(cell.text || ''), colW - 6);
            maxLines = Math.max(maxLines, wrapped.length);
          });
          totalH += maxLines * cellFontSize * 1.3 + 4;
        });
        totalH += 3;
        return;
      }
      if (seg.text === '\n') {
        lineCount++;
        curLineW = 0;
        return;
      }
      const fs = seg.fontSize || baseFontSize;
      const fontStyle = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      doc.setFontSize(fs);
      doc.setFont('times', fontStyle);
      const words = seg.text.split(/(\s+)/);
      words.forEach(word => {
        if (word === '') return;
        const wW = doc.getTextWidth(normaliserTexte(word));
        if (curLineW + wW > maxW && curLineW > 0 && word.trim() !== '') {
          lineCount++;
          curLineW = 0;
        }
        curLineW += wW;
      });
    });
    flushLines();

    return Math.max(totalH, lineH);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // M√âTADONN√âES & WATERMARK INVISIBLE
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const timestamp = new Date().toISOString();
  const uniqueId = 'FP-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9);
  
  // M√©tadonn√©es du PDF (tra√ßabilit√© invisible)
  doc.setProperties({
    title: `Fiche P√©dagogique - ${entete.activite || 'Sans titre'}`,
    subject: `${entete.module || ''} - ${entete.sequence || ''}`,
    author: 'EZ-ZAKY AZIZ',
    keywords: `fiche p√©dagogique, ${entete.niveau || ''}, √©ducation`,
    creator: 'G√©n√©rateur de Fiches P√©dagogiques v2.11 ¬© EZ-ZAKY AZIZ',
    producer: `App ID: ${uniqueId} | Generated: ${timestamp}`
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // PAGE 1 : EN-T√äTE
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sep1 = M + UW * P.sep1Pct;
  const sep2 = M + UW * P.sep2Pct;
  const endX = M + UW;

  let hy = M;

  // ‚îÄ‚îÄ Ligne 1 (h = l1h) ‚Äî Prof + Niveau avec labels personnalis√©s
  const L1H = P.l1h;
  setBlue();
  doc.rect(M, hy, UW, L1H, 'F');
  doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
  doc.line(sep1, hy, sep1, hy+L1H);
  doc.line(sep2, hy, sep2, hy+L1H);
  // Titre centr√© √† gauche
  drawTextWhite('FICHE PEDAGOGIQUE', M+5, hy + L1H*0.65, P.fontEnteteLabel, true);
  // Prof label + valeur avec formatage HTML
  const profLabel = normaliserTexte(entete.labelProf || 'PROF');
  drawTextWhite(profLabel + ' : ', sep1+5, hy + L1H*0.65, P.fontEnteteLabel, true);
  const profLabelW = doc.getTextWidth(profLabel + ' : ');
  // Dessiner la valeur du prof avec formatage HTML (limit√© en largeur)
  const profValueMaxW = sep2 - (sep1 + 5 + profLabelW + 5);
  drawFormattedTextWhite(entete.prof, sep1 + 5 + profLabelW, hy + L1H*0.65, profValueMaxW, P.fontEnteteLabel);
  // Niveau label
  const niveauLabel = normaliserTexte(entete.labelNiveau || 'NIVEAU');
  drawTextWhite(niveauLabel + ' :', sep2+5, hy + L1H*0.65, P.fontEnteteLabel, true);
  const niveauLabelW = doc.getTextWidth(niveauLabel + ' :') + 4;
  const niveauX = sep2 + niveauLabelW + 6;
  drawInputBox(niveauX, hy+4, endX-niveauX-2, L1H-8, entete.niveau, P.fontEnteteContent);
  hy += L1H;

  // ‚îÄ‚îÄ Ligne 2 (module)
  const L234H = P.l234h;
  const moduleLabel = normaliserTexte(entete.labelModule || 'Module');
  setBlue();
  doc.rect(M, hy, UW, L234H, 'F');
  drawTextWhite(moduleLabel + ' :', M+5, hy + L234H*0.65, P.fontEnteteLabel, true);
  const moduleLabelW = doc.getTextWidth(moduleLabel + ' :') + 4;
  drawInputBox(M+moduleLabelW+8, hy+3, endX-(M+moduleLabelW+8)-4, L234H-6, entete.module, P.fontEnteteContent);
  hy += L234H;

  // ‚îÄ‚îÄ Ligne 3 (s√©quence)
  const sequenceLabel = normaliserTexte(entete.labelSequence || 'Sequence');
  setBlue();
  doc.rect(M, hy, UW, L234H, 'F');
  drawTextWhite(sequenceLabel + ' :', M+5, hy + L234H*0.65, P.fontEnteteLabel, true);
  const seqLabelW = doc.getTextWidth(sequenceLabel + ' :') + 4;
  drawInputBox(M+seqLabelW+8, hy+3, endX-(M+seqLabelW+8)-4, L234H-6, entete.sequence, P.fontEnteteContent);
  hy += L234H;

  // ‚îÄ‚îÄ Ligne 4 (activit√© + support) ‚Äî hauteur flexible IND√âPENDANTE pour chaque case
  doc.setFontSize(P.fontEnteteContent);
  doc.setFont('times','normal');

  const activiteLabel = normaliserTexte(entete.labelActivite || 'Activite');
  const actLabelW = doc.getTextWidth(activiteLabel + ' :') + 4;
  // Largeur r√©elle de la zone de valeur Activit√©
  const actBoxW = sep2 - (M + actLabelW + 8) - 4;
  // Largeur r√©elle de la zone de valeur Support
  const supportLabel = normaliserTexte(entete.labelSupport || 'Support');
  doc.setFontSize(P.fontEnteteLabel); doc.setFont('times','bold');
  const supLabelW = doc.getTextWidth(supportLabel + ' :') + 4;
  doc.setFontSize(P.fontEnteteContent); doc.setFont('times','normal');
  const supportBoxX = sep2 + supLabelW + 8;
  const supportBoxW = endX - supportBoxX - 4;

  // ‚Äî Mesurer hauteur n√©cessaire pour Activit√©
  const activiteSegments = htmlToRichSegments(entete.activite || '');
  const actNeededH = Math.max(L234H, measureRichTextSegments(activiteSegments, actBoxW - 4, P.fontEnteteContent) + 8);

  // ‚Äî Mesurer hauteur n√©cessaire pour Support
  const supportSegments = htmlToRichSegments(entete.support || '');
  const supportNeededH = Math.max(L234H, measureRichTextSegments(supportSegments, supportBoxW - 4, P.fontEnteteContent) + 8);

  // ‚Äî Hauteur de la ligne 4 = max des deux pour le fond bleu
  const rowL4H = Math.max(actNeededH, supportNeededH);
  const hyL4 = hy;

  // Fond bleu toute la ligne
  setBlue();
  doc.rect(M, hyL4, UW, rowL4H, 'F');

  // ‚Äî Zone Activit√© (gauche de sep2) avec SA propre hauteur
  drawTextWhite(activiteLabel + ' :', M+5, hyL4 + P.fontEnteteLabel * 1.1 + 3, P.fontEnteteLabel, true);
  doc.setFillColor(255,255,255);
  setBlueStroke(0.5);
  // La case Activit√© utilise uniquement sa hauteur n√©cessaire
  doc.rect(M + actLabelW + 8, hyL4 + 3, actBoxW, actNeededH - 6, 'FD');
  if (activiteSegments && activiteSegments.length > 0) {
    drawRichTextSegments(activiteSegments, M + actLabelW + 10, hyL4 + P.fontEnteteContent * 0.85 + 4, actBoxW - 4, P.fontEnteteContent, [0,0,0]);
  }

  // ‚Äî Zone Support (droite de sep2) avec SA propre hauteur
  setBlue();
  drawTextWhite(supportLabel + ' :', sep2 + 5, hyL4 + P.fontEnteteLabel * 1.1 + 3, P.fontEnteteLabel, true);
  doc.setFillColor(255,255,255);
  setBlueStroke(0.5);
  // La case Support utilise uniquement sa hauteur n√©cessaire
  doc.rect(supportBoxX, hyL4 + 3, supportBoxW, supportNeededH - 6, 'FD');
  if (supportSegments && supportSegments.length > 0) {
    drawRichTextSegments(supportSegments, supportBoxX + 2, hyL4 + P.fontEnteteContent * 0.85 + 4, supportBoxW - 4, P.fontEnteteContent, [0,0,0]);
  }
  hy += rowL4H;

  // ‚îÄ‚îÄ LIGNES LIBRES SUPPL√âMENTAIRES (entre ligne 4 et objectif)
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        const llLabel = normaliserTexte(ll.label || 'Champ');
        const llVal = ll.val1 || '';
        setBlue();
        doc.rect(M, hy, UW, L234H, 'F');
        drawTextWhite(llLabel + ' :', M+5, hy + L234H*0.65, P.fontEnteteLabel, true);
        const llLabelW = doc.getTextWidth(llLabel + ' :') + 4;
        drawInputBox(M+llLabelW+8, hy+3, endX-(M+llLabelW+8)-4, L234H-6, llVal, P.fontEnteteContent);
        hy += L234H;
      } else {
        // Double
        const ll1 = normaliserTexte(ll.label1 || 'Champ A');
        const ll2 = normaliserTexte(ll.label2 || 'Champ B');
        setBlue();
        doc.rect(M, hy, UW, L234H, 'F');
        // S√©parateur au milieu
        const midX = M + UW/2;
        doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
        doc.line(midX, hy, midX, hy+L234H);
        // Gauche
        const ll1Y = hy + L234H * 0.65;
        drawTextWhite(ll1 + ' :', M+5, ll1Y, P.fontEnteteLabel, true);
        const ll1W = doc.getTextWidth(ll1 + ' :') + 4;
        drawInputBox(M+ll1W+8, hy+3, midX-(M+ll1W+8)-2, L234H-6, ll.val1||'', P.fontEnteteContent);
        // Droite
        drawTextWhite(ll2 + ' :', midX+5, ll1Y, P.fontEnteteLabel, true);
        const ll2W = doc.getTextWidth(ll2 + ' :') + 4;
        drawInputBox(midX+ll2W+8, hy+3, endX-(midX+ll2W+8)-4, L234H-6, ll.val2||'', P.fontEnteteContent);
        hy += L234H;
      }
    });
  }

  // ‚îÄ‚îÄ Ligne Objectif ‚Äî hauteur 100 % flexible selon contenu r√©el
  const L5H = P.l5h;
  const objectifLabel = normaliserTexte(entete.labelObjectif || 'Objectif');
  const objectifSegments = htmlToRichSegments(entete.objectif);
  const objectifBoxW = endX - (M + 60) - 2;

  // Mesurer la hauteur r√©elle n√©cessaire pour le contenu de l'objectif
  let objectifMeasuredH = 0;
  if (objectifSegments.length > 0) {
    // Compter lignes : chaque newline et chaque wrapping de texte
    const lineHObj = P.fontEnteteContent * 1.45;
    let curLineW = 0;
    let lineCount = 1; // au moins 1 ligne
    objectifSegments.forEach(seg => {
      if (seg.type === 'image') { lineCount += Math.ceil(120 / lineHObj) + 1; curLineW = 0; return; }
      if (seg.type === 'table') {
        const tdata = seg.tableData || [];
        tdata.forEach(row => { lineCount += 2; });
        curLineW = 0; return;
      }
      if (seg.text === '\n') { lineCount++; curLineW = 0; return; }
      const fs = seg.fontSize || P.fontEnteteContent;
      const style = seg.bold && seg.italic ? 'bolditalic' : seg.bold ? 'bold' : seg.italic ? 'italic' : 'normal';
      doc.setFontSize(fs); doc.setFont('times', style);
      const words = seg.text.split(/\s+/);
      words.forEach(w => {
        if (!w) return;
        const wW = doc.getTextWidth(normaliserTexte(w));
        if (curLineW + wW > objectifBoxW - 8 && curLineW > 0 && w.trim()) { lineCount++; curLineW = 0; }
        curLineW += wW;
      });
    });
    objectifMeasuredH = lineCount * lineHObj + 10; // +10 padding vertical (r√©duit de 12 √† 10)
  } else {
    // Si vide, utiliser une hauteur minimale r√©duite
    objectifMeasuredH = L5H * 0.5; // Hauteur minimale r√©duite quand vide
  }
  // Prendre le minimum entre L5H et la hauteur mesur√©e + padding
  const objectifNeededH = Math.max(L5H * 0.6, objectifMeasuredH); // Hauteur minimum r√©duite √† 60% de L5H

  setBlue();
  doc.rect(M, hy, 60, objectifNeededH, 'F');
  drawTextWhite(objectifLabel + ' :', M+3, hy + Math.min(20, objectifNeededH * 0.4), P.fontEnteteLabel, true);
  doc.setFillColor(255,255,255);
  setBlueStroke(0.5);
  doc.rect(M+60, hy+2, objectifBoxW, objectifNeededH-4, 'FD');
  if (objectifSegments.length > 0) {
    drawRichTextSegments(objectifSegments, M+62, hy + P.fontEnteteContent * 0.85 + 3, objectifBoxW - 6, P.fontEnteteContent, [0,0,0]);
  }
  const dynamicHeaderH = (hy - M) + objectifNeededH;
  hy += objectifNeededH;

  setBlueStroke(1.5);
  doc.setFillColor(0,0,0);
  doc.rect(M, M, UW, dynamicHeaderH, 'S');

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // PAGE 1 : TABLEAU ‚Äî EN-T√äTE
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let ty = M + dynamicHeaderH + P.gap; // top du tableau

  const colsSup = P.colsSup || [];
  // Construire les en-t√™tes et largeurs : [√âtapes, D√©roulement, ...SupCols, Dur√©e]
  const colHeaders = [P.labelColEtapes, P.labelColDeroulement, ...colsSup.map(c => c.label), P.labelColDuree];
  const colWidths  = [P.cols[0] * UW, P.cols[1] * UW, ...colsSup.map(c => (c.width/100) * UW), P.cols[2] * UW];

  const TH = P.tableHeaderH;
  setBlue();
  doc.rect(M, ty, UW, TH, 'F');
  // s√©parateurs et textes en-t√™te colonnes
  let cx = M;
  colHeaders.forEach((hdr, i) => {
    // s√©parateur vertical (sauf premier)
    if (i > 0) {
      doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
      doc.line(cx, ty, cx, ty+TH);
    }
    const lines = hdr.split('\n');
    doc.setTextColor(255,255,255);
    doc.setFontSize(P.fontTableHeader);
    doc.setFont('times','bold');
    if (lines.length === 1) {
      doc.text(lines[0], cx + colWidths[i]/2, ty + TH/2 + P.fontTableHeader*0.35, {align:'center'});
    } else {
      doc.text(lines[0], cx + colWidths[i]/2, ty + TH*0.38, {align:'center'});
      doc.text(lines[1], cx + colWidths[i]/2, ty + TH*0.72, {align:'center'});
    }
    cx += colWidths[i];
  });
  // bordure tableau
  setBlueStroke(0.8);
  doc.rect(M, ty, UW, TH, 'S');
  ty += TH;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // LIGNES DE DONN√âES (multipages)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const RH = P.rowHeight;
  const bottomLimit = PH - M;
  let currentPage = 1;

  function newPage() {
    // Remplir la page courante jusqu'en bas avant de tourner la page
    while (ty + RH <= bottomLimit) {
      doc.setFillColor(255,255,255);
      doc.rect(M, ty, UW, RH, 'F');
      doc.setLineWidth(0.8);
      setBlueStroke(0.8);
      doc.rect(M, ty, UW, RH, 'S');
      ty += RH;
    }
    doc.addPage();
    currentPage++;
    ty = M;
    // En-t√™te du tableau sur la nouvelle page (identique √† la premi√®re)
    setBlue();
    doc.rect(M, ty, UW, TH, 'F');
    let cx2 = M;
    colHeaders.forEach((hdr, i) => {
      if (i > 0) {
        doc.setDrawColor(255,255,255); doc.setLineWidth(0.5);
        doc.line(cx2, ty, cx2, ty+TH);
      }
      const lines = hdr.split('\n');
      doc.setTextColor(255,255,255);
      doc.setFontSize(P.fontTableHeader);
      doc.setFont('times','bold');
      if (lines.length === 1) {
        doc.text(lines[0], cx2 + colWidths[i]/2, ty + TH/2 + P.fontTableHeader*0.35, {align:'center'});
      } else {
        doc.text(lines[0], cx2 + colWidths[i]/2, ty + TH*0.38, {align:'center'});
        doc.text(lines[1], cx2 + colWidths[i]/2, ty + TH*0.72, {align:'center'});
      }
      cx2 += colWidths[i];
    });
    setBlueStroke(0.8);
    doc.rect(M, ty, UW, TH, 'S');
    ty += TH;
  }

  // Pr√©parer les lignes de donn√©es
  // Chaque √©tape = bloc de lignes
  // Calculer nb de lignes n√©cessaires par √©tape (wrap)
  function wrapText(text, width, fontSize) {
    if (!text) return [''];
    doc.setFontSize(fontSize);
    doc.setFont('times','normal');
    return doc.splitTextToSize(normaliserTexte(text), width - 4);
  }

  etapes.forEach((etape, etapeIdx) => {
    const w0 = colWidths[0];  // √âtapes
    const w1 = colWidths[1];  // D√©roulement
    const wLast = colWidths[colWidths.length - 1]; // Dur√©e

    // Convertir le HTML Quill en segments riches
    const enseignantSegments = htmlToRichSegments(etape.enseignant);
    const ensTextW = w1 - 6;
    const blockHeight = Math.max(
      measureRichTextSegments(enseignantSegments, ensTextW, P.fontTableContent) + 6,
      P.fontTableContent * 1.35 + 6
    );

    // Separator bleu avant chaque √©tape (sauf la premi√®re)
    if (etapeIdx > 0) {
      if (ty + 2 > bottomLimit) newPage();
      setBlueStroke(1.0);
      doc.line(M, ty, M + UW, ty);
    }

    // Si bloc ne rentre pas, nouvelle page
    if (ty + blockHeight > bottomLimit) newPage();

    const blockStart = ty;

    // Fond blanc
    doc.setFillColor(255,255,255);
    doc.rect(M, ty, UW, blockHeight, 'F');

    // Texte col 0 : √©tape (centr√© verticalement, avec formatage HTML)
    doc.setFontSize(P.fontTableContent);
    doc.setTextColor(er, eg, eb);
    const etapeY = blockStart + blockHeight/2 + P.fontTableContent*0.35;
    
    // Parser le HTML du nom de l'√©tape pour extraire texte simple (pour le wrapping)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = etape.nom || '';
    const plainText = tempDiv.textContent || tempDiv.innerText || '';
    const etapeNomLines = wrapText(plainText, w0, P.fontTableContent);
    
    const lineHeight = P.fontTableContent * 1.3;
    if (etapeNomLines.length === 1) {
      // Une seule ligne - dessiner avec formatage HTML centr√©
      drawFormattedTextCentered(etape.nom, M + w0/2, etapeY, w0, P.fontTableContent, [er, eg, eb]);
    } else {
      // Multi-lignes - dessiner chaque ligne (sans HTML pour simplifier)
      const startY = blockStart + blockHeight/2 - (etapeNomLines.length * lineHeight)/2 + P.fontTableContent*0.85;
      doc.setFont('times','bold');
      etapeNomLines.forEach((l, li) => {
        doc.text(l, M + w0/2, startY + li*lineHeight, {align:'center'});
      });
    }

    // Texte d√©roulement (col 1)
    const ens_x = M + w0 + 3;
    drawRichTextSegments(enseignantSegments, ens_x, blockStart + P.fontTableContent * 0.85 + 3, ensTextW, P.fontTableContent, [0,0,0]);

    // Colonnes suppl√©mentaires
    let supX = M + w0 + w1;
    colsSup.forEach((col, ci) => {
      const wSup = colWidths[2 + ci];
      const supVal = (etape.supVals && etape.supVals[col.n]) ? normaliserTexte(etape.supVals[col.n]) : '';
      doc.setFont('times','normal');
      doc.setTextColor(0,0,0);
      doc.setFontSize(P.fontTableContent);
      const supLines = wrapText(supVal, wSup, P.fontTableContent);
      supLines.forEach((line, li) => {
        doc.text(line, supX + 2, blockStart + P.fontTableContent * (0.85 + li * 1.3) + 3);
      });
      supX += wSup;
    });

    // Dur√©e (derni√®re colonne)
    doc.setFont('times','normal');
    doc.setTextColor(0,0,0);
    doc.setFontSize(P.fontTableContent);
    const dur_x = M + UW - wLast + 2;
    doc.text(normaliserTexte(etape.duree || ''), dur_x, blockStart + blockHeight/2 + P.fontTableContent*0.35);

    // Bordure ext√©rieure du bloc (bleu)
    doc.setLineWidth(0.8);
    setBlueStroke(0.8);
    doc.rect(M, blockStart, UW, blockHeight, 'S');

    // S√©parateurs verticaux entre colonnes
    doc.setDrawColor(gr, gg, gb); doc.setLineWidth(0.4);
    let sepX = M + w0;
    for (let i = 1; i < colWidths.length - 1; i++) {
      doc.line(sepX, blockStart, sepX, blockStart + blockHeight);
      sepX += colWidths[i];
    }
    doc.line(sepX, blockStart, sepX, blockStart + blockHeight); // avant Dur√©e

    ty += blockHeight;
  });

  // Remplissage lignes vides jusqu'en bas (page courante)
  while (ty + RH <= bottomLimit) {
    doc.setFillColor(255,255,255);
    doc.rect(M, ty, UW, RH, 'F');
    // Bordure ext√©rieure seulement (pas de quadrillage interne)
    doc.setLineWidth(0.8);
    setBlueStroke(0.8);
    doc.rect(M, ty, UW, RH, 'S');
    ty += RH;
  }

  // Num√©ros de page et copyright
  const totalPages = doc.internal.getNumberOfPages();
  for (let p = 1; p <= totalPages; p++) {
    doc.setPage(p);
    doc.setFontSize(8);
    doc.setTextColor(150,150,150);
    doc.setFont('times','normal');
    // Num√©ro de page centr√©
    doc.text(`Page ${p} / ${totalPages}`, PW/2, PH-4, {align:'center'});
    // Date √† gauche
    doc.text(`${new Date().toLocaleDateString('fr-FR')}`, M, PH-4);
    // Professeur √† droite
    doc.text(normaliserTexte(entete.prof || ''), endX, PH-4, {align:'right'});
    // Copyright discret en bas (tr√®s petit) avec ID unique invisible
    doc.setFontSize(6);
    doc.setTextColor(180,180,180);
    doc.text(`\u00A9 EZ-ZAKY AZIZ | App v3.0 | ${uniqueId}`, M, PH-1);
  }

  // Sauvegarde ‚Äî m√©thode sp√©ciale AppsGeyser WebView
  const safeName = (entete.activite || 'fiche').replace(/[^a-zA-Z0-9\u00C0-\u024F]/gi,'_').slice(0,40);
  const pdfFileName = `FichePedagogique_${safeName}_${entete.niveau || 'N'}.pdf`;
  
  // T√©l√©chargement direct en un clic
  doc.save(pdfFileName);

  showToast();
  
  } catch (error) {
    console.error('Erreur PDF:', error);
    alert('‚ùå Erreur lors de la g√©n√©ration du PDF.\n\nD√©tails: ' + error.message + '\n\nAssurez-vous que :\n1. Vous avez une connexion internet\n2. La biblioth√®que jsPDF est charg√©e\n3. Tous les champs sont correctement remplis');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TH√àMES DE MISE EN PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THEMES = [
  { id:'bleu',      name:'Bleu classique', main:'#1565C0', accent:'#C9A84C', grid:'#AAAAAA', etape:'#1565C0' },
  { id:'marine',    name:'Marine & or',    main:'#0D2B55', accent:'#D4AF37', grid:'#8899AA', etape:'#0D2B55' },
  { id:'vert',      name:'Vert acad√©mique',main:'#1B5E20', accent:'#F9A825', grid:'#A5C8A0', etape:'#1B5E20' },
  { id:'bordeaux',  name:'Bordeaux',       main:'#6D0C22', accent:'#C49A3C', grid:'#B07070', etape:'#6D0C22' },
  { id:'violet',    name:'Violet royal',   main:'#4A148C', accent:'#FFB300', grid:'#9E7CC0', etape:'#4A148C' },
  { id:'ardoise',   name:'Ardoise gris',   main:'#37474F', accent:'#78909C', grid:'#90A4AE', etape:'#37474F' },
  { id:'noir',      name:'Noir & or',      main:'#1A1A1A', accent:'#C9A84C', grid:'#555555', etape:'#C9A84C' },
  { id:'turquoise', name:'Turquoise',      main:'#00695C', accent:'#E65100', grid:'#80CBC4', etape:'#00695C' },
  { id:'rouge',     name:'Rouge vif',      main:'#B71C1C', accent:'#FFD600', grid:'#EF9A9A', etape:'#B71C1C' },
];

let activeThemeId = 'bleu';

function buildThemeGrid() {
  const grid = document.getElementById('theme-grid');
  grid.innerHTML = '';
  THEMES.forEach(t => {
    const div = document.createElement('div');
    div.className = 'theme-swatch' + (t.id === activeThemeId ? ' active' : '');
    div.id = 'swatch-' + t.id;
    div.onclick = () => applyTheme(t.id);
    div.innerHTML = `
      <div class="theme-swatch-bar" style="background:${t.main};">
        <div class="theme-swatch-dot" style="background:${t.accent};"></div>
        <div class="theme-swatch-dot"></div>
        <div class="theme-swatch-dot"></div>
      </div>
      <div class="theme-swatch-body">
        <div class="theme-swatch-line" style="background:${t.main};opacity:0.15;width:100%;"></div>
        <div class="theme-swatch-row">
          <div class="theme-swatch-line" style="background:${t.etape};width:35%;"></div>
          <div class="theme-swatch-line" style="background:#e0e0e0;flex:1;"></div>
        </div>
        <div class="theme-swatch-line" style="background:#e0e0e0;width:80%;"></div>
      </div>
      <div class="theme-swatch-name">${t.name}</div>
    `;
    grid.appendChild(div);
  });
}

function applyTheme(id) {
  const t = THEMES.find(x => x.id === id);
  if (!t) return;
  activeThemeId = id;
  document.getElementById('p-color-main').value = t.main;
  document.getElementById('p-color-accent').value = t.accent;
  document.getElementById('p-color-grid').value = t.grid;
  document.getElementById('p-color-etape-text').value = t.etape;
  // Mettre √† jour les swatches actifs
  document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
  const sw = document.getElementById('swatch-' + id);
  if (sw) sw.classList.add('active');
  applyThemePreview();
  // Appliquer aussi √† l'interface de l'app
  applyThemeToApp(t.main, t.accent);
}

function applyThemePreview() {
  const main = document.getElementById('p-color-main').value;
  const accent = document.getElementById('p-color-accent').value;
  const etape = document.getElementById('p-color-etape-text').value;
  // Aper√ßu mini
  document.getElementById('tp-header').style.background = main;
  document.getElementById('tp-badge').style.background = accent;
  document.getElementById('tp-table-header').style.background = main;
  document.getElementById('tp-label1').style.color = main;
  document.getElementById('tp-label2').style.color = main;
  document.getElementById('tp-etape').style.color = etape;
}

function applyThemeToApp(main, accent) {
  // Mettre √† jour les variables CSS de l'interface
  const r = document.documentElement.style;
  r.setProperty('--blue', main);
  r.setProperty('--blue-light', main);
  r.setProperty('--blue-dark', main);
  r.setProperty('--blue-pale', main + '18');
  r.setProperty('--gold', accent);
}

// Initialisation
buildThemeGrid();
applyThemePreview();


function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOUVELLES FONCTIONNALIT√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê



// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ COLLECTER DONN√âES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function collecterDonnees() {
  const entete = collecterEntete();
  const etapes = collecterEtapes();
  
  return {
    entete: entete,
    etapes: etapes,
    objectifs: [entete.objectif], // L'objectif est dans l'en-t√™te
    timestamp: Date.now()
  };
}

function genererPreviewLive() {
  const entete  = collecterEntete();
  const etapes  = collecterEtapes();
  const P       = collecterParams();
  const content = document.getElementById('preview-live-content');
  if (!content) return;

  const couleur = (document.getElementById('p-color-main')?.value) || '#1565C0';
  const accent  = (document.getElementById('p-color-accent')?.value) || '#C9A84C';

  // ‚îÄ‚îÄ EN-T√äTE ‚îÄ‚îÄ
  let html = `<div style="margin:0 0 14px;padding:12px 14px;border:2px solid ${couleur};border-radius:10px;background:#fff;font-size:13px;line-height:1.7;">`;

  // Ligne prof / niveau
  html += `<div style="display:flex;gap:6px;margin-bottom:4px;">
    <div style="flex:1;padding:5px 8px;background:${couleur}15;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelProf||'Prof'} :</span>
      <span style="color:#222;"> ${entete.prof||'‚Äî'}</span>
    </div>
    <div style="min-width:90px;padding:5px 8px;background:${couleur}15;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelNiveau||'Niveau'} :</span>
      <span style="color:#222;"> ${entete.niveau||'‚Äî'}</span>
    </div>
  </div>`;

  // Module
  if (entete.module || entete.labelModule) {
    html += `<div style="padding:4px 8px;margin-bottom:3px;"><span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelModule||'Module'} :</span> <span style="color:#222;">${entete.module||'‚Äî'}</span></div>`;
  }

  // S√©quence
  if (entete.sequence || entete.labelSequence) {
    html += `<div style="padding:4px 8px;margin-bottom:3px;"><span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelSequence||'S√©quence'} :</span> <span style="color:#222;">${entete.sequence||'‚Äî'}</span></div>`;
  }

  // Activit√© / Support
  html += `<div style="display:flex;gap:6px;margin-bottom:4px;">
    <div style="flex:1;padding:4px 8px;background:${accent}22;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelActivite||'Activit√©'} :</span>
      <span style="color:#222;"> ${entete.activite||'‚Äî'}</span>
    </div>
    <div style="min-width:90px;padding:4px 8px;background:${accent}22;border-radius:5px;">
      <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelSupport||'Support'} :</span>
      <span style="color:#222;"> ${entete.support||'‚Äî'}</span>
    </div>
  </div>`;

  // Lignes libres
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        html += `<div style="padding:4px 8px;margin-bottom:3px;"><span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${ll.label||'Champ'} :</span> <span style="color:#222;">${ll.val1||'‚Äî'}</span></div>`;
      } else {
        html += `<div style="display:flex;gap:6px;margin-bottom:3px;">
          <div style="flex:1;padding:4px 8px;background:${couleur}0d;border-radius:5px;">
            <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${ll.label1||'A'} :</span>
            <span style="color:#222;"> ${ll.val1||'‚Äî'}</span>
          </div>
          <div style="flex:1;padding:4px 8px;background:${couleur}0d;border-radius:5px;">
            <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${ll.label2||'B'} :</span>
            <span style="color:#222;"> ${ll.val2||'‚Äî'}</span>
          </div>
        </div>`;
      }
    });
  }

  // Objectif
  const objTxt = getQuillText('objectif-wrapper') || '‚Äî';
  html += `<div style="padding:5px 8px;margin-top:2px;border-top:1px solid ${couleur}33;">
    <span style="font-weight:700;color:${couleur};font-size:11px;text-transform:uppercase;">${entete.labelObjectif||'Objectif(s)'} :</span>
    <span style="color:#444;font-style:italic;"> ${objTxt.substring(0,200)}${objTxt.length>200?'‚Ä¶':''}</span>
  </div>`;

  html += `</div>`;

  // ‚îÄ‚îÄ TABLEAU DES √âTAPES ‚îÄ‚îÄ
  if (etapes.length === 0) {
    html += `<p style="color:#999;font-size:13px;text-align:center;padding:20px;">Aucune √©tape saisie.</p>`;
  } else {
    const colsSup = P.colsSup || [];
    html += `<div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead>
        <tr style="background:${couleur};color:white;">
          <th style="padding:7px 8px;border:1px solid ${couleur};text-align:left;font-weight:700;">${P.labelColEtapes||'√âtapes'}</th>
          <th style="padding:7px 8px;border:1px solid ${couleur};text-align:left;font-weight:700;">${P.labelColDeroulement||'D√©roulement de la s√©ance'}</th>
          ${colsSup.map(c => `<th style="padding:7px 8px;border:1px solid ${couleur};text-align:left;font-weight:700;">${c.label}</th>`).join('')}
          <th style="padding:7px 8px;border:1px solid ${couleur};text-align:center;font-weight:700;">${P.labelColDuree||'Dur√©e'}</th>
        </tr>
      </thead>
      <tbody>`;

    etapes.forEach((e, i) => {
      const bg = i % 2 === 0 ? '#fff' : `${couleur}08`;
      // Extraire le texte brut du HTML enseignant
      const div = document.createElement('div');
      div.innerHTML = e.enseignant || '';
      const enseignantTxt = div.textContent || '';
      html += `<tr style="background:${bg};">
          <td style="padding:6px 8px;border:1px solid ${couleur}44;font-weight:600;color:${couleur};">${e.nom||'‚Äî'}</td>
          <td style="padding:6px 8px;border:1px solid ${couleur}44;color:#333;">${enseignantTxt||'‚Äî'}</td>
          ${colsSup.map(c => `<td style="padding:6px 8px;border:1px solid ${couleur}44;color:#555;">${e.supVals?.[c.n]||'‚Äî'}</td>`).join('')}
          <td style="padding:6px 8px;border:1px solid ${couleur}44;text-align:center;color:#555;">${e.duree||'‚Äî'}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
  }

  content.innerHTML = html;
}

// Mettre √† jour la pr√©visualisation quand les donn√©es changent
document.addEventListener('input', function(e) {
  clearTimeout(window.previewTimeout);
  window.previewTimeout = setTimeout(genererPreviewLive, 500);
  // Recalculer dur√©e si champ dur√©e modifi√©
  if (e.target && e.target.id && e.target.id.includes('-duree')) {
    calculerDureeTotale();
  }
  // Sauvegarde auto avec debounce
  clearTimeout(window.saveTimeout);
  window.saveTimeout = setTimeout(sauvegarderAutomatique, 1500);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITAIRE : Conversion couleur vers format Word (RRGGBB)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function colorToWordHex(color) {
  if (!color) return null;
  
  // Si d√©j√† au format RRGGBB (6 caract√®res sans #)
  if (/^[0-9A-Fa-f]{6}$/.test(color)) {
    return color.toUpperCase();
  }
  
  // Utiliser hexToRgb pour convertir n'importe quel format
  const [r, g, b] = hexToRgb(color);
  
  // Convertir en hexad√©cimal RRGGBB
  const toHex = (n) => {
    const hex = n.toString(16).toUpperCase();
    return hex.length === 1 ? '0' + hex : hex;
  };
  
  return toHex(r) + toHex(g) + toHex(b);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EXPORT DOCX (OpenXML via JSZip) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genererDOCX() {
  if (typeof JSZip === 'undefined') {
    alert('‚ö†Ô∏è La biblioth√®que Word n\'est pas charg√©e.\n\nPour utiliser cette fonctionnalit√© :\n1. Assurez-vous d\'avoir une connexion internet\n2. Rechargez la page\n3. Attendez quelques secondes que les biblioth√®ques se chargent');
    return;
  }

  const entete = collecterEntete();
  const etapes = collecterEtapes();
  const P = collecterParams();

  const rawColor = ((document.getElementById('p-color-main') && document.getElementById('p-color-main').value) || '#1565C0').replace('#','');

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function x(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
  }
  function strip(html) {
    if (!html) return '';
    const d = document.createElement('div');
    d.innerHTML = html;
    return d.textContent || d.innerText || '';
  }

  // ‚îÄ‚îÄ Dimensions en twips (1 cm = 567 twips) ‚îÄ‚îÄ
  // A4 : 11906 √ó 16838 twips  |  marges : 284 twips ‚âà 5 mm chaque c√¥t√©
  const PG_W   = 11906;
  const MARGIN = 284;          // 5 mm ‚Äî coll√© aux bords
  const TW     = PG_W - MARGIN * 2;  // 11338 twips = largeur utile

  // En-t√™te : label court (2cm) + valeur large
  const LBL_W  = Math.round(TW * 0.18);   // ~18% ‚âà 2040 twips
  const VAL_W  = TW - LBL_W;              // ~82%

  // Ligne double (prof|niveau, activit√©|support) : 4 colonnes
  const LBL2_W = Math.round(TW * 0.16);   // 16%
  const VAL2_W = Math.round(TW * 0.34);   // 34%  ‚Üí 2√ó(16+34)=100%

  // Tableau √©tapes : colonnes dynamiques
  const colsSup = P.colsSup || [];
  const E0 = Math.round(TW * (P.cols[0]));   // √âtapes
  const E1 = Math.round(TW * (P.cols[1]));   // D√©roulement
  const E2 = TW - E0 - E1 - colsSup.reduce((s, c) => s + Math.round(TW * c.width/100), 0); // Dur√©e
  const ESup = colsSup.map(c => Math.round(TW * c.width / 100)); // Colonnes sup

  const BDR = (color) => `<w:tcBorders>
      <w:top    w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
      <w:left   w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
      <w:bottom w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
      <w:right  w:val="single" w:sz="6" w:space="0" w:color="${color}"/>
    </w:tcBorders>`;

  const CELL_MAR = `<w:tcMar>
      <w:top    w:w="60"  w:type="dxa"/>
      <w:bottom w:w="60"  w:type="dxa"/>
      <w:left   w:w="100" w:type="dxa"/>
      <w:right  w:w="100" w:type="dxa"/>
    </w:tcMar>`;

  // Cellule g√©n√©rique : (texte, gras, fondColor√©, largeurDxa, alignCenter, italique)
  function cell(text, bold, colored, w, center, italic) {
    const fill  = colored ? rawColor : 'FFFFFF';
    const tClr  = colored ? 'FFFFFF' : '000000';
    const jc    = center  ? '<w:jc w:val="center"/>' : '';
    return `<w:tc>
      <w:tcPr>
        <w:tcW w:w="${w}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="${fill}"/>
        ${BDR(rawColor)}
        ${CELL_MAR}
      </w:tcPr>
      <w:p>
        <w:pPr><w:spacing w:before="40" w:after="40"/>${jc}</w:pPr>
        <w:r>
          <w:rPr>
            ${bold   ? '<w:b/>'   : ''}
            ${italic ? '<w:i/>'   : ''}
            <w:color w:val="${tClr}"/>
            <w:sz w:val="18"/><w:szCs w:val="18"/>
          </w:rPr>
          <w:t xml:space="preserve">${x(text)}</w:t>
        </w:r>
      </w:p>
    </w:tc>`;
  }

  // Cellule avec support du formatage HTML (gras/italique/couleur/surlignage)
  function cellWithFormat(htmlText, colored, w, center) {
    const fill  = colored ? rawColor : 'FFFFFF';
    const tClr  = colored ? 'FFFFFF' : '000000';
    const jc    = center  ? '<w:jc w:val="center"/>' : '';
    
    const temp = document.createElement('div');
    temp.innerHTML = htmlText || '';
    
    let runs = '';
    
    function processNode(node, isBold, isItalic, isUnderline, textColor, bgColor) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        if (text) {
          // Couleur du texte : priorit√© √† la couleur h√©rit√©e, sinon couleur par d√©faut de la cellule
          const resolvedColor = textColor ? colorToWordHex(textColor) : tClr;
          // Couleur de fond (surlignage)
          const bgXml = bgColor ? `<w:shd w:val="clear" w:color="auto" w:fill="${colorToWordHex(bgColor)}"/>` : '';
          runs += `<w:r>
            <w:rPr>
              ${isBold ? '<w:b/><w:bCs/>' : ''}
              ${isItalic ? '<w:i/><w:iCs/>' : ''}
              ${isUnderline ? '<w:u w:val="single"/>' : ''}
              <w:color w:val="${resolvedColor}"/>
              ${bgXml}
              <w:sz w:val="18"/><w:szCs w:val="18"/>
            </w:rPr>
            <w:t xml:space="preserve">${x(text)}</w:t>
          </w:r>`;
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName.toLowerCase();
        let bold      = isBold      || tag === 'b' || tag === 'strong';
        let italic    = isItalic    || tag === 'i' || tag === 'em';
        let underline = isUnderline || tag === 'u';
        let color     = textColor;
        let bg        = bgColor;
        
        // <font color="..."> g√©n√©r√© par execCommand('foreColor')
        if (tag === 'font') {
          if (node.getAttribute('color')) color = node.getAttribute('color');
          if (node.getAttribute('bgcolor')) bg = node.getAttribute('bgcolor');
        }
        // <span style="color:...; background-color:..."> g√©n√©r√© par execCommand moderne
        if (node.style && node.style.color) color = node.style.color;
        if (node.style && node.style.backgroundColor) bg = node.style.backgroundColor;
        
        // Saut de ligne
        if (tag === 'br') {
          runs += `<w:r><w:br/></w:r>`;
          return;
        }
        
        Array.from(node.childNodes).forEach(child => {
          processNode(child, bold, italic, underline, color, bg);
        });
      }
    }
    
    Array.from(temp.childNodes).forEach(child => {
      processNode(child, false, false, false, null, null);
    });
    
    if (!runs) {
      runs = `<w:r>
        <w:rPr>
          <w:color w:val="${tClr}"/>
          <w:sz w:val="18"/><w:szCs w:val="18"/>
        </w:rPr>
        <w:t xml:space="preserve"></w:t>
      </w:r>`;
    }
    
    return `<w:tc>
      <w:tcPr>
        <w:tcW w:w="${w}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="${fill}"/>
        ${BDR(rawColor)}
        ${CELL_MAR}
      </w:tcPr>
      <w:p>
        <w:pPr><w:spacing w:before="40" w:after="40"/>${jc}</w:pPr>
        ${runs}
      </w:p>
    </w:tc>`;
  }

  // ‚îÄ‚îÄ Convertit HTML Quill ‚Üí paragraphes OpenXML ‚îÄ‚îÄ
  // CORRECTION COMPL√àTE: Parser le HTML Quill pour extraire texte, images ET tableaux
  // Collecteur global d'images pour les ajouter au ZIP
  let docxImages = [];
  let docxImageCounter = 0;
  
  // Fonction helper pour convertir HTML en runs Word ‚Äî lit les couleurs du contenu, avec gras par d√©faut
  function htmlToRunsWithColor(htmlText, defaultColor) {
    const temp = document.createElement('div');
    temp.innerHTML = htmlText || '';
    
    let runs = '';
    
    function processNode(node, isBold, isItalic, isUnderline, textColor, bgColor) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        if (text) {
          // Couleur r√©solue : couleur h√©rit√©e du HTML, sinon defaultColor (couleur du th√®me)
          const resolvedColor = textColor ? colorToWordHex(textColor) : defaultColor;
          const bgXml = bgColor ? `<w:shd w:val="clear" w:color="auto" w:fill="${colorToWordHex(bgColor)}"/>` : '';
          runs += `<w:r>
            <w:rPr>
              <w:b/><w:bCs/>
              ${isItalic ? '<w:i/><w:iCs/>' : ''}
              ${isUnderline ? '<w:u w:val="single"/>' : ''}
              <w:color w:val="${resolvedColor}"/>
              ${bgXml}
              <w:sz w:val="18"/><w:szCs w:val="18"/>
            </w:rPr>
            <w:t xml:space="preserve">${x(text)}</w:t>
          </w:r>`;
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName.toLowerCase();
        let bold      = isBold      || tag === 'b' || tag === 'strong';
        let italic    = isItalic    || tag === 'i' || tag === 'em';
        let underline = isUnderline || tag === 'u';
        let color     = textColor;
        let bg        = bgColor;
        
        // <font color="..."> g√©n√©r√© par execCommand('foreColor')
        if (tag === 'font') {
          if (node.getAttribute('color')) color = node.getAttribute('color');
          if (node.getAttribute('bgcolor')) bg = node.getAttribute('bgcolor');
        }
        // <span style="color:...; background-color:...">
        if (node.style && node.style.color) color = node.style.color;
        if (node.style && node.style.backgroundColor) bg = node.style.backgroundColor;
        
        if (tag === 'br') {
          runs += `<w:r><w:br/></w:r>`;
          return;
        }
        
        Array.from(node.childNodes).forEach(child => {
          processNode(child, bold, italic, underline, color, bg);
        });
      }
    }
    
    Array.from(temp.childNodes).forEach(child => {
      processNode(child, false, false, false, null, null);
    });
    
    if (!runs) {
      runs = `<w:r>
        <w:rPr>
          <w:b/><w:bCs/>
          <w:color w:val="${defaultColor}"/>
          <w:sz w:val="18"/><w:szCs w:val="18"/>
        </w:rPr>
        <w:t></w:t>
      </w:r>`;
    }
    
    return runs;
  }
  
  function htmlToWParagraphs(html, fontSize) {
    if (!html) return `<w:p><w:pPr><w:spacing w:before="40" w:after="40"/></w:pPr></w:p>`;
    const fs = fontSize || 18;
    
    // Utiliser la m√™me fonction que le PDF pour parser le HTML
    const segments = htmlToRichSegmentsForDocx(html);
    
    let output = '';
    let currentParagraph = [];
    
    segments.forEach((seg, idx) => {
      // IMAGE
      if (seg.type === 'image') {
        // Flush paragraph en cours
        if (currentParagraph.length > 0) {
          output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
          currentParagraph = [];
        }
        
        // Ajouter l'image √† la collection globale
        docxImageCounter++;
        const imageId = docxImageCounter;
        const rId = `rId${imageId + 1}`;  // +1 car rId1 est r√©serv√© pour styles.xml
        
        // D√©terminer l'extension
        let ext = 'png';
        if (seg.src.startsWith('data:image/jpeg') || seg.src.startsWith('data:image/jpg')) {
          ext = 'jpeg';
        } else if (seg.src.startsWith('data:image/gif')) {
          ext = 'gif';
        }
        
        // Dimensions : taille user (seg.w/seg.h en px CSS) ou naturelle
        let natW = 400, natH = 300;
        try {
          const tmpImg = new Image();
          tmpImg.src = seg.src;
          if (tmpImg.naturalWidth > 0) { natW = tmpImg.naturalWidth; natH = tmpImg.naturalHeight; }
        } catch(e) {}
        // Utiliser la taille d√©finie par l'utilisateur si disponible
        const usedW = (seg.w && seg.w > 0) ? seg.w : natW;
        const usedH = (seg.h && seg.h > 0) ? seg.h : Math.round(usedW * (natH / (natW || 1)));
        // 1 px CSS (96 DPI) = 9525 EMU ; largeur max ~14cm, hauteur max ~20cm
        const MAX_W_EMU = 5040000;
        const MAX_H_EMU = 7200000;
        const ratio = usedH / (usedW || 1);
        let widthEMU = Math.min(MAX_W_EMU, usedW * 9525);
        let heightEMU = Math.round(widthEMU * ratio);
        if (heightEMU > MAX_H_EMU) {
          heightEMU = MAX_H_EMU;
          widthEMU = Math.round(heightEMU / ratio);
        }
        
        docxImages.push({
          id: imageId,
          rId: rId,
          src: seg.src,
          ext: ext
        });
        
        // Structure XML EXACTEMENT comme le test qui fonctionne
        output += `<w:p>
      <w:r>
        <w:drawing>
          <wp:inline>
            <wp:extent cx="${widthEMU}" cy="${heightEMU}"/>
            <wp:docPr id="${imageId}" name="Picture ${imageId}"/>
            <a:graphic>
              <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
                <pic:pic>
                  <pic:nvPicPr>
                    <pic:cNvPr id="${imageId}" name="Picture ${imageId}"/>
                    <pic:cNvPicPr/>
                  </pic:nvPicPr>
                  <pic:blipFill>
                    <a:blip r:embed="${rId}"/>
                    <a:stretch>
                      <a:fillRect/>
                    </a:stretch>
                  </pic:blipFill>
                  <pic:spPr>
                    <a:xfrm>
                      <a:off x="0" y="0"/>
                      <a:ext cx="${widthEMU}" cy="${heightEMU}"/>
                    </a:xfrm>
                    <a:prstGeom prst="rect">
                      <a:avLst/>
                    </a:prstGeom>
                  </pic:spPr>
                </pic:pic>
              </a:graphicData>
            </a:graphic>
          </wp:inline>
        </w:drawing>
      </w:r>
    </w:p>`;
        return;
      }
      
      // TABLEAU
      if (seg.type === 'table') {
        // Flush paragraph en cours
        if (currentParagraph.length > 0) {
          output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
          currentParagraph = [];
        }
        
        // Cr√©er un vrai tableau Word
        const tableData = seg.tableData;
        if (tableData && tableData.length > 0) {
          // Calculer le nombre de colonnes
          const numCols = Math.max(...tableData.map(row => row.length));
          const colWidth = Math.floor(9000 / numCols); // Largeur totale divis√©e par nb colonnes
          
          output += `<w:tbl>
            <w:tblPr>
              <w:tblW w:w="9000" w:type="dxa"/>
              <w:tblBorders>
                <w:top w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:left w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:bottom w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:right w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:insideH w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
                <w:insideV w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
              </w:tblBorders>
            </w:tblPr>
            <w:tblGrid>`;
          
          for (let i = 0; i < numCols; i++) {
            output += `<w:gridCol w:w="${colWidth}"/>`;
          }
          output += `</w:tblGrid>`;
          
          // Lignes du tableau ‚Äî segments riches avec couleurs par run
          tableData.forEach((row, rowIdx) => {
            output += `<w:tr>`;
            row.forEach((cell, cellIdx) => {
              const isHeader = cell.isHeader || rowIdx === 0;
              // Fond de cellule : couleur personnalis√©e > header bleu p√¢le > blanc
              const bgFill = cell.bgColor
                ? colorToWordHex(cell.bgColor)
                : (isHeader ? 'E3F2FD' : 'FFFFFF');

              // Construire les runs riches depuis richContent
              const cellSegs = (cell.richContent && cell.richContent.length > 0)
                ? cell.richContent
                : [{ text: cell.text || '', bold: isHeader, italic: false, color: null, background: null }];

              let cellParagraphs = '';
              let curRuns = [];

              const flushCellPara = () => {
                const jc = isHeader ? '<w:jc w:val="center"/>' : '';
                cellParagraphs += `<w:p><w:pPr><w:spacing w:before="20" w:after="20"/>${jc}</w:pPr>${curRuns.join('')}</w:p>`;
                curRuns = [];
              };

              cellSegs.forEach(seg => {
                if (seg.text === '\n') { flushCellPara(); return; }
                if (!seg.text) return;
                const txtHex   = seg.color      ? colorToWordHex(seg.color)      : '000000';
                const bgHex    = seg.background ? colorToWordHex(seg.background) : null;
                const bgRunXml = bgHex ? `<w:shd w:val="clear" w:color="auto" w:fill="${bgHex}"/>` : '';
                const fontXml  = seg.font ? `<w:rFonts w:ascii="${seg.font}" w:hAnsi="${seg.font}" w:cs="${seg.font}"/>` : '';
                curRuns.push(`<w:r><w:rPr>${fontXml}${(seg.bold || isHeader) ? '<w:b/><w:bCs/>' : ''}${seg.italic ? '<w:i/><w:iCs/>' : ''}${seg.underline ? '<w:u w:val="single"/>' : ''}<w:color w:val="${txtHex}"/>${bgRunXml}<w:sz w:val="${fs}"/><w:szCs w:val="${fs}"/></w:rPr><w:t xml:space="preserve">${x(seg.text)}</w:t></w:r>`);
              });
              if (curRuns.length > 0) flushCellPara();
              if (!cellParagraphs) {
                cellParagraphs = `<w:p><w:pPr><w:spacing w:before="20" w:after="20"/></w:pPr><w:r><w:rPr><w:sz w:val="${fs}"/></w:rPr><w:t></w:t></w:r></w:p>`;
              }

              output += `<w:tc>
                <w:tcPr>
                  <w:tcW w:w="${colWidth}" w:type="dxa"/>
                  <w:shd w:val="clear" w:color="auto" w:fill="${bgFill}"/>
                </w:tcPr>
                ${cellParagraphs}
              </w:tc>`;
            });
            output += `</w:tr>`;
          });
          
          output += `</w:tbl>`;
          output += `<w:p><w:pPr><w:spacing w:before="0" w:after="100"/></w:pPr></w:p>`;
        }
        return;
      }
      
      // TEXTE
      if (seg.text) {
        if (seg.text === '\n') {
          if (currentParagraph.length > 0) {
            output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
            currentParagraph = [];
          }
        } else {
          const txt = x(seg.text);
          if (txt) {
            const segFs = seg.fontSize || fs;
            if (seg.listStart && currentParagraph.length > 0) {
              output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
              currentParagraph = [];
            }
            const fontXml = seg.font ? `<w:rFonts w:ascii="${seg.font}" w:hAnsi="${seg.font}" w:cs="${seg.font}"/>` : '';
            
            // Couleur du texte - Convertir en format Word (RRGGBB sans #)
            let colorXml = '';
            if (seg.color) {
              const colorHex = colorToWordHex(seg.color);
              if (colorHex) colorXml = `<w:color w:val="${colorHex}"/>`;
            }
            
            // Couleur de fond (surlignage) - Word utilise w:shd
            let bgXml = '';
            if (seg.background) {
              const bgHex = colorToWordHex(seg.background);
              if (bgHex) bgXml = `<w:shd w:val="clear" w:color="auto" w:fill="${bgHex}"/>`;
            }
            
            currentParagraph.push(`<w:r><w:rPr>${fontXml}${seg.bold?'<w:b/><w:bCs/>':''}${seg.italic?'<w:i/><w:iCs/>':''}${seg.underline?'<w:u w:val="single"/>':''}${colorXml}${bgXml}<w:sz w:val="${segFs}"/><w:szCs w:val="${segFs}"/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`);
          }
        }
      }
    });
    
    // Flush dernier paragraphe
    if (currentParagraph.length > 0) {
      output += `<w:p><w:pPr><w:spacing w:before="0" w:after="30"/></w:pPr>${currentParagraph.join('')}</w:p>`;
    }
    
    return output || `<w:p><w:pPr><w:spacing w:before="40" w:after="40"/></w:pPr></w:p>`;
  }
  
  // Parser HTML Quill en segments (texte, images, tableaux)
  function htmlToRichSegmentsForDocx(html) {
    if (!html || html.trim() === '') return [];
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const segments = [];

    const quillSizeMap = { 'small': 14, 'large': 24, 'huge': 30 }; // demi-points Word
    const headerSizeMap = { '1': 32, '2': 26, '3': 22 }; // demi-points Word

    function walk(node, ctx) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        if (text) segments.push({ 
          text, 
          bold: ctx.bold, 
          italic: ctx.italic, 
          underline: ctx.underline, 
          fontSize: ctx.fontSize, 
          isHeader: ctx.isHeader, 
          font: ctx.font || null,
          color: ctx.color || null,
          background: ctx.background || null
        });
        return;
      }
      if (node.nodeType !== Node.ELEMENT_NODE) return;
      const tag = node.tagName.toLowerCase();
      let c = Object.assign({}, ctx);

      if (tag === 'strong' || tag === 'b') c.bold = true;
      if (tag === 'em'     || tag === 'i') c.italic = true;
      if (tag === 'u') c.underline = true;
      
      // Balise <font> avec attributs color et/ou bgcolor (g√©n√©r√© par execCommand)
      if (tag === 'font') {
        if (node.getAttribute('color')) {
          c.color = node.getAttribute('color');
        }
        if (node.getAttribute('bgcolor')) {
          c.background = node.getAttribute('bgcolor');
        }
      }
      
      // Balise <span> avec attributs style (g√©n√©r√© par execCommand moderne)
      if (tag === 'span') {
        if (node.style.color) {
          c.color = node.style.color;
        }
        if (node.style.backgroundColor) {
          c.background = node.style.backgroundColor;
        }
      }

      // Headers
      if (tag === 'h1') { c.bold = true; c.fontSize = headerSizeMap['1']; c.isHeader = true; }
      if (tag === 'h2') { c.bold = true; c.fontSize = headerSizeMap['2']; c.isHeader = true; }
      if (tag === 'h3') { c.bold = true; c.fontSize = headerSizeMap['3']; c.isHeader = true; }

      // Taille via classe ql-size
      if (node.classList) {
        if (node.classList.contains('ql-size-small')) c.fontSize = quillSizeMap['small'];
        if (node.classList.contains('ql-size-large')) c.fontSize = quillSizeMap['large'];
        if (node.classList.contains('ql-size-huge'))  c.fontSize = quillSizeMap['huge'];
        // Police
        if (node.classList.contains('ql-font-times'))        c.font = 'Times New Roman';
        if (node.classList.contains('ql-font-georgia'))      c.font = 'Georgia';
        if (node.classList.contains('ql-font-merriweather')) c.font = 'Merriweather';
        if (node.classList.contains('ql-font-roboto'))       c.font = 'Roboto';
        if (node.classList.contains('ql-font-lato'))         c.font = 'Lato';
        if (node.classList.contains('ql-font-opensans'))     c.font = 'Open Sans';
        if (node.classList.contains('ql-font-courier'))      c.font = 'Courier New';
        
        // Couleurs Quill
        const colorClass = Array.from(node.classList).find(cls => cls.startsWith('ql-color-'));
        if (colorClass) {
          const colorValue = colorClass.replace('ql-color-', '').replace(/_/g, '');
          c.color = '#' + colorValue;
        }
        const bgClass = Array.from(node.classList).find(cls => cls.startsWith('ql-bg-'));
        if (bgClass) {
          const bgValue = bgClass.replace('ql-bg-', '').replace(/_/g, '');
          c.background = '#' + bgValue;
        }
      }
      
      // Couleur via style inline
      if (node.style) {
        if (node.style.color) c.color = node.style.color;
        if (node.style.backgroundColor) c.background = node.style.backgroundColor;
      }

      if (tag === 'br') {
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        return;
      }
      if (tag === 'p' || tag === 'h1' || tag === 'h2' || tag === 'h3') {
        Array.from(node.childNodes).forEach(ch => walk(ch, c));
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        return;
      }

      // ‚îÄ‚îÄ LISTES Quill v2 : <ol> avec <li data-list="ordered|bullet"> ‚îÄ‚îÄ
      if (tag === 'ol' || tag === 'ul') {
        let orderedIdx = 1;
        Array.from(node.children).forEach(li => {
          const dataList = li.getAttribute('data-list') || (tag === 'ol' ? 'ordered' : 'bullet');
          const isOrdered = dataList === 'ordered';
          const prefix = isOrdered ? (orderedIdx++) + '. ' : '‚Ä¢ ';
          segments.push({ text: prefix, bold: c.bold, italic: c.italic, underline: c.underline, fontSize: c.fontSize, listStart: true, isOrdered });
          Array.from(li.childNodes).forEach(ch => walk(ch, c));
          segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        });
        return;
      }
      // Li isol√©
      if (tag === 'li') {
        const dataList = node.getAttribute('data-list') || 'bullet';
        const isOrdered = dataList === 'ordered';
        segments.push({ text: isOrdered ? '1. ' : '‚Ä¢ ', bold: c.bold, italic: c.italic, underline: c.underline, fontSize: c.fontSize, listStart: true, isOrdered });
        Array.from(node.childNodes).forEach(ch => walk(ch, c));
        segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        return;
      }

      if (tag === 'img') {
        const src = node.getAttribute('src') || '';
        if (src.startsWith('data:image')) {
          // Lire la taille d√©finie par l'utilisateur (data-w/data-h ou style)
          const imgW = parseInt(node.getAttribute('data-w'))  || parseInt(node.style.width)  || node.naturalWidth  || 0;
          const imgH = parseInt(node.getAttribute('data-h'))  || parseInt(node.style.height) || node.naturalHeight || 0;
          segments.push({ type: 'image', src: src, w: imgW, h: imgH });
          segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        }
        return;
      }
      if (tag === 'table') {
        const tableData = [];
        node.querySelectorAll('tr').forEach(tr => {
          const rowData = [];
          tr.querySelectorAll('td, th').forEach(cell => {
            const isHeader = cell.tagName.toLowerCase() === 'th';
            let cellBg = null;
            if (cell.style && cell.style.backgroundColor) cellBg = cell.style.backgroundColor;
            const cellCtx = Object.assign({}, c, {
              bold:       isHeader || c.bold,
              color:      (cell.style && cell.style.color) ? cell.style.color : c.color,
              background: null
            });
            // Extraire les segments riches du contenu de la cellule
            const before = segments.length;
            Array.from(cell.childNodes).forEach(ch => walk(ch, cellCtx));
            const richContent = segments.splice(before);
            while (richContent.length && richContent[richContent.length-1].text === '\n') richContent.pop();
            rowData.push({
              text:        cell.textContent.trim(),
              isHeader:    isHeader,
              bgColor:     cellBg,
              richContent: richContent
            });
          });
          if (rowData.length > 0) tableData.push(rowData);
        });
        if (tableData.length > 0) {
          segments.push({ type: 'table', tableData });
          segments.push({ text: '\n', bold: false, italic: false, underline: false, fontSize: c.fontSize });
        }
        return;
      }
      Array.from(node.childNodes).forEach(ch => walk(ch, c));
    }

    const baseCtx = { bold: false, italic: false, underline: false, fontSize: null, isHeader: false };
    Array.from(temp.childNodes).forEach(n => walk(n, baseCtx));
    while (segments.length && segments[segments.length-1].text === '\n') segments.pop();
    return segments;
  }

  // R√©initialiser le compteur d'images AVANT de construire les tables (qui appellent htmlToWParagraphs)
  docxImages = [];
  docxImageCounter = 0;

  // Ligne simple : [LABEL | valeur pleine largeur]
  const rowFull = (lbl, val) => `<w:tr>${cell(lbl,true,true,LBL_W,false,false)}${cellWithFormat(val,false,VAL_W,false)}</w:tr>`;

  // Ligne simple avec valeur HTML riche (objectif)
  const rowFullRich = (lbl, htmlVal) => `<w:tr>
    ${cell(lbl,true,true,LBL_W,false,false)}
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${VAL_W}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
      </w:tcPr>
      ${htmlToWParagraphs(htmlVal, 18)}
    </w:tc>
  </w:tr>`;

  // Ligne double : [LABEL | val | LABEL | val]
  const rowDbl  = (l1,v1,l2,v2) => `<w:tr>
    ${cell(l1,true,true,LBL2_W,false,false)}
    ${cellWithFormat(v1,false,VAL2_W,false)}
    ${cell(l2,true,true,LBL2_W,false,false)}
    ${cellWithFormat(v2,false,VAL2_W,false)}
  </w:tr>`;

  // Lignes libres
  let llXML = '';
  if (entete.lignesLibres && entete.lignesLibres.length > 0) {
    entete.lignesLibres.forEach(ll => {
      if (ll.type === 'simple') {
        llXML += rowFull(ll.label || 'Champ', ll.val1 || '');
      } else {
        llXML += rowDbl(ll.label1||'A', ll.val1||'', ll.label2||'B', ll.val2||'');
      }
    });
  }

  const TBL_PR = (extraW) => `<w:tblPr>
    <w:tblW w:w="${extraW || TW}" w:type="dxa"/>
    <w:tblLayout w:type="fixed"/>
    <w:tblBorders>
      <w:top    w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:left   w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:bottom w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:right  w:val="single" w:sz="12" w:space="0" w:color="${rawColor}"/>
      <w:insideH w:val="single" w:sz="4" w:space="0" w:color="${rawColor}"/>
      <w:insideV w:val="single" w:sz="4" w:space="0" w:color="${rawColor}"/>
    </w:tblBorders>
    <w:tblCellMar>
      <w:top    w:w="0" w:type="dxa"/>
      <w:bottom w:w="0" w:type="dxa"/>
      <w:left   w:w="0" w:type="dxa"/>
      <w:right  w:w="0" w:type="dxa"/>
    </w:tblCellMar>
  </w:tblPr>`;

  // Tableau en-t√™te
  const enteteTable = `<w:tbl>
    ${TBL_PR()}
    ${rowDbl(x(entete.labelProf||'PROF'), entete.prof||'', x(entete.labelNiveau||'NIVEAU'), entete.niveau||'')}
    ${rowFull(x(entete.labelModule||'MODULE'),   entete.module||'')}
    ${rowFull(x(entete.labelSequence||'S√âQUENCE'), entete.sequence||'')}
    ${rowDbl(x(entete.labelActivite||'ACTIVIT√â'), entete.activite||'', x(entete.labelSupport||'SUPPORT'), entete.support||'')}
    ${llXML}
    ${rowFullRich(x(entete.labelObjectif||'OBJECTIF(S)'), entete.objectif||'')}
  </w:tbl>`;

  // Tableau √©tapes ‚Äî en-t√™te dynamique
  const headerEtapes = `<w:tr>
    ${cell(x(P.labelColEtapes),       true,true,  E0, true,  false)}
    ${cell(x(P.labelColDeroulement),  true,true,  E1, true,  false)}
    ${colsSup.map((col, i) => cell(x(col.label), true, true, ESup[i], true, false)).join('')}
    ${cell(x(P.labelColDuree),        true,true,  E2, true,  false)}
  </w:tr>`;

  // ‚îÄ‚îÄ Convertit HTML Quill ‚Üí paragraphes OpenXML ‚îÄ‚îÄ
  // G√®re : <p>, <br>, <strong>/<b>, <em>/<i>, <u>, <li>, texte brut
  const etapesRows = (etapes||[]).map(e => {
    // Colonnes suppl√©mentaires
    const supCells = colsSup.map((col, i) => `<w:tc>
      <w:tcPr>
        <w:tcW w:w="${ESup[i]}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
        <w:vAlign w:val="top"/>
      </w:tcPr>
      <w:p>
        <w:pPr><w:spacing w:before="40" w:after="40"/></w:pPr>
        <w:r>
          <w:rPr><w:sz w:val="18"/><w:szCs w:val="18"/></w:rPr>
          <w:t xml:space="preserve">${x((e.supVals && e.supVals[col.n]) || '')}</w:t>
        </w:r>
      </w:p>
    </w:tc>`).join('');

    return `<w:tr>
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${E0}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
        <w:vAlign w:val="center"/>
      </w:tcPr>
      <w:p>
        <w:pPr><w:jc w:val="center"/><w:spacing w:before="40" w:after="40"/></w:pPr>
        ${htmlToRunsWithColor(e.nom||'', rawColor)}
      </w:p>
    </w:tc>
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${E1}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
      </w:tcPr>
      ${htmlToWParagraphs(e.enseignant||'', 18)}
    </w:tc>
    ${supCells}
    <w:tc>
      <w:tcPr>
        <w:tcW w:w="${E2}" w:type="dxa"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFFFFF"/>
        ${BDR(rawColor)}${CELL_MAR}
        <w:vAlign w:val="center"/>
      </w:tcPr>
      <w:p>
        <w:pPr><w:jc w:val="center"/><w:spacing w:before="40" w:after="40"/></w:pPr>
        <w:r>
          <w:rPr><w:i/><w:sz w:val="18"/><w:szCs w:val="18"/></w:rPr>
          <w:t>${x(e.duree||'')}</w:t>
        </w:r>
      </w:p>
    </w:tc>
  </w:tr>`;
  }).join('');

  const etapesTable = `<w:tbl>
    ${TBL_PR()}
    ${headerEtapes}
    ${etapesRows}
  </w:tbl>`;

  // ‚îÄ‚îÄ document.xml ‚îÄ‚îÄ (les images ont d√©j√† √©t√© collect√©es lors de la construction des tables)
  const documentXML = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
  <w:body>
    <w:p>
      <w:pPr>
        <w:jc w:val="center"/>
        <w:spacing w:before="0" w:after="100"/>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:b/><w:color w:val="${rawColor}"/>
          <w:sz w:val="24"/><w:szCs w:val="24"/>
        </w:rPr>
        <w:t>FICHE P√âDAGOGIQUE</w:t>
      </w:r>
    </w:p>
    ${enteteTable}
    <w:p><w:pPr><w:spacing w:before="0" w:after="60"/></w:pPr></w:p>
    ${etapesTable}
    <w:sectPr>
      <w:pgSz w:w="${PG_W}" w:h="16838"/>
      <w:pgMar w:top="${MARGIN}" w:right="${MARGIN}" w:bottom="${MARGIN}" w:left="${MARGIN}"
               w:header="0" w:footer="0" w:gutter="0"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  // ‚îÄ‚îÄ Package DOCX ‚îÄ‚îÄ
  // Ajouter les types MIME des images si n√©cessaire
  let contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml"  ContentType="application/xml"/>`;
  
  // Ajouter les extensions d'images
  const imageExtensions = new Set(docxImages.map(img => img.ext));
  if (imageExtensions.has('png')) {
    contentTypes += `\n  <Default Extension="png" ContentType="image/png"/>`;
  }
  if (imageExtensions.has('jpeg')) {
    contentTypes += `\n  <Default Extension="jpeg" ContentType="image/jpeg"/>`;
  }
  if (imageExtensions.has('jpg')) {
    contentTypes += `\n  <Default Extension="jpg" ContentType="image/jpeg"/>`;
  }
  if (imageExtensions.has('gif')) {
    contentTypes += `\n  <Default Extension="gif" ContentType="image/gif"/>`;
  }
  
  contentTypes += `
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml"   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

  const rootRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  // G√©n√©rer les relationships pour les images
  let wordRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>`;
  
  docxImages.forEach(img => {
    wordRels += `\n  <Relationship Id="${img.rId}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image${img.id}.${img.ext}"/>`;
  });
  
  wordRels += `
</Relationships>`;

  const stylesXML = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:docDefaults>
    <w:rPrDefault>
      <w:rPr>
        <w:rFonts w:ascii="Times New Roman" w:hAnsi="Times New Roman" w:cs="Times New Roman"/>
        <w:sz w:val="18"/><w:szCs w:val="18"/>
      </w:rPr>
    </w:rPrDefault>
    <w:pPrDefault>
      <w:pPr><w:spacing w:before="0" w:after="0" w:line="240" w:lineRule="auto"/></w:pPr>
    </w:pPrDefault>
  </w:docDefaults>
</w:styles>`;

  const zip = new JSZip();
  zip.file('[Content_Types].xml',          contentTypes);
  zip.file('_rels/.rels',                  rootRels);
  zip.file('word/document.xml',            documentXML);
  zip.file('word/styles.xml',              stylesXML);
  zip.file('word/_rels/document.xml.rels', wordRels);
  
  // Ajouter les images au ZIP
  docxImages.forEach(img => {
    // Convertir base64 en binary
    const base64Data = img.src.split(',')[1];
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    zip.file(`word/media/image${img.id}.${img.ext}`, bytes, {binary: true});
  });

  zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
    .then(function(blob) {
      const safeName = (entete.activite || 'fiche').replace(/[^a-zA-Z0-9\u00C0-\u024F]/gi,'_').slice(0,40);
      const docxFileName = `FichePedagogique_${safeName}_${Date.now()}.docx`;

      // T√©l√©chargement direct en un clic
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = docxFileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 1000);

      const toast = document.getElementById('toast');
      toast.textContent = 'üìò Fiche export√©e en DOCX (Word)';
      showToast();
    })
    .catch(function(err) {
      console.error('Erreur DOCX:', err);
      alert('Erreur lors de la g√©n√©ration DOCX : ' + err.message);
    });
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOD√àLES DE FICHES P√âDAGOGIQUES ‚Äî ANGLAIS / LYC√âE / ENVIRONNEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MODELES_FICHES = [

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 1. FRAN√áAIS ‚Äî Lecture / Compr√©hension de texte
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'fr1', titre:'Lecture analytique ‚Äî La description dans le roman r√©aliste',
    sousTitre:'Fran√ßais ¬∑ Lecture / Analyse litt√©raire ¬∑ Lyc√©e', icone:'üìñ',
    matiere:'Fran√ßais', niveau:'2BAC', categorie:'francais',
    description:'S√©ance de lecture analytique d\'un extrait de roman r√©aliste (Balzac / Zola). Les √©l√®ves identifient les proc√©d√©s de la description, analysent leur fonction narrative et construisent un commentaire structur√©.',
    tags:['francais','2BAC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'2 BAC',module:'Module 2 ‚Äî Le Roman et ses personnages',sequence:'S√©quence 3 : La description r√©aliste',activite:'Lecture analytique',support:'Extrait : Balzac, "Le P√®re Goriot" ‚Äî description de la pension Vauquer',
        objectif:'<ul><li>Identifier les caract√©ristiques de la description r√©aliste (accumulation, lexique, focalisation)</li><li>Analyser la fonction de la description dans l\'√©conomie du r√©cit</li><li>Construire un commentaire litt√©raire structur√© √† partir d\'un extrait</li><li>Ma√Ætriser le vocabulaire de l\'analyse litt√©raire (champ lexical, m√©taphore, isotopie‚Ä¶)</li></ul>'},
      etapes:[
        {nom:'Mise en route',enseignant:'<p><strong>üñºÔ∏è Entr√©e dans le texte ‚Äî L\'image d√©clencheur</strong></p><p>‚Ä¢ Projeter une image d\'int√©rieur bourgeois du XIXe si√®cle</p><p>‚Ä¢ Questions orales : <em>¬´ Que voyez-vous ? Quelle atmosph√®re se d√©gage ? √Ä quelle √©poque situez-vous cette sc√®ne ? ¬ª</em></p><p>‚Ä¢ Mise en commun ‚Äî introduction de la notion de "roman r√©aliste" : peindre le r√©el</p><p>‚Ä¢ Annonce de l\'objectif : comprendre comment Balzac fait "voir" un lieu</p>',duree:'8 min'},
        {nom:'Lecture & d√©couverte',enseignant:'<p><strong>üìÑ Lecture silencieuse puis lecture expressive</strong></p><p>‚Ä¢ Lecture individuelle silencieuse (2 min) ‚Äî rep√©rage des mots inconnus</p><p>‚Ä¢ Lecture expressive par l\'enseignant ‚Äî mise en voix du texte</p><p>‚Ä¢ Questions de compr√©hension globale :</p><ul><li>Quel lieu est d√©crit ? Par qui ?</li><li>Quelle est l\'impression dominante qui se d√©gage ?</li><li>Relevez trois mots qui caract√©risent ce lieu</li></ul>',duree:'10 min'},
        {nom:'Analyse',enseignant:'<p><strong>üîç Analyse des proc√©d√©s d\'√©criture</strong></p><p>‚Ä¢ Travail en groupes (3‚Äì4 √©l√®ves) ‚Äî chaque groupe analyse un aspect :</p><ul><li>Groupe 1 : Le champ lexical dominant</li><li>Groupe 2 : Les figures de style (comparaisons, m√©taphores)</li><li>Groupe 3 : L\'organisation spatiale de la description</li><li>Groupe 4 : Le point de vue narratif et ses effets</li></ul><p>‚Ä¢ Mise en commun avec prise de notes au tableau</p>',duree:'15 min'},
        {nom:'Interpr√©tation',enseignant:'<p><strong>üí° Sens et fonctions de la description</strong></p><p>‚Ä¢ Discussion guid√©e :</p><ul><li><em>¬´ Pourquoi Balzac consacre-t-il autant de place √† d√©crire ce lieu ? ¬ª</em></li><li><em>¬´ Que nous apprend cette description sur les personnages qui y vivent ? ¬ª</em></li><li><em>¬´ Quel effet produit cette description sur le lecteur ? ¬ª</em></li></ul><p>‚Ä¢ √âlaboration collective d\'une r√©ponse √† la probl√©matique : la description comme r√©v√©lateur social</p>',duree:'10 min'},
        {nom:'Synth√®se',enseignant:'<p><strong>üìù Construction du commentaire</strong></p><p>‚Ä¢ Formulation collective du plan du commentaire :</p><ul><li>Axe I : Une description r√©aliste minutieuse</li><li>Axe II : Un lieu r√©v√©lateur de la mis√®re sociale</li></ul><p>‚Ä¢ Chaque √©l√®ve r√©dige l\'introduction et un paragraphe de commentaire</p><p>‚Ä¢ Bilan de s√©ance ‚Äî retour sur les outils d\'analyse acquis</p>',duree:'7 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#4A148C',colorAccent:'#C9A84C',colorGrid:'#CE93D8',colorEtapeText:'#4A148C',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'2 BAC',module:'Module 2 ‚Äî Le Roman et ses personnages'
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 2. MATH√âMATIQUES ‚Äî Fonctions du second degr√©
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'ma1', titre:'Les fonctions du second degr√© ‚Äî Forme canonique et repr√©sentation',
    sousTitre:'Math√©matiques ¬∑ Alg√®bre ¬∑ 2 BAC', icone:'üìê',
    matiere:'Math√©matiques', niveau:'2BAC', categorie:'maths',
    description:'S√©ance d\'alg√®bre sur les fonctions du second degr√©. Les √©l√®ves passent de la forme d√©velopp√©e √† la forme canonique, en d√©duisent les propri√©t√©s de la parabole et r√©solvent des probl√®mes d\'optimisation.',
    tags:['maths','2BAC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'2 BAC',module:'Module 1 ‚Äî Analyse et fonctions',sequence:'S√©quence 4 : Fonctions polyn√¥mes du second degr√©',activite:'Cours + Exercices ‚Äî Forme canonique',support:'Manuel + Fiche exercices "Parabole et optimisation"',
        objectif:'<ul><li>Passer de la forme d√©velopp√©e ax¬≤+bx+c √† la forme canonique a(x-Œ±)¬≤+Œ≤</li><li>Identifier le sommet de la parabole et l\'axe de sym√©trie</li><li>D√©terminer les extrema (maximum ou minimum) d\'une fonction du second degr√©</li><li>R√©soudre des probl√®mes d\'optimisation faisant intervenir une fonction du second degr√©</li></ul>'},
      etapes:[
        {nom:'Rappel & activation',enseignant:'<p><strong>üîÅ R√©vision ‚Äî Forme d√©velopp√©e</strong></p><p>‚Ä¢ Questions flash au tableau (5 min) :</p><ul><li>D√©velopper : (x+3)¬≤ ; (2x-1)¬≤ ; (x+a)¬≤</li><li>Factoriser : x¬≤-4 ; x¬≤+6x+9</li></ul><p>‚Ä¢ Correction collective ‚Äî rappel des identit√©s remarquables</p><p>‚Ä¢ Transition : <em>¬´ Comment trouver le minimum de f(x) = x¬≤-6x+11 ? ¬ª</em></p>',duree:'8 min'},
        {nom:'D√©couverte',enseignant:'<p><strong>üí° Construction de la forme canonique</strong></p><p>‚Ä¢ D√©monstration au tableau ‚Äî m√©thode de compl√©tion du carr√© :</p><p>f(x) = x¬≤-6x+11 = (x¬≤-6x+9)+2 = (x-3)¬≤+2</p><p>‚Ä¢ Questions guid√©es :</p><ul><li>Quel est le minimum de (x-3)¬≤ ? Pour quelle valeur de x ?</li><li>Quel est donc le minimum de f ? En quel point ?</li></ul><p>‚Ä¢ Formule g√©n√©rale : Œ± = -b/2a ; Œ≤ = f(Œ±)</p>',duree:'12 min'},
        {nom:'Entra√Ænement guid√©',enseignant:'<p><strong>‚úèÔ∏è Exercices progressifs (par niveaux)</strong></p><p>‚Ä¢ Niveau 1 : Mettre sous forme canonique (a=1) :<br>f(x) = x¬≤-4x+7 ; g(x) = x¬≤+8x+3</p><p>‚Ä¢ Niveau 2 : Cas g√©n√©ral (a‚â†1) :<br>h(x) = 2x¬≤-12x+5 ; k(x) = -3x¬≤+6x+1</p><p>‚Ä¢ Niveau 3 : D√©duire le sommet, le sens de variation, le minimum/maximum</p><p>‚Ä¢ Correction au tableau ‚Äî erreurs fr√©quentes signal√©es</p>',duree:'15 min'},
        {nom:'Probl√®me',enseignant:'<p><strong>üßÆ Probl√®me d\'optimisation</strong></p><p>‚Ä¢ Probl√®me contextualis√© :</p><p><em>¬´ Un rectangle a un p√©rim√®tre de 20 cm. Exprimer son aire en fonction de la longueur d\'un c√¥t√©, puis d√©terminer les dimensions qui maximisent l\'aire. ¬ª</em></p><p>‚Ä¢ R√©solution guid√©e : mod√©lisation ‚Üí forme canonique ‚Üí conclusion</p><p>‚Ä¢ Correction collective ‚Äî interpr√©tation g√©om√©trique de la solution</p>',duree:'10 min'},
        {nom:'Bilan',enseignant:'<p><strong>üìä Synth√®se & devoir</strong></p><p>‚Ä¢ Fiche r√©capitulative : tableau forme d√©velopp√©e ‚Üî canonique ‚Üî propri√©t√©s</p><p>‚Ä¢ Auto-√©valuation : 3 questions flash (vrai/faux)</p><p>‚Ä¢ Devoir maison : 3 exercices de mise sous forme canonique + 1 probl√®me d\'optimisation</p>',duree:'5 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#0D47A1',colorAccent:'#C9A84C',colorGrid:'#90CAF9',colorEtapeText:'#0D47A1',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'2 BAC',module:'Module 1 ‚Äî Analyse et fonctions'
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 3. SVT ‚Äî La mitose et la reproduction cellulaire
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'sv1', titre:'La mitose ‚Äî Division cellulaire et cycle cellulaire',
    sousTitre:'SVT ¬∑ Biologie cellulaire ¬∑ 1 BAC', icone:'üî¨',
    matiere:'SVT', niveau:'1BAC', categorie:'svt',
    description:'S√©ance de biologie sur la mitose. Les √©l√®ves observent les diff√©rentes phases de la division cellulaire sur des pr√©parations microscopiques, sch√©matisent et expliquent les m√©canismes de transmission de l\'information g√©n√©tique.',
    tags:['svt','1BAC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'1 BAC',module:'Module 1 ‚Äî Reproduction et g√©n√©tique',sequence:'S√©quence 2 : La division cellulaire',activite:'TP + Cours ‚Äî La mitose',support:'Microscope + Pr√©parations oignon / Sch√©mas + Vid√©o animation mitose',
        objectif:'<ul><li>D√©crire et sch√©matiser les diff√©rentes phases de la mitose (interphase, prophase, m√©taphase, anaphase, t√©lophase)</li><li>Comprendre le r√¥le de la mitose dans la croissance et la r√©g√©n√©ration des tissus</li><li>Relier la mitose √† la conservation du caryotype (2n chromosomes)</li><li>R√©aliser une observation microscopique et en faire un sch√©ma l√©gend√©</li></ul>'},
      etapes:[
        {nom:'Probl√©matique',enseignant:'<p><strong>‚ùì Mise en situation ‚Äî Probl√®me biologique</strong></p><p>‚Ä¢ Question d√©clencheur : <em>¬´ Comment une cellule unique (zygote) peut-elle donner un organisme de plusieurs milliards de cellules identiques ? ¬ª</em></p><p>‚Ä¢ Recueil des repr√©sentations initiales des √©l√®ves ‚Äî carte mentale collective</p><p>‚Ä¢ Annonce du plan : observer ‚Üí sch√©matiser ‚Üí expliquer</p>',duree:'5 min'},
        {nom:'Observation TP',enseignant:'<p><strong>üî¨ Travaux pratiques ‚Äî Observation microscopique</strong></p><p>‚Ä¢ Distribution des pr√©parations microscopiques (racine d\'oignon)</p><p>‚Ä¢ Consignes :</p><ul><li>Observer √† diff√©rents grossissements</li><li>Rep√©rer des cellules √† diff√©rents stades</li><li>Dessiner une cellule par phase observ√©e avec l√©gendes</li></ul><p>‚Ä¢ Circuler dans les rangs ‚Äî aide √† l\'identification des phases</p>',duree:'15 min'},
        {nom:'Cours',enseignant:'<p><strong>üìã Construction du cours ‚Äî Les 5 phases</strong></p><p>‚Ä¢ Pr√©sentation anim√©e des phases :</p><ul><li><strong>Interphase :</strong> r√©plication de l\'ADN (2n ‚Üí 4n chromatides)</li><li><strong>Prophase :</strong> condensation des chromosomes, disparition membrane nucl√©aire</li><li><strong>M√©taphase :</strong> alignement sur la plaque √©quatoriale</li><li><strong>Anaphase :</strong> migration des chromatides aux p√¥les</li><li><strong>T√©lophase :</strong> cytocin√®se ‚Äî 2 cellules filles (2n)</li></ul><p>‚Ä¢ Sch√©ma bilan √† compl√©ter par les √©l√®ves</p>',duree:'15 min'},
        {nom:'Exercices',enseignant:'<p><strong>‚úèÔ∏è Application et exercices</strong></p><p>‚Ä¢ Ex 1 : L√©gender un sch√©ma de mitose</p><p>‚Ä¢ Ex 2 : Ordonner des photos de phases dans le bon ordre</p><p>‚Ä¢ Ex 3 : Calculer le nombre de chromosomes √† chaque phase pour une esp√®ce 2n=46</p><p>‚Ä¢ Correction collective</p>',duree:'10 min'},
        {nom:'Bilan',enseignant:'<p><strong>üìä Synth√®se ‚Äî R√¥le biologique de la mitose</strong></p><p>‚Ä¢ Discussion : <em>¬´ Mitose et croissance / r√©g√©n√©ration / reproduction asexu√©e ¬ª</em></p><p>‚Ä¢ Bilan sch√©matique au tableau : cycle cellulaire complet (G1, S, G2, M)</p><p>‚Ä¢ Questions flash auto-√©valuation</p><p>‚Ä¢ DM : r√©diger un texte expliquant la mitose √† partir du sch√©ma bilan</p>',duree:'5 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#1B5E20',colorAccent:'#C9A84C',colorGrid:'#A5D6A7',colorEtapeText:'#1B5E20',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'1 BAC',module:'Module 1 ‚Äî Reproduction et g√©n√©tique'
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 4. HISTOIRE ‚Äî La Premi√®re Guerre mondiale
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'hi1', titre:'La Premi√®re Guerre mondiale ‚Äî Une guerre totale',
    sousTitre:'Histoire ¬∑ TC / 1 BAC', icone:'üèõÔ∏è',
    matiere:'Histoire', niveau:'TC', categorie:'histoire',
    description:'S√©ance d\'histoire sur la notion de "guerre totale" lors de la Premi√®re Guerre mondiale. √Ä partir de documents vari√©s (carte, t√©moignage, affiche de propagande), les √©l√®ves construisent et argumentent ce concept.',
    tags:['histoire','TC','1BAC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'Tronc Commun / 1 BAC',module:'Module 3 ‚Äî Les guerres mondiales du XXe si√®cle',sequence:'S√©quence 1 : La Premi√®re Guerre mondiale (1914‚Äì1918)',activite:'√âtude documentaire ‚Äî La notion de guerre totale',support:'Dossier documentaire : carte du front, t√©moignage de soldat, affiche de propagande, statistiques de pertes',
        objectif:'<ul><li>Comprendre et d√©finir le concept de "guerre totale"</li><li>Analyser des documents historiques de nature diff√©rente (carte, t√©moignage, affiche)</li><li>Identifier les dimensions militaires, √©conomiques, sociales et psychologiques du conflit</li><li>Construire un raisonnement historique argument√© √† partir de documents</li></ul>'},
      etapes:[
        {nom:'Mise en situation',enseignant:'<p><strong>üó∫Ô∏è Entr√©e dans le cours ‚Äî Situation g√©ographique</strong></p><p>‚Ä¢ Afficher la carte de l\'Europe en 1914 ‚Äî identifier les empires, les alliances</p><p>‚Ä¢ Chronologie rapide : attentats de Sarajevo (28 juin 1914) ‚Üí d√©clarations de guerre</p><p>‚Ä¢ Question-probl√®me : <em>¬´ En quoi la guerre de 1914‚Äì1918 est-elle diff√©rente des guerres pr√©c√©dentes ? ¬ª</em></p><p>‚Ä¢ Recueil des hypoth√®ses des √©l√®ves</p>',duree:'8 min'},
        {nom:'√âtude de docs',enseignant:'<p><strong>üìÑ Analyse documentaire en groupes</strong></p><p>‚Ä¢ 4 groupes ‚Äî chaque groupe analyse un document :</p><ul><li>Groupe 1 : Carte des fronts ‚Äî les tranch√©es, la guerre de position</li><li>Groupe 2 : T√©moignage de soldat ‚Äî conditions de vie dans les tranch√©es</li><li>Groupe 3 : Affiche de propagande ‚Äî mobilisation des civils</li><li>Groupe 4 : Statistiques des pertes ‚Äî ampleur des destructions humaines</li></ul><p>‚Ä¢ Questions-guide pour chaque document (fiche distribu√©e)</p>',duree:'15 min'},
        {nom:'Mise en commun',enseignant:'<p><strong>üó£Ô∏è Pr√©sentation et construction du concept</strong></p><p>‚Ä¢ Chaque groupe pr√©sente ses conclusions (2 min par groupe)</p><p>‚Ä¢ Construction collective au tableau de la notion de "guerre totale" :</p><ul><li>Dimension militaire : industrialisation de la guerre, nouvelles armes</li><li>Dimension √©conomique : √©conomie de guerre, rationnement</li><li>Dimension sociale : r√¥le des femmes, travailleurs coloniaux</li><li>Dimension psychologique : propagande, moral des troupes</li></ul>',duree:'12 min'},
        {nom:'Cours structur√©',enseignant:'<p><strong>üìã Bilan de cours ‚Äî Trace √©crite</strong></p><p>‚Ä¢ Dict√©e de la trace √©crite structur√©e en 3 parties :</p><ul><li>I. Une guerre industrielle et meurtri√®re</li><li>II. La mobilisation totale des soci√©t√©s</li><li>III. Un bilan humain et mat√©riel sans pr√©c√©dent</li></ul><p>‚Ä¢ Compl√©ter le sch√©ma bilan : "Guerre totale" au centre, 4 dimensions rayonnantes</p>',duree:'10 min'},
        {nom:'√âvaluation formative',enseignant:'<p><strong>‚úèÔ∏è Exercice de r√©daction courte</strong></p><p>‚Ä¢ Consigne : <em>¬´ En vous appuyant sur les documents √©tudi√©s, expliquez en 8‚Äì10 lignes pourquoi la Premi√®re Guerre mondiale est qualifi√©e de guerre totale. ¬ª</em></p><p>‚Ä¢ √âchange de copies ‚Äî correction entre pairs avec grille de crit√®res</p><p>‚Ä¢ Bilan et annonce de la prochaine s√©ance : les cons√©quences du conflit</p>',duree:'5 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#BF360C',colorAccent:'#C9A84C',colorGrid:'#FFCCBC',colorEtapeText:'#BF360C',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'TC / 1 BAC',module:'Module 3 ‚Äî Les guerres mondiales du XXe si√®cle'
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 5. PHYSIQUE-CHIMIE ‚Äî Les lois de l'√©lectricit√©
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'ph1', titre:'Loi d\'Ohm et circuits √©lectriques ‚Äî S√©rie et parall√®le',
    sousTitre:'Physique-Chimie ¬∑ √âlectricit√© ¬∑ Tronc Commun', icone:'‚öóÔ∏è',
    matiere:'Physique-Chimie', niveau:'TC', categorie:'physique',
    description:'S√©ance d\'√©lectricit√© sur la loi d\'Ohm et les circuits s√©rie/parall√®le. Approche exp√©rimentale : les √©l√®ves r√©alisent des montages, mesurent les grandeurs et v√©rifient les lois par l\'exp√©rience avant de les formaliser.',
    tags:['physique','TC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'Tronc Commun',module:'Module 2 ‚Äî √âlectricit√©',sequence:'S√©quence 3 : Loi d\'Ohm ‚Äî Circuits s√©rie et parall√®le',activite:'TP + Cours ‚Äî V√©rification exp√©rimentale de la loi d\'Ohm',support:'Mat√©riel TP : g√©n√©rateur, r√©sistances, amp√®rem√®tre, voltm√®tre, fils + Fiche TP',
        objectif:'<ul><li>√ânoncer et appliquer la loi d\'Ohm : U = R √ó I</li><li>Distinguer les caract√©ristiques d\'un circuit s√©rie (m√™me intensit√©) et parall√®le (m√™me tension)</li><li>R√©aliser un montage √©lectrique en respectant les conventions de branchement</li><li>Analyser des r√©sultats exp√©rimentaux et calculer une r√©sistance</li></ul>'},
      etapes:[
        {nom:'Probl√©matique',enseignant:'<p><strong>‚ö° Mise en situation exp√©rimentale</strong></p><p>‚Ä¢ Pr√©senter deux ampoules : l\'une dans un circuit s√©rie, l\'autre en parall√®le</p><p>‚Ä¢ Observation : <em>¬´ Que se passe-t-il quand on enl√®ve une ampoule dans chaque circuit ? ¬ª</em></p><p>‚Ä¢ Probl√©matique : <em>¬´ Quelles lois r√©gissent la tension et l\'intensit√© dans ces circuits ? ¬ª</em></p><p>‚Ä¢ Hypoth√®ses des √©l√®ves not√©es au tableau</p>',duree:'7 min'},
        {nom:'TP Circuit s√©rie',enseignant:'<p><strong>üîå TP 1 ‚Äî Circuit s√©rie</strong></p><p>‚Ä¢ R√©aliser le montage : g√©n√©rateur + 2 r√©sistances en s√©rie + amp√®rem√®tre</p><p>‚Ä¢ Mesures √† effectuer :</p><ul><li>Intensit√© I‚ÇÅ, I‚ÇÇ en diff√©rents points ‚Üí conclusion sur I</li><li>Tensions U‚ÇÅ, U‚ÇÇ, U_total ‚Üí loi des tensions en s√©rie</li></ul><p>‚Ä¢ Appliquer U = R√óI pour calculer chaque r√©sistance</p><p>‚Ä¢ Tableau de r√©sultats √† compl√©ter sur la fiche TP</p>',duree:'13 min'},
        {nom:'TP Circuit parall√®le',enseignant:'<p><strong>üîå TP 2 ‚Äî Circuit parall√®le</strong></p><p>‚Ä¢ Modifier le montage : 2 r√©sistances en d√©rivation</p><p>‚Ä¢ Mesures :</p><ul><li>Tensions U‚ÇÅ, U‚ÇÇ ‚Üí loi des tensions en parall√®le</li><li>Intensit√©s I‚ÇÅ, I‚ÇÇ, I_total ‚Üí loi des intensit√©s (n≈ìuds)</li></ul><p>‚Ä¢ Calcul de la r√©sistance √©quivalente R_eq = R‚ÇÅR‚ÇÇ/(R‚ÇÅ+R‚ÇÇ)</p><p>‚Ä¢ Comparaison des r√©sultats th√©oriques/exp√©rimentaux</p>',duree:'13 min'},
        {nom:'Formalisation',enseignant:'<p><strong>üìã Construction du cours ‚Äî Synth√®se th√©orique</strong></p><p>‚Ä¢ Loi d\'Ohm : U = R √ó I ‚Äî unit√©s (V, Œ©, A)</p><p>‚Ä¢ Circuit s√©rie : I = cst ; U_tot = U‚ÇÅ+U‚ÇÇ+‚Ä¶ ; R_eq = R‚ÇÅ+R‚ÇÇ+‚Ä¶</p><p>‚Ä¢ Circuit parall√®le : U = cst ; I_tot = I‚ÇÅ+I‚ÇÇ+‚Ä¶ ; 1/R_eq = 1/R‚ÇÅ+1/R‚ÇÇ+‚Ä¶</p><p>‚Ä¢ Exemples d\'applications domestiques (√©clairage, prise de courant)</p>',duree:'10 min'},
        {nom:'Exercices',enseignant:'<p><strong>‚úèÔ∏è Application num√©rique</strong></p><p>‚Ä¢ Ex 1 : R = 220 Œ©, U = 12 V ‚Üí calculer I</p><p>‚Ä¢ Ex 2 : Deux r√©sistances 100 Œ© en s√©rie ‚Äî U_total = 6 V ‚Üí calculer I et U‚ÇÅ</p><p>‚Ä¢ Ex 3 : R√©sistance √©quivalente de 3 r√©sistances en parall√®le</p><p>‚Ä¢ Correction rapide ‚Äî bilan + devoir maison</p>',duree:'7 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#37474F',colorAccent:'#C9A84C',colorGrid:'#B0BEC5',colorEtapeText:'#37474F',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'Tronc Commun',module:'Module 2 ‚Äî √âlectricit√©'
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 6. MATH√âMATIQUES ‚Äî Statistiques et probabilit√©s
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'ma2', titre:'Statistiques descriptives ‚Äî Moyenne, m√©diane, √©tendue',
    sousTitre:'Math√©matiques ¬∑ Statistiques ¬∑ Tronc Commun', icone:'üìä',
    matiere:'Math√©matiques', niveau:'TC', categorie:'maths',
    description:'S√©ance de statistiques sur les indicateurs de tendance centrale et de dispersion. Approche active : les √©l√®ves collectent des donn√©es r√©elles, calculent les indicateurs et les interpr√®tent dans un contexte concret.',
    tags:['maths','TC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'Tronc Commun',module:'Module 3 ‚Äî Statistiques et probabilit√©s',sequence:'S√©quence 1 : Statistiques descriptives',activite:'Cours + Activit√© ‚Äî Indicateurs statistiques',support:'Donn√©es r√©elles : notes de classe + Fiche activit√© + Calculatrice',
        objectif:'<ul><li>Calculer et interpr√©ter la moyenne, la m√©diane et l\'√©tendue d\'une s√©rie statistique</li><li>Repr√©senter graphiquement une s√©rie statistique (histogramme, diagramme circulaire)</li><li>Choisir l\'indicateur le plus adapt√© selon la situation</li><li>Lire et interpr√©ter un tableau statistique ou un graphique</li></ul>'},
      etapes:[
        {nom:'Situation r√©elle',enseignant:'<p><strong>üìä Collecte de donn√©es r√©elles</strong></p><p>‚Ä¢ Demander aux √©l√®ves leur note de math√©matiques du dernier contr√¥le</p><p>‚Ä¢ Saisir les donn√©es au tableau ‚Äî les classer</p><p>‚Ä¢ Question : <em>¬´ Comment r√©sumer ces donn√©es en un seul chiffre ? Lequel choisiriez-vous ? ¬ª</em></p><p>‚Ä¢ Discussion : intuition de la "note moyenne" vs "note du milieu"</p>',duree:'8 min'},
        {nom:'Cours ‚Äî Moyenne',enseignant:'<p><strong>üìê La moyenne arithm√©tique</strong></p><p>‚Ä¢ D√©finition et formule : xÃÑ = (Œ£x·µ¢)/n</p><p>‚Ä¢ Calcul sur les donn√©es de la classe</p><p>‚Ä¢ Exemple guid√© : s√©rie de temp√©ratures mensuelles</p><p>‚Ä¢ Propri√©t√©s : sensibilit√© aux valeurs extr√™mes (exemple avec une valeur aberrante)</p><p>‚Ä¢ Exercices d\'application imm√©diats (2 s√©ries)</p>',duree:'10 min'},
        {nom:'Cours ‚Äî M√©diane',enseignant:'<p><strong>üìê La m√©diane et l\'√©tendue</strong></p><p>‚Ä¢ D√©finition de la m√©diane : valeur qui partage la s√©rie en deux moiti√©s √©gales</p><p>‚Ä¢ M√©thode : trier la s√©rie ‚Üí trouver la valeur centrale (n impair) ou la moyenne des deux (n pair)</p><p>‚Ä¢ Calcul de la m√©diane et de l\'√©tendue sur les donn√©es de la classe</p><p>‚Ä¢ Comparaison moyenne/m√©diane : quand pr√©f√©rer l\'une ou l\'autre ?</p>',duree:'10 min'},
        {nom:'Repr√©sentation',enseignant:'<p><strong>üìâ Repr√©sentations graphiques</strong></p><p>‚Ä¢ Construire l\'histogramme des notes de la classe</p><p>‚Ä¢ Construction du diagramme circulaire (r√©partition par tranches)</p><p>‚Ä¢ Lecture et interpr√©tation : <em>¬´ Quelle information donne chaque type de graphique ? ¬ª</em></p><p>‚Ä¢ Exercice : lire un graphique statistique et r√©pondre √† des questions</p>',duree:'12 min'},
        {nom:'Synth√®se',enseignant:'<p><strong>üìù Bilan et exercice r√©capitulatif</strong></p><p>‚Ä¢ Tableau r√©capitulatif des indicateurs : d√©finition, formule, usage</p><p>‚Ä¢ Exercice r√©capitulatif : s√©rie de donn√©es ‚Üí calculer moyenne, m√©diane, √©tendue, tracer histogramme</p><p>‚Ä¢ Auto-correction</p><p>‚Ä¢ DM : 2 exercices de statistiques sur des donn√©es r√©elles (temp√©ratures, population)</p>',duree:'10 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#1565C0',colorAccent:'#C9A84C',colorGrid:'#90CAF9',colorEtapeText:'#1565C0',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'Tronc Commun',module:'Module 3 ‚Äî Statistiques et probabilit√©s'
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 7. ANGLAIS ‚Äî Compr√©hension orale (1 seul mod√®le)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id:'an1', titre:'Listening & Comprehension ‚Äî Climate Change',
    sousTitre:'Anglais ¬∑ Compr√©hension de l\'oral ¬∑ 1 BAC', icone:'üá¨üáß',
    matiere:'Anglais', niveau:'1BAC', categorie:'anglais',
    description:'S√©ance de compr√©hension de l\'oral sur le changement climatique. Les √©l√®ves √©coutent un reportage audio, extraient les informations cl√©s et r√©pondent √† des questions de compr√©hension globale et d√©taill√©e.',
    tags:['anglais','1BAC','Lyc√©e'],
    data:{
      v:2,
      entete:{prof:'EZ-ZAKY AZIZ',niveau:'1 BAC',module:'Module 2 ‚Äî Our Environment',sequence:'S√©quence 3 : Climate Change & Global Warming',activite:'Listening Comprehension',support:'Audio : "Climate Crisis" ‚Äî BBC Learning English',
        objectif:'<ul><li>Identifier les informations cl√©s dans un document audio authentique</li><li>Comprendre le vocabulaire li√© √† l\'environnement et au changement climatique</li><li>R√©pondre √† des questions de compr√©hension globale et d√©taill√©e</li><li>D√©velopper des strat√©gies d\'√©coute active</li></ul>'},
      etapes:[
        {nom:'Warm-up',enseignant:'<p><strong>üå°Ô∏è Pre-listening ‚Äî Brain Activation</strong></p><p>‚Ä¢ Afficher des images : fonte des glaces, canicules, inondations</p><p>‚Ä¢ Questions : <em>"What do you see? What problems do they illustrate? What do you know about climate change?"</em></p><p>‚Ä¢ Brainstorming collectif ‚Äî recueil des hypoth√®ses au tableau</p>',duree:'8 min'},
        {nom:'Pre-listening',enseignant:'<p><strong>üìñ Vocabulary & Context Preparation</strong></p><p>‚Ä¢ Vocabulaire cl√© : <em>greenhouse gases, carbon dioxide (CO‚ÇÇ), fossil fuels, renewable energy, deforestation, biodiversity</em></p><p>‚Ä¢ Pr√©diction du contenu √† partir du titre</p><p>‚Ä¢ Distribution de la fiche d\'√©coute (questions + grille de prise de notes)</p>',duree:'10 min'},
        {nom:'1√®re √©coute',enseignant:'<p><strong>üéôÔ∏è First Listening ‚Äî Global Comprehension</strong></p><p>‚Ä¢ √âcoute compl√®te <strong>sans interruption</strong></p><p>‚Ä¢ T√¢che : identifier le th√®me g√©n√©ral, le ton, l\'id√©e principale</p><p>‚Ä¢ Mise en commun orale ‚Äî correction collective</p>',duree:'10 min'},
        {nom:'2√®me √©coute',enseignant:'<p><strong>üîç Second Listening ‚Äî Detailed Comprehension</strong></p><p>‚Ä¢ R√©√©couter avec pauses possibles</p><p>‚Ä¢ Questions de d√©tail : causes, cons√©quences, solutions cit√©es dans le document</p><p>‚Ä¢ Travail individuel puis correction en bin√¥mes</p>',duree:'12 min'},
        {nom:'Post-listening',enseignant:'<p><strong>üí¨ Reaction & Personal Expression</strong></p><p>‚Ä¢ Discussion : <em>"What surprised you? What can WE do to fight climate change?"</em></p><p>‚Ä¢ Notes sur des actions concr√®tes (at home / at school / in the community)</p><p>‚Ä¢ Bilan ‚Äî auto-√©valuation rapide (pouce lev√©)</p>',duree:'10 min'}
      ],
      params:{marge:'8.5',gap:'5',fontEnteteLabel:'11',fontEnteteContent:'10',fontTableHeader:'10',fontTableContent:'9',rowHeight:'8',tableHeaderH:'18',headerH:'100',l1h:'22',l234h:'18',l5h:'40',sep1:'32',sep2:'60',col1:'20',col2:'65',colorMain:'#1565C0',colorAccent:'#C9A84C',colorGrid:'#AAAAAA',colorEtapeText:'#1565C0',labelColEtapes:'√âtapes',labelColDerou:'D√©roulement de la s√©ance',labelColDuree:'Dur√©e'},
      resume:'5 √©tapes ¬∑ 50 min',niveau:'1 BAC',module:'Module 2 ‚Äî Our Environment'
    }
  }

];

var filtreModeleActif = 'all';

function rendreTousLesModeles() { renderModeles(MODELES_FICHES); }

function filtrerModeles(filtre, btnEl) {
  filtreModeleActif = filtre;
  document.querySelectorAll('.modele-filter-btn').forEach(function(b){ b.classList.remove('active'); });
  if (btnEl) btnEl.classList.add('active');
  var filtres = filtre === 'all' ? MODELES_FICHES : MODELES_FICHES.filter(function(m){ return m.tags.indexOf(filtre) !== -1; });
  renderModeles(filtres);
}

function renderModeles(liste) {
  var container = document.getElementById('modeles-liste');
  if (!container) return;
  if (!liste || liste.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:30px;color:#aaa;font-size:14px;">Aucun mod√®le pour ce filtre.</div>';
    return;
  }
  container.innerHTML = liste.map(function(m) {
    var etapesHtml = m.data.etapes.map(function(e, i) {
      var desc = e.enseignant.replace(/<[^>]*>/g,'').substring(0, 70) + '‚Ä¶';
      return '<div class="modele-etape-row"><div class="modele-etape-num">'+(i+1)+'</div><div class="modele-etape-name">'+e.nom+'</div><div class="modele-etape-desc">'+desc+'</div><div class="modele-etape-duree">'+e.duree+'</div></div>';
    }).join('');
    return '<div class="modele-card">'+
      '<div class="modele-card-header">'+
        '<div class="modele-card-icon">'+m.icone+'</div>'+
        '<div><div class="modele-card-title">'+m.titre+'</div><div class="modele-card-subtitle">'+m.sousTitre+'</div></div>'+
      '</div>'+
      '<div class="modele-card-body">'+
        '<div style="margin-bottom:8px;">'+
          '<span class="modele-tag modele-tag-matiere">üá¨üáß '+m.matiere+'</span>'+
          '<span class="modele-tag modele-tag-niveau">üìö '+m.niveau+'</span>'+
          '<span class="modele-tag modele-tag-duree">‚è± '+m.data.resume+'</span>'+
        '</div>'+
        '<div class="modele-desc">'+m.description+'</div>'+
        '<div class="modele-etapes-preview">'+
          '<div style="font-size:10px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">Aper√ßu des √©tapes</div>'+
          etapesHtml+
        '</div>'+
      '</div>'+
      '<div class="modele-card-actions">'+
        '<button class="btn-modele-charger" onclick="chargerModele(\''+m.id+'\')">üìÇ Charger ce mod√®le</button>'+
        '<button class="btn-modele-sauver" onclick="sauverModeleRepertoire(\''+m.id+'\')">üíæ Sauver</button>'+
      '</div>'+
    '</div>';
  }).join('');
}

function chargerModele(id) {
  var modele = null;
  for (var i=0; i<MODELES_FICHES.length; i++) { if (MODELES_FICHES[i].id === id) { modele = MODELES_FICHES[i]; break; } }
  if (!modele) return;
  if (!confirm('üìÇ Charger le mod√®le "'+modele.titre+'" ?\n\nLe contenu actuel sera remplac√©.')) return;
  var data = JSON.parse(JSON.stringify(modele.data));
  restaurerFiche(data);
  showTab('entete');
  var toast = document.getElementById('toast');
  if (toast) toast.textContent = '‚úÖ Mod√®le charg√© ‚Äî personnalisez et exportez !';
  showToast();
}

function sauverModeleRepertoire(id) {
  var modele = null;
  for (var i=0; i<MODELES_FICHES.length; i++) { if (MODELES_FICHES[i].id === id) { modele = MODELES_FICHES[i]; break; } }
  if (!modele) return;
  var fiches = lireRepertoire();
  var nomFinal = '[MOD√àLE] ' + modele.titre;
  var existant = -1;
  for (var j=0; j<fiches.length; j++) { if (fiches[j].nom === nomFinal) { existant = j; break; } }
  if (existant !== -1) {
    if (!confirm('‚ö†Ô∏è Ce mod√®le est d√©j√† dans le r√©pertoire.\nVoulez-vous le remplacer ?')) return;
    fiches.splice(existant, 1);
  }
  var data = JSON.parse(JSON.stringify(modele.data));
  data.nom = nomFinal;
  data.savedAt = new Date().toLocaleString('fr-FR');
  data.resume = modele.data.resume;
  data.niveau = modele.niveau;
  data.module = modele.data.entete.module;
  fiches.push(data);
  ecrireRepertoire(fiches);
  mettreAJourBadgeRepertoire();
  var toast = document.getElementById('toast');
  if (toast) toast.textContent = 'üíæ Mod√®le sauvegard√© dans le r√©pertoire !';
  showToast();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOUVELLES FONCTIONNALIT√âS v3.0
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ EXPORT / IMPORT JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function exporterToutesLesFinches() {
  try {
    const fiches = lireRepertoire();
    const autosave = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null');
    const exportData = {
      version: '3.0',
      exportedAt: new Date().toLocaleString('fr-FR'),
      author: 'EZ-ZAKY AZIZ',
      fiches: fiches,
      autosave: autosave
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const dateStr = new Date().toISOString().slice(0,10);
    a.download = 'backup_fiches_pedagogiques_' + dateStr + '.json';
    a.click();
    URL.revokeObjectURL(url);
    localStorage.setItem('fp_last_backup', new Date().toLocaleString('fr-FR'));
    afficherExportStatus('‚úÖ Backup export√© avec succ√®s ! (' + fiches.length + ' fiche(s))', '#2E7D32');
    mettreAJourStatsPartage();
  } catch(e) {
    afficherExportStatus('‚ùå Erreur lors de l\'export : ' + e.message, '#C62828');
  }
}

function exporterFicheActuelle() {
  try {
    const data = collecterTout();
    data.exportedAt = new Date().toLocaleString('fr-FR');
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const nom = (data.entete && data.entete.activite) ? data.entete.activite.replace(/[^a-zA-Z0-9\u00C0-\u024F]/gi,'_').slice(0,30) : 'fiche';
    a.download = 'fiche_' + nom + '_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    afficherExportStatus('‚úÖ Fiche actuelle export√©e !', '#2E7D32');
  } catch(e) {
    afficherExportStatus('‚ùå Erreur lors de l\'export : ' + e.message, '#C62828');
  }
}

function importerFichesJSON() {
  document.getElementById('import-json-input').value = '';
  document.getElementById('import-json-input').click();
}

function lireJSONImporte(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const raw = e.target.result;
      const data = JSON.parse(raw);

      // ‚îÄ‚îÄ CAS 1 : Backup complet (exporterToutesLesFinches) ‚îÄ‚îÄ
      // Structure : { version, exportedAt, author, fiches:[], autosave }
      if (data.fiches && Array.isArray(data.fiches)) {
        const n = data.fiches.length;
        const msg = n === 0
          ? 'üì• Ce backup est vide (0 fiche). Rien √† importer.'
          : 'üì• Importer ' + n + ' fiche(s) depuis ce backup ?\n\nCes fiches seront AJOUT√âES √† votre r√©pertoire (vos fiches actuelles sont conserv√©es).';
        if (n === 0) { afficherExportStatus(msg, '#E65100'); return; }
        if (!confirm(msg)) return;
        const existing = lireRepertoire();
        // √âviter les doublons par nom
        const existingNames = new Set(existing.map(function(f) { return f.nom; }));
        const toAdd = data.fiches.filter(function(f) { return !existingNames.has(f.nom); });
        const dupes = data.fiches.length - toAdd.length;
        const merged = [...toAdd, ...existing];
        ecrireRepertoire(merged);
        // Restaurer l'autosave si existant et utile
        if (data.autosave && !localStorage.getItem(SAVE_KEY)) {
          localStorage.setItem(SAVE_KEY, JSON.stringify(data.autosave));
        }
        mettreAJourBadgeRepertoire();
        mettreAJourStatsPartage();
        let msg2 = '‚úÖ ' + toAdd.length + ' fiche(s) import√©e(s) !';
        if (dupes > 0) msg2 += ' (' + dupes + ' doublon(s) ignor√©(s))';
        afficherExportStatus(msg2, '#2E7D32');
        return;
      }

      // ‚îÄ‚îÄ CAS 2 : Fiche individuelle (exporterFicheActuelle) ‚îÄ‚îÄ
      // Structure : { v, entete, etapes, params, exportedAt, nom? }
      if (data.entete && typeof data.entete === 'object') {
        if (!confirm('üì• Charger cette fiche dans l\'√©diteur ?\n"' + (data.nom || data.entete.activite || 'Sans titre') + '"\n\nLe contenu actuel sera remplac√©.')) return;
        restaurerFiche(data);
        showTab('entete');
        afficherExportStatus('‚úÖ Fiche "' + (data.nom || data.entete.activite || 'Sans titre') + '" charg√©e !', '#1565C0');
        return;
      }

      // ‚îÄ‚îÄ CAS 3 : Ancienne structure v2.x (v + entete + etapes) ‚îÄ‚îÄ
      if ((data.v || data.version) && data.etapes && Array.isArray(data.etapes)) {
        if (!confirm('üì• Charger cette fiche dans l\'√©diteur ?\n\nLe contenu actuel sera remplac√©.')) return;
        restaurerFiche(data);
        showTab('entete');
        afficherExportStatus('‚úÖ Fiche charg√©e depuis le backup v2 !', '#1565C0');
        return;
      }

      // ‚îÄ‚îÄ Aucun format reconnu ‚îÄ‚îÄ
      afficherExportStatus('‚ùå Format non reconnu. V√©rifiez que c\'est bien un fichier export√© depuis cette application.', '#C62828');

    } catch(err) {
      afficherExportStatus('‚ùå Fichier JSON invalide ou corrompu : ' + err.message, '#C62828');
    }
  };
  reader.onerror = function() {
    afficherExportStatus('‚ùå Impossible de lire le fichier.', '#C62828');
  };
  reader.readAsText(file, 'UTF-8');
}

function confirmerEffacerTout() {
  if (!confirm('‚ö†Ô∏è ATTENTION !\n\nVoulez-vous vraiment supprimer TOUTES vos fiches sauvegard√©es ?\n\nCette action est IRR√âVERSIBLE.\n\nPensez √† exporter un backup avant !')) return;
  if (!confirm('üî¥ Derni√®re confirmation : effacer toutes les fiches ?')) return;
  localStorage.removeItem(REP_KEY);
  localStorage.removeItem(SAVE_KEY);
  mettreAJourBadgeRepertoire();
  mettreAJourStatsPartage();
  afficherExportStatus('üóëÔ∏è Toutes les fiches ont √©t√© supprim√©es.', '#E65100');
}

function afficherExportStatus(msg, color) {
  const el = document.getElementById('export-status');
  if (!el) return;
  el.style.display = 'block';
  el.style.background = color + '15';
  el.style.border = '1px solid ' + color + '40';
  el.style.color = color;
  el.textContent = msg;
  setTimeout(function() { if (el) el.style.display = 'none'; }, 4000);
}

function mettreAJourStatsPartage() {
  const fiches = lireRepertoire();
  const el1 = document.getElementById('stat-fiches');
  const el2 = document.getElementById('stat-taille');
  const el3 = document.getElementById('stat-backup');
  if (el1) el1.textContent = fiches.length;
  if (el2) {
    try {
      const totalSize = (localStorage.getItem(REP_KEY) || '').length * 2;
      el2.textContent = totalSize > 1024 ? Math.round(totalSize/1024) + ' Ko' : totalSize + ' o';
    } catch(e2) { if (el2) el2.textContent = '‚Äî'; }
  }
  if (el3) {
    const lastBackup = localStorage.getItem('fp_last_backup');
    el3.textContent = lastBackup ? lastBackup.split(' ')[0] : '‚Äî';
  }
}

// ‚îÄ‚îÄ PARTAGE PAR LIEN ET QR CODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchShareMethod(method, btn) {
  document.querySelectorAll('.share-method-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.share-panel').forEach(function(p) { p.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  const panel = document.getElementById('share-panel-' + method);
  if (panel) panel.classList.add('active');
}

function compresserFiche() {
  const data = collecterTout();
  const slim = {
    v: data.v,
    entete: data.entete,
    etapes: data.etapes.map(function(e) { return {
      nom: e.nom,
      enseignant: (e.enseignant || '').replace(/src="data:image[^"]*"/g, 'src="[IMG]"'),
      duree: e.duree
    }; }),
    params: data.params
  };
  const json = JSON.stringify(slim);
  try { return btoa(unescape(encodeURIComponent(json))); }
  catch(err) { return btoa(json); }
}

function genererURL() {
  try {
    const encoded = compresserFiche();
    const baseUrl = window.location.href.split('?')[0].split('#')[0];
    const url = baseUrl + '?fiche=' + encoded;
    const urlContainer = document.getElementById('url-container');
    const urlDisplay = document.getElementById('share-url-display');
    const sizeInfo = document.getElementById('url-size-info');
    if (urlContainer) urlContainer.style.display = 'block';
    if (urlDisplay) urlDisplay.textContent = url;
    if (sizeInfo) {
      const kb = Math.round(url.length / 1024 * 10) / 10;
      sizeInfo.textContent = 'Taille du lien : ' + kb + ' Ko';
      if (url.length > 50000) {
        sizeInfo.textContent += ' ‚ö†Ô∏è Lien tr√®s long ‚Äî pr√©f√©rez l\'export JSON.';
        sizeInfo.style.color = '#E65100';
      } else {
        sizeInfo.style.color = 'var(--muted)';
      }
    }
  } catch(e) {
    afficherExportStatus('‚ùå Erreur lors de la g√©n√©ration du lien : ' + e.message, '#C62828');
  }
}

function copierURL() {
  const urlEl = document.getElementById('share-url-display');
  if (!urlEl) return;
  const url = urlEl.textContent;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(function() {
      afficherExportStatus('‚úÖ Lien copi√© dans le presse-papiers !', '#2E7D32');
    }).catch(function() {
      selectionnerEtCopier(urlEl);
    });
  } else {
    selectionnerEtCopier(urlEl);
  }
}

function selectionnerEtCopier(el) {
  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  try {
    document.execCommand('copy');
    afficherExportStatus('‚úÖ Lien copi√© !', '#2E7D32');
  } catch(e) {
    afficherExportStatus('S√©lectionnez le texte manuellement et copiez-le.', '#1565C0');
  }
  sel.removeAllRanges();
}

function ouvrirURL() {
  const urlEl = document.getElementById('share-url-display');
  if (urlEl && urlEl.textContent) window.open(urlEl.textContent, '_blank');
}

function partagerEmail(mode) {
  var entete = {};
  try { entete = collecterEntete ? collecterEntete() : {}; } catch(e2) {}
  const nom = (entete.activite || entete.module || 'Fiche p√©dagogique');
  const sujet = encodeURIComponent('Fiche p√©dagogique : ' + nom);
  const corps = encodeURIComponent('Bonjour,\n\nJe partage la fiche p√©dagogique "' + nom + '".\n\nVeuillez trouver le fichier JSON en pi√®ce jointe.\nPour l\'importer :\n1. Ouvrez l\'application Fiche P√©dagogique\n2. Allez dans l\'onglet "Partage"\n3. Cliquez sur "Importer un backup (.json)"\n4. S√©lectionnez le fichier re√ßu\n\nCordialement,\n' + (entete.prof || ''));
  afficherExportStatus('üìß Export en cours... Joignez le fichier JSON t√©l√©charg√© √† votre email.', '#1565C0');
  setTimeout(function() { exporterFicheActuelle(); }, 200);
  setTimeout(function() { window.location.href = 'mailto:?subject=' + sujet + '&body=' + corps; }, 800);
}

// ‚îÄ‚îÄ QR R√âSUM√â (v3.2 ‚Äî fonctionne toujours car encode seulement les infos essentielles) ‚îÄ‚îÄ

function genererQRResume() {
  try {
    // Collecter seulement les infos essentielles de l'en-t√™te
    var entete = {};
    try { entete = collecterEntete ? collecterEntete() : {}; } catch(e2) {}
    var etapes = [];
    try { etapes = collecterEtapes ? collecterEtapes() : []; } catch(e2) {}

    function stripHtml(html) {
      if (!html) return '';
      const d = document.createElement('div');
      d.innerHTML = html;
      return (d.textContent || d.innerText || '').trim().slice(0, 120);
    }

    // Construire un texte compact et lisible (pas de JSON, juste du texte)
    const prof     = stripHtml(entete.prof     || '').slice(0, 40);
    const niveau   = stripHtml(entete.niveau   || '').slice(0, 20);
    const module_  = stripHtml(entete.module   || '').slice(0, 60);
    const sequence = stripHtml(entete.sequence || '').slice(0, 60);
    const activite = stripHtml(entete.activite || '').slice(0, 60);
    const objectif = stripHtml(entete.objectif || '').slice(0, 150);
    const dureeTotal = etapes.reduce(function(s, e) {
      const m = (e.duree || '').match(/(\d+[\.,]?\d*)/);
      return s + (m ? parseFloat(m[1].replace(',','.')) : 0);
    }, 0);

    // Construire les lignes du r√©sum√©
    const lines = [];
    lines.push('=== FICHE P√âDAGOGIQUE ===');
    if (prof)     lines.push('Prof : ' + prof);
    if (niveau)   lines.push('Niveau : ' + niveau);
    if (module_)  lines.push('Module : ' + module_);
    if (sequence) lines.push('S√©quence : ' + sequence);
    if (activite) lines.push('Activit√© : ' + activite);
    if (objectif) lines.push('Objectif : ' + objectif);
    if (etapes.length > 0) {
      lines.push('---');
      lines.push('√âtapes (' + etapes.length + ')' + (dureeTotal > 0 ? ' ¬∑ ' + dureeTotal + ' min' : '') + ' :');
      etapes.forEach(function(et, i) {
        const nom = stripHtml(et.nom || '').slice(0, 30) || ('√âtape ' + (i+1));
        lines.push((i+1) + '. ' + nom + (et.duree ? ' (' + et.duree + ')' : ''));
      });
    }
    lines.push('---');
    lines.push('App : Fiche P√©dagogique v3.2');
    lines.push('¬© EZ-ZAKY AZIZ');

    const qrText = lines.join('\n');

    // V√©rification de taille ‚Äî ce texte sera toujours court
    const preview = document.getElementById('qr-content-preview');
    if (preview) preview.textContent = qrText;

    const container = document.getElementById('qr-container');
    const canvas    = document.getElementById('qr-canvas');
    const infoEl    = document.getElementById('qr-info-text');
    const ctx       = canvas.getContext('2d');

    // Appel √† l'API QR (texte court = QR simple, toujours lisible)
    const qrApiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&ecc=M&margin=10&data='
                   + encodeURIComponent(qrText);

    // Afficher un loader pendant le chargement
    ctx.fillStyle = '#F5F8FF';
    ctx.fillRect(0, 0, 220, 220);
    ctx.fillStyle = '#1565C0';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('G√©n√©ration‚Ä¶', 110, 115);
    if (container) container.style.display = 'flex';

    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
      ctx.clearRect(0, 0, 220, 220);
      ctx.drawImage(img, 0, 0, 220, 220);
      if (infoEl) infoEl.textContent = 
        'R√©sum√© : ' + (prof || '‚Äî') + ' ¬∑ ' + (niveau || '‚Äî') + 
        (activite ? ' ¬∑ ' + activite.slice(0,30) : '') +
        ' ¬∑ ' + etapes.length + ' √©tape(s)' +
        (dureeTotal > 0 ? ' ¬∑ ' + dureeTotal + ' min' : '');
      afficherExportStatus('‚úÖ QR R√©sum√© g√©n√©r√© ! √Ä imprimer ou afficher en classe.', '#2E7D32');
    };
    img.onerror = function() {
      // Hors ligne ‚Äî dessiner un QR factice avec message
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, 220, 220);
      // Bordure bleue
      ctx.strokeStyle = '#1565C0';
      ctx.lineWidth = 3;
      ctx.strokeRect(4, 4, 212, 212);
      // Coins de QR
      [
        [10,10],[170,10],[10,170]
      ].forEach(function(pos) {
        ctx.fillStyle = '#1565C0';
        ctx.fillRect(pos[0], pos[1], 40, 40);
        ctx.fillStyle = 'white';
        ctx.fillRect(pos[0]+6, pos[1]+6, 28, 28);
        ctx.fillStyle = '#1565C0';
        ctx.fillRect(pos[0]+12, pos[1]+12, 16, 16);
      });
      // Message centr√©
      ctx.fillStyle = '#1565C0';
      ctx.font = 'bold 11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Connexion requise', 110, 90);
      ctx.font = '10px sans-serif';
      ctx.fillStyle = '#555';
      ctx.fillText('pour g√©n√©rer le QR.', 110, 106);
      ctx.fillText('Reconnectez-vous', 110, 126);
      ctx.fillText('puis r√©essayez.', 110, 142);
      if (infoEl) infoEl.textContent = '‚ö†Ô∏è Connexion internet requise pour g√©n√©rer le QR Code.';
      if (container) container.style.display = 'flex';
      afficherExportStatus('‚ö†Ô∏è QR non disponible hors ligne. Utilisez "üîë Code court" √† la place.', '#E65100');
    };
    img.src = qrApiUrl;

  } catch(e) {
    afficherExportStatus('‚ùå Erreur : ' + e.message, '#C62828');
  }
}

// Garder la compatibilit√© si genererQRCode est appel√© ailleurs
function genererQRCode() { genererQRResume(); }

function telechargerQR() {
  const canvas = document.getElementById('qr-canvas');
  if (!canvas) return;
  try {
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    const entete = {};
    try { Object.assign(entete, collecterEntete ? collecterEntete() : {}); } catch(e2) {}
    const nom = (entete.activite || entete.niveau || 'fiche').replace(/[^a-zA-Z0-9]/gi,'_').slice(0,20);
    a.download = 'QR_resume_' + nom + '.png';
    a.click();
    afficherExportStatus('‚úÖ QR t√©l√©charg√© !', '#2E7D32');
  } catch(e) {
    afficherExportStatus('‚ùå T√©l√©chargement impossible : ' + e.message, '#C62828');
  }
}

// ‚îÄ‚îÄ CODE COURT DE PARTAGE (fonctionne sur Android WebView) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Le code est stock√© dans localStorage avec une cl√© unique.
// Votre coll√®gue entre le code dans son application sur le m√™me appareil
// ou transf√®re le fichier JSON manuellement.
// Note : localStorage n'est pas partag√© entre appareils.
// Le "code" est donc un raccourci pour sauvegarder/retrouver une fiche
// sur le M√äME appareil, ou via copier-coller du code + import.

const CODE_PREFIX = 'fp_share_code_';

function genererCodeCourt() {
  try {
    const data = collecterTout();
    // G√©n√©rer un code de 8 caract√®res alphanum√©riques
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // sans I, O, 0, 1 pour √©viter confusion
    let code = '';
    for (let i = 0; i < 8; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    // Stocker dans localStorage avec expiration 48h
    const expiry = Date.now() + 48 * 60 * 60 * 1000;
    const payload = { data: data, code: code, expiry: expiry, createdAt: new Date().toLocaleString('fr-FR') };
    localStorage.setItem(CODE_PREFIX + code, JSON.stringify(payload));
    
    // Afficher le code
    const display = document.getElementById('code-court-display');
    const expiryEl = document.getElementById('code-court-expiry');
    const container = document.getElementById('code-court-container');
    if (display) display.textContent = code;
    if (expiryEl) expiryEl.textContent = 'Valide 48h sur cet appareil ¬∑ Cr√©√© le ' + new Date().toLocaleString('fr-FR');
    if (container) container.style.display = 'block';
    
    // Nettoyer les anciens codes expir√©s
    nettoyerCodesExpires();
    
  } catch(e) {
    afficherExportStatus('‚ùå Erreur g√©n√©ration code : ' + e.message, '#C62828');
  }
}

function nettoyerCodesExpires() {
  try {
    const keys = Object.keys(localStorage).filter(function(k) { return k.startsWith(CODE_PREFIX); });
    keys.forEach(function(k) {
      try {
        const p = JSON.parse(localStorage.getItem(k));
        if (p && p.expiry && p.expiry < Date.now()) localStorage.removeItem(k);
      } catch(e2) { localStorage.removeItem(k); }
    });
  } catch(e) {}
}

function copierCode() {
  const display = document.getElementById('code-court-display');
  if (!display) return;
  const code = display.textContent;
  if (!code || code === '‚Äî‚Äî') return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(function() {
      afficherExportStatus('‚úÖ Code "' + code + '" copi√© !', '#2E7D32');
    }).catch(function() {
      afficherExportStatus('Code : ' + code + ' (copiez-le manuellement)', '#1565C0');
    });
  } else {
    afficherExportStatus('Votre code : ' + code, '#1565C0');
  }
}

function partagerCodeWhatsApp() {
  const display = document.getElementById('code-court-display');
  if (!display) return;
  const code = display.textContent;
  if (!code || code === '‚Äî‚Äî') { afficherExportStatus('G√©n√©rez d\'abord un code.', '#E65100'); return; }
  const entete = {};
  try { Object.assign(entete, collecterEntete ? collecterEntete() : {}); } catch(e2) {}
  const nom = entete.activite || entete.module || 'Fiche p√©dagogique';
  const msg = 'Bonjour ! Je partage la fiche "' + nom + '".\n\nCode de partage : *' + code + '*\n\nOuvrez l\'application ‚Üí onglet Partage ‚Üí Code court ‚Üí entrez ce code.\n\n(Valide 48h sur cet appareil)';
  window.location.href = 'whatsapp://send?text=' + encodeURIComponent(msg);
}

function chargerParCode() {
  const input = document.getElementById('code-import-input');
  const statusEl = document.getElementById('code-import-status');
  if (!input || !statusEl) return;
  const code = (input.value || '').trim().toUpperCase();
  if (!code || code.length < 4) {
    statusEl.style.color = '#E65100';
    statusEl.textContent = '‚ö†Ô∏è Entrez un code valide.';
    return;
  }
  
  nettoyerCodesExpires();
  
  try {
    const stored = localStorage.getItem(CODE_PREFIX + code);
    if (!stored) {
      statusEl.style.color = '#C62828';
      statusEl.textContent = '‚ùå Code introuvable ou expir√©. V√©rifiez le code ou demandez-en un nouveau.';
      return;
    }
    const payload = JSON.parse(stored);
    if (!payload || !payload.data) {
      statusEl.style.color = '#C62828';
      statusEl.textContent = '‚ùå Donn√©es corrompues.';
      return;
    }
    if (payload.expiry && payload.expiry < Date.now()) {
      localStorage.removeItem(CODE_PREFIX + code);
      statusEl.style.color = '#E65100';
      statusEl.textContent = '‚è±Ô∏è Ce code a expir√©. Demandez un nouveau code.';
      return;
    }
    if (!confirm('üì• Charger la fiche associ√©e au code "' + code + '" ?\n\nLe contenu actuel sera remplac√©.')) return;
    restaurerFiche(payload.data);
    showTab('entete');
    statusEl.style.color = '#2E7D32';
    statusEl.textContent = '‚úÖ Fiche charg√©e !';
    input.value = '';
    afficherStatutSauvegarde('üì• Fiche charg√©e via code "' + code + '"', '#1565C0');
  } catch(e) {
    statusEl.style.color = '#C62828';
    statusEl.textContent = '‚ùå Erreur : ' + e.message;
  }
}

function partagerEmailCode() {
  const display = document.getElementById('code-court-display');
  const code = display ? display.textContent : '';
  var entete = {};
  try { Object.assign(entete, collecterEntete ? collecterEntete() : {}); } catch(e2) {}
  const nom = entete.activite || entete.module || 'Fiche p√©dagogique';
  const sujet = encodeURIComponent('Code de partage - Fiche : ' + nom);
  const corps = encodeURIComponent(
    'Bonjour,\n\nJe partage la fiche p√©dagogique "' + nom + '".\n\n' +
    'Code de partage : ' + (code && code !== '‚Äî‚Äî' ? code : '(g√©n√©rez d\'abord un code)') + '\n\n' +
    'Pour charger la fiche :\n' +
    '1. Ouvrez l\'application Fiche P√©dagogique\n' +
    '2. Allez dans l\'onglet "Partage"\n' +
    '3. Cliquez sur "üîë Code court"\n' +
    '4. Entrez le code ci-dessus\n\n' +
    'Note : le code est valide 48h.\n\nCordialement,\n' + (entete.prof || '')
  );
  if (!code || code === '‚Äî‚Äî') {
    afficherExportStatus('‚ö†Ô∏è G√©n√©rez d\'abord un code via "üîë G√©n√©rer un code de partage".', '#E65100');
    return;
  }
  window.location.href = 'mailto:?subject=' + sujet + '&body=' + corps;
}

// ‚îÄ‚îÄ CHARGEMENT DEPUIS URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function chargerDepuisURL() {
  try {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('fiche');
    if (!encoded) return;
    const json = decodeURIComponent(escape(atob(encoded)));
    const data = JSON.parse(json);
    if (data && (data.entete || data.v)) {
      setTimeout(function() {
        if (confirm('üì• Un lien de partage a √©t√© d√©tect√©.\n\nVoulez-vous charger la fiche partag√©e ?')) {
          restaurerFiche(data);
          showTab('entete');
          const cleanUrl = window.location.href.split('?')[0];
          if (window.history && window.history.replaceState) {
            window.history.replaceState({}, document.title, cleanUrl);
          }
          afficherStatutSauvegarde('üì• Fiche charg√©e depuis un lien de partage !', '#1565C0');
        }
      }, 1200);
    }
  } catch(e) {
    // URL invalide, ignorer
  }
}

// ‚îÄ‚îÄ APER√áU PDF SIMUL√â ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function genererPreviewSimulee() {
  const container = document.getElementById('pdf-preview-container');
  if (!container) return;
  try {
    var entete = {};
    var etapes = [];
    try { entete = collecterEntete ? collecterEntete() : {}; } catch(e2) {}
    try { etapes = collecterEtapes ? collecterEtapes() : []; } catch(e2) {}
    const mainColor = (document.getElementById('p-color-main') || {}).value || '#1565C0';
    function stripHtml(html) {
      if (!html) return '';
      const d = document.createElement('div');
      d.innerHTML = html;
      return (d.textContent || d.innerText || '').trim();
    }
    // Labels des colonnes
    const etapesLabel = (document.getElementById('label-col-etapes') || {}).value || '√âtapes';
    const deroulLabel = (document.getElementById('label-col-deroulement') || {}).value || 'D√©roulement de la s√©ance';
    const dureeLabel = (document.getElementById('label-col-duree') || {}).value || 'Dur√©e';
    // Labels de l'en-t√™te
    const getLabel = function(selector, fallback) {
      const els = document.querySelectorAll(selector);
      const el = els[0];
      return el ? (el.textContent || '').trim() || fallback : fallback;
    };
    const profLabel = getLabel('#fgrp-ligne1 .label-text', 'Professeur');
    const niveauLabel = (document.querySelectorAll('#fgrp-ligne1 .label-text')[1] || {textContent: 'Niveau'}).textContent.trim() || 'Niveau';
    const moduleLabel = getLabel('#fgrp-module .label-text', 'Module');
    const sequenceLabel = getLabel('#fgrp-sequence .label-text', 'S√©quence');
    const activiteLabel = getLabel('#fgrp-activite .label-text', 'Activit√©');
    const supportLabel = getLabel('#fgrp-support .label-text', 'Support');
    const objectifLabel = getLabel('#fgrp-objectif .label-text', 'Objectif');
    const lbl = 'background:' + mainColor + ';color:white;padding:4px 6px;font-size:8px;font-weight:700;min-width:60px;display:flex;align-items:center;white-space:nowrap;';
    const val = 'padding:4px 6px;font-size:8px;flex:1;border-left:1px solid ' + mainColor + ';word-break:break-word;';
    const borderStyle = 'border:1.5px solid ' + mainColor + ';border-radius:2px;margin-bottom:8px;overflow:hidden;font-family:Times New Roman,serif;';
    const rowStyle = 'display:flex;border-bottom:1px solid ' + mainColor + ';';
    let headerHtml = '<div style="' + borderStyle + '">';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + profLabel + '</span><span style="' + val + '">' + (stripHtml(entete.prof)||'‚Äî') + '</span><span style="' + lbl + '">' + niveauLabel + '</span><span style="' + val + '">' + (stripHtml(entete.niveau)||'‚Äî') + '</span></div>';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + moduleLabel + '</span><span style="' + val + 'flex:3">' + (stripHtml(entete.module)||'‚Äî') + '</span></div>';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + sequenceLabel + '</span><span style="' + val + 'flex:3">' + (stripHtml(entete.sequence)||'‚Äî') + '</span></div>';
    headerHtml += '<div style="' + rowStyle + '"><span style="' + lbl + '">' + activiteLabel + '</span><span style="' + val + '">' + (stripHtml(entete.activite)||'‚Äî') + '</span><span style="' + lbl + '">' + supportLabel + '</span><span style="' + val + '">' + (stripHtml(entete.support)||'‚Äî') + '</span></div>';
    headerHtml += '<div style="display:flex;min-height:30px;"><span style="' + lbl + 'align-items:flex-start;padding-top:5px;">' + objectifLabel + '</span><span style="' + val + 'flex:3;white-space:pre-wrap;">' + (stripHtml(entete.objectif)||'‚Äî') + '</span></div>';
    headerHtml += '</div>';
    let tableHtml = '<table style="width:100%;border-collapse:collapse;border:1px solid ' + mainColor + ';font-family:Times New Roman,serif;">';
    tableHtml += '<thead><tr><th style="background:' + mainColor + ';color:white;padding:4px;font-size:8px;width:18%;border:1px solid rgba(255,255,255,0.3);">' + etapesLabel + '</th><th style="background:' + mainColor + ';color:white;padding:4px;font-size:8px;width:72%;border:1px solid rgba(255,255,255,0.3);">' + deroulLabel + '</th><th style="background:' + mainColor + ';color:white;padding:4px;font-size:8px;width:10%;border:1px solid rgba(255,255,255,0.3);">' + dureeLabel + '</th></tr></thead><tbody>';
    if (etapes.length === 0) {
      tableHtml += '<tr><td colspan="3" style="padding:10px;text-align:center;font-size:8px;color:#aaa;">Aucune √©tape d√©finie</td></tr>';
    } else {
      etapes.forEach(function(et, i) {
        const d = stripHtml(et.enseignant || '');
        const dt = d.length > 180 ? d.slice(0,180) + '‚Ä¶' : d;
        tableHtml += '<tr><td style="border:1px solid #ddd;padding:4px 3px;font-size:8px;font-weight:700;color:' + mainColor + ';text-align:center;">' + (stripHtml(et.nom)||(i+1)) + '</td><td style="border:1px solid #ddd;padding:4px 3px;font-size:7px;">' + dt + '</td><td style="border:1px solid #ddd;padding:4px 3px;font-size:8px;text-align:center;">' + (et.duree||'‚Äî') + '</td></tr>';
      });
    }
    tableHtml += '</tbody></table>';
    container.innerHTML = '<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:10px;">' +
      '<button class="pdf-preview-update-btn" onclick="genererPreviewSimulee()">üîÑ Actualiser</button>' +
      '<button class="pdf-preview-update-btn" onclick="genererPDF()" style="background:#2E7D32;">üìÑ G√©n√©rer le vrai PDF</button>' +
      '</div>' +
      '<div class="pdf-page-sim">' +
      '<div style="text-align:center;font-size:9px;color:#aaa;margin-bottom:8px;">‚Äî Aper√ßu simul√© ¬∑ non contractuel ‚Äî</div>' +
      headerHtml + tableHtml +
      '<div style="text-align:center;font-size:7px;color:#bbb;margin-top:8px;">¬© EZ-ZAKY AZIZ ¬∑ v3.0 ¬∑ ' + new Date().toLocaleDateString('fr-FR') + '</div>' +
      '</div>' +
      '<div class="pdf-sim-info">üìê Aper√ßu approximatif A4 ¬∑ Le PDF r√©el peut l√©g√®rement diff√©rer</div>';
  } catch(err) {
    container.innerHTML = '<div class="pdf-sim-info" style="color:#E65100;">‚ùå ' + err.message + '</div>';
  }
}

// ‚îÄ‚îÄ INITIALISATION v3.0 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

window.addEventListener('load', function() {
  setTimeout(chargerDepuisURL, 600);
  setTimeout(mettreAJourStatsPartage, 1200);
});

(function() {
  const banner = document.getElementById('offline-banner');
  let restoreTimer = null;

  function showOffline() {
    if (!banner) return;
    banner.classList.remove('online-restored');
    banner.textContent = 'üìµ Mode hors ligne ‚Äî La g√©n√©ration PDF reste disponible';
    banner.classList.add('show');
    clearTimeout(restoreTimer);
  }

  function showOnline() {
    if (!banner) return;
    banner.classList.add('online-restored');
    banner.textContent = '‚úÖ Connexion r√©tablie';
    banner.classList.add('show');
    clearTimeout(restoreTimer);
    restoreTimer = setTimeout(() => banner.classList.remove('show'), 3000);
  }

  window.addEventListener('offline', showOffline);
  window.addEventListener('online',  showOnline);

  // V√©rification initiale
  if (!navigator.onLine) showOffline();

  // Chargement de jsPDF avec fallback inline si le script externe √©choue
  function injectJsPdfFallback() {
    // Si jsPDF n'est pas charg√©, afficher un avertissement clair
    setTimeout(() => {
      if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
        const warn = document.getElementById('jspdf-warn');
        if (warn) warn.style.display = 'block';
      }
    }, 4000);
  }

  window.addEventListener('load', injectJsPdfFallback);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MESSAGE DE BIENVENUE & LICENCE (Premier lancement)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.addEventListener('load', function() {
    // V√©rifier si c'est la premi√®re visite
    const hasSeenWelcome = localStorage.getItem('fp_welcome_seen');
    
    if (!hasSeenWelcome) {
      // Attendre 800ms pour que la page soit bien charg√©e
      setTimeout(function() {
        const acceptLicense = confirm(
          'üìã BIENVENUE dans le G√©n√©rateur de Fiches P√©dagogiques !\n\n' +
          '¬© 2025-2026 EZ-ZAKY AZIZ ‚Äî Version 3.0\n\n' +
          '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
          'LICENCE D\'UTILISATION\n' +
          '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
          'Cette application est gratuite et distribu√©e sous licence\n' +
          'Creative Commons BY-NC-SA 4.0.\n\n' +
          '‚úÖ VOUS POUVEZ :\n' +
          '   ‚Ä¢ Utiliser l\'application gratuitement\n' +
          '   ‚Ä¢ La partager avec vos coll√®gues\n' +
          '   ‚Ä¢ La modifier pour vos besoins\n\n' +
          '‚ö†Ô∏è VOUS DEVEZ :\n' +
          '   ‚Ä¢ Toujours cr√©diter l\'auteur (EZ-ZAKY AZIZ)\n' +
          '   ‚Ä¢ Partager vos modifications sous la m√™me licence\n\n' +
          '‚ùå INTERDIT :\n' +
          '   ‚Ä¢ Usage commercial (vente de l\'application)\n' +
          '   ‚Ä¢ Retirer le nom de l\'auteur\n\n' +
          '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
          'Pour plus de d√©tails, consultez l\'onglet "√Ä propos".\n\n' +
          'Acceptez-vous ces conditions d\'utilisation ?'
        );
        
        if (acceptLicense) {
          // Marquer comme vu
          localStorage.setItem('fp_welcome_seen', 'true');
          localStorage.setItem('fp_license_accepted', new Date().toISOString());
          
          // Message de bienvenue
          alert(
            'üéâ Merci et bienvenue !\n\n' +
            'Consultez l\'onglet "üìñ Guide" pour d√©couvrir\n' +
            'toutes les fonctionnalit√©s de l\'application.\n\n' +
            'Bonne cr√©ation de fiches p√©dagogiques ! üìö'
          );
        } else {
          // L'utilisateur a refus√©
          alert(
            '‚ö†Ô∏è Conditions non accept√©es\n\n' +
            'Vous devez accepter la licence pour utiliser cette application.\n\n' +
            'L\'application va maintenant se fermer.'
          );
          // Rediriger vers une page blanche
          document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;text-align:center;padding:20px;"><div><h1 style="color:#1565C0;">üìã</h1><h2>Licence non accept√©e</h2><p style="color:#666;">Vous devez accepter les conditions d\'utilisation<br>pour utiliser cette application.</p><button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#1565C0;color:white;border:none;border-radius:5px;cursor:pointer;font-size:14px;">üîÑ Recharger et accepter</button></div></div>';
        }
      }, 800);
    }
  });
})();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- FOOTER PERMANENT ‚Äî VERSION & COPYRIGHT              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app-footer">
  <div>
    ¬© 2025 <a href="#" onclick="showTab('apropos'); return false;">EZ-ZAKY AZIZ</a> ‚Äî Tous droits r√©serv√©s
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <span class="version-badge">v3.0</span>
    <span style="color:#aaa;">|</span>
    <a href="#" onclick="showTab('apropos'); return false;">Licence CC BY-NC-SA 4.0</a>
  </div>
</div>

</body>
</html>
